{% extends "base.html" %}
{% load static %}

{% block title %}Настройка MFA{% endblock %}

{% block content %}
<section class="ps-auth">
    <div class="ps-auth-card ps-card ps-card--elevated ps-animate-fade-up">
        <h1 class="ps-auth-title">Многофакторная аутентификация</h1>
        <p class="ps-auth-subtitle">Выберите метод: TOTP приложение, SMS или email. Второй фактор защитит ваш аккаунт.</p>

        {% if status %}
            <div class="ps-alert ps-alert--success">{{ status }}</div>
        {% endif %}
        {% if error %}
            <div class="ps-alert ps-alert--danger">{{ error }}</div>
        {% endif %}

        <div class="ps-auth-panels">
            <div class="ps-auth-panel is-active">
                <h3>1. Выбор метода</h3>
                <div class="ps-auth-social" style="gap: 10px;">
                    <form method="post" style="display:inline-block;">
                        {% csrf_token %}
                        <input type="hidden" name="action" value="start_totp" />
                        <button type="submit" class="ps-btn ps-btn-ghost">TOTP (Google Authenticator)</button>
                    </form>
                    <form method="post" style="display:inline-block;">
                        {% csrf_token %}
                        <input type="hidden" name="action" value="start_sms" />
                        <button type="submit" class="ps-btn ps-btn-ghost">SMS код</button>
                    </form>
                    <form method="post" style="display:inline-block;">
                        {% csrf_token %}
                        <input type="hidden" name="action" value="start_email" />
                        <button type="submit" class="ps-btn ps-btn-ghost">Email код</button>
                    </form>
                </div>
                <p class="ps-text-muted">TOTP самый надёжный: работает оффлайн и не зависит от доставки сообщений.</p>
            </div>
        </div>

        {% if secret %}
            <div class="ps-card ps-card--outlined" style="margin-top:16px;">
                <h3>2. Сканируйте QR</h3>
                {% if otpauth_url %}
                    <img src="https://api.qrserver.com/v1/create-qr-code/?size=220x220&data={{ otpauth_url|urlencode }}" alt="TOTP QR" />
                    <p class="ps-text-muted" style="margin-top:8px;">Если QR не сканируется, введите секрет вручную: <code>{{ secret }}</code></p>
                {% endif %}
                <form method="post" class="ps-form" style="margin-top:12px;">
                    {% csrf_token %}
                    <input type="hidden" name="action" value="verify" />
                    <label class="ps-form-label" for="code">Код из приложения</label>
                    <input id="code" name="code" type="text" class="ps-input" maxlength="6" placeholder="123456" />
                    <button class="ps-btn ps-btn-full" type="submit">Активировать MFA</button>
                </form>
            </div>
        {% elif method != "none" %}
            <div class="ps-card ps-card--outlined" style="margin-top:16px;">
                <h3>2. Подтвердите код</h3>
                <form method="post" class="ps-form">
                    {% csrf_token %}
                    <input type="hidden" name="action" value="verify" />
                    <label class="ps-form-label" for="code-otp">Код</label>
                    <input id="code-otp" name="code" type="text" class="ps-input" maxlength="6" placeholder="Код из SMS/Email" />
                    <button class="ps-btn ps-btn-full" type="submit">Активировать MFA</button>
                </form>
            </div>
        {% endif %}

        {% if mfa_enabled %}
            <div class="ps-card ps-card--outlined ps-alert--muted" style="margin-top:16px;">
                <p class="ps-text-muted">MFA уже включена ({{ method }}). Отключайте только при смене устройства.</p>
                <form method="post">
                    {% csrf_token %}
                    <input type="hidden" name="action" value="disable" />
                    <button class="ps-btn ps-btn-secondary">Отключить MFA</button>
                </form>
            </div>
        {% endif %}
    </div>
</section>
{% endblock %}
