################################################################################
# COMPRESSED PROJECT DUMP
# Root: C:\Users\Sultan\Downloads\parkshare_ru_part1
# Generated at: 2025-11-28 19:15:59
# Files: 160
# Max file size: 500KB
# Code compression: True
################################################################################
PROJECT TREE:
--------------------------------------------------------------------------------
parkshare_ru_part1/
    .env
    .env.example
    .env.prod
    .gitattributes
    .gitignore
    Dockerfile
    README.md
    api_server.py
    app.js
    database.py
    docker-compose.prod.yml
    docker-compose.yml
    dump_project.py
    entrypoint.sh
    index.html
    model_training.py
    project_dump.txt [SKIPPED - TOO LARGE]
    requirements.txt
    accounts/
        __init__.py
        admin.py
        apps.py
        auth.py
        forms.py
        models.py
        serializers.py
        urls.py
        utils.py
        views.py
        migrations/
            0001_initial.py
            0002_user_email_hash_user_phone_hash_logincode.py
            0003_userlevel_userbadge_promoreward.py
            __init__.py
    ai/
        __init__.py
        admin.py
        apps.py
        features.py
        models.py
        orchestrator.py
        pricing.py
        serializers.py
        tasks.py
        views.py
        chat/
            __init__.py
            parking_assistant.py
        management/
            __init__.py
            commands/
                __init__.py
                train_chat_intents_from_logs.py
        migrations/
            0001_initial.py
            __init__.py
    ai_services/
        __init__.py
        ai_pricing_service/
            __init__.py
            main.py
        cv_service/
            __init__.py
            main.py
    backend/
        manage.py
        backend/
            __init__.py
            config/
                __init__.py
                asgi.py
                celery.py
                urls.py
                wsgi.py
            settings/
                __init__.py
                base.py
                local.py
                production.py
                regions.py
        rest_framework_simplejwt/
            __init__.py
            authentication.py
            tokens.py
            views.py
        tests/
            __init__.py
            test_auth_api.py
            test_booking_model.py
    core/
        __init__.py
        admin.py
        apps.py
        context_processors.py
        integrations.py
        middleware.py
        models.py
        pagination.py
        permissions.py
        utils.py
    drf_spectacular/
        __init__.py
        openapi.py
        views.py
    frontend/
        parkmate/
            parkmate.types.ts
    nginx/
        nginx.conf
    parking/
        __init__.py
        admin.py
        apps.py
        models.py
        serializers.py
        tasks.py
        urls.py
        views.py
        management/
            commands/
                seed_demo_parking.py
        migrations/
            0001_initial.py
            0002_parkinglot_stress_index_parkingspot_occupancy_7d.py
            0003_booking_ai_fields.py
            0004_favoriteparkingspot_savedplace.py
            __init__.py
    payments/
        __init__.py
        admin.py
        apps.py
        models.py
        providers.py
        serializers.py
        tasks.py
        views.py
        migrations/
            0001_initial.py
            0002_alter_payment_provider.py
            0003_paymentmethod.py
            __init__.py
        providers/
            __init__.py
            base.py
            registry.py
            stripe.py
            yookassa.py
    regions/
        global.yml
        ru.yml
    services/
        __init__.py
        llm.py
        llm_service/
            Dockerfile
            main.py
            requirements.txt
    static/
        manifest.webmanifest
        service-worker.js
        css/
            app.css
            cinematic-ui.css
        icons/
        js/
            app.js
            map.js
            parkmate-ai.ts
            quantum-theme-manager.js
    templates/
        base.html
        offline.html
        accounts/
            login.html
            password_change.html
            password_change_done.html
            password_reset.html
            password_reset_complete.html
            password_reset_confirm.html
            password_reset_done.html
            password_reset_email.txt
            password_reset_subject.txt
            profile.html
            register.html
        parking/
            landing.html
            map_fullscreen.html
            owner_dashboard.html
            pwa_install.html
            user_dashboard.html
    vehicles/
        __init__.py
        admin.py
        apps.py
        models.py
        serializers.py
        urls.py
        views.py
        migrations/
            0001_initial.py
            __init__.py


================================================================================
FILES CONTENT:
================================================================================

# File 1/160: .env
################################################################################

DEBUG=1
SECRET_KEY=django-insecure-test-secret-key-for-dev-only
ALLOWED_HOSTS=127.0.0.1,localhost
DATABASE_NAME=db.sqlite3

YOOKASSA_SHOP_ID=
YOOKASSA_SECRET_KEY=

EMAIL_BACKEND=django.core.mail.backends.console.EmailBackend

# –ö–∞—Ä—Ç—ã / —Ä–µ–≥–∏–æ–Ω
REGION_PROFILE=RU
MAP_PROVIDER=yandex
YANDEX_MAP_API_KEY=

# –°—Ç–∞—Ä—ã–π —Ç–æ–∫–µ–Ω Mapbox (–µ—Å–ª–∏ –±—É–¥–µ—à—å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –≥–¥–µ-—Ç–æ –µ—â—ë)
MAPBOX_TOKEN=your_actual_token_here


# File 2/160: .env.example
################################################################################

# –ë–∞–∑–æ–≤—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ Django
DEBUG=False
SECRET_KEY=change_me_to_random_long_secret_key
ALLOWED_HOSTS=localhost,127.0.0.1,0.0.0.0
PLATFORM_MODE=RU

# –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö
# –î–ª—è –ø—Ä–æ–¥–∞–∫—à–µ–Ω–∞: postgres://user:password@db:5432/parkshare
# Django-environ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Ä–∞—Å–ø–∞—Ä—Å–∏—Ç URL.
DATABASE_URL=postgres://parkshare:parkshare@db:5432/parkshare

# Payments
PAYMENT_PROVIDER=yookassa
YOOKASSA_SHOP_ID=YOUR_SHOP_ID
YOOKASSA_SECRET_KEY=YOUR_SECRET
YOOKASSA_RETURN_URL=https://SERVER_HOST/payments/return/
YOOKASSA_WEBHOOK_SECRET=YOUR_WEBHOOK_SECRET
STRIPE_SECRET_KEY=YOUR_STRIPE_KEY
STRIPE_WEBHOOK_SECRET=YOUR_STRIPE_WEBHOOK_SECRET

# Redis (–±—Ä–æ–∫–µ—Ä/–∫—ç—à)
REDIS_URL=redis://redis:6379/0

# –¢–∞–π–º–∑–æ–Ω–∞ –∏ —è–∑—ã–∫
TIME_ZONE=Europe/Moscow
LANGUAGE_CODE=ru-ru

# –°–æ–ª—å –¥–ª—è —Ö—ç—à–∏—Ä–æ–≤–∞–Ω–∏—è —Ü–∏—Ñ—Ä –Ω–æ–º–µ—Ä–æ–≤
VEHICLE_PLATE_SALT=change_me_vehicle_plate_salt

# –ù–∞—Å—Ç—Ä–æ–π–∫–∏ CORS (–µ—Å–ª–∏ –Ω—É–∂–µ–Ω –¥–æ—Å—Ç—É–ø —Å –¥—Ä—É–≥–æ–≥–æ –¥–æ–º–µ–Ω–∞, –Ω–∞–ø—Ä–∏–º–µ—Ä, –º–æ–±. WebView)
CORS_ALLOWED_ORIGINS=http://localhost:8000

# –ù–∞—Å—Ç—Ä–æ–π–∫–∏ Celery
CELERY_BROKER_URL=${REDIS_URL}
CELERY_RESULT_BACKEND=${REDIS_URL}

# –ù–∞—Å—Ç—Ä–æ–π–∫–∏ YooKassa (–ø—Ä–∏–º–µ—Ä)
YOOKASSA_SHOP_ID=your_shop_id_here
YOOKASSA_SECRET_KEY=your_secret_key_here
YOOKASSA_RETURN_URL=https://example.com/payments/return/
YOOKASSA_WEBHOOK_SECRET=change_me_webhook_secret

# –ö–æ–º–∏—Å—Å–∏—è —Å–µ—Ä–≤–∏—Å–∞ (–ø—Ä–æ—Ü–µ–Ω—Ç, –±—É–¥–µ—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∞ –≤ –±–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫–µ)
SERVICE_COMMISSION_PERCENT=10

# –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å –¥–ª—è –ø—Ä–æ–¥–∞–∫—à–µ–Ω–∞
SECURE_SSL_REDIRECT=False
SESSION_COOKIE_SECURE=False
CSRF_COOKIE_SECURE=False

# –†–µ–≥–∏–æ–Ω / –∫–∞—Ä—Ç—ã
REGION_PROFILE=RU
MAP_PROVIDER=yandex
YANDEX_MAP_API_KEY=your_yandex_maps_api_key


# File 3/160: .env.prod
################################################################################

# -----------------------------
# DJANGO SETTINGS (PROD)
# -----------------------------
DEBUG=0
SECRET_KEY=django-insecure-–ø–æ—Å—Ç–∞–≤—å_—Å—é–¥–∞_–æ—á–µ–Ω—å_–¥–ª–∏–Ω–Ω—É—é_—Å—Ç—Ä–æ–∫—É_—Å–∏–º–≤–æ–ª–æ–≤
ALLOWED_HOSTS=your-domain.ru,your-domain.com,127.0.0.1

DJANGO_SETTINGS_MODULE=backend.settings.production

# -----------------------------
# DATABASE (PostgreSQL / PostGIS)
# -----------------------------
DATABASE_NAME=parkshare
DATABASE_USER=parkshare
DATABASE_PASSWORD=—Å–∏–ª—å–Ω—ã–π_–ø–∞—Ä–æ–ª—å_–∫_–±–¥
DATABASE_HOST=db
DATABASE_PORT=5432

# -----------------------------
# YOOKASSA PAYMENTS (–±–æ–µ–≤—ã–µ —Ä–µ–∫–≤–∏–∑–∏—Ç—ã)
# -----------------------------
YOOKASSA_SHOP_ID=—Ç–≤–æ–π_shop_id
YOOKASSA_SECRET_KEY=—Ç–≤–æ–π_secret_key

# -----------------------------
# EMAIL SETTINGS
# -----------------------------
EMAIL_BACKEND=django.core.mail.backends.smtp.EmailBackend
EMAIL_HOST=smtp.yandex.ru
EMAIL_PORT=465
EMAIL_USE_SSL=1
EMAIL_HOST_USER=no-reply@your-domain.ru
EMAIL_HOST_PASSWORD=–ø–∞—Ä–æ–ª—å_–æ—Ç_–ø–æ—á—Ç—ã

# -----------------------------
# MAP / REGION
# -----------------------------
REGION_PROFILE=RU
MAP_PROVIDER=yandex
YANDEX_MAP_API_KEY=your_yandex_maps_api_key
MAPBOX_TOKEN=your_actual_token_here


# File 4/160: .gitattributes
################################################################################

# Auto detect text files and perform LF normalization
* text=auto


# File 5/160: .gitignore
################################################################################

project_dump.txt
db.sqlite3
project_dump.txt


# File 6/160: Dockerfile
################################################################################

# Production-ready Dockerfile
FROM python:3.12-slim AS builder
ENV PYTHONUNBUFFERED=1 \
    PYTHONDONTWRITEBYTECODE=1

RUN apt-get update && apt-get install -y --no-install-recommends \
    build-essential \
    libpq-dev \
    gdal-bin \
    libgdal-dev \
    binutils \
    libproj-dev \
    libgeos-dev \
    libspatialindex-dev \
    gettext \
    curl \
    && rm -rf /var/lib/apt/lists/*

WORKDIR /app
COPY requirements.txt /app/
RUN pip install --upgrade pip && pip install -r requirements.txt
COPY . /app/

RUN python backend/manage.py collectstatic --noinput --settings=backend.settings.production || true

FROM python:3.12-slim AS runtime
ENV PYTHONUNBUFFERED=1 PYTHONDONTWRITEBYTECODE=1
WORKDIR /app

COPY --from=builder /usr/local/lib/python3.12 /usr/local/lib/python3.12
COPY --from=builder /usr/local/bin /usr/local/bin
COPY --from=builder /app /app

EXPOSE 8000
HEALTHCHECK --interval=30s --timeout=10s --retries=3 CMD curl -f http://localhost:8000/health/ || exit 1
CMD ["gunicorn", "backend.config.wsgi:application", "--bind", "0.0.0.0:8000"]


# File 7/160: README.md
################################################################################

# ParkShare Global Platform

–£–Ω–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω–Ω–∞—è –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ –¥–ª—è ParkShare —Å –ø—Ä–æ—Ñ–∏–ª—è–º–∏ RU/GLOBAL, –∑–∞—â–∏—â—ë–Ω–Ω—ã–º–∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞–º–∏ –∏ PWA —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥–æ–º.

## –ó–∞–ø—É—Å–∫
```bash
docker-compose up --build
```
ENVIRONMENT –≤—ã–±–∏—Ä–∞–µ—Ç—Å—è —á–µ—Ä–µ–∑ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è –∏ —Ñ–∞–π–ª—ã `.env.<profile>`.

–î–ª—è –ª–æ–∫–∞–ª—å–Ω–æ–π —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏ –±–µ–∑ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π PostGIS/GDAL —É—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ `USE_GIS=False` –∏ –∑–∞–¥–∞–π—Ç–µ
`DATABASE_URL=sqlite:///db.sqlite3`, —á—Ç–æ–±—ã Django –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–ª SQLite –∏ –Ω–µ —Ç—Ä–µ–±–æ–≤–∞–ª GDAL.

## –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã
- PostGIS (db)
- Redis (cache/rate limit/Celery)
- Gunicorn web (Django)
- Celery worker/beat
- Nginx –∫–∞–∫ TLS-—Ç–µ—Ä–º–∏–Ω–∞—Ç–æ—Ä

## –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å
- JWT + refresh —Ç–æ–∫–µ–Ω—ã (`/api/auth/token`, `/api/auth/token/refresh`)
- Rate limiting, CSP, HSTS, Referrer/Permissions Policy (`core/middleware.py`, `backend/settings`)
- Provider registry (`providers/`)
- –¢—Ä–∞–Ω–∑–∞–∫—Ü–∏–æ–Ω–Ω—ã–µ –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–π (`parking/views.py`)

## PWA
- –°–µ—Ä–≤–∏—Å-–≤–æ—Ä–∫–µ—Ä —Å —Ä–∞–∑–Ω—ã–º–∏ —Å—Ç—Ä–∞—Ç–µ–≥–∏—è–º–∏ –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏—è (`static/service-worker.js`)
- Offline fallback (`templates/offline.html`)

## AI
- –î–∏–Ω–∞–º–∏—á–µ—Å–∫–æ–µ —Ü–µ–Ω–æ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏–µ, —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏, CV –∏ –∞–Ω—Ç–∏—Ñ—Ä–æ–¥ (`ai/engines.py`, `services/ai.py`)

## –ü—Ä–æ–¥–∞–∫—à–µ–Ω-—Å—Ç–∞—Ä—Ç (Ubuntu/Debian)
```bash
cp .env.example .env.prod  # –∑–∞–ø–æ–ª–Ω–∏—Ç—å —Å–µ–∫—Ä–µ—Ç—ã/—Ö–æ—Å—Ç—ã
docker-compose -f docker-compose.prod.yml up -d --build
```

–î–æ–º–µ–Ω –∏ TLS –Ω–∞—Å—Ç—Ä–∞–∏–≤–∞—é—Ç—Å—è —á–µ—Ä–µ–∑ `nginx/nginx.conf` (–¥–æ–±–∞–≤—å—Ç–µ —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç—ã Let's Encrypt). ALLOWED_HOSTS –∏ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –∫–∞—Ä—Ç—ã/–ø–ª–∞—Ç–µ–∂–µ–π –±–µ—Ä—É—Ç—Å—è –∏–∑ `.env.prod`.


# File 8/160: api_server.py
################################################################################

# api_server.py
from __future__ import annotations
import datetime as dt
import re
from pathlib import Path
from typing import Any, Dict, List, Optional
import joblib
import numpy as np
import pandas as pd
from fastapi import FastAPI, HTTPException, Query
from fastapi.middleware.cors import CORSMiddleware
from pydantic import BaseModel
from database import get_connection
BASE_DIR = Path(__file__).parent
MODELS_DIR = BASE_DIR / "ai_models"
# --- –ó–∞–≥—Ä—É–∑–∫–∞ –º–æ–¥–µ–ª–µ–π ---
occ_bundle: Dict[str, Any] = joblib.load(MODELS_DIR / "occupancy_model.pkl")
OCC_PIPE = occ_bundle["pipeline"]
OCC_FEATURE_COLS = occ_bundle["feature_cols"]
NLP_PIPE = joblib.load(MODELS_DIR / "nlp_intent.pkl")
rec_bundle: Dict[str, Any] = joblib.load(MODELS_DIR / "recommender.pkl")
USER_ITEM: pd.DataFrame = rec_bundle["user_item"]
ITEM_SIM: pd.DataFrame = rec_bundle["item_sim"]
LOT_FEATURES: pd.DataFrame = rec_bundle["lot_features"]
# --- FastAPI ---
app = FastAPI(title="ParkShare Local AI", version="1.0.0")
app.add_middleware(
CORSMiddleware,
allow_origins=["*"],
allow_credentials=True,
allow_methods=["*"],
allow_headers=["*"],
)
# ---------- –°—Ö–µ–º—ã ----------
class Lot(BaseModel):
id: int
name: str
latitude: float
longitude: float
near_metro: bool
price_level: int
has_covered: bool
has_ev_charging: bool
predicted_occupancy: float
class SearchResult(BaseModel):
query: str
intent: str
time_of_day: Optional[str]
near_metro: Optional[bool]
max_price_level: Optional[int]
has_ev_charging: Optional[bool]
has_covered: Optional[bool]
lots: List[Lot]
class OccupancyPredictionResponse(BaseModel):
lot_id: int
ts: dt.datetime
predicted_occupancy: float
class Recommendation(BaseModel):
lot: Lot
score: float
class RecommendationsResponse(BaseModel):
user_id: Optional[int]
variant: str
recommendations: List[Recommendation]
# ---------- –£—Ç–∏–ª–∏—Ç—ã ----------
def parse_dt_iso(value: Optional[str]) -> dt.datetime:
if not value:
return dt.datetime.now()
try:
return dt.datetime.fromisoformat(value)
except Exception as exc:
raise HTTPException(status_code=400, detail=f"–ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç datetime: {value}") from exc
def nlp_extract_entities(text: str) -> Dict[str, Any]:
s = text.lower()
time_of_day = None
if "—É—Ç—Ä" in s:
time_of_day = "morning"
elif "–¥–Ω–µ–º" in s or "–¥–Ω—ë–º" in s:
time_of_day = "day"
elif "–≤–µ—á–µ—Ä" in s:
time_of_day = "evening"
elif "–Ω–æ—á" in s:
time_of_day = "night"
near_metro = "–º–µ—Ç—Ä–æ" in s
max_price_level: Optional[int] = None
if "–¥–µ—à–µ–≤" in s or "–Ω–µ–¥–æ—Ä–æ–≥" in s:
max_price_level = 1
elif "—Å—Ä–µ–¥–Ω" in s:
max_price_level = 2
elif "–¥–æ—Ä–æ–≥" in s:
max_price_level = 3
has_ev = "—ç–ª–µ–∫—Ç—Ä–æ" in s or "–∑–∞—Ä—è–¥–∫" in s or "ev" in s
has_covered = "–∫—Ä—ã—Ç" in s or "–ø–æ–¥–∑–µ–º" in s or "–ø–∞—Ä–∫–∏–Ω–≥" in s
return {
"time_of_day": time_of_day,
"near_metro": near_metro if near_metro else None,
"max_price_level": max_price_level,
"has_ev_charging": has_ev if has_ev else None,
"has_covered": has_covered if has_covered else None,
}
def build_occ_feature_df(lot_row: Dict[str, Any], ts: dt.datetime) -> pd.DataFrame:
return pd.DataFrame(
[
{
"hour": ts.hour,
"dow": ts.weekday(),
"temperature": 15.0,
"is_rain": 0,
"is_event": 0,
"near_metro": lot_row["near_metro"],
"price_level": lot_row["price_level"],
"has_covered": lot_row["has_covered"],
"has_ev_charging": lot_row["has_ev_charging"],
"lot_id_str": str(lot_row["id"]),
}
]
)[OCC_FEATURE_COLS]
def predict_occupancy_for_lot(lot_row: Dict[str, Any], ts: dt.datetime) -> float:
df = build_occ_feature_df(lot_row, ts)
pred = float(OCC_PIPE.predict(df)[0])
return max(0.0, min(pred, 1.0))
def fetch_lots(filters: Dict[str, Any] | None = None) -> List[Dict[str, Any]]:
conn = get_connection()
cur = conn.cursor()
base_query = """
SELECT
id, name, latitude, longitude,
near_metro, price_level, has_covered, has_ev_charging
FROM parking_lot
WHERE 1=1
"""
params: List[Any] = []
if filters:
if filters.get("near_metro") is not None:
base_query += " AND near_metro = ?"
params.append(1 if filters["near_metro"] else 0)
if filters.get("max_price_level") is not None:
base_query += " AND price_level <= ?"
params.append(int(filters["max_price_level"]))
if filters.get("has_ev_charging") is not None:
base_query += " AND has_ev_charging = ?"
params.append(1 if filters["has_ev_charging"] else 0)
if filters.get("has_covered") is not None:
base_query += " AND has_covered = ?"
params.append(1 if filters["has_covered"] else 0)
base_query += " ORDER BY price_level ASC, near_metro DESC"
cur.execute(base_query, params)
rows = [dict(r) for r in cur.fetchall()]
conn.close()
return rows
# ---------- –≠–Ω–¥–ø–æ–∏–Ω—Ç—ã ----------
@app.get("/health")
def health() -> Dict[str, Any]:
return {"status": "ok"}
@app.get("/api/lots", response_model=List[Lot])
def api_list_lots(
ts: Optional[str] = Query(default=None, description="ISO datetime, –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é ‚Äî —Å–µ–π—á–∞—Å"),
) -> List[Lot]:
dt_value = parse_dt_iso(ts)
lots = fetch_lots()
result: List[Lot] = []
for row in lots:
occ = predict_occupancy_for_lot(row, dt_value)
result.append(
Lot(
id=row["id"],
name=row["name"],
latitude=row["latitude"],
longitude=row["longitude"],
near_metro=bool(row["near_metro"]),
price_level=row["price_level"],
has_covered=bool(row["has_covered"]),
has_ev_charging=bool(row["has_ev_charging"]),
predicted_occupancy=occ,
)
)
return result
@app.get("/api/occupancy/predict", response_model=OccupancyPredictionResponse)
def api_predict_occupancy(
lot_id: int = Query(...),
ts: Optional[str] = Query(default=None),
) -> OccupancyPredictionResponse:
dt_value = parse_dt_iso(ts)
conn = get_connection()
cur = conn.cursor()
cur.execute(
"""
SELECT id, name, latitude, longitude,
near_metro, price_level, has_covered, has_ev_charging
FROM parking_lot
WHERE id = ?
""",
(lot_id,),
)
row = cur.fetchone()
conn.close()
if row is None:
raise HTTPException(status_code=404, detail="–ü–∞—Ä–∫–æ–≤–∫–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞")
d = dict(row)
occ = predict_occupancy_for_lot(d, dt_value)
return OccupancyPredictionResponse(
lot_id=lot_id,
ts=dt_value,
predicted_occupancy=occ,
)
@app.get("/api/search", response_model=SearchResult)
def api_search(
query: str = Query(..., min_length=1),
ts: Optional[str] = Query(default=None),
limit: int = Query(default=15, ge=1, le=100),
) -> SearchResult:
dt_value = parse_dt_iso(ts)
intent = NLP_PIPE.predict([query])[0]
entities = nlp_extract_entities(query)
filters: Dict[str, Any] = {}
if entities["near_metro"]:
filters["near_metro"] = True
if entities["max_price_level"] is not None:
filters["max_price_level"] = entities["max_price_level"]
if entities["has_ev_charging"] is not None:
filters["has_ev_charging"] = entities["has_ev_charging"]
if entities["has_covered"] is not None:
filters["has_covered"] = entities["has_covered"]
if intent == "near_metro":
filters["near_metro"] = True
if intent == "cheap" and "max_price_level" not in filters:
filters["max_price_level"] = 1
lots = fetch_lots(filters)
lots = lots[:limit]
lot_models: List[Lot] = []
for row in lots:
occ = predict_occupancy_for_lot(row, dt_value)
lot_models.append(
Lot(
id=row["id"],
name=row["name"],
latitude=row["latitude"],
longitude=row["longitude"],
near_metro=bool(row["near_metro"]),
price_level=row["price_level"],
has_covered=bool(row["has_covered"]),
has_ev_charging=bool(row["has_ev_charging"]),
predicted_occupancy=occ,
)
)
return SearchResult(
query=query,
intent=intent,
time_of_day=entities["time_of_day"],
near_metro=filters.get("near_metro"),
max_price_level=filters.get("max_price_level"),
has_ev_charging=filters.get("has_ev_charging"),
has_covered=filters.get("has_covered"),
lots=lot_models,
)
def _recommend_item_based(user_id: int, top_n: int = 10) -> List[int]:
if user_id not in USER_ITEM.index:
return []
user_ratings = USER_ITEM.loc[user_id]
rated_items = user_ratings[user_ratings > 0].index.tolist()
if not rated_items:
return []
scores = pd.Series(0.0, index=USER_ITEM.columns)
for item_id in rated_items:
sim_vec = ITEM_SIM.loc[item_id]
scores += sim_vec * float(user_ratings[item_id])
scores = scores.drop(rated_items)
scores = scores.sort_values(ascending=False)
return scores.head(top_n).index.tolist()
def _recommend_content_based(top_n: int = 10) -> List[int]:
df = LOT_FEATURES.copy()
df["score"] = 0.0
df["score"] += (1 - (df["price_level"] - 1) / 2)
df["score"] += df["near_metro"] * 0.5
df["score"] += df["has_ev_charging"] * 0.3
df["score"] += df["has_covered"] * 0.2
df = df.sort_values("score", ascending=False)
return df.head(top_n).index.tolist()
@app.get("/api/recommendations", response_model=RecommendationsResponse)
def api_recommendations(
user_id: Optional[int] = Query(default=None),
variant: Optional[str] = Query(
default=None,
description="A –∏–ª–∏ B ‚Äî –¥–ª—è A/B —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è (A=collab, B=content)",
),
limit: int = Query(default=10, ge=1, le=50),
ts: Optional[str] = Query(default=None),
) -> RecommendationsResponse:
dt_value = parse_dt_iso(ts)
chosen_variant = variant or ("A" if user_id else "B")
if chosen_variant == "A" and user_id is not None:
item_ids = _recommend_item_based(user_id, top_n=limit)
if not item_ids:
chosen_variant = "B"
if chosen_variant == "B" or user_id is None:
item_ids = _recommend_content_based(top_n=limit)
conn = get_connection()
cur = conn.cursor()
cur.execute(
f"""
SELECT id, name, latitude, longitude,
near_metro, price_level, has_covered, has_ev_charging
FROM parking_lot
WHERE id IN ({",".join(["?"] * len(item_ids))})
""",
item_ids,
)
rows = {r["id"]: dict(r) for r in cur.fetchall()}
conn.close()
recs: List[Recommendation] = []
for lot_id in item_ids:
row = rows.get(lot_id)
if not row:
continue
occ = predict_occupancy_for_lot(row, dt_value)
lot = Lot(
id=row["id"],
name=row["name"],
latitude=row["latitude"],
longitude=row["longitude"],
near_metro=bool(row["near_metro"]),
price_level=row["price_level"],
has_covered=bool(row["has_covered"]),
has_ev_charging=bool(row["has_ev_charging"]),
predicted_occupancy=occ,
)
# –ø—Ä–æ—Å—Ç–∞—è –º–µ—Ç—Ä–∏–∫–∞: –æ–±—Ä–∞—Ç–Ω–∞—è –∑–∞–Ω—è—Ç–æ—Å—Ç—å + –±–æ–Ω—É—Å –∑–∞ –º–µ—Ç—Ä–æ –∏ —Ü–µ–Ω—É
score = (1.0 - occ) + (1 - (row["price_level"] - 1) / 2) + (0.3 if row["near_metro"] else 0.0)
recs.append(Recommendation(lot=lot, score=float(score)))
return RecommendationsResponse(
user_id=user_id,
variant=chosen_variant,
recommendations=recs,
)

# File 9/160: app.js
################################################################################

const API_BASE = "http:
let map;
let markersLayer;
let lotsCache = [];
let lotsById = new Map();
function pickBestLot(lots) {
if (!lots || lots.length === 0) return null;
const ranked = [...lots].sort((a, b) => {
const occA = a.predicted_occupancy ?? 1;
const occB = b.predicted_occupancy ?? 1;
return occA - occB;
});
return ranked[0];
}
function updateAIOracleCard(lots) {
const nameEl = document.getElementById("aiOracleName");
const etaEl = document.getElementById("aiOracleETA");
const confEl = document.getElementById("aiOracleConfidence");
const metaEl = document.getElementById("aiOracleMeta");
const reasoningEl = document.getElementById("aiOracleReason");
if (!nameEl || !etaEl || !confEl || !metaEl || !reasoningEl) return;
if (!lots || lots.length === 0) {
nameEl.textContent = "‚Äî";
etaEl.textContent = "‚Äî";
confEl.textContent = "‚Äî";
metaEl.textContent = "‚Äî";
reasoningEl.textContent = "AI –≥–æ—Ç–æ–≤–∏—Ç –∏–Ω—Å–∞–π—Ç‚Ä¶";
return;
}
const bestLot = pickBestLot(lots);
if (!bestLot) return;
const occ = bestLot.predicted_occupancy ?? 0;
const occPercent = Math.round(occ * 100);
const eta = Math.max(2, Math.min(15, Math.round((1 - occ) * 12)));
const confidence = Math.max(68, Math.min(99, 96 - Math.round(occPercent / 2)));
const ev = bestLot.has_ev_charging ? "EV" : "–æ–±—ã—á–Ω–∞—è";
const covered = bestLot.has_covered ? "–∫—Ä—ã—Ç–∞—è" : "–æ—Ç–∫—Ä—ã—Ç–∞—è";
nameEl.textContent = bestLot.name;
etaEl.textContent = `${eta} –º–∏–Ω`;
confEl.textContent = `${confidence}%`;
metaEl.textContent = `${ev} ¬∑ ${covered}`;
reasoningEl.textContent =
"–£—á–∏—Ç—ã–≤–∞—è –≤–∞—à—É –∏—Å—Ç–æ—Ä–∏—é: –±—ã—Å—Ç—Ä—ã–π –≤—ã–µ–∑–¥, EV –∏ –±–ª–∏–∑–æ—Å—Ç—å –∫ –º–µ—Ç—Ä–æ ‚Äî —ç—Ç–æ—Ç —Å–ª–æ—Ç –¥–∞—Å—Ç –Ω–∞–∏–≤—ã—Å—à–∏–π WOW-—ç—Ñ—Ñ–µ–∫—Ç.";
}
function occupancyColor(value) {
if (value <= 0.4) return "
if (value <= 0.7) return "
return "
}
function initMap() {
map = L.map("map", {
zoomControl: true,
attributionControl: false,
}).setView([55.7558, 37.6173], 12);
L.tileLayer("https:
maxZoom: 19,
}).addTo(map);
markersLayer = L.layerGroup().addTo(map);
}
async function apiGet(path, params = {}) {
const url = new URL(API_BASE + path);
Object.entries(params).forEach(([k, v]) => {
if (v !== undefined && v !== null) {
url.searchParams.set(k, v);
}
});
const res = await fetch(url.toString());
if (!res.ok) {
const text = await res.text();
throw new Error(`API error ${res.status}: ${text}`);
}
return res.json();
}
function renderLotsOnMap(lots) {
markersLayer.clearLayers();
lots.forEach((lot) => {
const occ = lot.predicted_occupancy ?? 0;
const color = occupancyColor(occ);
const marker = L.circleMarker([lot.latitude, lot.longitude], {
radius: 8,
fillColor: color,
fillOpacity: 0.9,
color: "
weight: 1,
});
const occPercent = Math.round(occ * 100);
const html = `
<div style="font-size: 12px;">
<strong>${lot.name}</strong><br />
–ó–∞–≥—Ä—É–∑–∫–∞: <strong>${occPercent}%</strong><br />
–ú–µ—Ç—Ä–æ: ${lot.near_metro ? "—Ä—è–¥–æ–º" : "–Ω–µ—Ç"}<br />
–£—Ä–æ–≤–µ–Ω—å —Ü–µ–Ω—ã: ${lot.price_level}<br />
–ö—Ä—ã—Ç–∞—è: ${lot.has_covered ? "–¥–∞" : "–Ω–µ—Ç"}<br />
–ó–∞—Ä—è–¥–∫–∞ EV: ${lot.has_ev_charging ? "–µ—Å—Ç—å" : "–Ω–µ—Ç"}
</div>
`;
marker.bindPopup(html);
marker.addTo(markersLayer);
});
if (lots.length > 0) {
const bounds = L.latLngBounds(
lots.map((lot) => [lot.latitude, lot.longitude])
);
map.fitBounds(bounds.pad(0.2));
}
}
function renderLotsList(containerId, lots, clickHandler) {
const container = document.getElementById(containerId);
container.innerHTML = "";
if (!lots || lots.length === 0) {
container.innerHTML =
'<div style="font-size: 0.75rem; color:
return;
}
lots.forEach((lot) => {
const occ = lot.predicted_occupancy ?? 0;
const occPercent = Math.round(occ * 100);
const div = document.createElement("div");
div.className = "lot-item";
div.innerHTML = `
<div class="lot-main">
<div class="lot-name">${lot.name}</div>
<div class="lot-meta">
<span>–¶–µ–Ω–∞: L${lot.price_level}</span>
<span>–ú–µ—Ç—Ä–æ: ${lot.near_metro ? "—Ä—è–¥–æ–º" : "–Ω–µ—Ç"}</span>
<span>EV: ${lot.has_ev_charging ? "–µ—Å—Ç—å" : "–Ω–µ—Ç"}</span>
<span>–ö—Ä—ã—Ç–∞—è: ${lot.has_covered ? "–¥–∞" : "–Ω–µ—Ç"}</span>
</div>
</div>
<div class="lot-occ">${occPercent}%</div>
`;
div.addEventListener("click", () => clickHandler(lot));
container.appendChild(div);
});
}
async function loadAllLots() {
const status = document.getElementById("statusText");
try {
const lots = await apiGet("/api/lots");
lotsCache = lots;
lotsById.clear();
lots.forEach((lot) => lotsById.set(lot.id, lot));
renderLotsOnMap(lots);
renderLotsList("lotsList", lots, (lot) => {
map.setView([lot.latitude, lot.longitude], 16);
});
updateAIOracleCard(lots);
status.textContent = "AI-—Å–µ—Ä–≤–µ—Ä –ø–æ–¥–∫–ª—é—á—ë–Ω";
} catch (err) {
console.error(err);
status.textContent = "–û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ AI-—Å–µ—Ä–≤–µ—Ä—É";
}
}
async function handleSearch() {
const input = document.getElementById("searchInput");
const status = document.getElementById("searchStatus");
const text = input.value.trim();
if (!text) return;
status.textContent = "–û–±—Ä–∞–±–∞—Ç—ã–≤–∞—é –∑–∞–ø—Ä–æ—Å (–ª–æ–∫–∞–ª—å–Ω—ã–π NLP)‚Ä¶";
try {
const data = await apiGet("/api/search", { query: text });
const lots = data.lots || [];
renderLotsOnMap(lots);
renderLotsList("lotsList", lots, (lot) => {
map.setView([lot.latitude, lot.longitude], 16);
});
updateAIOracleCard(lots);
const parts = [];
parts.push(`–ò–Ω—Ç–µ–Ω—Ç: ${data.intent}`);
if (data.near_metro !== null) {
parts.push(`—Ä—è–¥–æ–º —Å –º–µ—Ç—Ä–æ: ${data.near_metro ? "–¥–∞" : "–Ω–µ—Ç"}`);
}
if (data.max_price_level !== null) {
parts.push(`–º–∞–∫—Å. —É—Ä–æ–≤–µ–Ω—å —Ü–µ–Ω—ã: L${data.max_price_level}`);
}
if (data.has_ev_charging !== null) {
parts.push(`EV: ${data.has_ev_charging ? "–Ω—É–∂–Ω–∞" : "–Ω–µ –Ω—É–∂–Ω–∞"}`);
}
if (data.has_covered !== null) {
parts.push(`–∫—Ä—ã—Ç–∞—è: ${data.has_covered ? "–Ω—É–∂–Ω–∞" : "–Ω–µ –Ω—É–∂–Ω–∞"}`);
}
if (data.time_of_day) {
parts.push(`–≤—Ä–µ–º—è —Å—É—Ç–æ–∫: ${data.time_of_day}`);
}
status.textContent = parts.join(" ¬∑ ") || "–§–∏–ª—å—Ç—Ä—ã –Ω–µ —Ä–∞—Å–ø–æ–∑–Ω–∞–Ω—ã.";
} catch (err) {
console.error(err);
status.textContent = "–û—à–∏–±–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –∑–∞–ø—Ä–æ—Å–∞";
}
}
async function initUsersSelect() {
const select = document.getElementById("userSelect");
for (let i = 1; i <= 20; i++) {
const opt = document.createElement("option");
opt.value = String(i);
opt.textContent = `–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å
select.appendChild(opt);
}
}
async function handleRecommendations(variant) {
const select = document.getElementById("userSelect");
const status = document.getElementById("recStatus");
const listContainerId = "recList";
const userId = parseInt(select.value, 10) || undefined;
status.textContent =
variant === "A"
? "–†–∞—Å—Å—á–∏—Ç—ã–≤–∞—é —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ (collaborative)‚Ä¶"
: "–†–∞—Å—Å—á–∏—Ç—ã–≤–∞—é —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ (content-based)‚Ä¶";
try {
const params = { limit: 10, variant };
if (variant === "A" && userId) {
params.user_id = userId;
}
const data = await apiGet("/api/recommendations", params);
const recs = data.recommendations || [];
const lots = recs.map((r) => r.lot);
renderLotsOnMap(lots);
renderLotsList(listContainerId, lots, (lot) => {
map.setView([lot.latitude, lot.longitude], 16);
});
updateAIOracleCard(lots);
status.textContent = `–í–∞—Ä–∏–∞–Ω—Ç ${data.variant}, –ø–æ–ª—É—á–µ–Ω–æ ${recs.length} —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–π.`;
} catch (err) {
console.error(err);
status.textContent = "–û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–π";
}
}
window.addEventListener("DOMContentLoaded", async () => {
initMap();
await initUsersSelect();
await loadAllLots();
document
.getElementById("searchBtn")
.addEventListener("click", () => handleSearch());
document
.getElementById("searchInput")
.addEventListener("keydown", (e) => {
if (e.key === "Enter") {
handleSearch();
}
});
document.getElementById("recBtn").addEventListener("click", () => {
handleRecommendations("A");
});
document
.getElementById("recContentBtn")
.addEventListener("click", () => {
handleRecommendations("B");
});
});

# File 10/160: database.py
################################################################################

# database.py
from __future__ import annotations
import random
import sqlite3
from dataclasses import dataclass
from datetime import datetime, timedelta
from pathlib import Path
from typing import List
DB_PATH = Path(__file__).parent / "ai_data.db"
def get_connection() -> sqlite3.Connection:
conn = sqlite3.connect(DB_PATH)
conn.row_factory = sqlite3.Row
return conn
def init_db() -> None:
conn = get_connection()
cur = conn.cursor()
cur.execute(
"""
CREATE TABLE IF NOT EXISTS parking_lot (
id INTEGER PRIMARY KEY AUTOINCREMENT,
name TEXT NOT NULL,
latitude REAL NOT NULL,
longitude REAL NOT NULL,
near_metro INTEGER NOT NULL,
price_level INTEGER NOT NULL,
has_covered INTEGER NOT NULL,
has_ev_charging INTEGER NOT NULL
);
"""
)
cur.execute(
"""
CREATE TABLE IF NOT EXISTS occupancy_history (
id INTEGER PRIMARY KEY AUTOINCREMENT,
lot_id INTEGER NOT NULL,
ts TEXT NOT NULL,
occupancy REAL NOT NULL,
temperature REAL NOT NULL,
is_rain INTEGER NOT NULL,
is_event INTEGER NOT NULL,
FOREIGN KEY (lot_id) REFERENCES parking_lot(id)
);
"""
)
cur.execute(
"""
CREATE TABLE IF NOT EXISTS app_user (
id INTEGER PRIMARY KEY AUTOINCREMENT,
name TEXT NOT NULL
);
"""
)
cur.execute(
"""
CREATE TABLE IF NOT EXISTS user_rating (
id INTEGER PRIMARY KEY AUTOINCREMENT,
user_id INTEGER NOT NULL,
lot_id INTEGER NOT NULL,
rating REAL NOT NULL,
FOREIGN KEY (user_id) REFERENCES app_user(id),
FOREIGN KEY (lot_id) REFERENCES parking_lot(id)
);
"""
)
conn.commit()
conn.close()
@dataclass
class LotSpec:
name: str
base_lat: float
base_lon: float
near_metro: int
price_level: int
has_covered: int
has_ev_charging: int
def generate_synthetic_data(
num_lots: int = 30,
num_users: int = 50,
days_back: int = 30,
) -> None:
"""
–ì–µ–Ω–µ—Ä–∞—Ü–∏—è —Å–∏–Ω—Ç–µ—Ç–∏—á–µ—Å–∫–∏—Ö:
- –ø–∞—Ä–∫–æ–≤–æ–∫
- –∏—Å—Ç–æ—Ä–∏–∏ –∑–∞–Ω—è—Ç–æ—Å—Ç–∏
- –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
- –æ—Ü–µ–Ω–æ–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
"""
random.seed(42)
conn = get_connection()
cur = conn.cursor()
# –ß–∏—Å—Ç–∏–º —Å—Ç–∞—Ä—ã–µ –¥–∞–Ω–Ω—ã–µ
cur.execute("DELETE FROM user_rating;")
cur.execute("DELETE FROM app_user;")
cur.execute("DELETE FROM occupancy_history;")
cur.execute("DELETE FROM parking_lot;")
conn.commit()
# –ë–∞–∑–æ–≤—ã–µ —Ç–æ—á–∫–∏ –≤–æ–∫—Ä—É–≥ –ú–æ—Å–∫–≤—ã
center_lat, center_lon = 55.7558, 37.6173
lots: List[int] = []
for i in range(num_lots):
near_metro = 1 if random.random() < 0.5 else 0
price_level = random.choice([1, 2, 3])
has_covered = 1 if random.random() < 0.4 else 0
has_ev = 1 if random.random() < 0.3 else 0
# –ù–µ–º–Ω–æ–≥–æ —Ä–∞—Å–∫–∏–¥—ã–≤–∞–µ–º —Ç–æ—á–∫–∏ –≤–æ–∫—Ä—É–≥ —Ü–µ–Ω—Ç—Ä–∞
lat = center_lat + random.uniform(-0.05, 0.05)
lon = center_lon + random.uniform(-0.1, 0.1)
cur.execute(
"""
INSERT INTO parking_lot (
name, latitude, longitude, near_metro,
price_level, has_covered, has_ev_charging
) VALUES (?, ?, ?, ?, ?, ?, ?)
""",
(
f"–õ–æ—Ç
lat,
lon,
near_metro,
price_level,
has_covered,
has_ev,
),
)
lots.append(cur.lastrowid)
# –ò—Å—Ç–æ—Ä–∏—è –∑–∞–Ω—è—Ç–æ—Å—Ç–∏ ‚Äî –∫–∞–∂–¥—ã–µ 2 —á–∞—Å–∞ –∑–∞ days_back –¥–Ω–µ–π
now = datetime.now()
start_ts = now - timedelta(days=days_back)
weather_states = ["sunny", "cloudy", "rainy"]
for lot_id in lots:
ts = start_ts
while ts < now:
dow = ts.weekday()
hour = ts.hour
is_event = 1 if (dow in (4, 5) and hour >= 18 and random.random() < 0.3) else 0
weather = random.choice(weather_states)
is_rain = 1 if weather == "rainy" else 0
temperature = random.uniform(-10, 30)
# –ë–∞–∑–æ–≤–∞—è –∑–∞–Ω—è—Ç–æ—Å—Ç—å –∑–∞–≤–∏—Å–∏—Ç –æ—Ç —á–∞—Å–∞ –∏ –¥–Ω—è –Ω–µ–¥–µ–ª–∏
base_occ = 0.2
if 8 <= hour <= 11:
base_occ = 0.6
elif 17 <= hour <= 20:
base_occ = 0.7
elif 0 <= hour <= 5:
base_occ = 0.1
if dow >= 5:
base_occ += 0.1
if is_event:
base_occ += 0.2
if is_rain:
base_occ += 0.1
base_occ = max(0.0, min(base_occ + random.uniform(-0.1, 0.1), 1.0))
cur.execute(
"""
INSERT INTO occupancy_history (
lot_id, ts, occupancy, temperature, is_rain, is_event
) VALUES (?, ?, ?, ?, ?, ?)
""",
(
lot_id,
ts.isoformat(),
base_occ,
temperature,
is_rain,
is_event,
),
)
ts += timedelta(hours=2)
# –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏
users = []
for i in range(num_users):
cur.execute(
"INSERT INTO app_user (name) VALUES (?);",
(f"user_{i+1}",),
)
users.append(cur.lastrowid)
# –û—Ü–µ–Ω–∫–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –ø–∞—Ä–∫–æ–≤–æ–∫
for user_id in users:
# –ö–∞–∂–¥—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –æ—Ü–µ–Ω–∏—Ç 5‚Äì15 –ø–∞—Ä–∫–æ–≤–æ–∫
k = random.randint(5, min(15, len(lots)))
rated_lots = random.sample(lots, k)
for lot_id in rated_lots:
# –†–µ–π—Ç–∏–Ω–≥ –∑–∞–≤–∏—Å–∏—Ç –æ—Ç price_level –∏ —Å–ª—É—á–∞–π–Ω–æ—Å—Ç–∏
base_rating = 4.5 - 0.5 * (random.randint(1, 3) - 1)
rating = max(1.0, min(5.0, base_rating + random.uniform(-1.0, 1.0)))
cur.execute(
"""
INSERT INTO user_rating (user_id, lot_id, rating)
VALUES (?, ?, ?)
""",
(user_id, lot_id, rating),
)
conn.commit()
conn.close()
print("–°–∏–Ω—Ç–µ—Ç–∏—á–µ—Å–∫–∏–µ –¥–∞–Ω–Ω—ã–µ —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω—ã –≤", DB_PATH)
if __name__ == "__main__":
init_db()
generate_synthetic_data()

# File 11/160: docker-compose.prod.yml
################################################################################

version: "3.9"

services:
  db:
    image: postgis/postgis:16-3.4
    restart: always
    environment:
      POSTGRES_DB: parkshare
      POSTGRES_USER: parkshare
      POSTGRES_PASSWORD: ${DB_PASSWORD:-change_me}
    volumes:
      - postgres_data:/var/lib/postgresql/data
    networks:
      - parkshare_net

  redis:
    image: redis:7-alpine
    restart: always
    networks:
      - parkshare_net

  web:
    build:
      context: .
      dockerfile: Dockerfile
    restart: always
    env_file:
      - .env.prod
    command: gunicorn backend.config.wsgi:application --bind 0.0.0.0:8000
    volumes:
      - static_volume:/app/staticfiles
      - media_volume:/app/media
    depends_on:
      - db
      - redis
    networks:
      - parkshare_net

  worker:
    build:
      context: .
      dockerfile: Dockerfile
    restart: always
    env_file:
      - .env.prod
    command: celery -A backend.config worker -l info
    depends_on:
      - db
      - redis
    networks:
      - parkshare_net

  beat:
    build:
      context: .
      dockerfile: Dockerfile
    restart: always
    env_file:
      - .env.prod
    command: celery -A backend.config beat -l info
    depends_on:
      - db
      - redis
    networks:
      - parkshare_net

  nginx:
    image: nginx:1.27-alpine
    restart: always
    ports:
      - "80:80"
    volumes:
      - ./nginx/nginx.conf:/etc/nginx/nginx.conf:ro
      - static_volume:/static
      - media_volume:/media
    depends_on:
      - web
    networks:
      - parkshare_net

volumes:
  postgres_data:
  static_volume:
  media_volume:

networks:
  parkshare_net:
    driver: bridge


# File 12/160: docker-compose.yml
################################################################################

version: "3.9"

services:
  db:
    image: postgis/postgis:16-3.4
    container_name: parkshare_db
    restart: always
    environment:
      POSTGRES_DB: parkshare
      POSTGRES_USER: parkshare
      POSTGRES_PASSWORD: parkshare
    volumes:
      - postgres_data:/var/lib/postgresql/data
    networks:
      - parkshare_net

  redis:
    image: redis:7-alpine
    container_name: parkshare_redis
    restart: always
    networks:
      - parkshare_net

  web:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: parkshare_web
    restart: always
    env_file:
      - .env  # –º–æ–∂–Ω–æ –ø–æ—Ç–æ–º –∑–∞–º–µ–Ω–∏—Ç—å –Ω–∞ .env.prod
    command: /app/entrypoint.sh
    volumes:
      - .:/app
      - static_volume:/app/staticfiles
      - media_volume:/app/media
    depends_on:
      - db
      - redis
    networks:
      - parkshare_net

  worker:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: parkshare_worker
    restart: always
    env_file:
      - .env
    command: celery -A backend.config worker -l info
    volumes:
      - .:/app
    depends_on:
      - db
      - redis
    networks:
      - parkshare_net

  beat:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: parkshare_beat
    restart: always
    env_file:
      - .env
    command: celery -A backend.config beat -l info
    volumes:
      - .:/app
    depends_on:
      - db
      - redis
    networks:
      - parkshare_net

  ai_pricing_service:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: parkshare_ai_pricing
    restart: always
    env_file:
      - .env
    command: uvicorn ai_services.ai_pricing_service.main:app --host 0.0.0.0 --port 8100
    depends_on:
      - redis
    networks:
      - parkshare_net

  llm_service:
    build:
      context: .
      dockerfile: services/llm_service/Dockerfile
    container_name: parkshare_llm_service
    restart: always
    env_file:
      - .env
    ports:
      - "8002:8002"
    networks:
      - parkshare_net

  cv_service:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: parkshare_cv_service
    restart: always
    env_file:
      - .env
    command: uvicorn ai_services.cv_service.main:app --host 0.0.0.0 --port 8200
    depends_on:
      - redis
    networks:
      - parkshare_net

  nginx:
    image: nginx:alpine
    container_name: parkshare_nginx
    restart: always
    ports:
      - "80:80"
    volumes:
      - ./nginx/nginx.conf:/etc/nginx/nginx.conf:ro
      - static_volume:/static
      - media_volume:/media
    depends_on:
      - web
    networks:
      - parkshare_net

volumes:
  postgres_data:
  static_volume:
  media_volume:

networks:
  parkshare_net:
    driver: bridge


# File 13/160: dump_project.py
################################################################################

import os
import re
from datetime import datetime
# –ö–∞–∫–∏–µ –ø–∞–ø–∫–∏ –∏–≥–Ω–æ—Ä–∏—Ä–æ–≤–∞—Ç—å (—Ä–∞—Å—à–∏—Ä–µ–Ω–Ω—ã–π —Å–ø–∏—Å–æ–∫)
EXCLUDED_DIRS = {
".git", ".venv", "venv", "__pycache__", "node_modules",
"dist", "build", "staticfiles", "media", ".idea", ".vscode",
"ai_models",
"static/icons",
"logs", "cache", "temp",
}
# –ö–∞–∫–∏–µ —Ä–∞—Å—à–∏—Ä–µ–Ω–∏—è —Ñ–∞–π–ª–æ–≤ –ø—Ä–æ–ø—É—Å–∫–∞—Ç—å (—Ä–∞—Å—à–∏—Ä–µ–Ω–Ω—ã–π —Å–ø–∏—Å–æ–∫)
IGNORED_EXTENSIONS = {
".pyc", ".pyo", ".pyd", ".sqlite3", ".sqlite", ".db",
".png", ".jpg", ".jpeg", ".gif", ".ico", ".svg", ".webp",
".pdf", ".zip", ".rar", ".7z", ".tar", ".gz",
".exe", ".dll", ".so", ".pkl", ".h5", ".model", ".pt",
".mp4", ".mp3", ".wav", ".avi", ".mov",
".log", ".tmp", ".cache",
}
# –§–∞–π–ª—ã, –∫–æ—Ç–æ—Ä—ã–µ –Ω—É–∂–Ω–æ –ø–æ–ª–Ω–æ—Å—Ç—å—é –∏–≥–Ω–æ—Ä–∏—Ä–æ–≤–∞—Ç—å
EXCLUDED_FILES = {
"CODEX_LOG1.txt", "CODEX__LOGS.txt",
"package-lock.json", "yarn.lock",
}
# –ú–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π —Ä–∞–∑–º–µ—Ä —Ñ–∞–π–ª–∞ –¥–ª—è –≤–∫–ª—é—á–µ–Ω–∏—è –≤ –¥–∞–º–ø (–≤ –±–∞–π—Ç–∞—Ö)
MAX_FILE_SIZE = 500 * 1024
# –°–∂–∞—Ç–∏–µ –∫–æ–¥–∞: —É–¥–∞–ª–µ–Ω–∏–µ –ª–∏—à–Ω–∏—Ö –ø—Ä–æ–±–µ–ª–æ–≤ –∏ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π
COMPRESS_CODE = True
def is_binary_file(filename: str) -> bool:
_, ext = os.path.splitext(filename.lower())
return ext in IGNORED_EXTENSIONS
def should_exclude_file(filename: str) -> bool:
"""–ü—Ä–æ–≤–µ—Ä—è–µ—Ç, –Ω—É–∂–Ω–æ –ª–∏ –∏—Å–∫–ª—é—á–∏—Ç—å —Ñ–∞–π–ª"""
return filename in EXCLUDED_FILES
def compress_content(content: str, filepath: str) -> str:
"""–°–∂–∏–º–∞–µ—Ç —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ —Ñ–∞–π–ª–∞ (—É–¥–∞–ª—è–µ—Ç –ª–∏—à–Ω–∏–µ –ø—Ä–æ–±–µ–ª—ã –∏ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏)"""
if not COMPRESS_CODE:
return content
_, ext = os.path.splitext(filepath.lower())
if ext in {'.py', '.js', '.css', '.html', '.ts'}:
# –£–¥–∞–ª—è–µ–º –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏ –∏ –ª–∏—à–Ω–∏–µ –ø—Ä–æ–±–µ–ª—ã
lines = []
in_multiline_comment = False
for line in content.split('\n'):
# –û–±—Ä–∞–±–æ—Ç–∫–∞ –º–Ω–æ–≥–æ—Å—Ç—Ä–æ—á–Ω—ã—Ö –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤
if in_multiline_comment:
if '*/' in line:
line = line.split('*/', 1)[1]
in_multiline_comment = False
else:
continue
# –£–¥–∞–ª—è–µ–º –æ–¥–Ω–æ—Å—Ç—Ä–æ—á–Ω—ã–µ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏
if '
line = line.split('
if '
line = line.split('
# –û–±—Ä–∞–±–æ—Ç–∫–∞ –º–Ω–æ–≥–æ—Å—Ç—Ä–æ—á–Ω—ã—Ö –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤ –¥–ª—è CSS/JS
if '
' in line:
line = line.split('')[1]
else:
line = line.split('

# File 14/160: entrypoint.sh
################################################################################

#!/bin/sh
set -e

# –ï—Å–ª–∏ DJANGO_SETTINGS_MODULE –Ω–µ –∑–∞–¥–∞–Ω, –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é —Å—á–∏—Ç–∞–µ–º, —á—Ç–æ —ç—Ç–æ –ø—Ä–æ–¥.
: "${DJANGO_SETTINGS_MODULE:=backend.settings.production}"
export DJANGO_SETTINGS_MODULE

echo "Using DJANGO_SETTINGS_MODULE=${DJANGO_SETTINGS_MODULE}"

# –ú–∏–≥—Ä–∞—Ü–∏–∏
python backend/manage.py migrate --noinput

# –°–±–æ—Ä —Å—Ç–∞—Ç–∏–∫–∏
python backend/manage.py collectstatic --noinput

# –ó–∞–ø—É—Å–∫ gunicorn
exec gunicorn backend.config.wsgi:application \
    --bind 0.0.0.0:8000 \
    --workers "${GUNICORN_WORKERS:-3}" \
    --timeout "${GUNICORN_TIMEOUT:-60}"


# File 15/160: index.html
################################################################################

<!-- index.html -->
<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8" />
<title>ParkShare AI Map</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<!-- Leaflet -->
<link
rel="stylesheet"
href="https:
integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
crossorigin=""
/>
<link rel="stylesheet" href="./static/css/cinematic-ui.css" />
<style>
:root {
--primary:
--bg:
--bg-card:
--text:
--accent:
--danger:
--warning:
}
* {
box-sizing: border-box;
}
body {
margin: 0;
font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI",
sans-serif;
background: radial-gradient(circle at top,
color: var(--text);
height: 100vh;
display: flex;
flex-direction: column;
}
header {
padding: 0.75rem 1rem;
display: flex;
align-items: center;
justify-content: space-between;
background: rgba(15, 23, 42, 0.9);
backdrop-filter: blur(12px);
border-bottom: 1px solid rgba(148, 163, 184, 0.2);
z-index: 1000;
position: sticky;
top: 0;
}
header h1 {
font-size: 1.1rem;
margin: 0;
display: flex;
align-items: center;
gap: 0.4rem;
}
.badge {
font-size: 0.7rem;
padding: 0.1rem 0.4rem;
border-radius: 999px;
border: 1px solid rgba(148, 163, 184, 0.5);
text-transform: uppercase;
letter-spacing: 0.08em;
}
.header-meta {
display: flex;
align-items: center;
gap: 0.75rem;
}
main {
flex: 1;
display: grid;
grid-template-columns: minmax(0, 2.2fr) minmax(0, 1.3fr);
min-height: 0;
}
#map {
width: 100%;
height: 100%;
}
.sidebar {
border-left: 1px solid rgba(148, 163, 184, 0.2);
background: radial-gradient(circle at top,
padding: 0.75rem;
display: flex;
flex-direction: column;
gap: 0.75rem;
min-width: 280px;
max-width: 480px;
}
.card {
background: rgba(15, 23, 42, 0.98);
border-radius: 0.9rem;
border: 1px solid rgba(148, 163, 184, 0.25);
padding: 0.75rem 0.8rem;
box-shadow: 0 18px 45px rgba(15, 23, 42, 0.6);
}
.card-title {
font-size: 0.9rem;
font-weight: 600;
margin-bottom: 0.4rem;
display: flex;
align-items: center;
justify-content: space-between;
}
.input-row {
display: flex;
gap: 0.4rem;
margin-top: 0.3rem;
}
input[type="text"],
select {
flex: 1;
padding: 0.4rem 0.5rem;
border-radius: 999px;
border: 1px solid rgba(148, 163, 184, 0.5);
background: rgba(15, 23, 42, 0.9);
color: var(--text);
font-size: 0.85rem;
outline: none;
}
input::placeholder {
color: rgba(148, 163, 184, 0.9);
}
button {
border-radius: 999px;
border: none;
padding: 0.45rem 0.9rem;
font-size: 0.8rem;
font-weight: 500;
cursor: pointer;
background: linear-gradient(135deg,
color:
display: inline-flex;
align-items: center;
gap: 0.35rem;
white-space: nowrap;
}
button.secondary {
background: rgba(15, 23, 42, 0.9);
border: 1px solid rgba(148, 163, 184, 0.6);
color: rgba(209, 213, 219, 0.95);
}
.pill {
font-size: 0.72rem;
border-radius: 999px;
padding: 0.16rem 0.5rem;
border: 1px solid rgba(148, 163, 184, 0.4);
display: inline-flex;
align-items: center;
gap: 0.3rem;
color: rgba(209, 213, 219, 0.95);
}
.pill-dot {
width: 0.55rem;
height: 0.55rem;
border-radius: 999px;
}
.pill-dot.green {
background: var(--accent);
}
.pill-dot.yellow {
background: var(--warning);
}
.pill-dot.red {
background: var(--danger);
}
.lots-list {
max-height: 220px;
overflow-y: auto;
margin-top: 0.4rem;
padding-right: 0.2rem;
}
.lot-item {
display: flex;
justify-content: space-between;
align-items: center;
padding: 0.4rem 0.2rem;
border-bottom: 1px solid rgba(31, 41, 55, 0.9);
cursor: pointer;
}
.lot-item:last-child {
border-bottom: none;
}
.lot-main {
display: flex;
flex-direction: column;
gap: 0.1rem;
font-size: 0.75rem;
}
.lot-name {
font-weight: 500;
font-size: 0.8rem;
}
.lot-meta {
display: flex;
flex-wrap: wrap;
gap: 0.3rem;
font-size: 0.7rem;
color: rgba(156, 163, 175, 0.95);
}
.lot-occ {
font-size: 0.8rem;
font-weight: 500;
min-width: 80px;
text-align: right;
}
.status {
font-size: 0.7rem;
color: rgba(148, 163, 184, 0.9);
margin-top: 0.3rem;
}
.ai-oracle-chip {
display: inline-flex;
align-items: center;
gap: 0.4rem;
padding: 0.18rem 0.65rem;
border-radius: 999px;
border: 1px solid rgba(59, 130, 246, 0.45);
background: linear-gradient(120deg, rgba(37, 99, 235, 0.35), rgba(14, 165, 233, 0.15));
color:
font-size: 0.75rem;
letter-spacing: 0.02em;
box-shadow: 0 12px 30px rgba(37, 99, 235, 0.25);
}
.ai-orchestrator-card {
position: relative;
overflow: hidden;
background: linear-gradient(135deg, rgba(30, 41, 59, 0.92), rgba(17, 24, 39, 0.94));
}
.ai-orchestrator-card .card-title {
align-items: center;
}
.ai-orchestrator-card .card-title span {
display: inline-flex;
align-items: center;
gap: 0.4rem;
}
.quantum-toggle {
border: 1px solid rgba(255, 255, 255, 0.12);
color:
font-weight: 600;
letter-spacing: 0.01em;
min-width: 150px;
justify-content: space-between;
}
.quantum-toggle__dot {
width: 18px;
height: 18px;
border-radius: 50%;
border: 2px solid rgba(255, 255, 255, 0.7);
background: radial-gradient(circle at 35% 35%,
box-shadow: 0 0 20px rgba(56, 189, 248, 0.45);
}
.quantum-toggle__label {
flex: 1;
text-align: right;
font-size: 0.8rem;
}
@media (max-width: 900px) {
main {
grid-template-columns: 1fr;
}
.sidebar {
max-width: 100%;
border-left: none;
border-top: 1px solid rgba(148, 163, 184, 0.2);
}
}
</style>
</head>
<body>
<header class="cinematic-surface">
<h1>
<span>ParkShare AI Map</span>
<span class="badge">local ML</span>
</h1>
<div class="header-meta">
<div class="ai-crest">
<span>üß†</span>
<span class="quantum-toggle__label">AI Orchestrator</span>
</div>
<button id="themeToggle" class="quantum-toggle cinematic-button" data-theme="dark">
<span class="quantum-toggle__dot"></span>
<span class="quantum-toggle__label">Dark Matter</span>
</button>
<div class="pill">
<span class="pill-dot green"></span>
<span id="statusText">–ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ AI-—Å–µ—Ä–≤–µ—Ä—É‚Ä¶</span>
</div>
</div>
</header>
<main>
<div id="map"></div>
<aside class="sidebar">
<section class="card cinematic-surface ai-orchestrator-card">
<div class="card-title">
<span>AI-–û—Ä–∫–µ—Å—Ç—Ä–∞—Ç–æ—Ä</span>
<span class="ai-oracle-chip">Quantum boost</span>
</div>
<div class="ai-forecast">
<div class="ai-forecast-metric">
<span class="ai-forecast-label">–õ—É—á—à–∞—è —Å—Ç–∞–≤–∫–∞</span>
<span class="ai-forecast-value" id="aiOracleName">‚Äî</span>
</div>
<div class="ai-forecast-metric">
<span class="ai-forecast-label">–û—Å–≤–æ–±–æ–¥–∏—Ç—Å—è —á–µ—Ä–µ–∑</span>
<span class="ai-forecast-value" id="aiOracleETA">‚Äî</span>
</div>
<div class="ai-forecast-metric">
<span class="ai-forecast-label">–£–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç—å AI</span>
<span class="ai-forecast-value" id="aiOracleConfidence">‚Äî</span>
</div>
<div class="ai-forecast-metric">
<span class="ai-forecast-label">EV/–∫—Ä—ã—Ç–∞—è</span>
<span class="ai-forecast-value" id="aiOracleMeta">‚Äî</span>
</div>
</div>
<div class="ai-reasoning" id="aiOracleReason">AI –≥–æ—Ç–æ–≤–∏—Ç –∏–Ω—Å–∞–π—Ç‚Ä¶</div>
</section>
<section class="card">
<div class="card-title">
<span>–ü–æ–∏—Å–∫ –ø–∞—Ä–∫–æ–≤–æ–∫ (NLP)</span>
</div>
<div class="input-row">
<input
type="text"
id="searchInput"
placeholder='–ù–∞–ø—Ä–∏–º–µ—Ä: "—Ä—è–¥–æ–º —Å –º–µ—Ç—Ä–æ", "–¥–µ—à–µ–≤—ã–µ —É—Ç—Ä–æ–º"'
/>
<button id="searchBtn">–ò—Å–∫–∞—Ç—å</button>
</div>
<div class="status" id="searchStatus">–ó–∞–ø—Ä–æ—Å –µ—â–µ –Ω–µ –≤—ã–ø–æ–ª–Ω–µ–Ω.</div>
</section>
<section class="card">
<div class="card-title">
<span>–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ (–∫–æ–ª–ª–∞–±. —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏—è)</span>
<select id="userSelect"></select>
</div>
<div class="input-row">
<button id="recBtn">–ü–æ–ª—É—á–∏—Ç—å —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏</button>
<button id="recContentBtn" class="secondary">–í–∞—Ä–∏–∞–Ω—Ç B (content)</button>
</div>
<div class="status" id="recStatus">–ù–µ—Ç —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–π.</div>
<div class="lots-list" id="recList"></div>
</section>
<section class="card">
<div class="card-title">
<span>–í—Å–µ –ø–∞—Ä–∫–æ–≤–∫–∏</span>
</div>
<div class="lots-list" id="lotsList"></div>
</section>
</aside>
</main>
<script
src="https:
integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
crossorigin=""
></script>
<script src="./static/js/quantum-theme-manager.js"></script>
<script src="app.js"></script>
<script>
window.psThemeManager = window.initQuantumThemeManager();
</script>
</body>
</html>

# File 16/160: model_training.py
################################################################################

# model_training.py
from __future__ import annotations
import joblib
import numpy as np
import pandas as pd
from pathlib import Path
from typing import Dict, Any
from sklearn.compose import ColumnTransformer
from sklearn.ensemble import RandomForestRegressor
from sklearn.feature_extraction.text import CountVectorizer
from sklearn.metrics.pairwise import cosine_similarity
from sklearn.pipeline import Pipeline
from sklearn.preprocessing import OneHotEncoder, StandardScaler
from sklearn.svm import LinearSVC
from database import DB_PATH, get_connection, init_db, generate_synthetic_data
BASE_DIR = Path(__file__).parent
MODELS_DIR = BASE_DIR / "ai_models"
MODELS_DIR.mkdir(exist_ok=True)
# ---------- 1. –ú–æ–¥–µ–ª—å –ø—Ä–µ–¥—Å–∫–∞–∑–∞–Ω–∏—è –∑–∞–≥—Ä—É–∂–µ–Ω–Ω–æ—Å—Ç–∏ –ø–∞—Ä–∫–æ–≤–æ–∫ ----------
def load_occupancy_dataframe() -> pd.DataFrame:
conn = get_connection()
query = """
SELECT
oh.lot_id,
oh.ts,
oh.occupancy,
oh.temperature,
oh.is_rain,
oh.is_event,
pl.near_metro,
pl.price_level,
pl.has_covered,
pl.has_ev_charging
FROM occupancy_history oh
JOIN parking_lot pl ON pl.id = oh.lot_id
"""
df = pd.read_sql_query(query, conn)
conn.close()
df["ts"] = pd.to_datetime(df["ts"])
df["hour"] = df["ts"].dt.hour
df["dow"] = df["ts"].dt.weekday
df["lot_id_str"] = df["lot_id"].astype(str)
return df
def train_occupancy_model() -> None:
df = load_occupancy_dataframe()
if df.empty:
raise RuntimeError("–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –æ–±—É—á–µ–Ω–∏—è occupancy-–º–æ–¥–µ–ª–∏")
feature_cols = [
"hour",
"dow",
"temperature",
"is_rain",
"is_event",
"near_metro",
"price_level",
"has_covered",
"has_ev_charging",
"lot_id_str",
]
X = df[feature_cols].copy()
y = df["occupancy"].astype(float)
numeric_features = [
"hour",
"dow",
"temperature",
"is_rain",
"is_event",
"near_metro",
"price_level",
"has_covered",
"has_ev_charging",
]
categorical_features = ["lot_id_str"]
preprocessor = ColumnTransformer(
transformers=[
("num", StandardScaler(), numeric_features),
("cat", OneHotEncoder(handle_unknown="ignore"), categorical_features),
]
)
model = RandomForestRegressor(
n_estimators=80,
random_state=42,
n_jobs=-1,
)
pipe = Pipeline(
steps=[
("preprocess", preprocessor),
("model", model),
]
)
pipe.fit(X, y)
model_path = MODELS_DIR / "occupancy_model.pkl"
joblib.dump(
{
"pipeline": pipe,
"feature_cols": feature_cols,
},
model_path,
)
print("occupancy_model.pkl —Å–æ—Ö—Ä–∞–Ω—ë–Ω –≤", model_path)
# ---------- 2. NLP: –∏–Ω—Ç–µ–Ω—Ç—ã –∏ –ø–∞—Ä—Å–∏–Ω–≥ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏—Ö –∑–∞–ø—Ä–æ—Å–æ–≤ ----------
def build_nlp_training_data() -> pd.DataFrame:
data = [
("—Ä—è–¥–æ–º —Å –º–µ—Ç—Ä–æ", "near_metro"),
("–ø–∞—Ä–∫–æ–≤–∫–∞ –æ–∫–æ–ª–æ –º–µ—Ç—Ä–æ", "near_metro"),
("–ø–∞—Ä–∫–æ–≤–∫–∞ –≤–æ–∑–ª–µ –º–µ—Ç—Ä–æ", "near_metro"),
("–≥–¥–µ –ø—Ä–∏–ø–∞—Ä–∫–æ–≤–∞—Ç—å—Å—è —É –º–µ—Ç—Ä–æ –∫—É—Ä—Å–∫–∞—è", "near_metro"),
("–Ω–∞–π–¥–∏ –ø–∞—Ä–∫–æ–≤–∫—É —É –º–µ—Ç—Ä–æ", "near_metro"),
("—Å–∞–º–∞—è –¥–µ—à–µ–≤–∞—è –ø–∞—Ä–∫–æ–≤–∫–∞", "cheap"),
("–¥–µ—à–µ–≤—ã–µ –ø–∞—Ä–∫–æ–≤–∫–∏ —É—Ç—Ä–æ–º", "cheap"),
("–Ω–µ–¥–æ—Ä–æ–≥–∞—è –ø–∞—Ä–∫–æ–≤–∫–∞ —Ä—è–¥–æ–º", "cheap"),
("–¥–µ—à–µ–≤–æ –ø—Ä–∏–ø–∞—Ä–∫–æ–≤–∞—Ç—å—Å—è", "cheap"),
("–Ω–µ–¥–æ—Ä–æ–≥–∏–µ –º–µ—Å—Ç–∞ –¥–ª—è –º–∞—à–∏–Ω—ã", "cheap"),
("–ø–∞—Ä–∫–æ–≤–∫–∞ —Å –∑–∞—Ä—è–¥–∫–æ–π –¥–ª—è —ç–ª–µ–∫—Ç—Ä–æ–º–æ–±–∏–ª—è", "ev"),
("–Ω—É–∂–Ω–∞ –∑–∞—Ä—è–¥–∫–∞ –¥–ª—è —ç–ª–µ–∫—Ç—Ä–æ–∫–∞—Ä–∞", "ev"),
("–ø–∞—Ä–∫–æ–≤–∫–∞ —Å ev charging", "ev"),
("–∫—Ä—ã—Ç–∞—è –ø–∞—Ä–∫–æ–≤–∫–∞", "covered"),
("–ø–æ–¥–∑–µ–º–Ω–∞—è –ø–∞—Ä–∫–æ–≤–∫–∞", "covered"),
("–ø–∞—Ä–∫–æ–≤–∫–∞ –≤ –ø–∞—Ä–∫–∏–Ω–≥–µ", "covered"),
("–ø–∞—Ä–∫–æ–≤–∫–∞ –Ω–æ—á—å—é", "time_night"),
("–ø–∞—Ä–∫–æ–≤–∫–∞ —É—Ç—Ä–æ–º", "time_morning"),
("–ø–∞—Ä–∫–æ–≤–∫–∞ –≤–µ—á–µ—Ä–æ–º", "time_evening"),
("–ø–∞—Ä–∫–æ–≤–∫–∞ –¥–Ω–µ–º", "time_day"),
("–Ω–∞–π–¥–∏ –ø–∞—Ä–∫–æ–≤–∫—É", "general"),
("–ø–æ–∫–∞–∑–∞—Ç—å –≤—Å–µ –ø–∞—Ä–∫–æ–≤–∫–∏", "general"),
("–≥–¥–µ –º–æ–∂–Ω–æ –ø—Ä–∏–ø–∞—Ä–∫–æ–≤–∞—Ç—å—Å—è", "general"),
("–ø–∞—Ä–∫–æ–≤–∫–∞ –≤ —Ü–µ–Ω—Ç—Ä–µ", "general"),
("–ø–∞—Ä–∫–æ–≤–∫–∞ –≤–æ–∑–ª–µ –æ—Ñ–∏—Å–∞", "general"),
]
return pd.DataFrame(data, columns=["text", "intent"])
def train_nlp_model() -> None:
df = build_nlp_training_data()
X = df["text"].values
y = df["intent"].values
pipe = Pipeline(
steps=[
(
"vec",
CountVectorizer(
ngram_range=(1, 2),
analyzer="word",
),
),
("clf", LinearSVC()),
]
)
pipe.fit(X, y)
model_path = MODELS_DIR / "nlp_intent.pkl"
joblib.dump(pipe, model_path)
print("nlp_intent.pkl —Å–æ—Ö—Ä–∞–Ω—ë–Ω –≤", model_path)
# ---------- 3. –†–µ–∫–æ–º–µ–Ω–¥–∞—Ç–µ–ª—å–Ω–∞—è —Å–∏—Å—Ç–µ–º–∞ (collab + content) ----------
def train_recommender() -> None:
"""
–ü—Ä–æ—Å—Ç–µ–π—à–∞—è item-based collaborative filtering + content-based —Ñ–æ–ª–±—ç–∫.
"""
conn = get_connection()
ratings = pd.read_sql_query("SELECT * FROM user_rating;", conn)
lots = pd.read_sql_query("SELECT * FROM parking_lot;", conn)
if ratings.empty or lots.empty:
raise RuntimeError("–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –æ–±—É—á–µ–Ω–∏—è —Ä–µ–∫–æ–º–µ–Ω–¥–µ—Ä–∞")
# user-item –º–∞—Ç—Ä–∏—Ü–∞
user_item = (
ratings.pivot(index="user_id", columns="lot_id", values="rating")
.fillna(0.0)
.astype(float)
)
# –ù–æ—Ä–º–∏—Ä—É–µ–º –ø–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º
user_norms = np.linalg.norm(user_item.values, axis=1, keepdims=True)
user_norms[user_norms == 0] = 1.0
user_item_norm = user_item.values / user_norms
# item-item similarity (cosine)
sim_matrix = cosine_similarity(user_item_norm.T)
item_ids = user_item.columns.tolist()
item_sim = pd.DataFrame(sim_matrix, index=item_ids, columns=item_ids)
# Content-features
lot_features = lots.set_index("id")[
["near_metro", "price_level", "has_covered", "has_ev_charging", "latitude", "longitude"]
].copy()
model_path = MODELS_DIR / "recommender.pkl"
joblib.dump(
{
"user_item": user_item,
"item_sim": item_sim,
"lot_features": lot_features,
},
model_path,
)
print("recommender.pkl —Å–æ—Ö—Ä–∞–Ω—ë–Ω –≤", model_path)
conn.close()
def main() -> None:
# –ù–∞ —Å–ª—É—á–∞–π —á–∏—Å—Ç–æ–π —É—Å—Ç–∞–Ω–æ–≤–∫–∏
init_db()
generate_synthetic_data()
print("=== –û–±—É—á–µ–Ω–∏–µ occupancy-–º–æ–¥–µ–ª–∏ ===")
train_occupancy_model()
print("=== –û–±—É—á–µ–Ω–∏–µ NLP-–º–æ–¥–µ–ª–∏ ===")
train_nlp_model()
print("=== –û–±—É—á–µ–Ω–∏–µ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ç–µ–ª—å–Ω–æ–π —Å–∏—Å—Ç–µ–º—ã ===")
train_recommender()
print("–ì–æ—Ç–æ–≤–æ: –≤—Å–µ –º–æ–¥–µ–ª–∏ –æ–±—É—á–µ–Ω—ã –∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã –≤", MODELS_DIR)
if __name__ == "__main__":
main()

# File 17/160: requirements.txt
################################################################################

Django==5.2.8
djangorestframework==3.16.1
django-environ==0.12.0
django-cors-headers==4.9.0
django-cryptography-django5==2.2
psycopg[binary]==3.2.12
celery==5.5.3
redis==7.0.1
Pillow==11.1.0
numpy==2.3.0
pandas==2.2.3
scikit-learn==1.7.2
gunicorn==23.0.0
yookassa
drf-spectacular==0.27.2
django-ratelimit==4.1.0
djangorestframework-simplejwt==5.3.1
httpx==0.27.2
asgiref==3.8.1

# AI‚Äë–º–∏–∫—Ä–æ—Å–µ—Ä–≤–∏—Å—ã (ParkMate AI)
fastapi
uvicorn[standard]==0.32.1


# File 18/160: accounts\__init__.py
################################################################################



# File 19/160: accounts\admin.py
################################################################################

# accounts/admin.py
from django.contrib import admin
from django.contrib.auth.admin import UserAdmin as DjangoUserAdmin
from .models import User
@admin.register(User)
class UserAdmin(DjangoUserAdmin):
"""
–ö–∞—Å—Ç–æ–º–Ω–∞—è –∞–¥–º–∏–Ω–∫–∞ –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è —Å UUID-ID –∏ —Ä–æ–ª—è–º–∏.
"""
fieldsets = DjangoUserAdmin.fieldsets + (
(
"–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ",
{
"fields": (
"role",
"email_encrypted",
"phone_encrypted",
"owner_request_pending",
)
},
),
)
list_display = (
"username",
"role",
"is_active",
"is_staff",
"is_superuser",
"date_joined",
)
list_filter = ("role", "is_active", "is_staff", "is_superuser")
search_fields = ("username",)

# File 20/160: accounts\apps.py
################################################################################

# accounts/apps.py
from django.apps import AppConfig
class AccountsConfig(AppConfig):
default_auto_field = "django.db.models.BigAutoField"
name = "accounts"
verbose_name = "–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ ParkShare"

# File 21/160: accounts\auth.py
################################################################################

# accounts/auth.py
from __future__ import annotations
from typing import Optional
from django.contrib.auth import get_user_model
from core.utils import normalize_phone
from .utils import normalize_email, hash_email, hash_phone
User = get_user_model()
def _get_first_or_none(qs):
try:
return qs.first()
except Exception:
return None
def find_user_by_identifier(identifier: str) -> Optional[User]:
"""
–ò—â–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –ø–æ:
1) username (—Ä–µ–≥–∏—Å—Ç—Ä–æ–Ω–µ–∑–∞–≤–∏—Å–∏–º–æ);
2) email (–Ω–æ—Ä–º–∞–ª–∏–∑–æ–≤–∞–Ω–Ω—ã–π, —á–µ—Ä–µ–∑ email_hash);
3) —Ç–µ–ª–µ—Ñ–æ–Ω—É (–Ω–æ—Ä–º–∞–ª–∏–∑–æ–≤–∞–Ω–Ω—ã–π, —á–µ—Ä–µ–∑ phone_hash).
–í –ë–î –Ω–∏–∫–æ–≥–¥–∞ –Ω–µ —Ñ–∏–ª—å—Ç—Ä—É–µ–º –ø–æ –∑–∞—à–∏—Ñ—Ä–æ–≤–∞–Ω–Ω—ã–º –ø–æ–ª—è–º.
"""
if not identifier:
return None
ident = identifier.strip()
qs = User.objects.filter(is_active=True)
# 1) –õ–æ–≥–∏–Ω (username)
try:
return qs.get(username__iexact=ident)
except User.DoesNotExist:
pass
except User.MultipleObjectsReturned:
return _get_first_or_none(qs.filter(username__iexact=ident).order_by("date_joined"))
# 2) Email
if "@" in ident:
email = normalize_email(ident)
if not email:
return None
email_hash = hash_email(email)
if not email_hash:
return None
try:
return qs.get(email_hash=email_hash)
except User.DoesNotExist:
pass
except User.MultipleObjectsReturned:
return _get_first_or_none(qs.filter(email_hash=email_hash).order_by("date_joined"))
return None
# 3) –¢–µ–ª–µ—Ñ–æ–Ω
phone = normalize_phone(ident)
if not phone:
return None
phone_hash = hash_phone(phone)
if not phone_hash:
return None
try:
return qs.get(phone_hash=phone_hash)
except User.DoesNotExist:
return None
except User.MultipleObjectsReturned:
return _get_first_or_none(qs.filter(phone_hash=phone_hash).order_by("date_joined"))

# File 22/160: accounts\forms.py
################################################################################

# accounts/forms.py
from typing import Any
from django import forms
from django.contrib.auth.forms import AuthenticationForm, UserCreationForm
from django.utils.translation import gettext_lazy as _
from core.utils import normalize_phone
from .models import User
class LoginForm(AuthenticationForm):
"""
–§–æ—Ä–º–∞ –≤—Ö–æ–¥–∞: –æ–¥–Ω–æ –ø–æ–ª–µ –¥–ª—è –ª–æ–≥–∏–Ω–∞ / email / —Ç–µ–ª–µ—Ñ–æ–Ω–∞ + –ø–∞—Ä–æ–ª—å.
"""
username = forms.CharField(
label=_("–õ–æ–≥–∏–Ω / Email / –¢–µ–ª–µ—Ñ–æ–Ω"),
widget=forms.TextInput(attrs={"autofocus": True, "class": "ps-input"}),
)
def clean(self):
"""
–ü–æ–¥–º–µ–Ω—è–µ–º username –Ω–∞ —Ä–µ–∞–ª—å–Ω—ã–π –ª–æ–≥–∏–Ω –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è, —á—Ç–æ–±—ã
AuthenticationForm –º–æ–≥–ª–∞ –≤—ã–∑–≤–∞—Ç—å authenticate() –∫–∞–∫ –æ–±—ã—á–Ω–æ.
"""
from .auth import find_user_by_identifier
identifier = self.cleaned_data.get("username")
password = self.cleaned_data.get("password")
if identifier and password:
user = find_user_by_identifier(identifier)
if user is not None:
self.cleaned_data["username"] = user.get_username()
return super().clean()
class RegisterForm(UserCreationForm):
"""
–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è —á–µ—Ä–µ–∑ HTML-—Ñ–æ—Ä–º—É.
Email –∏ —Ç–µ–ª–µ—Ñ–æ–Ω ‚Äî –æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–µ, —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è –≤ –∑–∞—à–∏—Ñ—Ä–æ–≤–∞–Ω–Ω–æ–º –≤–∏–¥–µ.
"""
email = forms.EmailField(
label=_("Email (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)"),
required=False,
widget=forms.EmailInput(attrs={"class": "ps-input"}),
)
phone = forms.CharField(
label=_("–¢–µ–ª–µ—Ñ–æ–Ω (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)"),
required=False,
widget=forms.TextInput(attrs={"class": "ps-input"}),
)
class Meta(UserCreationForm.Meta):
model = User
fields = ("username", "email", "phone")
widgets = {
"username": forms.TextInput(attrs={"class": "ps-input"}),
}
def clean_email(self) -> str:
"""
–ü—Ä–æ—Å—Ç–æ –Ω–æ—Ä–º–∞–ª–∏–∑—É–µ–º email, –±–µ–∑ –∑–∞–ø—Ä–æ—Å–æ–≤ –∫ –ë–î.
"""
email = (self.cleaned_data.get("email") or "").strip().lower()
return email
def clean_phone(self) -> str:
"""
–¢–æ–ª—å–∫–æ –Ω–æ—Ä–º–∞–ª–∏–∑—É–µ–º –Ω–æ–º–µ—Ä, –±–µ–∑ –ø—Ä–æ–≤–µ—Ä–∫–∏ —É–Ω–∏–∫–∞–ª—å–Ω–æ—Å—Ç–∏.
"""
phone = self.cleaned_data.get("phone") or ""
if not phone:
return ""
phone = normalize_phone(phone)
if not phone:
raise forms.ValidationError(_("–ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç —Ç–µ–ª–µ—Ñ–æ–Ω–∞."))
return phone
def save(self, commit: bool = True) -> User:
"""
–°–æ—Ö—Ä–∞–Ω—è–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏ –¥—É–±–ª–∏—Ä—É–µ–º –Ω–æ—Ä–º–∞–ª–∏–∑–æ–≤–∞–Ω–Ω—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è
–≤ email_plain / phone_plain, —á—Ç–æ–±—ã –∏—Ö –º–æ–∂–Ω–æ –±—ã–ª–æ –ø–æ–∫–∞–∑—ã–≤–∞—Ç—å –≤ UI.
"""
user: User = super().save(commit=False)
email = (self.cleaned_data.get("email") or "").strip().lower()
phone = self.cleaned_data.get("phone") or ""
user.email_plain = email or ""
user.phone_plain = normalize_phone(phone or "") if phone else ""
if commit:
user.save()
return user
class ProfileForm(forms.ModelForm):
"""
–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –ø—Ä–æ—Ñ–∏–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (email/phone + –±–∞–∑–æ–≤—ã–µ –ø–æ–ª—è).
"""
email = forms.EmailField(
label=_("Email"),
required=False,
widget=forms.EmailInput(attrs={"class": "ps-input"}),
)
phone = forms.CharField(
label=_("–¢–µ–ª–µ—Ñ–æ–Ω"),
required=False,
widget=forms.TextInput(attrs={"class": "ps-input"}),
)
class Meta:
model = User
fields = ("first_name", "last_name", "email", "phone")
widgets = {
"first_name": forms.TextInput(attrs={"class": "ps-input"}),
"last_name": forms.TextInput(attrs={"class": "ps-input"}),
}
def clean_email(self) -> str:
email = (self.cleaned_data.get("email") or "").strip().lower()
return email
def clean_phone(self) -> str:
phone = self.cleaned_data.get("phone") or ""
if not phone:
return ""
phone = normalize_phone(phone)
if not phone:
raise forms.ValidationError(_("–ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç —Ç–µ–ª–µ—Ñ–æ–Ω–∞."))
# –ë–æ–ª—å—à–µ –ù–ò–ö–ê–ö–ò–• –∑–∞–ø—Ä–æ—Å–æ–≤ –∫ User.objects.filter(phone_encrypted=...)
return phone
def save(self, commit: bool = True) -> Any:
user: User = super().save(commit=False)
email = (self.cleaned_data.get("email") or "").strip().lower()
phone = self.cleaned_data.get("phone") or ""
user.email_plain = email or ""
user.phone_plain = normalize_phone(phone or "") if phone else ""
if commit:
user.save()
return user

# File 23/160: accounts\models.py
################################################################################

# accounts/models.py
import uuid
from django.contrib.auth.models import AbstractUser
from django.db import models
from django.utils import timezone
from django.utils.translation import gettext_lazy as _
from django_cryptography.fields import encrypt
from core.models import TimeStampedUUIDModel
from .utils import hash_email, hash_phone
class User(AbstractUser):
"""
–ö–∞—Å—Ç–æ–º–Ω—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å:
- UUID –∫–∞–∫ –ø–µ—Ä–≤–∏—á–Ω—ã–π –∫–ª—é—á;
- —Ä–æ–ª—å (driver / owner / admin);
- email/—Ç–µ–ª–µ—Ñ–æ–Ω –≤ –∑–∞—à–∏—Ñ—Ä–æ–≤–∞–Ω–Ω–æ–º –≤–∏–¥–µ (django-cryptography-django5);
- –æ—Ç–¥–µ–ª—å–Ω—ã–µ —Ö—ç—à–∏ email/—Ç–µ–ª–µ—Ñ–æ–Ω–∞ –¥–ª—è –±–µ–∑–æ–ø–∞—Å–Ω–æ–≥–æ –ø–æ–∏—Å–∫–∞/—É–Ω–∏–∫–∞–ª—å–Ω–æ—Å—Ç–∏.
"""
class Role(models.TextChoices):
DRIVER = "driver", _("–í–æ–¥–∏—Ç–µ–ª—å")
OWNER = "owner", _("–í–ª–∞–¥–µ–ª–µ—Ü –ø–∞—Ä–∫–æ–≤–∫–∏")
ADMIN = "admin", _("–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä")
id = models.UUIDField(primary_key=True, default=uuid.uuid4, editable=False)
role = models.CharField(
_("–†–æ–ª—å"),
max_length=16,
choices=Role.choices,
default=Role.DRIVER,
help_text=_("–û–ø—Ä–µ–¥–µ–ª—è–µ—Ç –ø—Ä–∞–≤–∞ –¥–æ—Å—Ç—É–ø–∞ –≤ —Å–∏—Å—Ç–µ–º–µ."),
)
# –®–∏—Ñ—Ä–æ–≤–∞–Ω–Ω—ã–µ –∫–æ–Ω—Ç–∞–∫—Ç–Ω—ã–µ –ø–æ–ª—è
email_encrypted = encrypt(
models.EmailField(
_("Email (–∑–∞—à–∏—Ñ—Ä–æ–≤–∞–Ω–Ω—ã–π)"),
blank=True,
null=True,
help_text=_("–û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–π email, —Ö—Ä–∞–Ω–∏—Ç—Å—è –≤ –∑–∞—à–∏—Ñ—Ä–æ–≤–∞–Ω–Ω–æ–º –≤–∏–¥–µ."),
)
)
phone_encrypted = encrypt(
models.CharField(
_("–¢–µ–ª–µ—Ñ–æ–Ω (–∑–∞—à–∏—Ñ—Ä–æ–≤–∞–Ω–Ω—ã–π)"),
max_length=32,
blank=True,
null=True,
help_text=_("–û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–π —Ç–µ–ª–µ—Ñ–æ–Ω, —Ö—Ä–∞–Ω–∏—Ç—Å—è –≤ –∑–∞—à–∏—Ñ—Ä–æ–≤–∞–Ω–Ω–æ–º –≤–∏–¥–µ."),
)
)
# –û—Ç–¥–µ–ª—å–Ω—ã–µ —Ö—ç—à–∏ –¥–ª—è –ø–æ–∏—Å–∫–∞ –∏ –ø—Ä–æ–≤–µ—Ä–∫–∏ —É–Ω–∏–∫–∞–ª—å–Ω–æ—Å—Ç–∏
email_hash = models.CharField(
_("–•—ç—à –Ω–æ—Ä–º–∞–ª–∏–∑–æ–≤–∞–Ω–Ω–æ–≥–æ email"),
max_length=64,
blank=True,
db_index=True,
help_text=_("–ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ –¥–ª—è –ø–æ–∏—Å–∫–∞ –∏ –ø—Ä–æ–≤–µ—Ä–∫–∏ —É–Ω–∏–∫–∞–ª—å–Ω–æ—Å—Ç–∏ email."),
)
phone_hash = models.CharField(
_("–•—ç—à –Ω–æ—Ä–º–∞–ª–∏–∑–æ–≤–∞–Ω–Ω–æ–≥–æ —Ç–µ–ª–µ—Ñ–æ–Ω–∞"),
max_length=64,
blank=True,
db_index=True,
help_text=_("–ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ –¥–ª—è –ø–æ–∏—Å–∫–∞ –∏ –ø—Ä–æ–≤–µ—Ä–∫–∏ —É–Ω–∏–∫–∞–ª—å–Ω–æ—Å—Ç–∏ —Ç–µ–ª–µ—Ñ–æ–Ω–∞."),
)
owner_request_pending = models.BooleanField(
_("–ó–∞–ø—Ä–æ—à–µ–Ω–æ –ø–æ–≤—ã—à–µ–Ω–∏–µ –¥–æ –≤–ª–∞–¥–µ–ª—å—Ü–∞"),
default=False,
help_text=_("–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø–æ–¥–∞–ª –∑–∞—è–≤–∫—É –Ω–∞ —Ä–æ–ª—å –≤–ª–∞–¥–µ–ª—å—Ü–∞ –ø–∞—Ä–∫–æ–≤–∫–∏."),
)
# username + password –æ—Å—Ç–∞—é—Ç—Å—è —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–º–∏ –ø–æ–ª—è–º–∏ AbstractUser
REQUIRED_FIELDS: list[str] = []
class Meta:
verbose_name = _("–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å")
verbose_name_plural = _("–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏")
def __str__(self) -> str:
return self.username
# –£–¥–æ–±–Ω—ã–µ —Å–≤–æ–π—Å—Ç–≤–∞ –¥–ª—è —Ä–∞—Å—à–∏—Ñ—Ä–æ–≤–∞–Ω–Ω—ã—Ö –∫–æ–Ω—Ç–∞–∫—Ç–æ–≤
@property
def email_plain(self) -> str:
"""
–î–æ—Å—Ç—É–ø –∫ —Ä–∞—Å—à–∏—Ñ—Ä–æ–≤–∞–Ω–Ω–æ–º—É email.
–í –∫–æ–¥–µ (–∏ –≤ –∞–¥–º–∏–Ω–∫–µ) –º–æ–∂–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å user.email_plain.
"""
return self.email_encrypted or ""
@email_plain.setter
def email_plain(self, value: str) -> None:
self.email_encrypted = value or None
@property
def phone_plain(self) -> str:
return self.phone_encrypted or ""
@phone_plain.setter
def phone_plain(self, value: str) -> None:
self.phone_encrypted = value or None
# –†–æ–ª–µ–≤—ã–µ —Ñ–ª–∞–≥–∏
@property
def is_driver(self) -> bool:
return self.role == self.Role.DRIVER
@property
def is_owner(self) -> bool:
return self.role in (self.Role.OWNER, self.Role.ADMIN)
@property
def is_admin(self) -> bool:
return self.role == self.Role.ADMIN or self.is_superuser
# –°–ª—É–∂–µ–±–Ω—ã–µ –º–µ—Ç–æ–¥—ã
def update_contact_hashes(self) -> None:
"""
–ü–µ—Ä–µ—Å—á–∏—Ç—ã–≤–∞–µ—Ç email_hash / phone_hash –Ω–∞ –æ—Å–Ω–æ–≤–µ —Ç–µ–∫—É—â–∏—Ö –∑–Ω–∞—á–µ–Ω–∏–π
email_plain / phone_plain.
"""
self.email_hash = hash_email(self.email_plain)
self.phone_hash = hash_phone(self.phone_plain)
def save(self, *args, **kwargs) -> None:
# –ü–µ—Ä–µ–¥ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ–º –≤—Å–µ–≥–¥–∞ –æ–±–Ω–æ–≤–ª—è–µ–º —Ö—ç—à–∏ –∫–æ–Ω—Ç–∞–∫—Ç–æ–≤
self.update_contact_hashes()
super().save(*args, **kwargs)
class LoginCode(TimeStampedUUIDModel):
"""
–û–¥–Ω–æ—Ä–∞–∑–æ–≤—ã–π –∫–æ–¥ –¥–ª—è –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è email/—Ç–µ–ª–µ—Ñ–æ–Ω–∞ –∏ –≤—Ö–æ–¥–∞.
"""
class Channel(models.TextChoices):
EMAIL = "email", _("Email")
PHONE = "phone", _("–¢–µ–ª–µ—Ñ–æ–Ω")
class Purpose(models.TextChoices):
REGISTER = "register", _("–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è")
LOGIN = "login", _("–í—Ö–æ–¥")
RESET_PASSWORD = "reset_password", _("–°–±—Ä–æ—Å –ø–∞—Ä–æ–ª—è")
user = models.ForeignKey(
User,
on_delete=models.CASCADE,
related_name="login_codes",
)
channel = models.CharField(
_("–ö–∞–Ω–∞–ª"),
max_length=16,
choices=Channel.choices,
)
purpose = models.CharField(
_("–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ"),
max_length=32,
choices=Purpose.choices,
)
code_hash = models.CharField(
_("–•—ç—à –∫–æ–¥–∞"),
max_length=128,
db_index=True,
)
expires_at = models.DateTimeField(_("–ò—Å—Ç–µ–∫–∞–µ—Ç –≤"))
is_used = models.BooleanField(_("–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω"), default=False)
class Meta:
verbose_name = _("–ö–æ–¥ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è")
verbose_name_plural = _("–ö–æ–¥—ã –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è")
indexes = [
models.Index(fields=["user", "purpose", "is_used"]),
]
def __str__(self) -> str:
return f"{self.purpose} code for {self.user_id}"
@property
def is_expired(self) -> bool:
return timezone.now() >= self.expires_at
class UserLevel(TimeStampedUUIDModel):
"""–£—Ä–æ–≤–µ–Ω—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –ø–æ –∫–æ–ª–∏—á–µ—Å—Ç–≤—É –∑–∞–≤–µ—Ä—à—ë–Ω–Ω—ã—Ö –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–π."""
name = models.CharField(max_length=64)
threshold = models.PositiveIntegerField(
default=0, help_text="–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∑–∞–≤–µ—Ä—à—ë–Ω–Ω—ã—Ö –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–π –¥–ª—è —É—Ä–æ–≤–Ω—è"
)
description = models.TextField(blank=True)
class Meta:
verbose_name = "–£—Ä–æ–≤–µ–Ω—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è"
verbose_name_plural = "–£—Ä–æ–≤–Ω–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π"
ordering = ("threshold",)
def __str__(self) -> str:
return self.name
class UserBadge(TimeStampedUUIDModel):
"""–ë–µ–π–¥–∂ –∑–∞ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å/–ª–æ—è–ª—å–Ω–æ—Å—Ç—å."""
user = models.ForeignKey(
User, on_delete=models.CASCADE, related_name="badges", verbose_name="–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å"
)
title = models.CharField(max_length=128)
description = models.TextField(blank=True)
icon = models.CharField(max_length=64, blank=True)
level = models.ForeignKey(
UserLevel,
on_delete=models.SET_NULL,
null=True,
blank=True,
related_name="badges",
)
class Meta:
verbose_name = "–ë–µ–π–¥–∂"
verbose_name_plural = "–ë–µ–π–¥–∂–∏"
ordering = ("-created_at",)
def __str__(self) -> str:
return f"{self.title} ‚Äî {self.user}"
class PromoReward(TimeStampedUUIDModel):
"""–ó–∞–≥–æ—Ç–æ–≤–∫–∞ –ø–æ–¥ –ø—Ä–æ–º–æ/–±–æ–Ω—É—Å—ã."""
code = models.CharField(max_length=32, unique=True)
description = models.TextField(blank=True)
active = models.BooleanField(default=True)
usage_limit = models.PositiveIntegerField(default=1)
class Meta:
verbose_name = "–ü—Ä–æ–º–æ/–±–æ–Ω—É—Å"
verbose_name_plural = "–ü—Ä–æ–º–æ/–±–æ–Ω—É—Å—ã"
def __str__(self) -> str:
return self.code

# File 24/160: accounts\serializers.py
################################################################################

# accounts/serializers.py
from django.contrib.auth import authenticate
from django.contrib.auth.password_validation import validate_password
from django.utils.translation import gettext_lazy as _
from rest_framework import serializers
from core.utils import normalize_phone
from .auth import find_user_by_identifier
from .models import User, LoginCode
from .utils import normalize_email, hash_email, hash_phone
class UserSerializer(serializers.ModelSerializer):
"""
–ë–∞–∑–æ–≤–æ–µ –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –¥–ª—è –∞–¥–º–∏–Ω—Å–∫–∏—Ö API.
–ö–æ–Ω—Ç–∞–∫—Ç–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –Ω–µ —Ä–∞—Å–∫—Ä—ã–≤–∞—é—Ç—Å—è.
"""
has_email = serializers.SerializerMethodField()
has_phone = serializers.SerializerMethodField()
class Meta:
model = User
fields = (
"id",
"username",
"role",
"is_active",
"date_joined",
"has_email",
"has_phone",
)
def get_has_email(self, obj: User) -> bool:
return bool(obj.email_plain)
def get_has_phone(self, obj: User) -> bool:
return bool(obj.phone_plain)
class UserProfileSerializer(serializers.ModelSerializer):
"""
–ü—Ä–æ—Ñ–∏–ª—å —Ç–µ–∫—É—â–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.
–ó–¥–µ—Å—å –º–æ–∂–Ω–æ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å email/—Ç–µ–ª–µ—Ñ–æ–Ω.
"""
email = serializers.CharField(
source="email_plain",
allow_blank=True,
required=False,
)
phone = serializers.CharField(
source="phone_plain",
allow_blank=True,
required=False,
)
class Meta:
model = User
fields = ("id", "username", "role", "email", "phone")
def validate_phone(self, value: str) -> str:
"""
–í–∞–ª–∏–¥–∏—Ä—É–µ–º –∏ –Ω–æ—Ä–º–∞–ª–∏–∑—É–µ–º —Ç–µ–ª–µ—Ñ–æ–Ω, –ø—Ä–æ–≤–µ—Ä—è–µ–º —É–Ω–∏–∫–∞–ª—å–Ω–æ—Å—Ç—å —á–µ—Ä–µ–∑ phone_hash.
"""
value = value or ""
if not value:
return ""
normalized = normalize_phone(value)
if not normalized:
raise serializers.ValidationError(_("–ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç —Ç–µ–ª–µ—Ñ–æ–Ω–∞."))
phone_hash = hash_phone(normalized)
user = self.instance
qs = User.objects.filter(phone_hash=phone_hash)
if user is not None:
qs = qs.exclude(pk=user.pk)
if phone_hash and qs.exists():
raise serializers.ValidationError(
_("–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å —Ç–∞–∫–∏–º —Ç–µ–ª–µ—Ñ–æ–Ω–æ–º —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç.")
)
return normalized
def validate_email(self, value: str) -> str:
"""
–í–∞–ª–∏–¥–∏—Ä—É–µ–º –∏ –Ω–æ—Ä–º–∞–ª–∏–∑—É–µ–º email, –ø—Ä–æ–≤–µ—Ä—è–µ–º —É–Ω–∏–∫–∞–ª—å–Ω–æ—Å—Ç—å —á–µ—Ä–µ–∑ email_hash.
"""
value = normalize_email(value)
if not value:
return ""
email_hash = hash_email(value)
user = self.instance
qs = User.objects.filter(email_hash=email_hash)
if user is not None:
qs = qs.exclude(pk=user.pk)
if email_hash and qs.exists():
raise serializers.ValidationError(
_("–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å —Ç–∞–∫–∏–º email —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç.")
)
return value
class RegisterSerializer(serializers.Serializer):
"""
–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è —á–µ—Ä–µ–∑ API.
"""
username = serializers.CharField(max_length=150)
password = serializers.CharField(write_only=True, min_length=8)
email = serializers.EmailField(required=False, allow_blank=True)
phone = serializers.CharField(required=False, allow_blank=True)
def validate_username(self, value: str) -> str:
if User.objects.filter(username=value).exists():
raise serializers.ValidationError(
_("–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å —Ç–∞–∫–∏–º –ª–æ–≥–∏–Ω–æ–º —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç.")
)
return value
def validate_email(self, value: str) -> str:
email = normalize_email(value)
if not email:
return ""
email_hash = hash_email(email)
if email_hash and User.objects.filter(email_hash=email_hash).exists():
raise serializers.ValidationError(
_("–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å —Ç–∞–∫–∏–º email —É–∂–µ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω.")
)
return email
def validate_phone(self, value: str) -> str:
value = value or ""
if not value:
return ""
normalized = normalize_phone(value)
if not normalized:
raise serializers.ValidationError(_("–ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç —Ç–µ–ª–µ—Ñ–æ–Ω–∞."))
phone_hash = hash_phone(normalized)
if phone_hash and User.objects.filter(phone_hash=phone_hash).exists():
raise serializers.ValidationError(
_("–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å —Ç–∞–∫–∏–º —Ç–µ–ª–µ—Ñ–æ–Ω–æ–º —É–∂–µ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω.")
)
return normalized
def validate_password(self, value: str) -> str:
validate_password(value)
return value
def create(self, validated_data: dict) -> User:
email = validated_data.pop("email", "")
phone = validated_data.pop("phone", "")
user = User(username=validated_data["username"])
user.set_password(validated_data["password"])
if email:
user.email_plain = email
if phone:
user.phone_plain = phone
user.save()
return user
class LoginSerializer(serializers.Serializer):
"""
–õ–æ–≥–∏–Ω —á–µ—Ä–µ–∑ API (session-based).
–ü–æ–∑–≤–æ–ª—è–µ—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –ª–æ–≥–∏–Ω, email –∏–ª–∏ —Ç–µ–ª–µ—Ñ–æ–Ω.
"""
identifier = serializers.CharField(
label=_("–õ–æ–≥–∏–Ω / Email / –¢–µ–ª–µ—Ñ–æ–Ω"),
)
password = serializers.CharField(write_only=True)
def validate(self, attrs: dict) -> dict:
identifier = attrs.get("identifier")
password = attrs.get("password")
if not identifier or not password:
raise serializers.ValidationError(
_("–ù–µ–æ–±—Ö–æ–¥–∏–º–æ —É–∫–∞–∑–∞—Ç—å –ª–æ–≥–∏–Ω –∏ –ø–∞—Ä–æ–ª—å."),
code="authorization",
)
user = find_user_by_identifier(identifier)
if user is None:
raise serializers.ValidationError(
_("–ù–µ–≤–µ—Ä–Ω—ã–π –ª–æ–≥–∏–Ω/email/—Ç–µ–ª–µ—Ñ–æ–Ω –∏–ª–∏ –ø–∞—Ä–æ–ª—å."),
code="authorization",
)
# authenticate –Ω—É–∂–µ–Ω –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –ø–∞—Ä–æ–ª—è –∏ backend'–∞ –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏
auth_user = authenticate(
username=user.username,
password=password,
)
if auth_user is None:
raise serializers.ValidationError(
_("–ù–µ–≤–µ—Ä–Ω—ã–π –ª–æ–≥–∏–Ω/email/—Ç–µ–ª–µ—Ñ–æ–Ω –∏–ª–∏ –ø–∞—Ä–æ–ª—å."),
code="authorization",
)
if not auth_user.is_active:
raise serializers.ValidationError(
_("–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –¥–µ–∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω."),
code="authorization",
)
attrs["user"] = auth_user
return attrs
class ChangePasswordSerializer(serializers.Serializer):
"""
–°–º–µ–Ω–∞ –ø–∞—Ä–æ–ª—è —Ç–µ–∫—É—â–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.
"""
old_password = serializers.CharField(write_only=True)
new_password = serializers.CharField(write_only=True, min_length=8)
def validate_new_password(self, value: str) -> str:
user = self.context["request"].user
validate_password(value, user=user)
return value
def validate(self, attrs: dict) -> dict:
user = self.context["request"].user
old_password = attrs.get("old_password")
if not user.check_password(old_password):
raise serializers.ValidationError(
{"old_password": _("–ù–µ–≤–µ—Ä–Ω—ã–π —Ç–µ–∫—É—â–∏–π –ø–∞—Ä–æ–ª—å.")}
)
return attrs
def save(self, **kwargs) -> User:
user = self.context["request"].user
new_password = self.validated_data["new_password"]
user.set_password(new_password)
user.save(update_fields=["password"])
return user
class PasswordResetRequestSerializer(serializers.Serializer):
"""
–ó–∞–ø—Ä–æ—Å –Ω–∞ —Å–±—Ä–æ—Å –ø–∞—Ä–æ–ª—è –ø–æ email (API).
"""
email = serializers.EmailField()
def validate_email(self, value: str) -> str:
# –í —Ü–µ–ª—è—Ö –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏ –Ω–µ —Ä–∞—Å–∫—Ä—ã–≤–∞–µ–º, —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å.
return normalize_email(value)
class OTPRequestSerializer(serializers.Serializer):
"""
–ó–∞–ø—Ä–æ—Å –∫–æ–¥–∞ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è –¥–ª—è email/—Ç–µ–ª–µ—Ñ–æ–Ω–∞.
"""
identifier = serializers.CharField(
label=_("Email –∏–ª–∏ —Ç–µ–ª–µ—Ñ–æ–Ω"),
)
purpose = serializers.ChoiceField(
choices=LoginCode.Purpose.choices,
default=LoginCode.Purpose.LOGIN,
)
class OTPVerifySerializer(serializers.Serializer):
"""
–ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–æ–¥–∞ –∏ –≤—ã–¥–∞—á–∞ JWT/—Å–µ—Å—Å–∏–∏.
"""
identifier = serializers.CharField(label=_("Email –∏–ª–∏ —Ç–µ–ª–µ—Ñ–æ–Ω"))
code = serializers.CharField(label=_("–ö–æ–¥"), max_length=8)
purpose = serializers.ChoiceField(
choices=LoginCode.Purpose.choices,
default=LoginCode.Purpose.LOGIN,
)

# File 25/160: accounts\urls.py
################################################################################

# accounts/urls.py
from django.contrib.auth import views as auth_views
from django.urls import path, reverse_lazy
from .views import CustomLoginView, ProfileView, RegisterView, logout_view
# TODO: –∏–Ω—Ç–µ–≥—Ä–∏—Ä–æ–≤–∞—Ç—å –≤—Ö–æ–¥ –ø–æ –∫–æ–¥—É –∏ –ì–æ—Å—É—Å–ª—É–≥–∏ (ESIA) –≤ –æ—Ç–¥–µ–ª—å–Ω—ã–µ view/urls, –∫–æ–≥–¥–∞ –ø–æ—è–≤—è—Ç—Å—è –ø—Ä–æ–≤–∞–π–¥–µ—Ä—ã
app_name = "accounts"
urlpatterns = [
path("login/", CustomLoginView.as_view(), name="login"),
path("logout/", logout_view, name="logout"),
path("register/", RegisterView.as_view(), name="register"),
path("profile/", ProfileView.as_view(), name="profile"),
# –°–º–µ–Ω–∞ –ø–∞—Ä–æ–ª—è (HTML)
path(
"password/change/",
auth_views.PasswordChangeView.as_view(
template_name="accounts/password_change.html",
success_url=reverse_lazy("accounts:password_change_done"),
),
name="password_change",
),
path(
"password/change/done/",
auth_views.PasswordChangeDoneView.as_view(
template_name="accounts/password_change_done.html"
),
name="password_change_done",
),
# –°–±—Ä–æ—Å –ø–∞—Ä–æ–ª—è (HTML)
path(
"password/reset/",
auth_views.PasswordResetView.as_view(
template_name="accounts/password_reset.html",
email_template_name="accounts/password_reset_email.txt",
subject_template_name="accounts/password_reset_subject.txt",
success_url=reverse_lazy("accounts:password_reset_done"),
),
name="password_reset",
),
path(
"password/reset/done/",
auth_views.PasswordResetDoneView.as_view(
template_name="accounts/password_reset_done.html"
),
name="password_reset_done",
),
path(
"reset/<uidb64>/<token>/",
auth_views.PasswordResetConfirmView.as_view(
template_name="accounts/password_reset_confirm.html",
success_url=reverse_lazy("accounts:password_reset_complete"),
),
name="password_reset_confirm",
),
path(
"reset/done/",
auth_views.PasswordResetCompleteView.as_view(
template_name="accounts/password_reset_complete.html"
),
name="password_reset_complete",
),
]

# File 26/160: accounts\utils.py
################################################################################

from __future__ import annotations
from typing import Optional
import hashlib
from django.conf import settings
from core.utils import normalize_phone
def normalize_email(email: Optional[str]) -> str:
"""
–ü—Ä–∏–≤–æ–¥–∏–º email –∫ –∫–∞–Ω–æ–Ω–∏—á–Ω–æ–º—É –≤–∏–¥—É:
- str.strip()
- .lower()
"""
if not email:
return ""
return email.strip().lower()
def _hash_value(kind: str, value: str) -> str:
"""
–í–Ω—É—Ç—Ä–µ–Ω–Ω—è—è —Ñ—É–Ω–∫—Ü–∏—è —Ö—ç—à–∏—Ä–æ–≤–∞–Ω–∏—è —Å —Å–æ–ª—å—é –Ω–∞ –±–∞–∑–µ SECRET_KEY.
kind: 'email' –∏–ª–∏ 'phone' (–Ω–∞ –±—É–¥—É—â–µ–µ –º–æ–∂–Ω–æ —Ä–∞—Å—à–∏—Ä—è—Ç—å).
"""
if not value:
return ""
salted = f"{settings.SECRET_KEY}:{kind}:{value}"
return hashlib.sha256(salted.encode("utf-8")).hexdigest()
def hash_email(email: str) -> str:
"""
–•—ç—à –Ω–æ—Ä–º–∞–ª–∏–∑–æ–≤–∞–Ω–Ω–æ–≥–æ email.
–í –ë–î —Ö—Ä–∞–Ω–∏—Ç—Å—è —Ç–æ–ª—å–∫–æ —Ö—ç—à, —Å–∞–º email ‚Äî –≤ –∑–∞—à–∏—Ñ—Ä–æ–≤–∞–Ω–Ω–æ–º –ø–æ–ª–µ.
"""
normalized = normalize_email(email)
if not normalized:
return ""
return _hash_value("email", normalized)
def hash_phone(phone: str) -> str:
"""
–•—ç—à –Ω–æ—Ä–º–∞–ª–∏–∑–æ–≤–∞–Ω–Ω–æ–≥–æ —Ç–µ–ª–µ—Ñ–æ–Ω–∞.
–í –ë–î —Ö—Ä–∞–Ω–∏—Ç—Å—è —Ç–æ–ª—å–∫–æ —Ö—ç—à, —Å–∞–º —Ç–µ–ª–µ—Ñ–æ–Ω ‚Äî –≤ –∑–∞—à–∏—Ñ—Ä–æ–≤–∞–Ω–Ω–æ–º –ø–æ–ª–µ.
"""
normalized = normalize_phone(phone)
if not normalized:
return ""
return _hash_value("phone", normalized)

# File 27/160: accounts\views.py
################################################################################

# accounts/views.py
from typing import Any
from django.contrib.auth import login as auth_login, logout as auth_logout
from django.contrib.auth.mixins import LoginRequiredMixin
from django.contrib.auth.views import LoginView as DjangoLoginView
from django.contrib.auth.forms import PasswordResetForm
from django.http import HttpRequest, HttpResponse
from django.shortcuts import redirect, render
from django.urls import reverse, reverse_lazy
from django.views import View
from django.views.generic import UpdateView
from rest_framework import permissions, status, viewsets
from rest_framework.views import APIView
from rest_framework.decorators import action
from rest_framework.response import Response
from rest_framework_simplejwt.tokens import RefreshToken
from rest_framework_simplejwt.views import TokenRefreshView
from django.utils import timezone
from django.utils.crypto import get_random_string
from django.contrib.auth import login as auth_login_session
from django.core.mail import send_mail
from core.permissions import IsSelfOrAdmin
from .forms import LoginForm, ProfileForm, RegisterForm
from .models import User, LoginCode
from .serializers import (
ChangePasswordSerializer,
LoginSerializer,
PasswordResetRequestSerializer,
RegisterSerializer,
UserProfileSerializer,
UserSerializer,
OTPRequestSerializer,
OTPVerifySerializer,
)
from .auth import find_user_by_identifier
from .utils import hash_email
# ===== HTML-–≤—å—é—Ö–∏ (—à–∞–±–ª–æ–Ω–Ω—ã–π –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å) =====
class RegisterView(View):
"""
–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è —á–µ—Ä–µ–∑ HTML-—Ñ–æ—Ä–º—É.
"""
template_name = "accounts/register.html"
def get(self, request: HttpRequest) -> HttpResponse:
if request.user.is_authenticated:
return redirect("user_dashboard")
form = RegisterForm()
return render(request, self.template_name, {"form": form})
def post(self, request: HttpRequest) -> HttpResponse:
if request.user.is_authenticated:
return redirect("user_dashboard")
form = RegisterForm(request.POST)
if form.is_valid():
user = form.save()
auth_login(request, user)
return redirect("user_dashboard")
return render(request, self.template_name, {"form": form})
class ProfileView(LoginRequiredMixin, UpdateView):
"""
–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –ø—Ä–æ—Ñ–∏–ª—è (email/—Ç–µ–ª–µ—Ñ–æ–Ω) –≤ HTML-–∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–µ.
"""
model = User
form_class = ProfileForm
template_name = "accounts/profile.html"
success_url = reverse_lazy("user_dashboard")
def get_object(self, queryset=None) -> User:
return self.request.user
class CustomLoginView(DjangoLoginView):
"""
–û–±—ë—Ä—Ç–∫–∞ –Ω–∞–¥ —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–º LoginView —Å —Ä—É—Å—Å–∫–∏–º —à–∞–±–ª–æ–Ω–æ–º –∏ –∫–∞—Å—Ç–æ–º–Ω–æ–π —Ñ–æ—Ä–º–æ–π.
"""
template_name = "accounts/login.html"
form_class = LoginForm
def get_success_url(self) -> str:
return reverse("user_dashboard")
def logout_view(request: HttpRequest) -> HttpResponse:
auth_logout(request)
return redirect("landing")
# ===== API (DRF) =====
class UserViewSet(viewsets.ModelViewSet):
"""
API –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏.
–ú–∞—Ä—à—Ä—É—Ç—ã:
- /api/accounts/users/                   (GET)   ‚Äî —Å–ø–∏—Å–æ–∫ (—Ç–æ–ª—å–∫–æ –∞–¥–º–∏–Ω)
- /api/accounts/users/{id}/              (GET)   ‚Äî –ø—Ä–æ—Ñ–∏–ª—å (—Å–∞–º –∏–ª–∏ –∞–¥–º–∏–Ω)
- /api/accounts/users/me/                (GET)   ‚Äî –ø—Ä–æ—Ñ–∏–ª—å —Ç–µ–∫—É—â–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
- /api/accounts/users/me/                (PATCH) ‚Äî –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–≤–æ–µ–≥–æ –ø—Ä–æ—Ñ–∏–ª—è
- /api/accounts/users/register/          (POST)  ‚Äî —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è
- /api/accounts/users/login/             (POST)  ‚Äî –ª–æ–≥–∏–Ω (session-based)
- /api/accounts/users/logout/            (POST)  ‚Äî –ª–æ–≥–∞—É—Ç
- /api/accounts/users/change-password/   (POST)  ‚Äî —Å–º–µ–Ω–∞ –ø–∞—Ä–æ–ª—è (API)
- /api/accounts/users/reset-password/    (POST)  ‚Äî –∑–∞–ø—Ä–æ—Å —Å–±—Ä–æ—Å–∞ –ø–∞—Ä–æ–ª—è –ø–æ email
"""
queryset = User.objects.all().order_by("-date_joined")
serializer_class = UserSerializer
def get_permissions(self) -> list[Any]:
if self.action in ("register", "login", "reset_password"):
permission_classes = [permissions.AllowAny]
elif self.action in ("list", "destroy"):
permission_classes = [permissions.IsAdminUser]
elif self.action in ("me", "change_password", "logout"):
permission_classes = [permissions.IsAuthenticated]
else:
# retrieve/update/partial_update ‚Äî —Ç–æ–ª—å–∫–æ —Å–∞–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∏–ª–∏ –∞–¥–º–∏–Ω
permission_classes = [permissions.IsAuthenticated, IsSelfOrAdmin]
return [perm() for perm in permission_classes]
def get_queryset(self):
user: User = self.request.user
if not user.is_authenticated:
return User.objects.none()
if user.is_superuser or getattr(user, "is_admin", False):
return User.objects.all().order_by("-date_joined")
return User.objects.filter(pk=user.pk)
def perform_destroy(self, instance: User) -> None:
"""
–£–¥–∞–ª—è—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –º–æ–∂–µ—Ç —Ç–æ–ª—å–∫–æ –∞–¥–º–∏–Ω ‚Äî –∫–æ–Ω—Ç—Ä–æ–ª–∏—Ä—É–µ—Ç—Å—è permissions.
"""
super().perform_destroy(instance)
@action(detail=False, methods=["get", "patch"], url_path="me")
def me(self, request):
"""
–ü—Ä–æ—Ñ–∏–ª—å —Ç–µ–∫—É—â–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.
GET ‚Äî –ø–æ–ª—É—á–∏—Ç—å; PATCH ‚Äî –æ–±–Ω–æ–≤–∏—Ç—å email/—Ç–µ–ª–µ—Ñ–æ–Ω.
"""
if request.method.lower() == "get":
serializer = UserProfileSerializer(request.user)
return Response(serializer.data)
serializer = UserProfileSerializer(
request.user, data=request.data, partial=True
)
serializer.is_valid(raise_exception=True)
serializer.save()
return Response(serializer.data)
@action(detail=False, methods=["post"], url_path="register")
def register(self, request):
"""
–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è —á–µ—Ä–µ–∑ API.
"""
serializer = RegisterSerializer(data=request.data)
serializer.is_valid(raise_exception=True)
user: User = serializer.save()
auth_login(request, user)
data = UserProfileSerializer(user).data
return Response(data, status=status.HTTP_201_CREATED)
@action(detail=False, methods=["post"], url_path="login")
def login(self, request):
"""
–õ–æ–≥–∏–Ω —á–µ—Ä–µ–∑ API. –ò—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–µ Django-—Å–µ—Å—Å–∏–∏.
"""
serializer = LoginSerializer(data=request.data)
serializer.is_valid(raise_exception=True)
user: User = serializer.validated_data["user"]
auth_login(request, user)
data = UserProfileSerializer(user).data
return Response(data, status=status.HTTP_200_OK)
@action(detail=False, methods=["post"], url_path="logout")
def logout(self, request):
"""
–õ–æ–≥–∞—É—Ç —á–µ—Ä–µ–∑ API (–æ—á–∏—Å—Ç–∫–∞ —Å–µ—Å—Å–∏–∏).
"""
auth_logout(request)
return Response(
{"detail": "–í—ã –≤—ã—à–ª–∏ –∏–∑ —Å–∏—Å—Ç–µ–º—ã."}, status=status.HTTP_200_OK
)
@action(detail=False, methods=["post"], url_path="change-password")
def change_password(self, request):
"""
–°–º–µ–Ω–∞ –ø–∞—Ä–æ–ª—è —Ç–µ–∫—É—â–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (API).
"""
serializer = ChangePasswordSerializer(
data=request.data, context={"request": request}
)
serializer.is_valid(raise_exception=True)
serializer.save()
return Response(
{"detail": "–ü–∞—Ä–æ–ª—å —É—Å–ø–µ—à–Ω–æ –∏–∑–º–µ–Ω—ë–Ω."},
status=status.HTTP_200_OK,
)
@action(detail=False, methods=["post"], url_path="reset-password")
def reset_password(self, request):
"""
–ó–∞–ø—Ä–æ—Å –Ω–∞ —Å–±—Ä–æ—Å –ø–∞—Ä–æ–ª—è –ø–æ email (API).
–ò—Å–ø–æ–ª—å–∑—É–µ—Ç —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π PasswordResetForm –∏ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –ø–∏—Å—å–º–æ
—á–µ—Ä–µ–∑ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–Ω—ã–π EMAIL_BACKEND.
"""
serializer = PasswordResetRequestSerializer(data=request.data)
serializer.is_valid(raise_exception=True)
email = serializer.validated_data["email"]
form = PasswordResetForm(data={"email": email})
if form.is_valid():
form.save(
request=request,
use_https=request.is_secure(),
email_template_name="accounts/password_reset_email.txt",
subject_template_name="accounts/password_reset_subject.txt",
)
# –ù–µ–∑–∞–≤–∏—Å–∏–º–æ –æ—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞ –≥–æ–≤–æ—Ä–∏–º –æ–¥–Ω–æ –∏ —Ç–æ –∂–µ, —á—Ç–æ–±—ã –Ω–µ —Ä–∞—Å–∫—Ä—ã–≤–∞—Ç—å,
# —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å —Ç–∞–∫–∏–º email.
return Response(
{
"detail": (
"–ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å —Ç–∞–∫–∏–º email —Å—É—â–µ—Å—Ç–≤—É–µ—Ç, –Ω–∞ –Ω–µ–≥–æ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∞ "
"–∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—è –ø–æ —Å–±—Ä–æ—Å—É –ø–∞—Ä–æ–ª—è."
)
},
status=status.HTTP_200_OK,
)
class TokenObtainPairView(APIView):
"""JWT-–∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è –ø–æ –ª–æ–≥–∏–Ω—É/email/—Ç–µ–ª–µ—Ñ–æ–Ω—É.
–í–æ–∑–≤—Ä–∞—â–∞–µ—Ç –ø–∞—Ä—É access/refresh —Ç–æ–∫–µ–Ω–æ–≤ –∏ —É–ø—Ä–æ—â–∞–µ—Ç –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—é —Å –º–æ–±–∏–ª—å–Ω—ã–º–∏
–∫–ª–∏–µ–Ω—Ç–∞–º–∏ –∏ PWA. –í–∞–ª–∏–¥–∞—Ü–∏—è –∏ –∞–Ω—Ç–∏-–±—Ä—É—Ç—Ñ–æ—Ä—Å –æ—Å—Ç–∞—é—Ç—Å—è –≤ LoginSerializer.
"""
permission_classes = [permissions.AllowAny]
def post(self, request, *args, **kwargs):
serializer = LoginSerializer(data=request.data)
serializer.is_valid(raise_exception=True)
user = serializer.validated_data["user"]
refresh = RefreshToken.for_user(user)
return Response(
{
"access": str(refresh.access_token),
"refresh": str(refresh),
"user": UserProfileSerializer(user).data,
},
status=status.HTTP_200_OK,
)
class TokenRefreshSlidingView(TokenRefreshView):
"""–£–ø–∞–∫–æ–≤—ã–≤–∞–µ–º refresh endpoint –≤ –µ–¥–∏–Ω—ã–π namespace accounts."""
permission_classes = [permissions.AllowAny]
class AuthOTPRequestView(APIView):
"""
POST /api/auth/request-code
identifier: email/phone, purpose: login/register/reset_password
"""
permission_classes = [permissions.AllowAny]
def post(self, request, *args, **kwargs):
serializer = OTPRequestSerializer(data=request.data)
serializer.is_valid(raise_exception=True)
identifier = serializer.validated_data["identifier"]
purpose = serializer.validated_data["purpose"]
# –ù–∞—Ö–æ–¥–∏–º –∏–ª–∏ —Å–æ–∑–¥–∞—ë–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –¥–ª—è —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏
user = find_user_by_identifier(identifier)
if purpose == LoginCode.Purpose.REGISTER and user is None:
# –°–æ–∑–¥–∞—ë–º "—Å—ã—Ä–æ–≥–æ" –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è —Å —Ä–∞–Ω–¥–æ–º–Ω—ã–º username
username = f"user_{get_random_string(8)}"
user = User.objects.create(username=username, is_active=True)
if "@" in identifier:
user.email_plain = identifier
else:
user.phone_plain = identifier
user.save()
if user is None:
# –î–ª—è login/reset_password –Ω–µ —Ä–∞—Å–∫—Ä—ã–≤–∞–µ–º —Ñ–∞–∫—Ç –æ—Ç—Å—É—Ç—Å—Ç–≤–∏—è –∞–∫–∫–∞—É–Ω—Ç–∞
return Response(status=status.HTTP_204_NO_CONTENT)
# –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º –∫–æ–¥ –∏ —Ö—ç—à–∏—Ä—É–µ–º –µ–≥–æ
raw_code = get_random_string(6, allowed_chars="0123456789")
code_hash = hash_email(raw_code)
expires_at = timezone.now() + timezone.timedelta(minutes=10)
LoginCode.objects.create(
user=user,
channel=LoginCode.Channel.EMAIL if "@" in identifier else LoginCode.Channel.PHONE,
purpose=purpose,
code_hash=code_hash,
expires_at=expires_at,
)
# –û—Ç–ø—Ä–∞–≤–∫–∞ –∫–æ–¥–∞ (–¥–ª—è SMS —Ç—É—Ç –±—É–¥–µ—Ç –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å –ø—Ä–æ–≤–∞–π–¥–µ—Ä–æ–º)
if "@" in identifier:
send_mail(
subject="–í–∞—à –∫–æ–¥ ParkShare",
message=f"–í–∞—à –∫–æ–¥ –≤—Ö–æ–¥–∞: {raw_code} (–¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª–µ–Ω 10 –º–∏–Ω—É—Ç).",
from_email=None,
recipient_list=[identifier],
fail_silently=True,
)
# –î–ª—è –¥–µ–º–æ –≤–æ–∑–≤—Ä–∞—â–∞–µ–º 204 –±–µ–∑ —Ç–µ–ª–∞
return Response(status=status.HTTP_204_NO_CONTENT)
class AuthOTPVerifyView(APIView):
"""
POST /api/auth/verify-code
identifier + code ‚Üí –ª–æ–≥–∏–Ω (session + JWT).
"""
permission_classes = [permissions.AllowAny]
def post(self, request, *args, **kwargs):
serializer = OTPVerifySerializer(data=request.data)
serializer.is_valid(raise_exception=True)
identifier = serializer.validated_data["identifier"]
code = serializer.validated_data["code"]
purpose = serializer.validated_data["purpose"]
user = find_user_by_identifier(identifier)
if user is None:
return Response({"detail": "–ù–µ–≤–µ—Ä–Ω—ã–π –∫–æ–¥ –∏–ª–∏ –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä."}, status=status.HTTP_400_BAD_REQUEST)
code_hash = hash_email(code)
qs = LoginCode.objects.filter(
user=user,
purpose=purpose,
is_used=False,
).order_by("-created_at")
code_obj = qs.first()
if not code_obj or code_obj.code_hash != code_hash or code_obj.is_expired:
return Response({"detail": "–ù–µ–≤–µ—Ä–Ω—ã–π –∏–ª–∏ –ø—Ä–æ—Å—Ä–æ—á–µ–Ω–Ω—ã–π –∫–æ–¥."}, status=status.HTTP_400_BAD_REQUEST)
code_obj.is_used = True
code_obj.save(update_fields=["is_used", "updated_at"])
# –õ–æ–≥–∏–Ω–∏–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (session + JWT)
auth_login_session(request, user)
refresh = RefreshToken.for_user(user)
return Response(
{
"access": str(refresh.access_token),
"refresh": str(refresh),
},
status=status.HTTP_200_OK,
)

# File 28/160: accounts\migrations\0001_initial.py
################################################################################

# Generated by Django 5.2.8 on 2025-11-21 21:34
import django.contrib.auth.models
import django.contrib.auth.validators
import django.utils.timezone
import django_cryptography.fields
import uuid
from django.db import migrations, models
class Migration(migrations.Migration):
initial = True
dependencies = [
('auth', '0012_alter_user_first_name_max_length'),
]
operations = [
migrations.CreateModel(
name='User',
fields=[
('password', models.CharField(max_length=128, verbose_name='password')),
('last_login', models.DateTimeField(blank=True, null=True, verbose_name='last login')),
('is_superuser', models.BooleanField(default=False, help_text='Designates that this user has all permissions without explicitly assigning them.', verbose_name='superuser status')),
('username', models.CharField(error_messages={'unique': 'A user with that username already exists.'}, help_text='Required. 150 characters or fewer. Letters, digits and @/./+/-/_ only.', max_length=150, unique=True, validators=[django.contrib.auth.validators.UnicodeUsernameValidator()], verbose_name='username')),
('first_name', models.CharField(blank=True, max_length=150, verbose_name='first name')),
('last_name', models.CharField(blank=True, max_length=150, verbose_name='last name')),
('email', models.EmailField(blank=True, max_length=254, verbose_name='email address')),
('is_staff', models.BooleanField(default=False, help_text='Designates whether the user can log into this admin site.', verbose_name='staff status')),
('is_active', models.BooleanField(default=True, help_text='Designates whether this user should be treated as active. Unselect this instead of deleting accounts.', verbose_name='active')),
('date_joined', models.DateTimeField(default=django.utils.timezone.now, verbose_name='date joined')),
('id', models.UUIDField(default=uuid.uuid4, editable=False, primary_key=True, serialize=False)),
('role', models.CharField(choices=[('driver', '–í–æ–¥–∏—Ç–µ–ª—å'), ('owner', '–í–ª–∞–¥–µ–ª–µ—Ü –ø–∞—Ä–∫–æ–≤–∫–∏'), ('admin', '–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä')], default='driver', help_text='–û–ø—Ä–µ–¥–µ–ª—è–µ—Ç –ø—Ä–∞–≤–∞ –¥–æ—Å—Ç—É–ø–∞ –≤ —Å–∏—Å—Ç–µ–º–µ.', max_length=16, verbose_name='–†–æ–ª—å')),
('email_encrypted', django_cryptography.fields.encrypt(models.EmailField(blank=True, help_text='–û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–π email, —Ö—Ä–∞–Ω–∏—Ç—Å—è –≤ –∑–∞—à–∏—Ñ—Ä–æ–≤–∞–Ω–Ω–æ–º –≤–∏–¥–µ.', max_length=254, null=True, verbose_name='Email (–∑–∞—à–∏—Ñ—Ä–æ–≤–∞–Ω–Ω—ã–π)'))),
('phone_encrypted', django_cryptography.fields.encrypt(models.CharField(blank=True, help_text='–û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–π —Ç–µ–ª–µ—Ñ–æ–Ω, —Ö—Ä–∞–Ω–∏—Ç—Å—è –≤ –∑–∞—à–∏—Ñ—Ä–æ–≤–∞–Ω–Ω–æ–º –≤–∏–¥–µ.', max_length=32, null=True, verbose_name='–¢–µ–ª–µ—Ñ–æ–Ω (–∑–∞—à–∏—Ñ—Ä–æ–≤–∞–Ω–Ω—ã–π)'))),
('owner_request_pending', models.BooleanField(default=False, help_text='–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø–æ–¥–∞–ª –∑–∞—è–≤–∫—É –Ω–∞ —Ä–æ–ª—å –≤–ª–∞–¥–µ–ª—å—Ü–∞ –ø–∞—Ä–∫–æ–≤–∫–∏.', verbose_name='–ó–∞–ø—Ä–æ—à–µ–Ω–æ –ø–æ–≤—ã—à–µ–Ω–∏–µ –¥–æ –≤–ª–∞–¥–µ–ª—å—Ü–∞')),
('groups', models.ManyToManyField(blank=True, help_text='The groups this user belongs to. A user will get all permissions granted to each of their groups.', related_name='user_set', related_query_name='user', to='auth.group', verbose_name='groups')),
('user_permissions', models.ManyToManyField(blank=True, help_text='Specific permissions for this user.', related_name='user_set', related_query_name='user', to='auth.permission', verbose_name='user permissions')),
],
options={
'verbose_name': '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å',
'verbose_name_plural': '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏',
},
managers=[
('objects', django.contrib.auth.models.UserManager()),
],
),
]

# File 29/160: accounts\migrations\0002_user_email_hash_user_phone_hash_logincode.py
################################################################################

# Generated by Django 5.2.8 on 2025-11-23 15:00
import django.db.models.deletion
import uuid
from django.conf import settings
from django.db import migrations, models
class Migration(migrations.Migration):
dependencies = [
('accounts', '0001_initial'),
]
operations = [
migrations.AddField(
model_name='user',
name='email_hash',
field=models.CharField(blank=True, db_index=True, help_text='–ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ –¥–ª—è –ø–æ–∏—Å–∫–∞ –∏ –ø—Ä–æ–≤–µ—Ä–∫–∏ —É–Ω–∏–∫–∞–ª—å–Ω–æ—Å—Ç–∏ email.', max_length=64, verbose_name='–•—ç—à –Ω–æ—Ä–º–∞–ª–∏–∑–æ–≤–∞–Ω–Ω–æ–≥–æ email'),
),
migrations.AddField(
model_name='user',
name='phone_hash',
field=models.CharField(blank=True, db_index=True, help_text='–ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ –¥–ª—è –ø–æ–∏—Å–∫–∞ –∏ –ø—Ä–æ–≤–µ—Ä–∫–∏ —É–Ω–∏–∫–∞–ª—å–Ω–æ—Å—Ç–∏ —Ç–µ–ª–µ—Ñ–æ–Ω–∞.', max_length=64, verbose_name='–•—ç—à –Ω–æ—Ä–º–∞–ª–∏–∑–æ–≤–∞–Ω–Ω–æ–≥–æ —Ç–µ–ª–µ—Ñ–æ–Ω–∞'),
),
migrations.CreateModel(
name='LoginCode',
fields=[
('created_at', models.DateTimeField(auto_now_add=True, verbose_name='–î–∞—Ç–∞ —Å–æ–∑–¥–∞–Ω–∏—è')),
('updated_at', models.DateTimeField(auto_now=True, verbose_name='–î–∞—Ç–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è')),
('id', models.UUIDField(default=uuid.uuid4, editable=False, primary_key=True, serialize=False)),
('channel', models.CharField(choices=[('email', 'Email'), ('phone', '–¢–µ–ª–µ—Ñ–æ–Ω')], max_length=16, verbose_name='–ö–∞–Ω–∞–ª')),
('purpose', models.CharField(choices=[('register', '–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è'), ('login', '–í—Ö–æ–¥'), ('reset_password', '–°–±—Ä–æ—Å –ø–∞—Ä–æ–ª—è')], max_length=32, verbose_name='–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ')),
('code_hash', models.CharField(db_index=True, max_length=128, verbose_name='–•—ç—à –∫–æ–¥–∞')),
('expires_at', models.DateTimeField(verbose_name='–ò—Å—Ç–µ–∫–∞–µ—Ç –≤')),
('is_used', models.BooleanField(default=False, verbose_name='–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω')),
('user', models.ForeignKey(on_delete=django.db.models.deletion.CASCADE, related_name='login_codes', to=settings.AUTH_USER_MODEL)),
],
options={
'verbose_name': '–ö–æ–¥ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è',
'verbose_name_plural': '–ö–æ–¥—ã –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è',
'indexes': [models.Index(fields=['user', 'purpose', 'is_used'], name='accounts_lo_user_id_024bc5_idx')],
},
),
]

# File 30/160: accounts\migrations\0003_userlevel_userbadge_promoreward.py
################################################################################

import uuid
from django.db import migrations, models
import django.db.models.deletion
class Migration(migrations.Migration):
dependencies = [
('accounts', '0002_user_email_hash_user_phone_hash_logincode'),
]
operations = [
migrations.CreateModel(
name='UserLevel',
fields=[
('id', models.UUIDField(default=uuid.uuid4, editable=False, primary_key=True, serialize=False)),
('created_at', models.DateTimeField(auto_now_add=True, verbose_name='–î–∞—Ç–∞ —Å–æ–∑–¥–∞–Ω–∏—è')),
('updated_at', models.DateTimeField(auto_now=True, verbose_name='–î–∞—Ç–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è')),
('name', models.CharField(max_length=64)),
('threshold', models.PositiveIntegerField(default=0, help_text='–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∑–∞–≤–µ—Ä—à—ë–Ω–Ω—ã—Ö –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–π –¥–ª—è —É—Ä–æ–≤–Ω—è')),
('description', models.TextField(blank=True)),
],
options={
'verbose_name': '–£—Ä–æ–≤–µ–Ω—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è',
'verbose_name_plural': '–£—Ä–æ–≤–Ω–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π',
'ordering': ('threshold',),
},
),
migrations.CreateModel(
name='PromoReward',
fields=[
('id', models.UUIDField(default=uuid.uuid4, editable=False, primary_key=True, serialize=False)),
('created_at', models.DateTimeField(auto_now_add=True, verbose_name='–î–∞—Ç–∞ —Å–æ–∑–¥–∞–Ω–∏—è')),
('updated_at', models.DateTimeField(auto_now=True, verbose_name='–î–∞—Ç–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è')),
('code', models.CharField(max_length=32, unique=True)),
('description', models.TextField(blank=True)),
('active', models.BooleanField(default=True)),
('usage_limit', models.PositiveIntegerField(default=1)),
],
options={
'verbose_name': '–ü—Ä–æ–º–æ/–±–æ–Ω—É—Å',
'verbose_name_plural': '–ü—Ä–æ–º–æ/–±–æ–Ω—É—Å—ã',
},
),
migrations.CreateModel(
name='UserBadge',
fields=[
('id', models.UUIDField(default=uuid.uuid4, editable=False, primary_key=True, serialize=False)),
('created_at', models.DateTimeField(auto_now_add=True, verbose_name='–î–∞—Ç–∞ —Å–æ–∑–¥–∞–Ω–∏—è')),
('updated_at', models.DateTimeField(auto_now=True, verbose_name='–î–∞—Ç–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è')),
('title', models.CharField(max_length=128)),
('description', models.TextField(blank=True)),
('icon', models.CharField(blank=True, max_length=64)),
('level', models.ForeignKey(blank=True, null=True, on_delete=django.db.models.deletion.SET_NULL, related_name='badges', to='accounts.userlevel')),
('user', models.ForeignKey(on_delete=django.db.models.deletion.CASCADE, related_name='badges', to='accounts.user', verbose_name='–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å')),
],
options={
'verbose_name': '–ë–µ–π–¥–∂',
'verbose_name_plural': '–ë–µ–π–¥–∂–∏',
'ordering': ('-created_at',),
},
),
]

# File 31/160: accounts\migrations\__init__.py
################################################################################



# File 32/160: ai\__init__.py
################################################################################

default_app_config = "ai.apps.AiConfig"

# File 33/160: ai\admin.py
################################################################################

from django.contrib import admin
from .models import ChatFeedback, ChatMessage, ChatSession, DeviceProfile, UiEvent
@admin.register(DeviceProfile)
class DeviceProfileAdmin(admin.ModelAdmin):
list_display = ("device_id", "user", "layout_profile", "theme", "created_at")
search_fields = ("device_id", "user__username")
@admin.register(UiEvent)
class UiEventAdmin(admin.ModelAdmin):
list_display = ("event_type", "device_profile", "created_at")
list_filter = ("event_type",)
@admin.register(ChatSession)
class ChatSessionAdmin(admin.ModelAdmin):
list_display = ("id", "user", "created_at", "last_activity_at")
search_fields = ("id", "user__username")
@admin.register(ChatMessage)
class ChatMessageAdmin(admin.ModelAdmin):
list_display = ("session", "role", "created_at")
list_filter = ("role",)
search_fields = ("text",)
@admin.register(ChatFeedback)
class ChatFeedbackAdmin(admin.ModelAdmin):
list_display = ("message", "rating", "created_at")
list_filter = ("rating",)

# File 34/160: ai\apps.py
################################################################################

from django.apps import AppConfig
class AiConfig(AppConfig):
default_auto_field = "django.db.models.BigAutoField"
# –í–ê–ñ–ù–û: –∑–¥–µ—Å—å –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å —Ä–µ–∞–ª—å–Ω—ã–π –ø—É—Ç—å –¥–æ –ø–∞–∫–µ—Ç–∞ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
# –ü–∞–ø–∫–∞ –Ω–∞–∑—ã–≤–∞–µ—Ç—Å—è "ai", –ª–µ–∂–∏—Ç –≤ –∫–æ—Ä–Ω–µ –ø—Ä–æ–µ–∫—Ç–∞ -> name = "ai"
name = "ai"
verbose_name = "AI –∏ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ ParkShare"

# File 35/160: ai\features.py
################################################################################

from __future__ import annotations
import pandas as pd
from parking.models import Booking
def bookings_dataframe() -> pd.DataFrame:
"""
–°–æ–±–∏—Ä–∞–µ—Ç –∏—Å—Ç–æ—Ä–∏—é –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–π –≤ DataFrame –¥–ª—è –æ–±—É—á–µ–Ω–∏—è/–∞–Ω–∞–ª–∏—Ç–∏–∫–∏.
"""
qs = Booking.objects.filter(
status__in=[
Booking.Status.CONFIRMED,
Booking.Status.ACTIVE,
Booking.Status.COMPLETED,
]
).select_related("spot", "spot__lot")
rows = []
for b in qs:
rows.append(
{
"booking_id": str(b.id),
"spot_id": str(b.spot_id),
"lot_id": str(b.spot.lot_id),
"city": b.spot.lot.city,
"start": b.start_at,
"end": b.end_at,
"duration_hours": (b.end_at - b.start_at).total_seconds() / 3600.0,
"price": float(b.total_price),
"dow": b.start_at.weekday(),
"hour": b.start_at.hour,
}
)
if not rows:
return pd.DataFrame()
df = pd.DataFrame(rows)
df["is_weekend"] = df["dow"] >= 5
return df

# File 36/160: ai\models.py
################################################################################

# ai/models.py
from __future__ import annotations
from django.conf import settings
from django.db import models
from django.utils.translation import gettext_lazy as _
from core.models import TimeStampedModel, TimeStampedUUIDModel
class DeviceProfile(TimeStampedUUIDModel):
"""
–ü—Ä–æ—Ñ–∏–ª—å —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞/–∫–ª–∏–µ–Ω—Ç–∞ –¥–ª—è –∞–¥–∞–ø—Ç–∏–≤–Ω–æ–≥–æ UI.
–°–≤—è–∑–∞–Ω –ª–∏–±–æ —Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º, –ª–∏–±–æ —Å –∞–Ω–æ–Ω–∏–º–Ω—ã–º device_id (–∏–∑ cookies/LS).
"""
class LayoutProfile(models.TextChoices):
COMPACT = "compact", _("–ö–æ–º–ø–∞–∫—Ç–Ω—ã–π")
COMFORTABLE = "comfortable", _("–ö–æ–º—Ñ–æ—Ä—Ç–Ω—ã–π")
class Theme(models.TextChoices):
LIGHT = "light", _("–°–≤–µ—Ç–ª–∞—è")
DARK = "dark", _("–¢—ë–º–Ω–∞—è")
SYSTEM = "system", _("–°–∏—Å—Ç–µ–º–Ω–∞—è")
user = models.ForeignKey(
settings.AUTH_USER_MODEL,
on_delete=models.SET_NULL,
null=True,
blank=True,
related_name="device_profiles",
)
device_id = models.CharField(
_("ID —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞"),
max_length=64,
db_index=True,
)
viewport_width = models.IntegerField(_("–®–∏—Ä–∏–Ω–∞ viewport"), null=True, blank=True)
viewport_height = models.IntegerField(_("–í—ã—Å–æ—Ç–∞ viewport"), null=True, blank=True)
pixel_ratio = models.FloatField(_("Pixel ratio"), null=True, blank=True)
user_agent = models.TextField(_("User‚ÄëAgent"), blank=True)
layout_profile = models.CharField(
_("–ü—Ä–æ—Ñ–∏–ª—å –∫–æ–º–ø–æ–Ω–æ–≤–∫–∏"),
max_length=32,
choices=LayoutProfile.choices,
default=LayoutProfile.COMPACT,
)
theme = models.CharField(
_("–¢–µ–º–∞"),
max_length=16,
choices=Theme.choices,
default=Theme.SYSTEM,
)
class Meta:
verbose_name = _("–ü—Ä–æ—Ñ–∏–ª—å —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞")
verbose_name_plural = _("–ü—Ä–æ—Ñ–∏–ª–∏ —É—Å—Ç—Ä–æ–π—Å—Ç–≤")
unique_together = ("device_id", "user")
def __str__(self) -> str:
return f"DeviceProfile({self.device_id}, {self.layout_profile})"
class UiEvent(TimeStampedUUIDModel):
"""
–°—ã—Ä—ã–µ —Å–æ–±—ã—Ç–∏—è UI/–∞–¥–∞–ø—Ç–∏–≤–Ω–æ—Å—Ç–∏ (scroll, resize, layout_probe –∏ —Ç.–ø.).
"""
device_profile = models.ForeignKey(
DeviceProfile,
on_delete=models.CASCADE,
related_name="events",
)
event_type = models.CharField(_("–¢–∏–ø —Å–æ–±—ã—Ç–∏—è"), max_length=64)
payload = models.JSONField(_("Payload"), null=True, blank=True)
class Meta:
verbose_name = _("UI‚Äë—Å–æ–±—ã—Ç–∏–µ")
verbose_name_plural = _("UI‚Äë—Å–æ–±—ã—Ç–∏—è")
def __str__(self) -> str:
return f"UiEvent({self.event_type})"
class ChatSession(TimeStampedUUIDModel):
"""–°–µ—Å—Å–∏—è —á–∞—Ç–∞ (cookie ps_chat_sid)."""
user = models.ForeignKey(
settings.AUTH_USER_MODEL,
on_delete=models.SET_NULL,
null=True,
blank=True,
related_name="chat_sessions",
)
client_info = models.JSONField("–î–∞–Ω–Ω—ã–µ –∫–ª–∏–µ–Ω—Ç–∞", null=True, blank=True)
last_activity_at = models.DateTimeField("–ü–æ—Å–ª–µ–¥–Ω—è—è –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å", auto_now=True)
class Meta:
verbose_name = "–°–µ—Å—Å–∏—è —á–∞—Ç–∞"
verbose_name_plural = "–°–µ—Å—Å–∏–∏ —á–∞—Ç–∞"
def __str__(self) -> str:
return f"ChatSession({self.id})"
class ChatMessage(TimeStampedModel):
"""–°–æ–æ–±—â–µ–Ω–∏—è –≤ —Ä–∞–º–∫–∞—Ö —Å–µ—Å—Å–∏–∏."""
class Role(models.TextChoices):
USER = "user", "User"
ASSISTANT = "assistant", "Assistant"
session = models.ForeignKey(
ChatSession,
on_delete=models.CASCADE,
related_name="messages",
)
role = models.CharField("–†–æ–ª—å", max_length=16, choices=Role.choices)
text = models.TextField("–¢–µ–∫—Å—Ç")
meta = models.JSONField("–ú–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ", null=True, blank=True)
class Meta:
verbose_name = "–°–æ–æ–±—â–µ–Ω–∏–µ —á–∞—Ç–∞"
verbose_name_plural = "–°–æ–æ–±—â–µ–Ω–∏—è —á–∞—Ç–∞"
ordering = ("-created_at",)
def __str__(self) -> str:
return f"[{self.role}] {self.text[:30]}"
class ChatFeedback(TimeStampedModel):
"""–û—Ü–µ–Ω–∫–∏ –æ—Ç–≤–µ—Ç–æ–≤ –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç–∞."""
message = models.ForeignKey(
ChatMessage,
on_delete=models.CASCADE,
related_name="feedback",
)
rating = models.IntegerField("–û—Ü–µ–Ω–∫–∞", default=0)
class Meta:
verbose_name = "–§–∏–¥–±–µ–∫ —á–∞—Ç–∞"
verbose_name_plural = "–§–∏–¥–±–µ–∫ —á–∞—Ç–∞"
ordering = ("-created_at",)
def __str__(self) -> str:
return f"Feedback({self.rating})"

# File 37/160: ai\orchestrator.py
################################################################################

from __future__ import annotations
from decimal import Decimal
from typing import Any, Dict
from django.utils import timezone
from ai.pricing import recommend_price_for_spot
class PricingDecision:
def __init__(self, payload: Dict[str, Any]):
self.payload = payload
@property
def price(self) -> Decimal:
return Decimal(str(self.payload.get("recommended_price", 0)))
def to_dict(self) -> Dict[str, Any]:
return self.payload
class AvailabilityDecision:
def __init__(self, payload: Dict[str, Any]):
self.payload = payload
def to_dict(self) -> Dict[str, Any]:
return self.payload
def apply_ai_pricing(booking) -> PricingDecision | None:
"""–ü–æ–¥–∫–ª—é—á–∞–µ—Ç ML/GBM –º–æ–¥–µ–ª—å –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–æ–≥–æ —Ü–µ–Ω–æ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏—è.
–î–ª—è MVP –∏—Å–ø–æ–ª—å–∑—É–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â—É—é recommend_price_for_spot, –Ω–æ —Å–æ—Ö—Ä–∞–Ω—è–µ–º
–ø–æ–ª–Ω—É—é —Å—Ç—Ä—É–∫—Ç—É—Ä—É –¥–ª—è –±—É–¥—É—â–∏—Ö CatBoost/GBM –º–æ–¥–µ–ª–µ–π (ParkMate).
"""
suggestion = recommend_price_for_spot(booking.spot)
if not suggestion:
return None
hours = max(Decimal("1"), Decimal((booking.end_at - booking.start_at).total_seconds()) / Decimal(3600))
base_total = Decimal(str(booking.total_price))
ai_hour_price = Decimal(str(suggestion["recommended_price"]))
ai_total = (ai_hour_price * hours).quantize(Decimal("0.01"))
booking.total_price = ai_total
booking.dynamic_pricing_applied = True
booking.ai_snapshot = {
"pricing": suggestion,
"calculated_at": timezone.now().isoformat(),
}
return PricingDecision({
**suggestion,
"applied_total": str(ai_total),
"hours": str(hours),
})
def attach_availability_forecast(booking, forecast: Dict[str, Any] | None = None) -> None:
if forecast:
booking.ai_snapshot = {
**(booking.ai_snapshot or {}),
"availability": forecast,
}

# File 38/160: ai\pricing.py
################################################################################

from __future__ import annotations
from pathlib import Path
from typing import Any, Dict, Optional
import joblib
import numpy as np
from django.conf import settings
from django.utils import timezone
from sklearn.ensemble import RandomForestRegressor
from core.utils import round_price
from parking.models import ParkingSpot
from .features import bookings_dataframe
MODEL_PATH = Path(getattr(settings, "BASE_DIR", ".")) / "ai_models" / "pricing_model.pkl"
def train_pricing_model(df=None) -> Optional[RandomForestRegressor]:
"""
–û–±—É—á–∞–µ—Ç –ø—Ä–æ—Å—Ç—É—é RandomForest-–º–æ–¥–µ–ª—å –¥–ª—è –æ—Ü–µ–Ω–∫–∏ —Ü–µ–Ω—ã –∑–∞ —á–∞—Å.
"""
if df is None:
df = bookings_dataframe()
if df.empty or len(df) < 20:
return None
df = df.copy()
df["price_per_hour"] = df["price"] / df["duration_hours"].clip(lower=0.5)
X = df[["hour", "dow", "is_weekend"]].values
y = df["price_per_hour"].values
model = RandomForestRegressor(
n_estimators=50,
random_state=42,
n_jobs=-1,
)
model.fit(X, y)
MODEL_PATH.parent.mkdir(parents=True, exist_ok=True)
joblib.dump(model, MODEL_PATH)
return model
def load_pricing_model() -> Optional[RandomForestRegressor]:
if not MODEL_PATH.exists():
return None
try:
model: RandomForestRegressor = joblib.load(MODEL_PATH)
return model
except Exception:
return None
def recommend_price_for_spot(spot: ParkingSpot) -> Optional[Dict[str, Any]]:
"""
–í–æ–∑–≤—Ä–∞—â–∞–µ—Ç –¥–∏–∞–ø–∞–∑–æ–Ω —Ä–µ–∫–æ–º–µ–Ω–¥–æ–≤–∞–Ω–Ω—ã—Ö —Ü–µ–Ω –¥–ª—è –≤–ª–∞–¥–µ–ª—å—Ü–∞ –º–µ—Å—Ç–∞.
–£—á–∏—Ç—ã–≤–∞–µ—Ç:
- –±–∞–∑–æ–≤—É—é —Ü–µ–Ω—É;
- –∑–∞–≥—Ä—É–∑–∫—É –º–µ—Å—Ç–∞ –∑–∞ 7 –¥–Ω–µ–π (occupancy_7d);
- (–ø–æ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏) –ø—Ä–µ–¥—Å–∫–∞–∑–∞–Ω–∏–µ ML‚Äë–º–æ–¥–µ–ª–∏.
"""
base_price = float(spot.hourly_price or 0.0)
if base_price <= 0:
return None
now = timezone.now()
features = np.array([[now.hour, now.weekday(), 1 if now.weekday() >= 5 else 0]])
model = load_pricing_model()
predicted = None
if model is not None:
try:
predicted_value = float(model.predict(features)[0])
if predicted_value > 0:
predicted = predicted_value
except Exception:
predicted = None
occupancy = float(getattr(spot, "occupancy_7d", 0.0) or 0.0)
factor = 1.0
reason_parts = []
if occupancy > 0.8:
factor += 0.15
reason_parts.append("–º–µ—Å—Ç–æ —á–∞—Å—Ç–æ –∑–∞–Ω—è—Ç–æ (–≤—ã—Å–æ–∫–∞—è –∑–∞–≥—Ä—É–∑–∫–∞)")
elif occupancy < 0.3:
factor -= 0.1
reason_parts.append("–º–µ—Å—Ç–æ –ø—Ä–æ—Å—Ç–∞–∏–≤–∞–µ—Ç (–Ω–∏–∑–∫–∞—è –∑–∞–≥—Ä—É–∑–∫–∞)")
if predicted is not None:
ai_price = round_price(predicted, step=5.0)
reason_parts.append("ML‚Äë–º–æ–¥–µ–ª—å —É—á–∏—Ç—ã–≤–∞–µ—Ç –∏—Å—Ç–æ—Ä–∏—á–µ—Å–∫–∏–µ —Ü–µ–Ω—ã –ø–æ —Ä–∞–π–æ–Ω—É")
else:
ai_price = base_price
recommended = round_price(ai_price * factor, step=5.0)
min_price = round_price(recommended * 0.9, step=5.0)
max_price = round_price(recommended * 1.1, step=5.0)
if not reason_parts:
reason_parts.append("–∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –±–∞–∑–æ–≤–∞—è —Å—Ç–∞–≤–∫–∞ –∏ —Å—Ä–µ–¥–Ω—è—è –∑–∞–≥—Ä—É–∑–∫–∞")
reason = "–ù–∞ –æ—Å–Ω–æ–≤–µ: " + "; ".join(reason_parts) + "."
return {
"base_price": base_price,
"recommended_price": recommended,
"min_price": min_price,
"max_price": max_price,
"reason": reason,
}

# File 39/160: ai\serializers.py
################################################################################



# File 40/160: ai\tasks.py
################################################################################

from __future__ import annotations
from datetime import timedelta
from celery import shared_task
from django.utils import timezone
from parking.models import Booking, ParkingLot, ParkingSpot
from .features import bookings_dataframe
from .pricing import train_pricing_model
@shared_task
def update_models() -> None:
"""
–ü–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–∏ –æ–±—É—á–∞–µ—Ç –º–æ–¥–µ–ª—å —Ü–µ–Ω –∏ –æ–±–Ω–æ–≤–ª—è–µ—Ç –º–µ—Ç—Ä–∏–∫–∏ –∑–∞–≥—Ä—É–∂–µ–Ω–Ω–æ—Å—Ç–∏.
–î–µ–ª–∞–µ—Ç —Ç—Ä–∏ –≤–µ—â–∏:
1) –æ–±—É—á–∞–µ—Ç/–ø–µ—Ä–µ–æ–±—É—á–∞–µ—Ç ML‚Äë–º–æ–¥–µ–ª—å —Ü–µ–Ω–æ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏—è;
2) —Å—á–∏—Ç–∞–µ—Ç occupancy_7d –¥–ª—è –∞–∫—Ç–∏–≤–Ω—ã—Ö –º–µ—Å—Ç;
3) —Å—á–∏—Ç–∞–µ—Ç stress_index –¥–ª—è –ø–∞—Ä–∫–æ–≤–æ–∫ (—Å—Ä–µ–¥–Ω—è—è –∑–∞–≥—Ä—É–∑–∫–∞ –º–µ—Å—Ç).
"""
df = bookings_dataframe()
train_pricing_model(df)
now = timezone.now()
window_start = now - timedelta(days=7)
# 1‚Äì2. –û–±–Ω–æ–≤–ª—è–µ–º occupancy_7d –¥–ª—è –º–µ—Å—Ç
active_spots = ParkingSpot.objects.filter(
status=ParkingSpot.SpotStatus.ACTIVE,
lot__is_active=True,
lot__is_approved=True,
).select_related("lot")
total_period_hours = 24 * 7
for spot in active_spots:
qs = Booking.objects.filter(
spot=spot,
start_at__lt=now,
end_at__gt=window_start,
status__in=[
Booking.Status.CONFIRMED,
Booking.Status.ACTIVE,
Booking.Status.COMPLETED,
],
)
booked_hours = 0.0
for b in qs:
start = max(b.start_at, window_start)
end = min(b.end_at, now)
delta_h = max((end - start).total_seconds() / 3600.0, 0.0)
booked_hours += delta_h
occupancy = booked_hours / float(total_period_hours)
spot.occupancy_7d = max(0.0, min(occupancy, 1.0))
spot.save(update_fields=["occupancy_7d"])
# 3. –ò–Ω–¥–µ–∫—Å –∑–∞–≥—Ä—É–∂–µ–Ω–Ω–æ—Å—Ç–∏ –ø–æ –æ–±—ä–µ–∫—Ç–∞–º –ø–∞—Ä–∫–æ–≤–∫–∏
lots = ParkingLot.objects.filter(is_active=True, is_approved=True)
for lot in lots:
spots = lot.spots.all()
if not spots:
lot.stress_index = 0.0
lot.save(update_fields=["stress_index"])
continue
values = [max(0.0, min(s.occupancy_7d, 1.0)) for s in spots]
lot.stress_index = sum(values) / len(values)
lot.save(update_fields=["stress_index"])

# File 41/160: ai\views.py
################################################################################

# backend/ai/views.py
from __future__ import annotations
import logging
from typing import Any
from uuid import UUID, uuid4
from asgiref.sync import async_to_sync
from django.utils import timezone
from rest_framework import status
from rest_framework.permissions import AllowAny
from rest_framework.response import Response
from rest_framework.views import APIView
from parking.models import ParkingLot, ParkingSpot
from ai.pricing import recommend_price_for_spot
from ai.models import ChatFeedback, ChatMessage, ChatSession, DeviceProfile, UiEvent
from ai.chat import generate_chat_reply
from services.llm import check_llm_health
logger = logging.getLogger(__name__)
class RecommendationsAPIView(APIView):
"""
–†–µ–∞–ª—å–Ω—ã–µ AI-—Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –ø–æ –ø–∞—Ä–∫–æ–≤–∫–∞–º.
–ü—Ä–∏–º–µ—Ä:
GET /api/ai/recommendations/?city=–ú–æ—Å–∫–≤–∞&limit=10
"""
def get(self, request, *args: Any, **kwargs: Any) -> Response:
city = request.query_params.get("city")
limit = int(request.query_params.get("limit", 10))
qs = ParkingSpot.objects.filter(
status=ParkingSpot.SpotStatus.ACTIVE,
lot__is_active=True,
lot__is_approved=True,
).select_related("lot")
if city:
qs = qs.filter(lot__city__iexact=city)
# –°–Ω–∞—á–∞–ª–∞ –±–µ—Ä—ë–º —Å–∞–º—ã–µ "–º–µ–Ω–µ–µ –∑–∞–≥—Ä—É–∂–µ–Ω–Ω—ã–µ" –∏ –¥–µ—à—ë–≤—ã–µ –º–µ—Å—Ç–∞
qs = qs.order_by("lot__stress_index", "hourly_price")[: limit * 2]
recommendations: list[dict[str, Any]] = []
now = timezone.now()
for spot in qs[:limit]:
try:
pricing = recommend_price_for_spot(spot)
except Exception:
pricing = None
rec: dict[str, Any] = {
"spot_id": str(spot.id),
"lot_id": str(spot.lot_id),
"lot_name": spot.lot.name,
"city": spot.lot.city,
"address": spot.lot.address,
"vehicle_type": spot.get_vehicle_type_display(),
"hourly_price": float(spot.hourly_price or 0),
"occupancy_7d": float(spot.occupancy_7d or 0.0),
"stress_index": float(spot.lot.stress_index or 0.0),
"is_covered": spot.is_covered,
"has_ev_charging": spot.has_ev_charging,
"is_24_7": spot.is_24_7,
"now": now,
}
if pricing:
rec.update(
{
"ai_recommended_hourly_price": float(
pricing.get("recommended_price", 0.0)
),
"ai_base_price": float(pricing.get("base_price", 0.0)),
"ai_min_price": float(pricing.get("min_price", 0.0)),
"ai_max_price": float(pricing.get("max_price", 0.0)),
"ai_reason": pricing.get("reason", ""),
"ai_discount_percent": float(
pricing.get("discount_percent") or 0.0
),
"ai_is_discount": bool(pricing.get("is_discount") or False),
}
)
recommendations.append(rec)
return Response(
{
"count": len(recommendations),
"results": recommendations,
},
status=status.HTTP_200_OK,
)
class StressIndexAPIView(APIView):
"""
–†–µ–∞–ª—å–Ω—ã–π –∏–Ω–¥–µ–∫—Å –∑–∞–≥—Ä—É–∂–µ–Ω–Ω–æ—Å—Ç–∏ –ø–æ –≥–æ—Ä–æ–¥–∞–º / –ø–∞—Ä–∫–æ–≤–∫–∞–º.
–ü—Ä–∏–º–µ—Ä:
GET /api/ai/stress-index/
GET /api/ai/stress-index/?city=–°–ü–±
"""
def get(self, request, *args: Any, **kwargs: Any) -> Response:
city = request.query_params.get("city")
lots_qs = ParkingLot.objects.filter(is_active=True, is_approved=True)
if city:
lots_qs = lots_qs.filter(city__iexact=city)
lots = list(
lots_qs.values(
"id",
"name",
"city",
"address",
"stress_index",
)
)
if not lots:
return Response(
{
"stress_index": 0.0,
"lots": [],
"details": "–ù–µ—Ç –∞–∫—Ç–∏–≤–Ω—ã—Ö –ø–∞—Ä–∫–æ–≤–æ–∫ –¥–ª—è –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ —Ñ–∏–ª—å—Ç—Ä–∞",
},
status=status.HTTP_200_OK,
)
values = [float(l["stress_index"] or 0.0) for l in lots]
avg = sum(values) / len(values)
max_val = max(values)
min_val = min(values)
return Response(
{
"stress_index": round(avg, 3),
"min": round(min_val, 3),
"max": round(max_val, 3),
"lots": lots,
},
status=status.HTTP_200_OK,
)
class DepartureAssistantAPIView(APIView):
"""
–ü—Ä–æ—Å—Ç–µ–π—à–∏–π –ø–æ–º–æ—â–Ω–∏–∫ –ø–æ –≤—Ä–µ–º–µ–Ω–∏ –≤—ã–µ–∑–¥–∞ (–ø–æ–∫–∞ –±–µ–∑ –≤–Ω–µ—à–Ω–∏—Ö API).
–ü—Ä–∏–Ω–∏–º–∞–µ—Ç:
POST /api/ai/departure-assistant/
{
"desired_arrival_iso": "2025-11-22T19:00:00+03:00",
"parking_buffer_minutes": 10,
"traffic_buffer_minutes": 20
}
"""
def post(self, request, *args: Any, **kwargs: Any) -> Response:
from datetime import timedelta
from django.utils.dateparse import parse_datetime
desired_arrival_iso = request.data.get("desired_arrival_iso")
parking_buffer = int(request.data.get("parking_buffer_minutes", 10))
traffic_buffer = int(request.data.get("traffic_buffer_minutes", 20))
if not desired_arrival_iso:
return Response(
{
"detail": "–ù—É–∂–µ–Ω –ø–∞—Ä–∞–º–µ—Ç—Ä desired_arrival_iso –≤ ISO-—Ñ–æ—Ä–º–∞—Ç–µ",
},
status=status.HTTP_400_BAD_REQUEST,
)
desired_arrival = parse_datetime(desired_arrival_iso)
if desired_arrival is None:
return Response(
{
"detail": "–ù–µ —É–¥–∞–ª–æ—Å—å —Ä–∞—Å–ø–∞—Ä—Å–∏—Ç—å desired_arrival_iso",
},
status=status.HTTP_400_BAD_REQUEST,
)
total_buffer = timedelta(
minutes=parking_buffer + traffic_buffer,
)
suggested_departure = desired_arrival - total_buffer
return Response(
{
"suggested_departure_time": suggested_departure,
"desired_arrival_time": desired_arrival,
"parking_buffer_minutes": parking_buffer,
"traffic_buffer_minutes": traffic_buffer,
"message": "–ü–æ–∫–∞ –±–µ–∑ –ø—Ä–æ–±–æ–∫/–ø–æ–≥–æ–¥—ã, –Ω–æ —É–∂–µ —Å—á–∏—Ç–∞–µ—Ç –±—É—Ñ–µ—Ä—ã –≤—Ä–µ–º–µ–Ω–∏.",
},
status=status.HTTP_200_OK,
)
class ParkingChatAPIView(APIView):
"""–ú–∏–Ω–∏-—á–∞—Ç–±–æ—Ç –¥–ª—è –ø–æ–¥—Å–∫–∞–∑–æ–∫ –ø–æ –ø–∞—Ä–∫–æ–≤–∫–µ."""
permission_classes = [AllowAny]
def post(self, request, *args, **kwargs):
data = request.data or {}
message = data.get("message") or ""
history = data.get("history") or []
logger.info(
"Parking chat API request",
extra={
"message": str(message)[:200],
"history_len": len(history),
"user": getattr(request.user, "id", None),
"ip": request.META.get("REMOTE_ADDR"),
"ua": request.META.get("HTTP_USER_AGENT"),
},
)
sid_raw = request.COOKIES.get("ps_chat_sid")
try:
sid = UUID(sid_raw) if sid_raw else uuid4()
except (ValueError, TypeError):
sid = uuid4()
session, _ = ChatSession.objects.get_or_create(
id=sid,
defaults={
"user": request.user if request.user.is_authenticated else None,
"client_info": {
"ua": request.META.get("HTTP_USER_AGENT"),
"ip": request.META.get("REMOTE_ADDR"),
},
},
)
if request.user.is_authenticated and session.user is None:
session.user = request.user
session.save(update_fields=["user", "last_activity_at"])
ChatMessage.objects.create(
session=session,
role=ChatMessage.Role.USER,
text=message,
meta={"history": history},
)
try:
logger.info(
"Parking chat request received",
extra={"message": message, "session": str(session.id)},
)
result = generate_chat_reply(
message,
history,
request.user if request.user.is_authenticated else None,
)
except Exception as exc:
logger.exception("Parking chat failed", exc_info=exc)
result = {
"reply": "–ò–∑–≤–∏–Ω–∏—Ç–µ, –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç –≤—Ä–µ–º–µ–Ω–Ω–æ –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω.",
"suggestions": [],
"reason": "assistant_error",
}
status_code = status.HTTP_503_SERVICE_UNAVAILABLE
else:
status_code = status.HTTP_200_OK
assistant_message = ChatMessage.objects.create(
session=session,
role=ChatMessage.Role.ASSISTANT,
text=result.get("reply", ""),
meta={"suggested_spots": result.get("suggestions", [])},
)
response = Response(
{
"reply": result.get("reply"),
"suggestions": result.get("suggestions", []),
"message_id": assistant_message.id,
"reason": result.get("reason"),
},
status=status_code,
)
response.set_cookie("ps_chat_sid", str(session.id), max_age=60 * 60 * 24 * 30, httponly=False)
return response
class LLMServiceHealthAPIView(APIView):
permission_classes = [AllowAny]
def get(self, request, *args, **kwargs):
try:
health = async_to_sync(check_llm_health)()
except Exception as exc:
logger.warning("LLM health check failed", exc_info=exc)
return Response(
{"ok": False, "detail": str(exc)},
status=status.HTTP_503_SERVICE_UNAVAILABLE,
)
return Response(health, status=status.HTTP_200_OK if health.get("ok") else status.HTTP_503_SERVICE_UNAVAILABLE)
class ChatFeedbackAPIView(APIView):
permission_classes = [AllowAny]
def post(self, request, *args, **kwargs):
message_id = request.data.get("message_id")
rating = int(request.data.get("rating", 0))
if message_id is None:
return Response({"detail": "message_id required"}, status=status.HTTP_400_BAD_REQUEST)
try:
message = ChatMessage.objects.get(id=message_id)
except ChatMessage.DoesNotExist:
return Response({"detail": "message not found"}, status=status.HTTP_404_NOT_FOUND)
feedback = ChatFeedback.objects.create(message=message, rating=rating)
return Response({"id": feedback.id, "rating": feedback.rating}, status=status.HTTP_201_CREATED)
# ===== ParkMate AI ‚Äî –∫–æ–Ω—Ñ–∏–≥ –∏ –ø—Ä–µ–¥—Å–∫–∞–∑–∞–Ω–∏—è (price/availability) =====
class ParkMateConfigAPIView(APIView):
"""
AI‚Äë–ø–æ–º–æ—â–Ω–∏–∫ –∞–¥–∞–ø—Ç–∏–≤–Ω–æ—Å—Ç–∏:
- –ø—Ä–∏–Ω–∏–º–∞–µ—Ç —Ç–µ–ª–µ–º–µ—Ç—Ä–∏—é –∫–ª–∏–µ–Ω—Ç–∞ (viewport, pixelRatio, platform);
- —Å–æ–∑–¥–∞—ë—Ç/–æ–±–Ω–æ–≤–ª—è–µ—Ç DeviceProfile;
- –∑–∞–ø–∏—Å—ã–≤–∞–µ—Ç UiEvent;
- –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç layout_profile / design_mode / theme.
"""
permission_classes = [AllowAny]
def post(self, request, *args: Any, **kwargs: Any) -> Response:
data = request.data or {}
client = data.get("client") or {}
action = data.get("action") or "adaptive-profile"
width = int(client.get("width") or 0)
height = int(client.get("height") or 0)
pixel_ratio = float(client.get("pixelRatio") or client.get("pixel_ratio") or 1.0)
platform = (client.get("platform") or "RU")[:8]
device_id = (request.COOKIES.get("ps_device_id") or client.get("deviceId") or "anonymous")[:64]
user_agent = request.META.get("HTTP_USER_AGENT", "")[:1024]
# –≠–≤—Ä–∏—Å—Ç–∏–∫–∞ layout‚Äë–ø—Ä–æ—Ñ–∏–ª—è
if width < 640:
layout = DeviceProfile.LayoutProfile.COMPACT
elif width < 1024:
layout = DeviceProfile.LayoutProfile.COMFORTABLE
else:
layout = DeviceProfile.LayoutProfile.COMFORTABLE
design_mode = "pwa" if width < 1024 else "desktop"
user = request.user if request.user.is_authenticated else None
profile, _ = DeviceProfile.objects.get_or_create(
device_id=device_id,
user=user,
defaults={
"viewport_width": width,
"viewport_height": height,
"pixel_ratio": pixel_ratio,
"user_agent": user_agent,
"layout_profile": layout,
},
)
# –û–±–Ω–æ–≤–ª—è–µ–º –æ—Å–Ω–æ–≤–Ω—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã
profile.viewport_width = width
profile.viewport_height = height
profile.pixel_ratio = pixel_ratio
profile.layout_profile = layout
profile.save(update_fields=["viewport_width", "viewport_height", "pixel_ratio", "layout_profile", "updated_at"])
UiEvent.objects.create(
device_profile=profile,
event_type=action,
payload={
"width": width,
"height": height,
"pixel_ratio": pixel_ratio,
"platform": platform,
},
)
return Response(
{
"layout_profile": layout,
"design_mode": design_mode,
"theme": profile.theme,
}
)
def get(self, request, *args: Any, **kwargs: Any) -> Response:
"""
–í–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Ñ—Ä–æ–Ω—Ç—É –∫–æ–Ω—Ñ–∏–≥ ParkMateAI (–∫–æ–Ω—Ç—Ä–∞–∫—Ç—ã/URL‚Äë—ã —Å–µ—Ä–≤–∏—Å–æ–≤).
–§–æ—Ä–º–∞—Ç —Å–æ–≥–ª–∞—Å–æ–≤–∞–Ω —Å static/js/parkmate-ai.ts (ParkMateAI).
"""
data = {
"voiceCommands": {
"booking": "–ó–∞–±—Ä–æ–Ω–∏—Ä–æ–≤–∞—Ç—å –ø–∞—Ä–∫–æ–≤–∫—É —Ä—è–¥–æ–º",
"navigation": "–ü–æ—Å—Ç—Ä–æ–∏—Ç—å –º–∞—Ä—à—Ä—É—Ç –¥–æ –ø–∞—Ä–∫–æ–≤–∫–∏",
"payment": "–û–ø–ª–∞—Ç–∏—Ç—å —Ç–µ–∫—É—â—É—é –ø–∞—Ä–∫–æ–≤–∫—É",
"support": "–°–≤—è–∑–∞—Ç—å—Å—è —Å –ø–æ–¥–¥–µ—Ä–∂–∫–æ–π ParkShare",
},
"computerVision": {
"licensePlateRecognition": "/api/ai/cv/license-plate/",
"parkingSpotDetection": "/api/ai/cv/parking-occupancy/",
"damageDetection": "/api/ai/cv/vehicle-damage/",
"occupancyAnalytics": "/api/ai/stress-index/",
},
"predictions": {
"arrivalTime": "/api/ai/departure-assistant/",
"priceForecast": "/api/ai/parkmate/price-forecast/",
"availability": "/api/ai/parkmate/availability/",
},
}
return Response(data, status=status.HTTP_200_OK)
# –û—Å—Ç–∞–ª—å–Ω—ã–µ –∫–ª–∞—Å—Å—ã (RecommendationsAPIView, StressIndexAPIView, DepartureAssistantAPIView,
# ParkMatePriceForecastAPIView, ParkMateAvailabilityForecastAPIView) –æ—Å—Ç–∞—é—Ç—Å—è –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π
class ParkMatePriceForecastAPIView(APIView):
"""
–≠–Ω–¥–ø–æ–∏–Ω—Ç ParkMate –¥–ª—è –ø—Ä–æ–≥–Ω–æ–∑–∞ —Ü–µ–Ω—ã –ø–æ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–º—É –º–µ—Å—Ç—É.
POST /api/ai/parkmate/price-forecast/
{
"spot_id": "uuid"
}
"""
permission_classes = [AllowAny]
def post(self, request, *args: Any, **kwargs: Any) -> Response:
from django.shortcuts import get_object_or_404
spot_id = request.data.get("spot_id")
if not spot_id:
return Response(
{"detail": "spot_id is required."},
status=status.HTTP_400_BAD_REQUEST,
)
spot = get_object_or_404(
ParkingSpot,
pk=spot_id,
status=ParkingSpot.SpotStatus.ACTIVE,
lot__is_active=True,
lot__is_approved=True,
)
pricing = recommend_price_for_spot(spot)
if not pricing:
return Response(
{"detail": "AI pricing is not available for this spot."},
status=status.HTTP_404_NOT_FOUND,
)
base_price = float(pricing.get("base_price", 0.0))
recommended_price = float(pricing.get("recommended_price", base_price))
min_price = float(pricing.get("min_price", recommended_price))
max_price = float(pricing.get("max_price", recommended_price))
discount_percent = float(pricing.get("discount_percent") or 0.0)
is_discount = bool(pricing.get("is_discount") or False)
data = {
"spot_id": str(spot.id),
"lot_id": str(spot.lot_id),
"currency": "RUB",
"base_price": base_price,
"recommended_price": recommended_price,
"min_price": min_price,
"max_price": max_price,
"discount_percent": discount_percent,
"is_discount": is_discount,
"reason": pricing.get("reason", ""),
}
return Response(data, status=status.HTTP_200_OK)
class ParkMateAvailabilityForecastAPIView(APIView):
"""
–≠–Ω–¥–ø–æ–∏–Ω—Ç ParkMate –¥–ª—è –ø—Ä–æ–≥–Ω–æ–∑–∞ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ –º–µ—Å—Ç–∞.
POST /api/ai/parkmate/availability/
{
"spot_id": "uuid"
"occupancy_7d": 0.4,
"stress_index": 0.5
}
"""
permission_classes = [AllowAny]
def post(self, request, *args: Any, **kwargs: Any) -> Response:
from django.shortcuts import get_object_or_404
spot_id = request.data.get("spot_id")
occupancy_7d = request.data.get("occupancy_7d")
stress_index = request.data.get("stress_index")
spot = None
if spot_id:
spot = get_object_or_404(
ParkingSpot,
pk=spot_id,
status=ParkingSpot.SpotStatus.ACTIVE,
lot__is_active=True,
lot__is_approved=True,
)
occupancy_7d = float(spot.occupancy_7d or 0.0)
stress_index = float(spot.lot.stress_index or 0.0)
else:
try:
occupancy_7d = float(occupancy_7d or 0.0)
stress_index = float(stress_index or 0.0)
except (TypeError, ValueError):
return Response(
{
"detail": (
"occupancy_7d –∏ stress_index –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å —á–∏—Å–ª–∞–º–∏, "
"–µ—Å–ª–∏ –Ω–µ –ø–µ—Ä–µ–¥–∞–Ω spot_id."
)
},
status=status.HTTP_400_BAD_REQUEST,
)
# –ù–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏—è
occupancy_7d = max(0.0, min(float(occupancy_7d), 1.0))
stress_index = max(0.0, min(float(stress_index), 1.0))
# –ü—Ä–æ—Å—Ç–∞—è —ç–≤—Ä–∏—Å—Ç–∏–∫–∞: —á–µ–º –≤—ã—à–µ –∑–∞–≥—Ä—É–∑–∫–∞/—Å—Ç—Ä–µ—Å—Å, —Ç–µ–º –Ω–∏–∂–µ –≤–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç—å –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏
base_avail = 1.0 - 0.7 * occupancy_7d - 0.3 * stress_index
base_avail = max(0.0, min(base_avail, 1.0))
next_1h = round(base_avail, 3)
next_3h = round(max(0.0, base_avail - 0.1), 3)
next_24h = round(max(0.0, base_avail - 0.2), 3)
now = timezone.now()
data = {
"spot_id": str(spot.id) if spot else None,
"occupancy_7d": occupancy_7d,
"stress_index": stress_index,
"as_of": now,
"availability": {
"next_1h": next_1h,
"next_3h": next_3h,
"next_24h": next_24h,
},
}
return Response(data, status=status.HTTP_200_OK)

# File 42/160: ai\chat\__init__.py
################################################################################

"""Chat helpers for local parking assistant."""
from .parking_assistant import generate_chat_reply
__all__ = ["generate_chat_reply"]

# File 43/160: ai\chat\parking_assistant.py
################################################################################

"""
–£–º–Ω—ã–π –ø–æ–º–æ—â–Ω–∏–∫ –ø–æ–¥–±–∏—Ä–∞–µ—Ç –ø–∞—Ä–∫–æ–≤–∫–∏ –ø–æ —Ç–µ–∫—Å—Ç–æ–≤–æ–º—É –∑–∞–ø—Ä–æ—Å—É, –∏—Å–ø–æ–ª—å–∑—É—è
–ø—Ä–æ—Å—Ç—ã–µ –ø—Ä–∞–≤–∏–ª–∞ –∏ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ –¥–∞–Ω–Ω—ã–µ –º–æ–¥–µ–ª–∏ –ø–∞—Ä–∫–æ–≤–æ–∫. –ü—Ä–∏ –∂–µ–ª–∞–Ω–∏–∏ —Å—é–¥–∞
–º–æ–∂–Ω–æ –ø–æ–¥–∫–ª—é—á–∏—Ç—å –æ–±—É—á–µ–Ω–Ω—ã–µ NLP-–º–æ–¥–µ–ª–∏.
"""
from __future__ import annotations
import logging
import random
import re
from functools import lru_cache
from typing import Any, Dict, Iterable, List, Optional, Tuple
try:
from sklearn.feature_extraction.text import TfidfVectorizer
from sklearn.metrics.pairwise import cosine_similarity
except Exception:
TfidfVectorizer = None
cosine_similarity = None
from asgiref.sync import async_to_sync
from django.contrib.auth import get_user_model
from django.db.models import Q
from parking.models import ParkingSpot
from services.llm import LLMClientError, parse_search_query
User = get_user_model()
logger = logging.getLogger(__name__)
def _extract_budget(text: str) -> Optional[int]:
match = re.search(r"(\d{2,5})\s*(?:‚ÇΩ|—Ä|—Ä—É–±)", text)
if match:
try:
return int(match.group(1))
except ValueError:
return None
return None
def _extract_time_hint(text: str) -> str:
if "–∑–∞–≤—Ç—Ä–∞" in text:
return "–Ω–∞ –∑–∞–≤—Ç—Ä–∞"
if "–Ω–æ—á" in text:
return "–Ω–∞ –Ω–æ—á—å"
if re.search(r"\b(\d{1,2})\s*[-‚Äì]\s*(\d{1,2})\b", text):
return "–≤ —É–∫–∞–∑–∞–Ω–Ω–æ–µ –æ–∫–Ω–æ –≤—Ä–µ–º–µ–Ω–∏"
if "—Å–µ–π—á–∞—Å" in text or "–ø—Ä—è–º–æ —Å–µ–π—á–∞—Å" in text:
return "–Ω–∞ –±–ª–∏–∂–∞–π—à–∏–π —á–∞—Å"
return "—Å–∫–æ—Ä–æ"
INTENT_CORPUS: list[tuple[str, str]] = [
("ev", "–∑–∞—Ä—è–¥–∫–∞ –¥–ª—è —ç–ª–µ–∫—Ç—Ä–æ–º–æ–±–∏–ª—è ev —ç–ª–µ–∫—Ç—Ä–æ–º–æ–±–∏–ª—å tesla leaf"),
("budget", "—Å–∞–º–∞—è –¥–µ—à—ë–≤–∞—è –¥—ë—à–µ–≤–æ –±—é–¥–∂–µ—Ç —ç–∫–æ–Ω–æ–º"),
("night", "–Ω–æ—á—å –Ω–æ—á–µ–≤–∫–∞ –æ—Å—Ç–∞–≤–∏—Ç—å –Ω–∞ –Ω–æ—á—å –∫—Ä—É–≥–ª–æ—Å—É—Ç–æ—á–Ω–æ"),
("covered", "–∫—Ä—ã—Ç–∞—è –ø–∞—Ä–∫–æ–≤–∫–∞ –ø–æ–¥–∑–µ–º–Ω–∞—è –∑–∞—â–∏—Ç–∞ –æ—Ç –¥–æ–∂–¥—è"),
("fast", "—Å–µ–π—á–∞—Å –±–ª–∏–∂–∞–π—à–∞—è –≤–æ–∑–ª–µ –º–µ–Ω—è —Ä—è–¥–æ–º —Å—Ä–æ—á–Ω–æ –ø—Ä—è–º–æ —Å–µ–π—á–∞—Å"),
]
@lru_cache(maxsize=1)
def _intent_vectorizer():
if not TfidfVectorizer:
return None, None
labels, texts = zip(*INTENT_CORPUS)
vect = TfidfVectorizer(stop_words=None)
matrix = vect.fit_transform(texts)
return vect, (labels, matrix)
def _detect_intents(text: str) -> list[str]:
vect, payload = _intent_vectorizer()
if not vect or not payload:
return []
labels, matrix = payload
query_vec = vect.transform([text])
sims = cosine_similarity(query_vec, matrix).flatten()
ranked: list[Tuple[float, str]] = sorted(zip(sims, labels), reverse=True)
return [lbl for score, lbl in ranked if score > 0.18][:3]
def _build_base_queryset() -> Iterable[ParkingSpot]:
return (
ParkingSpot.objects.filter(
status=ParkingSpot.SpotStatus.ACTIVE,
lot__is_active=True,
lot__is_approved=True,
)
.select_related("lot")
)
def _parse_with_llm(text: str) -> dict[str, Any] | None:
"""Try to parse a query using the external LLM service.
Returns None if the service is unavailable or any error occurs so that we can
gracefully fallback to the rule-based parsing.
"""
try:
logger.info(
"Invoking LLM parser for chat message",
extra={"query": text[:200]},
)
parsed = async_to_sync(parse_search_query)(text)
logger.info(
"LLM parsed query",
extra={"query": text, "parsed": parsed},
)
return parsed
except (LLMClientError, ValueError) as exc:
logger.warning(
"LLM parsing failed, using rule-based fallback",
extra={"query": text},
exc_info=exc,
)
except Exception as exc:
logger.exception(
"Unexpected LLM parse error, using fallback", extra={"query": text}
)
return None
def _apply_llm_filters(queryset, payload: dict[str, Any]):
q_filter = Q()
city = payload.get("city")
if city:
q_filter &= Q(lot__city__iexact=city) | Q(lot__address__icontains=city)
if payload.get("has_ev_charging") is True:
q_filter &= Q(has_ev_charging=True)
if payload.get("covered") is True:
q_filter &= Q(is_covered=True)
max_price = payload.get("max_price_per_hour")
if max_price is not None:
try:
q_filter &= Q(hourly_price__lte=float(max_price))
except (TypeError, ValueError):
logger.debug("Skip invalid max_price_per_hour", extra={"value": max_price})
near_metro = payload.get("near_metro")
if near_metro:
q_filter &= Q(lot__address__icontains="–º–µ—Ç—Ä–æ") | Q(lot__name__icontains="–º–µ—Ç—Ä–æ")
if q_filter:
queryset = queryset.filter(q_filter)
return queryset
def _apply_intents(queryset, text: str):
lowered = text.lower()
q_filter = Q()
intents = set(_detect_intents(lowered))
if "ev" in lowered or "–∑–∞—Ä—è–¥" in lowered or "—ç–ª–µ–∫—Ç—Ä–æ" in lowered or "ev" in intents:
q_filter &= Q(has_ev_charging=True)
if "–∫—Ä—ã—Ç" in lowered or "covered" in intents:
q_filter &= Q(is_covered=True)
if "24/7" in lowered or "–∫—Ä—É–≥–ª–æ—Å—É—Ç–æ—á" in lowered or "night" in intents:
q_filter &= Q(is_24_7=True)
if "budget" in intents:
q_filter &= Q(hourly_price__lte=300)
metro_match = re.search(r"–º–µ—Ç—Ä–æ\s+([\w—ë–Å\-\s]+)", lowered)
if metro_match:
station = metro_match.group(1).strip()
q_filter &= Q(lot__address__icontains=station) | Q(lot__name__icontains=station)
address_match = re.search(r"(—É–ª\.|—É–ª–∏—Ü–∞|–ø—Ä–æ—Å–ø–µ–∫—Ç|—à–æ—Å—Å–µ|–ø–ª\.|–ø–ª–æ—â–∞–¥—å)\s+([\w—ë–Å\s\-]+)", lowered)
if address_match:
fragment = address_match.group(0)
q_filter &= Q(lot__address__icontains=fragment)
budget = _extract_budget(lowered)
if budget:
q_filter &= Q(hourly_price__lte=budget)
if q_filter:
queryset = queryset.filter(q_filter)
return queryset, intents
def _spot_payload(spot: ParkingSpot) -> dict[str, Any]:
tags = []
if spot.has_ev_charging:
tags.append("EV")
if spot.is_covered:
tags.append("–∫—Ä—ã—Ç–∞—è")
if spot.is_24_7:
tags.append("24/7")
if getattr(spot, "allow_dynamic_pricing", False):
tags.append("AI")
return {
"spot_id": str(spot.id),
"title": f"{spot.lot.name} ‚Äî {spot.name}",
"price": float(spot.hourly_price or 0),
"distance_m": getattr(spot, "distance_km", None) * 1000 if getattr(spot, "distance_km", None) else None,
"tags": tags,
"occupancy_now": float(getattr(spot, "occupancy_7d", 0.0) or 0.0),
}
def _compose_reply(context: dict[str, Any], count: int) -> str:
templates = [
"–ù–∞—à—ë–ª –¥–ª—è –≤–∞—Å {count} –≤–∞—Ä–∏–∞–Ω—Ç–æ–≤ –æ–∫–æ–ª–æ {area}. –¶–µ–Ω—ã –æ—Ç {min_price} –¥–æ {max_price} ‚ÇΩ/—á–∞—Å. –°–µ–π—á–∞—Å —Å–≤–æ–±–æ–¥–Ω–æ –ø—Ä–∏–º–µ—Ä–Ω–æ {availability}%.",
"–ü–æ–¥–æ–±—Ä–∞–ª {count} –ø–∞—Ä–∫–æ–≤–æ–∫ {time_hint}. –ú–∏–Ω–∏–º–∞–ª—å–Ω—ã–π —Ç–∞—Ä–∏—Ñ {min_price} ‚ÇΩ/—á–∞—Å, –º–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π {max_price} ‚ÇΩ/—á–∞—Å.",
"–ï—Å—Ç—å {count} –ø–æ–¥—Ö–æ–¥—è—â–∏—Ö –º–µ—Å—Ç {area}. –ß—Ç–æ–±—ã —Ä–∞—Å—à–∏—Ä–∏—Ç—å –≤—ã–±–æ—Ä, –º–æ–∂–Ω–æ —Å–∫–æ—Ä—Ä–µ–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –±—é–¥–∂–µ—Ç {budget_hint}.",
]
area = context.get("area") or "—Ä—è–¥–æ–º"
min_price = context.get("min_price", 0)
max_price = context.get("max_price", max(min_price, min_price + 50))
availability = context.get("availability", 60)
budget_hint = f"–¥–æ {context['budget']} ‚ÇΩ" if context.get("budget") else "–∏–ª–∏ —Ä–∞–¥–∏—É—Å"
time_hint = context.get("time_hint", "")
template = random.choice(templates)
return template.format(
count=count or 0,
area=area,
min_price=min_price,
max_price=max_price,
availability=availability,
budget_hint=budget_hint,
time_hint=time_hint,
)
def _llm_time_hint(payload: dict[str, Any]) -> str:
start_at = payload.get("start_at")
end_at = payload.get("end_at")
if start_at and end_at:
return "–Ω–∞ –≤—ã–±—Ä–∞–Ω–Ω—ã–π –∏–Ω—Ç–µ—Ä–≤–∞–ª"
if start_at:
return "–∫ —É–∫–∞–∑–∞–Ω–Ω–æ–º—É –≤—Ä–µ–º–µ–Ω–∏"
return "—Å–∫–æ—Ä–æ"
def _prepare_context(
spots: list[ParkingSpot], area: Optional[str], budget: Optional[int], time_hint: str
) -> dict[str, Any]:
prices = [float(s.hourly_price or 0) for s in spots] or [0]
return {
"area": area or "—Ä—è–¥–æ–º",
"min_price": int(min(prices)),
"max_price": int(max(prices)),
"availability": int(
100
- (sum([float(getattr(s, "occupancy_7d", 0.0) or 0) for s in spots]) / len(prices))
* 100
)
if spots
else 0,
"budget": budget,
"time_hint": time_hint,
}
def _reply_payload(spots: list[ParkingSpot], context: dict[str, Any], reasoning: str) -> dict[str, Any]:
suggestions = [_spot_payload(spot) for spot in spots][:6]
if not suggestions:
reply = "–°–µ–π—á–∞—Å –Ω–µ—Ç –ø–∞—Ä–∫–æ–≤–æ–∫ –ø–æ–¥ —ç—Ç–∏ —É—Å–ª–æ–≤–∏—è. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ —É–≤–µ–ª–∏—á–∏—Ç—å –±—é–¥–∂–µ—Ç –∏–ª–∏ –≤—ã–±—Ä–∞—Ç—å –¥—Ä—É–≥–æ–π —Ä–∞–π–æ–Ω."
reasoning = reasoning or "–ó–∞–ø—Ä–æ—Å —Å–ª–∏—à–∫–æ–º —É–∑–∫–∏–π –∏–ª–∏ –≤ –±–∞–∑–µ –ø–æ–∫–∞ –Ω–µ—Ç –ø–æ–¥—Ö–æ–¥—è—â–∏—Ö –º–µ—Å—Ç."
else:
reply = _compose_reply(context, len(suggestions))
return {
"reply": reply,
"suggestions": suggestions,
"reason": reasoning,
"intents": context.get("intents", []),
}
def _handle_llm_flow(text: str):
parsed = _parse_with_llm(text)
if not parsed:
logger.debug(
"LLM returned no result; will use rule-based fallback",
extra={"query": text[:120]},
)
return None
qs = _apply_llm_filters(_build_base_queryset(), parsed)
qs = qs.order_by("lot__stress_index", "hourly_price")[:12]
spots = list(qs)
area_hint = None
if parsed.get("near_metro"):
area_hint = "—Ä—è–¥–æ–º —Å –º–µ—Ç—Ä–æ"
if parsed.get("city"):
area_hint = parsed["city"]
budget = parsed.get("max_price_per_hour")
time_hint = _llm_time_hint(parsed)
context = _prepare_context(spots, area_hint, budget, time_hint)
reasoning_parts = ["LLM —Ä–∞–∑–æ–±—Ä–∞–ª –Ω–∞–º–µ—Ä–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è"]
if parsed.get("has_ev_charging"):
reasoning_parts.append("—É—á—Ç–µ–Ω–∞ EV-–∑–∞—Ä—è–¥–∫–∞")
if parsed.get("covered"):
reasoning_parts.append("–æ—Å—Ç–∞–≤–ª–µ–Ω—ã –∫—Ä—ã—Ç—ã–µ –º–µ—Å—Ç–∞")
if budget:
reasoning_parts.append("–æ—Ç—Ñ–∏–ª—å—Ç—Ä–æ–≤–∞–Ω–æ –ø–æ –±—é–¥–∂–µ—Ç—É")
context["intents"] = []
return _reply_payload(spots, context, ", ".join(reasoning_parts))
def _handle_rule_based_flow(lowered: str):
qs, intents = _apply_intents(_build_base_queryset(), lowered)
budget = _extract_budget(lowered)
if budget:
qs = qs.filter(hourly_price__lte=budget)
qs = qs.order_by("lot__stress_index", "hourly_price")[:12]
spots = list(qs)
area_hint = None
metro_match = re.search(r"–º–µ—Ç—Ä–æ\s+([\w—ë–Å\-\s]+)", lowered)
if metro_match:
area_hint = f"—É –º–µ—Ç—Ä–æ {metro_match.group(1).strip().title()}"
time_hint = _extract_time_hint(lowered)
context = _prepare_context(spots, area_hint, budget, time_hint)
context["intents"] = list(intents)
why = []
if "ev" in intents:
why.append("—É—á—ë–ª –Ω–∞–ª–∏—á–∏–µ EV-–∑–∞—Ä—è–¥–∫–∏")
if "budget" in intents or budget:
why.append("–æ—Ç—Å–æ—Ä—Ç–∏—Ä–æ–≤–∞–ª –ø–æ —Ü–µ–Ω–µ")
if "night" in intents:
why.append("–æ—Å—Ç–∞–≤–∏–ª —Ç–æ–ª—å–∫–æ –∫—Ä—É–≥–ª–æ—Å—É—Ç–æ—á–Ω—ã–µ")
reasoning = ", ".join(why) if why else "–∏—Å–ø–æ–ª—å–∑–æ–≤–∞–ª –±–ª–∏–∂–∞–π—à–∏–µ –∏ –º–µ–Ω–µ–µ –∑–∞–≥—Ä—É–∂–µ–Ω–Ω—ã–µ –º–µ—Å—Ç–∞"
return _reply_payload(spots, context, reasoning)
def generate_chat_reply(message: str, history: Optional[List[dict]], user: Optional[User]) -> dict[str, Any]:
text = (message or "").strip()
logger.info(
"Incoming parking chat message",
extra={
"message": text[:200],
"history_len": len(history or []),
"user": getattr(user, "id", None),
},
)
if not text:
logger.info("Empty chat message, returning friendly prompt")
return {
"reply": "–û–ø–∏—à–∏—Ç–µ –≤—Ä–µ–º—è, –∞–¥—Ä–µ—Å –∏–ª–∏ –º–µ—Ç—Ä–æ ‚Äî –ø–æ–¥–±–µ—Ä—É –ø–∞—Ä–∫–æ–≤–∫—É.",
"suggestions": [],
"reason": "empty_message",
}
lowered = text.lower()
try:
llm_response = _handle_llm_flow(text)
if llm_response:
return llm_response
except Exception as exc:
logger.exception("LLM flow errored, forcing rule-based fallback", exc_info=exc)
logger.info("Falling back to rule-based parser")
return _handle_rule_based_flow(lowered)

# File 44/160: ai\management\__init__.py
################################################################################



# File 45/160: ai\management\commands\__init__.py
################################################################################



# File 46/160: ai\management\commands\train_chat_intents_from_logs.py
################################################################################

from django.core.management.base import BaseCommand
from ai.models import ChatMessage
class Command(BaseCommand):
help = "–ü—Ä–æ—Ö–æ–¥–∏—Ç—Å—è –ø–æ –ª–æ–≥–∞–º —á–∞—Ç–∞ –∏ –ø–æ–¥–≥–æ—Ç–∞–≤–ª–∏–≤–∞–µ—Ç –¥–∞–Ω–Ω—ã–µ –¥–ª—è –æ–±—É—á–µ–Ω–∏—è NLP/intent –º–æ–¥–µ–ª–µ–π."
def handle(self, *args, **options):
total = ChatMessage.objects.count()
assistant_messages = ChatMessage.objects.filter(role=ChatMessage.Role.ASSISTANT).count()
user_messages = total - assistant_messages
self.stdout.write(self.style.SUCCESS("–í—Å–µ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏–π: %s" % total))
self.stdout.write(f"–û—Ç–≤–µ—Ç–æ–≤ –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç–∞: {assistant_messages}")
self.stdout.write(f"–°–æ–æ–±—â–µ–Ω–∏–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π: {user_messages}")
# TODO: –≤—ã–≥—Ä—É–∂–∞—Ç—å –¥–∏–∞–ª–æ–≥–∏ –∏ –æ–±—É—á–∞—Ç—å –Ω–∞–º–µ—Ä–µ–Ω–∏—è
self.stdout.write("–ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –∫ –æ–±—É—á–µ–Ω–∏—é –∑–∞–≤–µ—Ä—à–µ–Ω–∞ (–∑–∞–≥–ª—É—à–∫–∞).")

# File 47/160: ai\migrations\0001_initial.py
################################################################################

# Generated manually to include initial AI models
from django.conf import settings
from django.db import migrations, models
import django.db.models.deletion
import uuid
class Migration(migrations.Migration):
initial = True
dependencies = [
migrations.swappable_dependency(settings.AUTH_USER_MODEL),
]
operations = [
migrations.CreateModel(
name='ChatSession',
fields=[
('created_at', models.DateTimeField(auto_now_add=True, verbose_name='–î–∞—Ç–∞ —Å–æ–∑–¥–∞–Ω–∏—è')),
('updated_at', models.DateTimeField(auto_now=True, verbose_name='–î–∞—Ç–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è')),
('id', models.UUIDField(default=uuid.uuid4, editable=False, primary_key=True, serialize=False)),
('client_info', models.JSONField(blank=True, null=True, verbose_name='–î–∞–Ω–Ω—ã–µ –∫–ª–∏–µ–Ω—Ç–∞')),
('last_activity_at', models.DateTimeField(auto_now=True, verbose_name='–ü–æ—Å–ª–µ–¥–Ω—è—è –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å')),
('user', models.ForeignKey(blank=True, null=True, on_delete=django.db.models.deletion.SET_NULL, related_name='chat_sessions', to=settings.AUTH_USER_MODEL)),
],
options={
'verbose_name': '–°–µ—Å—Å–∏—è —á–∞—Ç–∞',
'verbose_name_plural': '–°–µ—Å—Å–∏–∏ —á–∞—Ç–∞',
},
),
migrations.CreateModel(
name='DeviceProfile',
fields=[
('created_at', models.DateTimeField(auto_now_add=True, verbose_name='–î–∞—Ç–∞ —Å–æ–∑–¥–∞–Ω–∏—è')),
('updated_at', models.DateTimeField(auto_now=True, verbose_name='–î–∞—Ç–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è')),
('id', models.UUIDField(default=uuid.uuid4, editable=False, primary_key=True, serialize=False)),
('device_id', models.CharField(db_index=True, max_length=64, verbose_name='ID —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞')),
('viewport_width', models.IntegerField(blank=True, null=True, verbose_name='–®–∏—Ä–∏–Ω–∞ viewport')),
('viewport_height', models.IntegerField(blank=True, null=True, verbose_name='–í—ã—Å–æ—Ç–∞ viewport')),
('pixel_ratio', models.FloatField(blank=True, null=True, verbose_name='Pixel ratio')),
('user_agent', models.TextField(blank=True, verbose_name='User‚ÄëAgent')),
('layout_profile', models.CharField(choices=[('compact', '–ö–æ–º–ø–∞–∫—Ç–Ω—ã–π'), ('comfortable', '–ö–æ–º—Ñ–æ—Ä—Ç–Ω—ã–π')], default='compact', max_length=32, verbose_name='–ü—Ä–æ—Ñ–∏–ª—å –∫–æ–º–ø–æ–Ω–æ–≤–∫–∏')),
('theme', models.CharField(choices=[('light', '–°–≤–µ—Ç–ª–∞—è'), ('dark', '–¢—ë–º–Ω–∞—è'), ('system', '–°–∏—Å—Ç–µ–º–Ω–∞—è')], default='system', max_length=16, verbose_name='–¢–µ–º–∞')),
('user', models.ForeignKey(blank=True, null=True, on_delete=django.db.models.deletion.SET_NULL, related_name='device_profiles', to=settings.AUTH_USER_MODEL)),
],
options={
'verbose_name': '–ü—Ä–æ—Ñ–∏–ª—å —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞',
'verbose_name_plural': '–ü—Ä–æ—Ñ–∏–ª–∏ —É—Å—Ç—Ä–æ–π—Å—Ç–≤',
'unique_together': {('device_id', 'user')},
},
),
migrations.CreateModel(
name='UiEvent',
fields=[
('created_at', models.DateTimeField(auto_now_add=True, verbose_name='–î–∞—Ç–∞ —Å–æ–∑–¥–∞–Ω–∏—è')),
('updated_at', models.DateTimeField(auto_now=True, verbose_name='–î–∞—Ç–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è')),
('id', models.UUIDField(default=uuid.uuid4, editable=False, primary_key=True, serialize=False)),
('event_type', models.CharField(max_length=64, verbose_name='–¢–∏–ø —Å–æ–±—ã—Ç–∏—è')),
('payload', models.JSONField(blank=True, null=True, verbose_name='Payload')),
('device_profile', models.ForeignKey(on_delete=django.db.models.deletion.CASCADE, related_name='events', to='ai.deviceprofile')),
],
options={
'verbose_name': 'UI‚Äë—Å–æ–±—ã—Ç–∏–µ',
'verbose_name_plural': 'UI‚Äë—Å–æ–±—ã—Ç–∏—è',
},
),
migrations.CreateModel(
name='ChatMessage',
fields=[
('created_at', models.DateTimeField(auto_now_add=True, verbose_name='–î–∞—Ç–∞ —Å–æ–∑–¥–∞–Ω–∏—è')),
('updated_at', models.DateTimeField(auto_now=True, verbose_name='–î–∞—Ç–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è')),
('id', models.BigAutoField(auto_created=True, primary_key=True, serialize=False, verbose_name='ID')),
('role', models.CharField(choices=[('user', 'User'), ('assistant', 'Assistant')], max_length=16, verbose_name='–†–æ–ª—å')),
('text', models.TextField(verbose_name='–¢–µ–∫—Å—Ç')),
('meta', models.JSONField(blank=True, null=True, verbose_name='–ú–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ')),
('session', models.ForeignKey(on_delete=django.db.models.deletion.CASCADE, related_name='messages', to='ai.chatsession')),
],
options={
'verbose_name': '–°–æ–æ–±—â–µ–Ω–∏–µ —á–∞—Ç–∞',
'verbose_name_plural': '–°–æ–æ–±—â–µ–Ω–∏—è —á–∞—Ç–∞',
'ordering': ('-created_at',),
},
),
migrations.CreateModel(
name='ChatFeedback',
fields=[
('created_at', models.DateTimeField(auto_now_add=True, verbose_name='–î–∞—Ç–∞ —Å–æ–∑–¥–∞–Ω–∏—è')),
('updated_at', models.DateTimeField(auto_now=True, verbose_name='–î–∞—Ç–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è')),
('id', models.BigAutoField(auto_created=True, primary_key=True, serialize=False, verbose_name='ID')),
('rating', models.IntegerField(default=0, verbose_name='–û—Ü–µ–Ω–∫–∞')),
('message', models.ForeignKey(on_delete=django.db.models.deletion.CASCADE, related_name='feedback', to='ai.chatmessage')),
],
options={
'verbose_name': '–§–∏–¥–±–µ–∫ —á–∞—Ç–∞',
'verbose_name_plural': '–§–∏–¥–±–µ–∫ —á–∞—Ç–∞',
'ordering': ('-created_at',),
},
),
]

# File 48/160: ai\migrations\__init__.py
################################################################################



# File 49/160: ai_services\__init__.py
################################################################################

"""
AI microservices for ParkShare / ParkShare RU.
–°–æ–¥–µ—Ä–∂–∏—Ç –æ—Ç–¥–µ–ª—å–Ω—ã–µ FastAPI‚Äë–ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è:
- ai_pricing_service: –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–æ–µ —Ü–µ–Ω–æ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏–µ;
- cv_service: Computer Vision (—Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏–µ –Ω–æ–º–µ—Ä–æ–≤, –∑–∞–ø–æ–ª–Ω–µ–Ω–Ω–æ—Å—Ç—å –∏ —Ç.–¥.).
"""

# File 50/160: ai_services\ai_pricing_service\__init__.py
################################################################################

"""
AI Pricing microservice (FastAPI) for dynamic parking spot pricing.
"""

# File 51/160: ai_services\ai_pricing_service\main.py
################################################################################

from __future__ import annotations
from decimal import Decimal, ROUND_HALF_UP
from typing import Optional
from fastapi import FastAPI
from pydantic import BaseModel, Field
app = FastAPI(
title="ParkShare AI Pricing Service",
version="0.1.0",
description=(
"–û—Ç–¥–µ–ª—å–Ω—ã–π –º–∏–∫—Ä–æ—Å–µ—Ä–≤–∏—Å ParkMate AI –¥–ª—è –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–æ–≥–æ —Ü–µ–Ω–æ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏—è "
"–ø–∞—Ä–∫–æ–≤–æ—á–Ω—ã—Ö –º–µ—Å—Ç. –ü–æ–∫–∞ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç –ø—Ä–æ—Å—Ç—ã–µ —ç–≤—Ä–∏—Å—Ç–∏–∫–∏, –Ω–æ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å "
"–≥–æ—Ç–æ–≤ –¥–ª—è –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è CatBoost/Transformer‚Äë–º–æ–¥–µ–ª–µ–π."
),
)
def round_price(value: float, step: float = 10.0) -> float:
"""
–õ–æ–∫–∞–ª—å–Ω–∞—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è round_price, –Ω–µ –∑–∞–≤–∏—Å—è—â–∞—è –æ—Ç Django.
–û–∫—Ä—É–≥–ª—è–µ—Ç —Ü–µ–Ω—É –∫ –±–ª–∏–∂–∞–π—à–µ–º—É step (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é 10 ‚ÇΩ).
"""
if step <= 0:
return float(Decimal(str(value)).quantize(Decimal("0.01")))
v = Decimal(str(value))
step_dec = Decimal(str(step))
scaled = (v / step_dec).quantize(Decimal("1"), rounding=ROUND_HALF_UP)
result = scaled * step_dec
return float(result)
class PricingRequest(BaseModel):
base_price: float = Field(..., gt=0, description="–ë–∞–∑–æ–≤–∞—è —Ü–µ–Ω–∞ –∑–∞ —á–∞—Å, ‚ÇΩ")
occupancy_7d: float = Field(
0.0,
ge=0.0,
le=1.0,
description="–ó–∞–≥—Ä—É–∂–µ–Ω–Ω–æ—Å—Ç—å –º–µ—Å—Ç–∞ –∑–∞ –ø–æ—Å–ª–µ–¥–Ω–∏–µ 7 –¥–Ω–µ–π (0..1)",
)
stress_index: float = Field(
0.0,
ge=0.0,
le=1.0,
description="–ò–Ω–¥–µ–∫—Å –∑–∞–≥—Ä—É–∂–µ–Ω–Ω–æ—Å—Ç–∏ –ø–∞—Ä–∫–æ–≤–∫–∏ (0..1)",
)
hour: Optional[int] = Field(
None, ge=0, le=23, description="–ß–∞—Å —Å—É—Ç–æ–∫ (0‚Äì23, –ª–æ–∫–∞–ª—å–Ω–æ–µ –≤—Ä–µ–º—è –ø–∞—Ä–∫–æ–≤–∫–∏)"
)
dow: Optional[int] = Field(
None, ge=0, le=6, description="–î–µ–Ω—å –Ω–µ–¥–µ–ª–∏ (0=–ø–æ–Ω–µ–¥–µ–ª—å–Ω–∏–∫, 6=–≤–æ—Å–∫—Ä–µ—Å–µ–Ω—å–µ)"
)
use_ml: bool = Field(
False,
description=(
"–§–ª–∞–≥ –¥–ª—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è ML‚Äë–º–æ–¥–µ–ª–∏ (–∑–∞—Ä–µ–∑–µ—Ä–≤–∏—Ä–æ–≤–∞–Ω–æ; "
"–ø–æ–∫–∞ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ —ç–≤—Ä–∏—Å—Ç–∏–∫–∞)."
),
)
class PricingResponse(BaseModel):
base_price: float
recommended_price: float
min_price: float
max_price: float
discount_percent: float
is_discount: bool
reason: str
@app.get("/health", tags=["health"])
def health() -> dict:
"""
–ü—Ä–æ—Å—Ç–æ–π healthcheck.
"""
return {"status": "ok"}
@app.post(
"/api/v1/pricing/recommend",
response_model=PricingResponse,
tags=["pricing"],
summary="–ü–æ–ª—É—á–∏—Ç—å —Ä–µ–∫–æ–º–µ–Ω–¥–æ–≤–∞–Ω–Ω—É—é —Ü–µ–Ω—É –∑–∞ —á–∞—Å",
)
def recommend_price(payload: PricingRequest) -> PricingResponse:
"""
–≠–≤—Ä–∏—Å—Ç–∏—á–µ—Å–∫–æ–µ —Ü–µ–Ω–æ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏–µ –Ω–∞ –æ—Å–Ω–æ–≤–µ:
- –±–∞–∑–æ–≤–æ–π —Ü–µ–Ω—ã;
- –∑–∞–≥—Ä—É–∂–µ–Ω–Ω–æ—Å—Ç–∏ –º–µ—Å—Ç–∞/–ø–∞—Ä–∫–æ–≤–∫–∏;
- –≤—Ä–µ–º–µ–Ω–∏ —Å—É—Ç–æ–∫ (—á–∞—Å –ø–∏–∫ / –Ω–µ —á–∞—Å –ø–∏–∫).
–í –¥–∞–ª—å–Ω–µ–π—à–µ–º —Å—é–¥–∞ –º–æ–∂–Ω–æ –ø–æ–¥—Å—Ç–∞–≤–∏—Ç—å CatBoost/Transformer‚Äë–º–æ–¥–µ–ª—å.
"""
base_price = payload.base_price
occ = float(payload.occupancy_7d or 0.0)
stress = float(payload.stress_index or 0.0)
factor = 1.0
reasons: list[str] = []
# –ó–∞–≥—Ä—É–∂–µ–Ω–Ω–æ—Å—Ç—å –º–µ—Å—Ç–∞
if occ > 0.8:
factor += 0.15
reasons.append("–º–µ—Å—Ç–æ —á–∞—Å—Ç–æ –∑–∞–Ω—è—Ç–æ (–≤—ã—Å–æ–∫–∞—è –∑–∞–≥—Ä—É–∂–µ–Ω–Ω–æ—Å—Ç—å –∑–∞ 7 –¥–Ω–µ–π)")
elif occ < 0.3:
factor -= 0.10
reasons.append("–º–µ—Å—Ç–æ –ø—Ä–æ—Å—Ç–∞–∏–≤–∞–µ—Ç (–Ω–∏–∑–∫–∞—è –∑–∞–≥—Ä—É–∂–µ–Ω–Ω–æ—Å—Ç—å –∑–∞ 7 –¥–Ω–µ–π)")
# –°—Ç—Ä–µ—Å—Å –ø–æ –ø–∞—Ä–∫–æ–≤–∫–µ
if stress > 0.7:
factor += 0.10
reasons.append("–≤—ã—Å–æ–∫–∏–π –ø–∞—Ä–∫–æ–≤–æ—á–Ω—ã–π —Å—Ç—Ä–µ—Å—Å –ø–æ –æ–±—ä–µ–∫—Ç—É")
elif stress < 0.3:
factor -= 0.05
reasons.append("–Ω–∏–∑–∫–∏–π –ø–∞—Ä–∫–æ–≤–æ—á–Ω—ã–π —Å—Ç—Ä–µ—Å—Å –ø–æ –æ–±—ä–µ–∫—Ç—É")
# –í—Ä–µ–º—è —Å—É—Ç–æ–∫
if payload.hour is not None:
hour = payload.hour
if 8 <= hour <= 11 or 17 <= hour <= 21:
factor += 0.10
reasons.append("—á–∞—Å –ø–∏–∫")
else:
factor -= 0.05
reasons.append("–Ω–µ —á–∞—Å –ø–∏–∫")
# –û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º —Ñ–∞–∫—Ç–æ—Ä
if factor < 0.5:
factor = 0.5
if factor > 1.5:
factor = 1.5
recommended = round_price(base_price * factor, step=5.0)
min_price = round_price(recommended * 0.9, step=5.0)
max_price = round_price(recommended * 1.1, step=5.0)
# –°–∫–∏–¥–∫–∞ –æ—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω–æ –±–∞–∑–æ–≤–æ–π —Ü–µ–Ω—ã
discount_percent = 0.0
is_discount = False
if recommended < base_price:
diff = (base_price - recommended) / base_price
discount_percent = float(
(Decimal(str(diff)) * Decimal("100")).quantize(Decimal("0.1"))
)
is_discount = True
if not reasons:
reasons.append("–∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ –±–∞–∑–æ–≤–∞—è —Å—Ç–∞–≤–∫–∞")
reason = "; ".join(reasons)
return PricingResponse(
base_price=base_price,
recommended_price=recommended,
min_price=min_price,
max_price=max_price,
discount_percent=discount_percent,
is_discount=is_discount,
reason=reason,
)

# File 52/160: ai_services\cv_service\__init__.py
################################################################################

"""
Computer Vision microservice (FastAPI) for ParkShare:
- —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏–µ –Ω–æ–º–µ—Ä–æ–≤;
- –æ—Ü–µ–Ω–∫–∞ –∑–∞–ø–æ–ª–Ω–µ–Ω–Ω–æ—Å—Ç–∏ –ø–∞—Ä–∫–æ–≤–æ–∫ –ø–æ –∫–∞–¥—Ä–∞–º –∫–∞–º–µ—Ä.
"""

# File 53/160: ai_services\cv_service\main.py
################################################################################

from __future__ import annotations
from datetime import datetime, timezone
from typing import Optional
from fastapi import FastAPI
from pydantic import BaseModel, Field, root_validator
app = FastAPI(
title="ParkShare CV Service",
version="0.1.0",
description=(
"–ó–∞–≥–ª—É—à–µ—á–Ω—ã–π CV‚Äë—Å–µ—Ä–≤–∏—Å ParkMate AI. "
"–ò–Ω—Ç–µ—Ä—Ñ–µ–π—Å –≥–æ—Ç–æ–≤ –ø–æ–¥ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—é OpenCV/ONNX/WebGPU‚Äë–º–æ–¥–µ–ª–µ–π."
),
)
class LicensePlateRequest(BaseModel):
image_url: Optional[str] = Field(
None,
description="URL –¥–æ –∫–∞–¥—Ä–∞/—Ñ–æ—Ç–æ —Å –Ω–æ–º–µ—Ä–æ–º –∞–≤—Ç–æ–º–æ–±–∏–ª—è (–µ—Å–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è —Å–µ—Ä–≤–µ—Ä–Ω–∞—è –∑–∞–≥—Ä—É–∑–∫–∞).",
)
image_base64: Optional[str] = Field(
None,
description="Base64‚Äë–∫–æ–¥–∏—Ä–æ–≤–∞–Ω–Ω–æ–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ (–µ—Å–ª–∏ –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º –Ω–∞–ø—Ä—è–º—É—é).",
)
region: str = Field("RU", description="–ö–æ–¥ —Ä–µ–≥–∏–æ–Ω–∞/—Å—Ç—Ä–∞–Ω—ã (–Ω–∞–ø—Ä–∏–º–µ—Ä, RU, EU, US).")
@root_validator
def validate_source(cls, values):
if not values.get("image_url") and not values.get("image_base64"):
raise ValueError("–ù—É–∂–Ω–æ –ø–µ—Ä–µ–¥–∞—Ç—å –ª–∏–±–æ image_url, –ª–∏–±–æ image_base64.")
return values
class LicensePlateResponse(BaseModel):
plate: str
normalized_plate: str
region: str
confidence: float
class ParkingOccupancyRequest(BaseModel):
image_url: Optional[str] = Field(
None,
description="URL –¥–æ –∫–∞–¥—Ä–∞ –∫–∞–º–µ—Ä—ã —Å –ø–∞—Ä–∫–æ–≤–∫–æ–π.",
)
camera_id: Optional[str] = Field(
None,
description="ID –∫–∞–º–µ—Ä—ã/–ø–æ—Ç–æ–∫–∞ –≤ –≤–∞—à–µ–º –¥–æ–º–µ–Ω–µ.",
)
total_slots: Optional[int] = Field(
None,
gt=0,
description="–û–±—â–µ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –º–µ—Å—Ç (–µ—Å–ª–∏ –∏–∑–≤–µ—Å—Ç–Ω–æ –∑–∞—Ä–∞–Ω–µ–µ).",
)
@root_validator
def validate_source(cls, values):
if not values.get("image_url") and not values.get("camera_id"):
raise ValueError("–ù—É–∂–Ω–æ —É–∫–∞–∑–∞—Ç—å image_url –∏–ª–∏ camera_id.")
return values
class ParkingOccupancyResponse(BaseModel):
occupied_slots: int
total_slots: int
occupancy_rate: float = Field(..., ge=0.0, le=1.0)
timestamp: datetime
@app.get("/health", tags=["health"])
def health() -> dict:
return {"status": "ok"}
@app.post(
"/api/v1/cv/license-plate",
response_model=LicensePlateResponse,
tags=["cv"],
summary="–†–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏–µ –≥–æ—Å–Ω–æ–º–µ—Ä–∞ (–∑–∞–≥–ª—É—à–∫–∞)",
)
def recognize_plate(payload: LicensePlateRequest) -> LicensePlateResponse:
"""
–ó–∞–≥–ª—É—à–∫–∞ –¥–ª—è —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏—è –≥–æ—Å–Ω–æ–º–µ—Ä–∞.
–†–µ–∞–ª—å–Ω–∞—è –ª–æ–≥–∏–∫–∞ –¥–æ–ª–∂–Ω–∞ –≤—ã–∑—ã–≤–∞—Ç—å –º–æ–¥–µ–ª—å (OpenCV+ONNX –∏ —Ç.–ø.).
"""
# TODO: –∑–∞–º–µ–Ω–∏—Ç—å –Ω–∞ –≤—ã–∑–æ–≤ —Ä–µ–∞–ª—å–Ω–æ–π –º–æ–¥–µ–ª–∏/—Å–µ—Ä–≤–∏—Å–∞
fake_plate = "A000AA197"
normalized = fake_plate.replace(" ", "")
return LicensePlateResponse(
plate=fake_plate,
normalized_plate=normalized,
region=payload.region,
confidence=0.85,
)
@app.post(
"/api/v1/cv/parking-occupancy",
response_model=ParkingOccupancyResponse,
tags=["cv"],
summary="–û—Ü–µ–Ω–∫–∞ –∑–∞–ø–æ–ª–Ω–µ–Ω–Ω–æ—Å—Ç–∏ –ø–∞—Ä–∫–æ–≤–∫–∏ –ø–æ –∫–∞–¥—Ä—É (–∑–∞–≥–ª—É—à–∫–∞)",
)
def parking_occupancy(payload: ParkingOccupancyRequest) -> ParkingOccupancyResponse:
"""
–ó–∞–≥–ª—É—à–∫–∞ –¥–ª—è –æ—Ü–µ–Ω–∫–∏ –∑–∞–ø–æ–ª–Ω–µ–Ω–Ω–æ—Å—Ç–∏ –ø–∞—Ä–∫–æ–≤–∫–∏:
- –µ—Å–ª–∏ total_slots –∏–∑–≤–µ—Å—Ç–µ–Ω, —Å—á–∏—Ç–∞–µ–º –ø—Ä–∏–º–µ—Ä–Ω–æ 50% –∑–∞–Ω—è—Ç–æ—Å—Ç–∏;
- –µ—Å–ª–∏ –Ω–µ—Ç, –ø—Ä–µ–¥–ø–æ–ª–∞–≥–∞–µ–º 20 –º–µ—Å—Ç –∏ 40% –∑–∞–Ω—è—Ç–æ.
"""
total_slots = payload.total_slots or 20
occupied_slots = max(1, int(total_slots * 0.4))
occupancy_rate = occupied_slots / float(total_slots)
return ParkingOccupancyResponse(
occupied_slots=occupied_slots,
total_slots=total_slots,
occupancy_rate=round(occupancy_rate, 3),
timestamp=datetime.now(timezone.utc),
)

# File 54/160: backend\manage.py
################################################################################

#!/usr/bin/env python
"""Django's command-line utility for administrative tasks."""
import os
import sys
from pathlib import Path
def main() -> None:
"""
–¢–æ—á–∫–∞ –≤—Ö–æ–¥–∞ –¥–ª—è manage.py.
–í–ê–ñ–ù–û: –¥–æ–±–∞–≤–ª—è–µ–º –∫–æ—Ä–µ–Ω—å —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è –≤ sys.path, —á—Ç–æ–±—ã –ø–∞–∫–µ—Ç—ã
—É—Ä–æ–≤–Ω—è `accounts`, `parking`, `payments` –∏ —Ç.–ø. –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ –∏–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–ª–∏—Å—å,
–¥–∞–∂–µ –µ—Å–ª–∏ –∑–∞–ø—É—Å–∫–∞–µ–º `python backend/manage.py ...`.
"""
current_file = Path(__file__).resolve()
backend_dir = current_file.parent
project_root = backend_dir.parent
# –ì–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ–º, —á—Ç–æ –∫–æ—Ä–µ–Ω—å –ø—Ä–æ–µ–∫—Ç–∞ –≤ PYTHONPATH
project_root_str = str(project_root)
if project_root_str not in sys.path:
sys.path.insert(0, project_root_str)
# –ï—Å–ª–∏ –ø–µ—Ä–µ–º–µ–Ω–Ω–∞—è –æ–∫—Ä—É–∂–µ–Ω–∏—è –Ω–µ –∑–∞–¥–∞–Ω–∞ ‚Äì –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é –∏—Å–ø–æ–ª—å–∑—É–µ–º dev-–Ω–∞—Å—Ç—Ä–æ–π–∫–∏
os.environ.setdefault("DJANGO_SETTINGS_MODULE", "backend.settings.local")
try:
from django.core.management import execute_from_command_line
except ImportError as exc:
raise ImportError(
"–ù–µ —É–¥–∞–ª–æ—Å—å –∏–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å Django. –£–±–µ–¥–∏—Å—å, —á—Ç–æ –≤–∏—Ä—Ç—É–∞–ª—å–Ω–æ–µ "
"–æ–∫—Ä—É–∂–µ–Ω–∏–µ –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω–æ –∏ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã."
) from exc
execute_from_command_line(sys.argv)
if __name__ == "__main__":
main()

# File 55/160: backend\backend\__init__.py
################################################################################

from .config.celery import app as celery_app
__all__ = ("celery_app",)

# File 56/160: backend\backend\config\__init__.py
################################################################################

# –ü—É—Å—Ç–æ–π, –Ω–æ –≤–∞–∂–Ω–æ –Ω–∞–ª–∏—á–∏—è –¥–ª—è –∏–º–ø–æ—Ä—Ç–∞ –Ω–∞—Å—Ç—Ä–æ–µ–∫ –∏ celery.

# File 57/160: backend\backend\config\asgi.py
################################################################################

import os
from django.core.asgi import get_asgi_application
settings_module = os.environ.get("DJANGO_SETTINGS_MODULE")
if not settings_module:
raise RuntimeError(
"DJANGO_SETTINGS_MODULE –Ω–µ –∑–∞–¥–∞–Ω. "
"–£–∫–∞–∂–∏ backend.settings.local (dev) –∏–ª–∏ backend.settings.production (prod)."
)
application = get_asgi_application()

# File 58/160: backend\backend\config\celery.py
################################################################################

# backend/backend/config/celery.py
from __future__ import annotations
import os
from celery import Celery
# 1) –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ DJANGO_SETTINGS_MODULE –∑–∞–¥–∞–Ω –∏–∑–≤–Ω–µ
settings_module = os.environ.get("DJANGO_SETTINGS_MODULE")
if not settings_module:
raise RuntimeError(
"DJANGO_SETTINGS_MODULE –Ω–µ –∑–∞–¥–∞–Ω. "
"–£–∫–∞–∂–∏ backend.settings.local (dev) –∏–ª–∏ backend.settings.production (prod) "
"–≤ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è (–Ω–∞–ø—Ä–∏–º–µ—Ä, –≤ .env –∏–ª–∏ unit-—Ñ–∞–π–ª–µ systemd)."
)
# 2) –°–æ–∑–¥–∞—ë–º Celery-–ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ
app = Celery("backend")
# 3) –ß–∏—Ç–∞–µ–º –∫–æ–Ω—Ñ–∏–≥ –∏–∑ Django settings, –≤—Å–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ —Å –ø—Ä–µ—Ñ–∏–∫—Å–æ–º CELERY_
app.config_from_object("django.conf:settings", namespace="CELERY")
# 4) –ê–≤—Ç–æ-–æ–±–Ω–∞—Ä—É–∂–µ–Ω–∏–µ tasks.py –≤–æ –≤—Å–µ—Ö django-–ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è—Ö
app.autodiscover_tasks()
@app.task(bind=True)
def debug_task(self) -> None:
print(f"Debug task: Request: {self.request!r}")

# File 59/160: backend\backend\config\urls.py
################################################################################

from django.conf import settings
from django.conf.urls.static import static
from django.contrib import admin
from django.contrib.staticfiles import finders
from django.http import Http404, HttpResponse
from django.urls import include, path
from django.views.decorators.cache import never_cache
from django.views.generic import TemplateView
from drf_spectacular.views import (
SpectacularAPIView,
SpectacularRedocView,
SpectacularSwaggerView,
)
from rest_framework import routers
from accounts import views as accounts_api
from ai import views as ai_api
from parking import views as parking_views
from payments import views as payments_api
from vehicles import views as vehicles_api
router = routers.DefaultRouter()
# Accounts / –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ (—Ç–æ–ª—å–∫–æ API)
router.register(r"accounts/users", accounts_api.UserViewSet, basename="user")
# Vehicles
router.register(r"vehicles", vehicles_api.VehicleViewSet, basename="vehicle")
# Parking
router.register(r"parking/lots", parking_views.ParkingLotViewSet, basename="parking-lot")
router.register(r"parking/spots", parking_views.ParkingSpotViewSet, basename="parking-spot")
router.register(r"parking/bookings", parking_views.BookingViewSet, basename="booking")
router.register(r"parking/waitlist", parking_views.WaitlistViewSet, basename="waitlist")
router.register(r"parking/complaints", parking_views.ComplaintViewSet, basename="complaint")
router.register(
r"parking/favorites", parking_views.FavoriteParkingSpotViewSet, basename="favorite-spot"
)
router.register(
r"parking/saved-places", parking_views.SavedPlaceViewSet, basename="saved-place"
)
# Payments
router.register(r"payments", payments_api.PaymentViewSet, basename="payment")
router.register(
r"payment-methods", payments_api.PaymentMethodViewSet, basename="payment-method"
)
router.register(
r"payments/methods", payments_api.PaymentMethodViewSet, basename="payment-method-nested"
)
@never_cache
def service_worker(request):
"""
–û—Ç–¥–∞—ë–º service-worker.js —Å –∫–æ—Ä–Ω—è –¥–æ–º–µ–Ω–∞, –Ω–æ —Ñ–∏–∑–∏—á–µ—Å–∫–∏ –æ–Ω –ª–µ–∂–∏—Ç –≤ static/.
"""
path = finders.find("service-worker.js")
if not path:
raise Http404("Service worker not found")
with open(path, "rb") as f:
content = f.read()
return HttpResponse(content, content_type="application/javascript")
@never_cache
def manifest(request):
"""
–û—Ç–¥–∞—ë–º manifest.webmanifest —Å –ø—Ä–∞–≤–∏–ª—å–Ω—ã–º content-type.
"""
path = finders.find("manifest.webmanifest")
if not path:
raise Http404("Manifest not found")
with open(path, "rb") as f:
content = f.read()
return HttpResponse(content, content_type="application/manifest+json")
urlpatterns = [
path("admin/", admin.site.urls),
# PWA —Ñ–∞–π–ª—ã
path("service-worker.js", service_worker, name="service_worker"),
path("manifest.webmanifest", manifest, name="manifest"),
# Web‚Äë—Å—Ç—Ä–∞–Ω–∏—Ü—ã
path("", parking_views.LandingPageView.as_view(), name="landing"),
path("map/", parking_views.MapPageView.as_view(), name="map_page"),
path("pwa-install/", parking_views.PWAInstallGuideView.as_view(), name="pwa_install"),
path("–ª–∏—á–Ω—ã–π-–∫–∞–±–∏–Ω–µ—Ç/", parking_views.UserDashboardView.as_view(), name="user_dashboard"),
path("–∫–∞–±–∏–Ω–µ—Ç-–≤–ª–∞–¥–µ–ª—å—Ü–∞/", parking_views.OwnerDashboardView.as_view(), name="owner_dashboard"),
path("offline/", TemplateView.as_view(template_name="offline.html"), name="offline"),
# Auth —Å—Ç—Ä–∞–Ω–∏—Ü—ã (—Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è/–ª–æ–≥–∏–Ω/—Å–±—Ä–æ—Å –ø–∞—Ä–æ–ª—è)
path("accounts/", include("accounts.urls")),
# API (DRF router)
path("api/", include(router.urls)),
# JWT auth
path(
"api/auth/token/",
accounts_api.TokenObtainPairView.as_view(),
name="token_obtain_pair",
),
path(
"api/auth/token/refresh/",
accounts_api.TokenRefreshSlidingView.as_view(),
name="token_refresh",
),
# OTP / auth
path("api/auth/request-code/", accounts_api.AuthOTPRequestView.as_view(), name="auth_request_code"),
path("api/auth/verify-code/", accounts_api.AuthOTPVerifyView.as_view(), name="auth_verify_code"),
# OpenAPI / –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è
path("api/schema/", SpectacularAPIView.as_view(), name="api-schema"),
path(
"api/docs/",
SpectacularSwaggerView.as_view(url_name="api-schema"),
name="api-docs",
),
path(
"api/docs/redoc/",
SpectacularRedocView.as_view(url_name="api-schema"),
name="api-docs-redoc",
),
# AI API (ParkMate + –∞–Ω–∞–ª–∏—Ç–∏–∫–∞)
path("api/ai/recommendations/", ai_api.RecommendationsAPIView.as_view(), name="ai_recommendations"),
path("api/ai/stress-index/", ai_api.StressIndexAPIView.as_view(), name="ai_stress_index"),
path("api/ai/departure-assistant/", ai_api.DepartureAssistantAPIView.as_view(), name="ai_departure_assistant"),
path("api/ai/parkmate/config/", ai_api.ParkMateConfigAPIView.as_view(), name="parkmate_config"),
path("api/ai/parkmate/price-forecast/", ai_api.ParkMatePriceForecastAPIView.as_view(), name="parkmate_price_forecast"),
path("api/ai/chat/parking/", ai_api.ParkingChatAPIView.as_view(), name="ai_parking_chat"),
path("api/ai/chat/feedback/", ai_api.ChatFeedbackAPIView.as_view(), name="ai_chat_feedback"),
path("api/ai/llm/health/", ai_api.LLMServiceHealthAPIView.as_view(), name="ai_llm_health"),
path("api/parking/map/", parking_views.ParkingMapAPIView.as_view(), name="parking_map"),
path("api/geocode/", parking_views.GeocodeAPIView.as_view(), name="geocode"),
# Payments webhooks
path("payments/webhook/yookassa/", payments_api.YooKassaWebhookView.as_view(), name="yookassa_webhook"),
path("payments/webhook/stripe/", payments_api.StripeWebhookView.as_view(), name="stripe_webhook"),
# DRF browsable API login/logout
path("api-auth/", include("rest_framework.urls")),
]
if settings.DEBUG:
urlpatterns += static(settings.MEDIA_URL, document_root=settings.MEDIA_ROOT)
urlpatterns += static(settings.STATIC_URL, document_root=settings.STATIC_ROOT)

# File 60/160: backend\backend\config\wsgi.py
################################################################################

import os
from django.core.wsgi import get_wsgi_application
settings_module = os.environ.get("DJANGO_SETTINGS_MODULE")
if not settings_module:
raise RuntimeError(
"DJANGO_SETTINGS_MODULE –Ω–µ –∑–∞–¥–∞–Ω. "
"–£–∫–∞–∂–∏ backend.settings.local (dev) –∏–ª–∏ backend.settings.production (prod)."
)
application = get_wsgi_application()

# File 61/160: backend\backend\settings\__init__.py
################################################################################

"""
–ü–∞–∫–µ—Ç –Ω–∞—Å—Ç—Ä–æ–µ–∫ Django –¥–ª—è ParkShare.
–í–∞–∂–Ω–æ:
- –ù–µ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ DJANGO_SETTINGS_MODULE=backend.settings.
- –í—Å–µ–≥–¥–∞ —É–∫–∞–∑—ã–≤–∞–π—Ç–µ –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–π –º–æ–¥—É–ª—å:
- backend.settings.local      ‚Äî –¥–ª—è –ª–æ–∫–∞–ª—å–Ω–æ–π —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏
- backend.settings.production ‚Äî –¥–ª—è –ø—Ä–æ–¥–∞–∫—à–µ–Ω–∞
–≠—Ç–æ —Å–æ–≥–ª–∞—Å–æ–≤–∞–Ω–æ —Å –ø—Ä–æ–≤–µ—Ä–∫–∞–º–∏ –≤ backend.config.wsgi / asgi / celery.
"""

# File 62/160: backend\backend\settings\base.py
################################################################################

import os
from datetime import timedelta
from pathlib import Path
from typing import List
import environ
from .regions import REGION_PROFILES
# ---------------------------------------------------------------------------
# –ü—É—Ç–∏
# ---------------------------------------------------------------------------
# BASE_DIR ‚Äî –∫–æ—Ä–µ–Ω—å —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è: C:\Users\Sultan\Downloads\parkshare_ru_part1
BASE_DIR = Path(__file__).resolve().parents[3]
# –¢—É—Ç –≥–ª–∞–≤–Ω–∞—è –ø—Ä–∞–≤–∫–∞: –±–æ–ª—å—à–µ –Ω–µ —É—Ö–æ–¥–∏–º –Ω–∞ —É—Ä–æ–≤–µ–Ω—å –≤—ã—à–µ
PROJECT_ROOT = BASE_DIR
# ---------------------------------------------------------------------------
# –û–∫—Ä—É–∂–µ–Ω–∏–µ
# ---------------------------------------------------------------------------
env = environ.Env(
DEBUG=(bool, False),
)
env_file = PROJECT_ROOT / ".env"
if env_file.exists():
environ.Env.read_env(str(env_file))
DEBUG: bool = env.bool("DEBUG", default=False)
# –û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û: –∫–ª—é—á —Ç–æ–ª—å–∫–æ –∏–∑ –ø–µ—Ä–µ–º–µ–Ω–Ω–æ–π –æ–∫—Ä—É–∂–µ–Ω–∏—è / .env
SECRET_KEY: str = env("SECRET_KEY")
ALLOWED_HOSTS: List[str] = env.list(
"ALLOWED_HOSTS", default=["localhost", "127.0.0.1"]
)
# –ú–∞—Ä–∫–µ—Ç/—Ä–µ–≥–∏–æ–Ω: RU ‚Äî –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é, GLOBAL ‚Äî –º–µ–∂–¥—É–Ω–∞—Ä–æ–¥–Ω—ã–π –ø—Ä–æ—Ñ–∏–ª—å.
PLATFORM_MODE: str = env("PLATFORM_MODE", default="RU").upper()
# ---------------------------------------------------------------------------
# –†–µ–≥–∏–æ–Ω–∞–ª—å–Ω—ã–µ –ø—Ä–æ—Ñ–∏–ª–∏ / –∫–∞—Ä—Ç—ã
# ---------------------------------------------------------------------------
REGION_PROFILE: str = env("REGION_PROFILE", default="RU")
REGION = REGION_PROFILES.get(REGION_PROFILE, REGION_PROFILES["RU"])
# –ü—Ä–æ–≤–∞–π–¥–µ—Ä –∫–∞—Ä—Ç—ã –º–æ–∂–Ω–æ –ø–µ—Ä–µ–æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å —á–µ—Ä–µ–∑ MAP_PROVIDER,
# –∏–Ω–∞—á–µ –±–µ—Ä—ë–º primary –∏–∑ –ø—Ä–æ—Ñ–∏–ª—è.
MAP_PROVIDER: str = env("MAP_PROVIDER", default=REGION["maps"]["primary"])
MAP_PROVIDER_FALLBACK: str = env(
"MAP_PROVIDER_FALLBACK", default=REGION["maps"].get("fallback", "leaflet")
)
YANDEX_MAP_API_KEY: str = env("YANDEX_MAP_API_KEY", default="")
MAPBOX_TOKEN: str = env("MAPBOX_TOKEN", default="")
MAP_DEFAULT_CENTER = REGION["maps"].get("default_center", [55.75, 37.61])
MAP_DEFAULT_ZOOM = REGION["maps"].get("default_zoom", 11)
# ---------------------------------------------------------------------------
# –ü—Ä–∏–ª–æ–∂–µ–Ω–∏—è
# ---------------------------------------------------------------------------
INSTALLED_APPS = [
# Django
"django.contrib.admin",
"django.contrib.auth",
"django.contrib.contenttypes",
"django.contrib.sessions",
"django.contrib.messages",
"django.contrib.staticfiles",
# –°—Ç–æ—Ä–æ–Ω–Ω–∏–µ
"rest_framework",
"corsheaders",
"django_cryptography",
"drf_spectacular",
# –ü—Ä–æ–µ–∫—Ç–Ω—ã–µ
"accounts",
"vehicles",
"parking",
"payments",
"ai",
"core",
]
MIDDLEWARE = [
"core.middleware.RateLimitMiddleware",
"corsheaders.middleware.CorsMiddleware",
"django.middleware.security.SecurityMiddleware",
"core.middleware.SecurityHeadersMiddleware",
"django.middleware.gzip.GZipMiddleware",
"django.contrib.sessions.middleware.SessionMiddleware",
"django.middleware.common.CommonMiddleware",
"django.middleware.csrf.CsrfViewMiddleware",
"django.contrib.auth.middleware.AuthenticationMiddleware",
"django.contrib.messages.middleware.MessageMiddleware",
"django.middleware.clickjacking.XFrameOptionsMiddleware",
]
ROOT_URLCONF = "backend.config.urls"
TEMPLATES = [
{
"BACKEND": "django.template.backends.django.DjangoTemplates",
"DIRS": [BASE_DIR / "templates"],
"APP_DIRS": True,
"OPTIONS": {
"context_processors": [
"django.template.context_processors.debug",
"django.template.context_processors.request",
"django.contrib.auth.context_processors.auth",
"django.contrib.messages.context_processors.messages",
# –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ ParkShare: —Ä–µ–≥–∏–æ–Ω, –∫–∞—Ä—Ç–∞ –∏ —Ç.–¥.
"core.context_processors.global_settings",
],
},
},
]
WSGI_APPLICATION = "backend.config.wsgi.application"
ASGI_APPLICATION = "backend.config.asgi.application"
# ---------------------------------------------------------------------------
# –ë–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö
# ---------------------------------------------------------------------------
DATABASES = {
"default": env.db(
"DATABASE_URL", default=f"sqlite:
)
}
# –ï—Å–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–µ–º PostgreSQL ‚Äî –ø–µ—Ä–µ–∫–ª—é—á–∞–µ–º—Å—è –Ω–∞ PostGIS
if DATABASES["default"]["ENGINE"] == "django.db.backends.postgresql":
DATABASES["default"]["ENGINE"] = "django.contrib.gis.db.backends.postgis"
# ---------------------------------------------------------------------------
# –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å / –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è
# ---------------------------------------------------------------------------
AUTH_USER_MODEL = "accounts.User"
AUTH_PASSWORD_VALIDATORS = [
{
"NAME": "django.contrib.auth.password_validation.UserAttributeSimilarityValidator",
},
{
"NAME": "django.contrib.auth.password_validation.MinimumLengthValidator",
"OPTIONS": {"min_length": 8},
},
{
"NAME": "django.contrib.auth.password_validation.CommonPasswordValidator",
},
{
"NAME": "django.contrib.auth.password_validation.NumericPasswordValidator",
},
]
# ---------------------------------------------------------------------------
# –õ–æ–∫–∞–ª–∏–∑–∞—Ü–∏—è
# ---------------------------------------------------------------------------
LANGUAGE_CODE = env("LANGUAGE_CODE", default="ru-ru")
TIME_ZONE = env("TIME_ZONE", default="Europe/Moscow")
USE_I18N = True
USE_L10N = True
USE_TZ = True
# ---------------------------------------------------------------------------
# –°—Ç–∞—Ç–∏–∫–∞ / –º–µ–¥–∏–∞
# ---------------------------------------------------------------------------
STATIC_URL = "/static/"
STATIC_ROOT = BASE_DIR / "staticfiles"
STATICFILES_DIRS = [
BASE_DIR / "static",
]
MEDIA_URL = "/media/"
MEDIA_ROOT = BASE_DIR / "media"
# ---------------------------------------------------------------------------
# PWA
# ---------------------------------------------------------------------------
PWA_APP_NAME = "ParkShare RU"
PWA_APP_SHORT_NAME = "ParkShare"
PWA_THEME_COLOR = "
PWA_BACKGROUND_COLOR = "
# ---------------------------------------------------------------------------
# DRF / OpenAPI
# ---------------------------------------------------------------------------
REST_FRAMEWORK = {
"DEFAULT_AUTHENTICATION_CLASSES": [
"rest_framework_simplejwt.authentication.JWTAuthentication",
"rest_framework.authentication.SessionAuthentication",
],
"DEFAULT_PERMISSION_CLASSES": [
"rest_framework.permissions.IsAuthenticatedOrReadOnly",
],
"DEFAULT_PAGINATION_CLASS": "core.pagination.DefaultPageNumberPagination",
"PAGE_SIZE": 20,
"DEFAULT_SCHEMA_CLASS": "drf_spectacular.openapi.AutoSchema",
}
SPECTACULAR_SETTINGS = {
"TITLE": "ParkShare RU API",
"DESCRIPTION": "API —Å–µ—Ä–≤–∏—Å–∞ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è –ø–∞—Ä–∫–æ–≤–æ—á–Ω—ã—Ö –º–µ—Å—Ç ParkShare RU.",
"VERSION": "1.0.0",
"SERVE_INCLUDE_SCHEMA": False,
}
# ---------------------------------------------------------------------------
# CORS
# ---------------------------------------------------------------------------
CORS_ALLOWED_ORIGINS = env.list("CORS_ALLOWED_ORIGINS", default=[])
CORS_ALLOWED_ORIGIN_REGEXES = env.list("CORS_ALLOWED_ORIGIN_REGEXES", default=[])
CORS_ALLOW_CREDENTIALS = True
CSRF_TRUSTED_ORIGINS = env.list("CSRF_TRUSTED_ORIGINS", default=[])
# ---------------------------------------------------------------------------
# JWT
# ---------------------------------------------------------------------------
SIMPLE_JWT = {
"ACCESS_TOKEN_LIFETIME": timedelta(minutes=15),
"REFRESH_TOKEN_LIFETIME": timedelta(days=7),
"ROTATE_REFRESH_TOKENS": True,
"BLACKLIST_AFTER_ROTATION": True,
"ALGORITHM": "HS256",
"SIGNING_KEY": SECRET_KEY,
"AUTH_HEADER_TYPES": ("Bearer",),
"AUTH_TOKEN_CLASSES": ("rest_framework_simplejwt.tokens.AccessToken",),
"UPDATE_LAST_LOGIN": True,
}
# ---------------------------------------------------------------------------
# Redis / Celery
# ---------------------------------------------------------------------------
REDIS_URL = env("REDIS_URL", default="redis:
CELERY_BROKER_URL = env("CELERY_BROKER_URL", default=REDIS_URL)
CELERY_RESULT_BACKEND = env("CELERY_RESULT_BACKEND", default=REDIS_URL)
CELERY_ACCEPT_CONTENT = ["json"]
CELERY_TASK_SERIALIZER = "json"
CELERY_RESULT_SERIALIZER = "json"
CELERY_TIMEZONE = TIME_ZONE
CELERY_BEAT_SCHEDULE = {
"expire_unpaid_bookings": {
"task": "parking.tasks.expire_unpaid_bookings",
"schedule": 60 * 10,
},
"update_ai_models": {
"task": "ai.tasks.update_models",
"schedule": 60 * 60,
},
"check_stale_payments": {
"task": "payments.tasks.check_stale_payments",
"schedule": 60 * 15,
},
}
# ---------------------------------------------------------------------------
# –õ–æ–≥–∏
# ---------------------------------------------------------------------------
LOGGING = {
"version": 1,
"disable_existing_loggers": False,
"formatters": {
"verbose": {
"format": "[{asctime}] {levelname} {name} {message}",
"style": "{",
},
"simple": {
"format": "{levelname} {message}",
"style": "{",
},
},
"handlers": {
"console": {
"class": "logging.StreamHandler",
"formatter": "verbose",
},
},
"loggers": {
"django": {
"handlers": ["console"],
"level": "INFO",
},
"parkshare": {
"handlers": ["console"],
"level": "INFO",
},
"ai": {
"handlers": ["console"],
"level": "DEBUG",
"propagate": False,
},
"services": {
"handlers": ["console"],
"level": "DEBUG",
"propagate": False,
},
},
}
# ---------------------------------------------------------------------------
# Email
# ---------------------------------------------------------------------------
EMAIL_BACKEND = env(
"EMAIL_BACKEND",
default="django.core.mail.backends.console.EmailBackend",
)
DEFAULT_FROM_EMAIL = env(
"DEFAULT_FROM_EMAIL",
default="ParkShare RU <noreply@example.com>",
)
SERVER_EMAIL = env("SERVER_EMAIL", default=DEFAULT_FROM_EMAIL)
# ---------------------------------------------------------------------------
# –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å (–±–∞–∑–æ–≤—ã–π —É—Ä–æ–≤–µ–Ω—å, –¥–µ—Ç–∞–ª–∏ –ø–µ—Ä–µ–æ–ø—Ä–µ–¥–µ–ª—è—é—Ç—Å—è –≤ production.py)
# ---------------------------------------------------------------------------
SECURE_SSL_REDIRECT = env.bool("SECURE_SSL_REDIRECT", default=False)
SESSION_COOKIE_SECURE = env.bool("SESSION_COOKIE_SECURE", default=False)
CSRF_COOKIE_SECURE = env.bool("CSRF_COOKIE_SECURE", default=False)
SESSION_COOKIE_HTTPONLY = True
CSRF_COOKIE_HTTPONLY = True
SESSION_COOKIE_SAMESITE = "Lax"
CSRF_COOKIE_SAMESITE = "Lax"
X_FRAME_OPTIONS = "DENY"
SECURE_PROXY_SSL_HEADER = ("HTTP_X_FORWARDED_PROTO", "https")
CONTENT_SECURITY_POLICY = env(
"CONTENT_SECURITY_POLICY",
default=(
"default-src 'self'; "
"script-src 'self' 'unsafe-inline' https:; "
"style-src 'self' 'unsafe-inline' https:; "
"img-src 'self' data: https:; "
"connect-src 'self' https:; "
"font-src 'self' https: data:; "
"frame-ancestors 'none'; "
"form-action 'self';"
),
)
REFERRER_POLICY = env("REFERRER_POLICY", default="strict-origin-when-cross-origin")
PERMISSIONS_POLICY = env(
"PERMISSIONS_POLICY",
# –†–∞–∑—Ä–µ—à–∞–µ–º –≥–µ–æ–ª–æ–∫–∞—Ü–∏—é —Ç–æ–ª—å–∫–æ —Å–µ–±–µ, –æ—Å—Ç–∞–ª—å–Ω–æ–µ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é –∑–∞–ø—Ä–µ—â–µ–Ω–æ
default="geolocation=(self), camera=(), microphone=(), payment=()",
)
# COOP / COEP / CORP ‚Äî –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é –≤—ã–∫–ª—é—á–µ–Ω—ã, —á—Ç–æ–±—ã –Ω–µ –ª–æ–º–∞—Ç—å
# –≤–Ω–µ—à–Ω–∏–µ —Ä–µ—Å—É—Ä—Å—ã (–∫–∞—Ä—Ç—ã, CDN, –ø–ª–∞—Ç—ë–∂–Ω—ã–µ –≤–∏–¥–∂–µ—Ç—ã –∏ —Ç.–ø.).
# –ï—Å–ª–∏ –ø–æ–Ω–∞–¥–æ–±–∏—Ç—Å—è SharedArrayBuffer –∏ —Å—Ç—Ä–æ–≥–∞—è –∏–∑–æ–ª—è—Ü–∏—è ‚Äî –≤–∫–ª—é—á–∏—à—å
# —è–≤–Ω–æ —á–µ—Ä–µ–∑ .env.
CROSS_ORIGIN_OPENER_POLICY = env(
"CROSS_ORIGIN_OPENER_POLICY", default=""
)
CROSS_ORIGIN_EMBEDDER_POLICY = env(
"CROSS_ORIGIN_EMBEDDER_POLICY", default=""
)
CROSS_ORIGIN_RESOURCE_POLICY = env(
"CROSS_ORIGIN_RESOURCE_POLICY", default=""
)
# ---------------------------------------------------------------------------
# Rate limiting
# ---------------------------------------------------------------------------
RATE_LIMIT_CACHE = env("RATE_LIMIT_CACHE", default="default")
RATE_LIMIT_WINDOW = env.int("RATE_LIMIT_WINDOW", default=60)
RATE_LIMIT_REQUESTS = env.int("RATE_LIMIT_REQUESTS", default=120)
RATE_LIMIT_WHITELIST = env.list(
"RATE_LIMIT_WHITELIST", default=["127.0.0.1", "::1"]
)
# ---------------------------------------------------------------------------
# django-cryptography
# ---------------------------------------------------------------------------
DJANGO_CRYPTography_KEY = SECRET_KEY
# ---------------------------------------------------------------------------
# –ë–∏–∑–Ω–µ—Å-–Ω–∞—Å—Ç—Ä–æ–π–∫–∏
# ---------------------------------------------------------------------------
VEHICLE_PLATE_SALT = env("VEHICLE_PLATE_SALT", default="change_me_vehicle_salt")
YOOKASSA_SHOP_ID = env("YOOKASSA_SHOP_ID", default="")
YOOKASSA_SECRET_KEY = env("YOOKASSA_SECRET_KEY", default="")
YOOKASSA_RETURN_URL = env("YOOKASSA_RETURN_URL", default="")
YOOKASSA_WEBHOOK_SECRET = env("YOOKASSA_WEBHOOK_SECRET", default="")
STRIPE_SECRET_KEY = env("STRIPE_SECRET_KEY", default="")
STRIPE_WEBHOOK_SECRET = env("STRIPE_WEBHOOK_SECRET", default="")
DEFAULT_PAYMENT_PROVIDER = env(
"PAYMENT_PROVIDER",
default="yookassa" if PLATFORM_MODE == "RU" else "stripe",
)
SERVICE_COMMISSION_PERCENT = env.int("SERVICE_COMMISSION_PERCENT", default=10)
# ---------------------------------------------------------------------------
# –ö—ç—à –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é ‚Äî in-memory (–≤ –ø—Ä–æ–¥–∞–∫—à–µ–Ω–µ –º–æ–∂–Ω–æ –ø–µ—Ä–µ–∫–ª—é—á–∏—Ç—å –Ω–∞ Redis)
# ---------------------------------------------------------------------------
CACHES = {
"default": {
"BACKEND": "django.core.cache.backends.locmem.LocMemCache",
"LOCATION": "parkshare_cache",
}
}
DEFAULT_AUTO_FIELD = "django.db.models.BigAutoField"

# File 63/160: backend\backend\settings\local.py
################################################################################

from .base import *
# –õ–æ–∫–∞–ª—å–Ω–∞—è —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∞
DEBUG = env.bool("DEBUG", default=True)
ALLOWED_HOSTS = env.list("ALLOWED_HOSTS", default=["127.0.0.1", "localhost"])
INTERNAL_IPS = ["127.0.0.1"]
SECURE_SSL_REDIRECT = False
SESSION_COOKIE_SECURE = False
CSRF_COOKIE_SECURE = False

# File 64/160: backend\backend\settings\production.py
################################################################################

from django.core.exceptions import ImproperlyConfigured
from .base import *
# –ü—Ä–æ–¥–∞–∫—à–µ–Ω-–Ω–∞—Å—Ç—Ä–æ–π–∫–∏
DEBUG = False
ALLOWED_HOSTS = env.list("ALLOWED_HOSTS", default=[])
if not ALLOWED_HOSTS:
raise ImproperlyConfigured(
"–í –ø—Ä–æ–¥–∞–∫—à–µ–Ω–µ ALLOWED_HOSTS –Ω–µ –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –ø—É—Å—Ç—ã–º. "
"–ó–∞–¥–∞–π—Ç–µ ALLOWED_HOSTS –≤ .env"
)
SECURE_SSL_REDIRECT = env.bool("SECURE_SSL_REDIRECT", default=True)
SESSION_COOKIE_SECURE = env.bool("SESSION_COOKIE_SECURE", default=True)
CSRF_COOKIE_SECURE = env.bool("CSRF_COOKIE_SECURE", default=True)
SECURE_HSTS_SECONDS = env.int("SECURE_HSTS_SECONDS", default=60 * 60 * 24)
SECURE_HSTS_INCLUDE_SUBDOMAINS = True
SECURE_HSTS_PRELOAD = True

# File 65/160: backend\backend\settings\regions.py
################################################################################

from __future__ import annotations
"""
–†–µ–≥–∏–æ–Ω–∞–ª—å–Ω—ã–µ –ø—Ä–æ—Ñ–∏–ª–∏ ParkShare.
RU ‚Äî –æ—Å–Ω–æ–≤–Ω–æ–π –ø—Ä–æ—Ñ–∏–ª—å (ParkShare RU) —Å –Ø–Ω–¥–µ–∫—Å.–ö–∞—Ä—Ç–∞–º–∏, —Ä–æ—Å—Å–∏–π—Å–∫–∏–º–∏ –ø–ª–∞—Ç—ë–∂–∫–∞–º–∏
–∏ –ø—Ä–æ–≤–∞–π–¥–µ—Ä–∞–º–∏ –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏.
EU/US ‚Äî –∑–∞–≥–æ—Ç–æ–≤–∫–∏ –¥–ª—è –±—É–¥—É—â–∏—Ö —Ä—ã–Ω–∫–æ–≤.
"""
REGION_PROFILES = {
"RU": {
"code": "RU",
"name": "Russia",
"maps": {
# –í–∞–∂–Ω–æ: –ª–æ–≥–∏—á–µ—Å–∫–∏–µ –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä—ã, –∞ –Ω–µ "–º–∞—Ä–∫–µ—Ç–∏–Ω–≥–æ–≤—ã–µ" –Ω–∞–∑–≤–∞–Ω–∏—è
"primary": "yandex",
"fallback": "leaflet",
"language": "ru_RU",
"default_center": [55.75, 37.61],
"default_zoom": 11,
},
"payments": {
"required": [
"sberbank_online",
"tinkoff",
"yoomoney",
"mir_pay",
"qiwi",
],
},
"auth": [
"gosuslugi",
"vk_id",
"yandex_id",
"sber_id",
],
"holidays": {
"provider": "ru_holidays",
},
},
"EU": {
"code": "EU",
"name": "European Union",
"maps": {
"primary": "leaflet",
"fallback": "leaflet",
"language": "en_US",
"default_center": [52.52, 13.405],
"default_zoom": 11,
},
"payments": {
"required": [
"visa_mastercard",
],
},
"auth": ["email_password"],
"holidays": {
"provider": "eu_holidays",
},
},
"US": {
"code": "US",
"name": "United States",
"maps": {
"primary": "leaflet",
"fallback": "leaflet",
"language": "en_US",
"default_center": [40.7128, -74.0060],
"default_zoom": 11,
},
"payments": {
"required": [
"visa_mastercard",
"apple_pay",
"google_pay",
],
},
"auth": ["email_password"],
"holidays": {
"provider": "us_holidays",
},
},
}

# File 66/160: backend\rest_framework_simplejwt\__init__.py
################################################################################

"""Stub for rest_framework_simplejwt to allow offline checks."""

# File 67/160: backend\rest_framework_simplejwt\authentication.py
################################################################################

from rest_framework.authentication import BaseAuthentication
class JWTAuthentication(BaseAuthentication):
def authenticate(self, request):
return None

# File 68/160: backend\rest_framework_simplejwt\tokens.py
################################################################################

class RefreshToken:
@classmethod
def for_user(cls, user):
return cls()
def __str__(self):
return "stub-token"
@property
def access_token(self):
return "stub-access"

# File 69/160: backend\rest_framework_simplejwt\views.py
################################################################################

from rest_framework.response import Response
from rest_framework.views import APIView
class TokenObtainPairView(APIView):
def post(self, request, *args, **kwargs):
return Response({"access": "stub", "refresh": "stub"})
class TokenRefreshView(APIView):
def post(self, request, *args, **kwargs):
return Response({"access": "stub"})
class TokenRefreshSlidingView(TokenRefreshView):
pass

# File 70/160: backend\tests\__init__.py
################################################################################

# –ü–∞–∫–µ—Ç —Å –±–∞–∑–æ–≤—ã–º–∏ —Ç–µ—Å—Ç–∞–º–∏ –ø—Ä–æ–µ–∫—Ç–∞ ParkShare RU.

# File 71/160: backend\tests\test_auth_api.py
################################################################################

from django.test import TestCase
from rest_framework.test import APIClient
class AuthApiTests(TestCase):
def setUp(self) -> None:
self.client = APIClient()
self.password = "StrongPass123"
def test_register_and_login_by_username_email_and_phone(self):
# –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è
resp = self.client.post(
"/api/accounts/users/register/",
{
"username": "demo",
"password": self.password,
"email": "demo@example.com",
"phone": "+7 (999) 123-45-67",
},
format="json",
)
self.assertEqual(resp.status_code, 201)
self.client.logout()
# –õ–æ–≥–∏–Ω –ø–æ –ª–æ–≥–∏–Ω—É
resp = self.client.post(
"/api/accounts/users/login/",
{"identifier": "demo", "password": self.password},
format="json",
)
self.assertEqual(resp.status_code, 200)
self.assertEqual(resp.data["username"], "demo")
self.client.logout()
# –õ–æ–≥–∏–Ω –ø–æ email
resp = self.client.post(
"/api/accounts/users/login/",
{"identifier": "demo@example.com", "password": self.password},
format="json",
)
self.assertEqual(resp.status_code, 200)
self.client.logout()
# –õ–æ–≥–∏–Ω –ø–æ —Ç–µ–ª–µ—Ñ–æ–Ω—É (–≤ –ª—é–±–æ–º —É–¥–æ–±–Ω–æ–º —Ñ–æ—Ä–º–∞—Ç–µ)
resp = self.client.post(
"/api/accounts/users/login/",
{"identifier": "+7 999 123-45-67", "password": self.password},
format="json",
)
self.assertEqual(resp.status_code, 200)

# File 72/160: backend\tests\test_booking_model.py
################################################################################

from datetime import timedelta
from decimal import Decimal
from django.test import TestCase
from django.utils import timezone
from accounts.models import User
from parking.models import Booking, ParkingLot, ParkingSpot
class BookingModelTests(TestCase):
def setUp(self) -> None:
self.owner = User.objects.create_user(
username="owner",
password="StrongPass123",
role=User.Role.OWNER,
)
self.driver = User.objects.create_user(
username="driver",
password="StrongPass123",
role=User.Role.DRIVER,
)
self.lot = ParkingLot.objects.create(
owner=self.owner,
name="Test Lot",
city="Test City",
address="Test street, 1",
)
self.spot = ParkingSpot.objects.create(
lot=self.lot,
name="A1",
hourly_price=Decimal("100.00"),
)
def test_calculate_price_hourly_with_commission(self):
now = timezone.now()
booking = Booking(
user=self.driver,
spot=self.spot,
booking_type=Booking.BookingType.HOURLY,
start_at=now,
end_at=now + timedelta(hours=1, minutes=30),
total_price=Decimal("0.00"),
currency="RUB",
)
total = booking.calculate_price()
# 2 —á–∞—Å–∞ * 100 ‚ÇΩ + 10% –∫–æ–º–∏—Å—Å–∏–∏ = 220
self.assertEqual(total, Decimal("220.00"))
def test_is_spot_available(self):
now = timezone.now()
existing = Booking.objects.create(
user=self.driver,
spot=self.spot,
booking_type=Booking.BookingType.HOURLY,
start_at=now,
end_at=now + timedelta(hours=2),
status=Booking.Status.CONFIRMED,
total_price=Decimal("200.00"),
currency="RUB",
)
# –ü–µ—Ä–µ—Å–µ–∫–∞—é—â–∏–π—Å—è –∏–Ω—Ç–µ—Ä–≤–∞–ª ‚Äî –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω
self.assertFalse(
Booking.is_spot_available(
self.spot,
now + timedelta(minutes=30),
now + timedelta(hours=3),
)
)
# –ù–µ–ø–µ—Ä–µ—Å–µ–∫–∞—é—â–∏–π—Å—è –∏–Ω—Ç–µ—Ä–≤–∞–ª ‚Äî –¥–æ—Å—Ç—É–ø–µ–Ω
self.assertTrue(
Booking.is_spot_available(
self.spot,
existing.end_at + timedelta(minutes=1),
existing.end_at + timedelta(hours=1),
)
)

# File 73/160: core\__init__.py
################################################################################



# File 74/160: core\admin.py
################################################################################



# File 75/160: core\apps.py
################################################################################

# core/apps.py
from django.apps import AppConfig
class CoreConfig(AppConfig):
default_auto_field = "django.db.models.BigAutoField"
name = "core"
verbose_name = "–Ø–¥—Ä–æ ParkShare"

# File 76/160: core\context_processors.py
################################################################################

# core/context_processors.py
from __future__ import annotations
from django.conf import settings
def global_settings(request):
"""
–ì–ª–æ–±–∞–ª—å–Ω—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏, –∫–æ—Ç–æ—Ä—ã–µ –Ω—É–∂–Ω—ã –≤–æ –≤—Å–µ—Ö —à–∞–±–ª–æ–Ω–∞—Ö:
—Ä–µ–≥–∏–æ–Ω, –∫–∞—Ä—Ç–∞, –∫–ª—é—á–∏ –∏ –¥–µ—Ñ–æ–ª—Ç–Ω—ã–π —Ü–µ–Ω—Ç—Ä.
"""
return {
"REGION_PROFILE": getattr(settings, "REGION_PROFILE", "RU"),
"PLATFORM_MODE": getattr(settings, "PLATFORM_MODE", "RU"),
"MAP_PROVIDER": getattr(settings, "MAP_PROVIDER", "yandex"),
"MAP_PROVIDER_FALLBACK": getattr(settings, "MAP_PROVIDER_FALLBACK", "leaflet"),
"YANDEX_MAP_API_KEY": getattr(settings, "YANDEX_MAP_API_KEY", ""),
"MAPBOX_TOKEN": getattr(settings, "MAPBOX_TOKEN", ""),
"MAP_DEFAULT_CENTER": getattr(
settings,
"MAP_DEFAULT_CENTER",
[55.75, 37.61],
),
"MAP_DEFAULT_ZOOM": getattr(settings, "MAP_DEFAULT_ZOOM", 11),
}

# File 77/160: core\integrations.py
################################################################################

"""core/integrations.py
–ê–¥–∞–ø—Ç–µ—Ä—ã –¥–ª—è –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–π –ø–æ —Ä–µ–≥–∏–æ–Ω–∞–º:
- –∫–∞—Ä—Ç—ã (RU: –Ø–Ω–¥–µ–∫—Å, GLOBAL: Mapbox/OSM);
- –ø–ª–∞—Ç–µ–∂–∏ (RU: YooKassa, GLOBAL: Stripe);
- –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è (RU: –ï–°–ò–ê/VK/–Ø–Ω–¥–µ–∫—Å, GLOBAL: generic OAuth2).
–¶–µ–ª—å ‚Äî –µ–¥–∏–Ω–∞—è —Ç–æ—á–∫–∞ –≤—ã–±–æ—Ä–∞ –ø—Ä–æ–≤–∞–π–¥–µ—Ä–∞ —á–µ—Ä–µ–∑ PLATFORM_MODE
(ENV: PLATFORM_MODE=RU|GLOBAL) –±–µ–∑ —Ä–∞–∑–¥—É–≤–∞–Ω–∏—è –º–∏–∫—Ä–æ—Å–µ—Ä–≤–∏—Å–æ–≤.
"""
from __future__ import annotations
from dataclasses import dataclass
from typing import Dict
from django.conf import settings
@dataclass
class MapProviderAdapter:
key: str
api_key: str
language: str
default_center: list[float]
default_zoom: int
def as_frontend_payload(self) -> Dict[str, str | list[float] | int]:
return {
"provider": self.key,
"language": self.language,
"api_key": self.api_key,
"center": self.default_center,
"zoom": self.default_zoom,
}
@dataclass
class PaymentGatewayAdapter:
key: str
webhook_url: str
return_url: str
def as_dict(self) -> Dict[str, str]:
return {
"provider": self.key,
"webhook_url": self.webhook_url,
"return_url": self.return_url,
}
@dataclass
class AuthProviderAdapter:
key: str
client_id: str
authorization_url: str
scopes: list[str]
def as_dict(self) -> Dict[str, str | list[str]]:
return {
"provider": self.key,
"client_id": self.client_id,
"authorization_url": self.authorization_url,
"scopes": self.scopes,
}
RU_INTEGRATIONS = {
"maps": MapProviderAdapter(
key=settings.MAP_PROVIDER,
api_key=settings.YANDEX_MAP_API_KEY,
language=settings.REGION.get("maps", {}).get("language", "ru_RU"),
default_center=settings.MAP_DEFAULT_CENTER,
default_zoom=settings.MAP_DEFAULT_ZOOM,
),
"payments": PaymentGatewayAdapter(
key=settings.DEFAULT_PAYMENT_PROVIDER,
webhook_url="/payments/webhook/yookassa/",
return_url=settings.YOOKASSA_RETURN_URL,
),
"auth": [
AuthProviderAdapter(
key="gosuslugi",
client_id="GOSUSLUGI_CLIENT_ID_PLACEHOLDER",
authorization_url="https:
scopes=["openid", "profile"],
),
AuthProviderAdapter(
key="vk_id",
client_id="VK_CLIENT_ID_PLACEHOLDER",
authorization_url="https:
scopes=["email"],
),
],
}
GLOBAL_INTEGRATIONS = {
"maps": MapProviderAdapter(
key=settings.MAP_PROVIDER if settings.PLATFORM_MODE == "GLOBAL" else "mapbox",
api_key=settings.MAPBOX_TOKEN,
language="en_US",
default_center=settings.MAP_DEFAULT_CENTER,
default_zoom=settings.MAP_DEFAULT_ZOOM,
),
"payments": PaymentGatewayAdapter(
key=settings.DEFAULT_PAYMENT_PROVIDER,
webhook_url="/payments/webhook/stripe/",
return_url="/payments/return/",
),
"auth": [
AuthProviderAdapter(
key="google",
client_id="GOOGLE_OAUTH_CLIENT_ID",
authorization_url="https:
scopes=["openid", "email", "profile"],
),
AuthProviderAdapter(
key="apple",
client_id="APPLE_CLIENT_ID",
authorization_url="https:
scopes=["name", "email"],
),
],
}
def get_integrations() -> dict:
if settings.PLATFORM_MODE == "GLOBAL":
return GLOBAL_INTEGRATIONS
return RU_INTEGRATIONS

# File 78/160: core\middleware.py
################################################################################

from __future__ import annotations
import time
from typing import Callable
from django.conf import settings
from django.core.cache import caches
from django.http import HttpRequest, HttpResponse, JsonResponse
# core/middleware.py
from django.conf import settings
class SecurityHeadersMiddleware:
"""
–î–æ–±–∞–≤–ª—è–µ—Ç –±–∞–∑–æ–≤—ã–µ –∑–∞—â–∏—Ç–Ω—ã–µ –∑–∞–≥–æ–ª–æ–≤–∫–∏.
COOP/COEP/CORP –±–µ—Ä—ë–º –∏–∑ settings.* –∏ –≤ DEBUG –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é –æ—Ç–∫–ª—é—á–∞–µ–º,
—á—Ç–æ–±—ã –Ω–µ –ª–æ–º–∞—Ç—å dev-—Ñ–∏—á–∏ –≤—Ä–æ–¥–µ Leaflet / –≤–Ω–µ—à–Ω–∏—Ö API.
"""
def __init__(self, get_response):
self.get_response = get_response
def __call__(self, request):
response = self.get_response(request)
# CSP
csp = getattr(settings, "CONTENT_SECURITY_POLICY", None)
if csp:
response.setdefault("Content-Security-Policy", csp)
# X-Frame-Options
response.setdefault("X-Frame-Options", "DENY")
# X-Content-Type-Options
response.setdefault("X-Content-Type-Options", "nosniff")
# Referrer-Policy
referrer = getattr(settings, "REFERRER_POLICY", None)
if referrer:
response.setdefault("Referrer-Policy", referrer)
# Permissions-Policy
perm = getattr(settings, "PERMISSIONS_POLICY", None)
if perm:
response.setdefault("Permissions-Policy", perm)
# --- COOP / COEP / CORP ---
if settings.DEBUG:
# –í dev –≤–æ–æ–±—â–µ –Ω–µ —Å—Ç–∞–≤–∏–º –∏—Ö, –∏ –∑–∞–æ–¥–Ω–æ —Å–Ω–æ—Å–∏–º, –µ—Å–ª–∏ –∫—Ç–æ-—Ç–æ –≤—ã—à–µ –∏—Ö –ø–æ–≤–µ—Å–∏–ª
for header in (
"Cross-Origin-Opener-Policy",
"Cross-Origin-Embedder-Policy",
"Cross-Origin-Resource-Policy",
):
if header in response:
del response[header]
else:
coop = getattr(settings, "CROSS_ORIGIN_OPENER_POLICY", None)
coep = getattr(settings, "CROSS_ORIGIN_EMBEDDER_POLICY", None)
corp = getattr(settings, "CROSS_ORIGIN_RESOURCE_POLICY", None)
if coop:
response.setdefault("Cross-Origin-Opener-Policy", coop)
if coep:
response.setdefault("Cross-Origin-Embedder-Policy", coep)
if corp:
response.setdefault("Cross-Origin-Resource-Policy", corp)
return response
class RateLimitMiddleware:
"""–ü—Ä–æ—Å—Ç–µ–π—à–∏–π rate limiting –Ω–∞ —É—Ä–æ–≤–Ω–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è.
–ò—Å–ø–æ–ª—å–∑—É–µ–º cache (Redis –≤ –ø—Ä–æ–¥–∞–∫—à–µ–Ω–µ) –¥–ª—è –ø–æ–¥—Å—á—ë—Ç–∞ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ –∑–∞–ø—Ä–æ—Å–æ–≤
–≤ —Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω–æ–µ –æ–∫–Ω–æ. –ï—Å–ª–∏ –ª–∏–º–∏—Ç –ø—Ä–µ–≤—ã—à–µ–Ω ‚Äî –æ—Ç–¥–∞—ë–º 429 –∏ –∑–∞–≥–æ–ª–æ–≤–æ–∫
``Retry-After``.
"""
def __init__(self, get_response: Callable):
self.get_response = get_response
self.cache = caches[getattr(settings, "RATE_LIMIT_CACHE", "default")]
self.window = int(getattr(settings, "RATE_LIMIT_WINDOW", 60))
self.limit = int(getattr(settings, "RATE_LIMIT_REQUESTS", 120))
self.whitelist = set(getattr(settings, "RATE_LIMIT_WHITELIST", []))
def __call__(self, request: HttpRequest) -> HttpResponse:
if request.method.upper() == "OPTIONS":
return self.get_response(request)
client_ip = self._get_client_ip(request)
if client_ip and client_ip not in self.whitelist:
if self._is_rate_limited(client_ip):
retry_after = self.window
return JsonResponse(
{"detail": "Too many requests, please retry later."},
status=429,
headers={"Retry-After": str(retry_after)},
)
return self.get_response(request)
def _get_client_ip(self, request: HttpRequest) -> str:
forwarded_for = request.META.get("HTTP_X_FORWARDED_FOR")
if forwarded_for:
return forwarded_for.split(",")[0].strip()
return request.META.get("REMOTE_ADDR", "")
def _is_rate_limited(self, client_ip: str) -> bool:
window_start = int(time.time()
cache_key = f"ratelimit:{client_ip}:{window_start}"
added = self.cache.add(cache_key, 1, timeout=self.window)
if added:
return False
try:
current = self.cache.incr(cache_key)
except Exception:
# Fallback: –µ—Å–ª–∏ –±–µ–∫–µ–Ω–¥ –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç incr, –ø—Ä–æ–±—É–µ–º —á–∏—Ç–∞—Ç—å/–ø–∏—Å–∞—Ç—å –≤—Ä—É—á–Ω—É—é.
current = int(self.cache.get(cache_key) or 0) + 1
self.cache.set(cache_key, current, timeout=self.window)
return current > self.limit

# File 79/160: core\models.py
################################################################################

# backend/core/models.py
import uuid
from django.db import models
from django.utils.translation import gettext_lazy as _
class TimeStampedModel(models.Model):
"""
–ê–±—Å—Ç—Ä–∞–∫—Ç–Ω–∞—è –º–æ–¥–µ–ª—å —Å –ø–æ–ª—è–º–∏ created_at/updated_at.
–ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–ª—è –µ–¥–∏–Ω–æ–æ–±—Ä–∞–∑–Ω–æ–≥–æ –∞—É–¥–∏—Ç–∞ –≤—Ä–µ–º–µ–Ω–∏ —Å–æ–∑–¥–∞–Ω–∏—è –∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è
–∑–∞–ø–∏—Å–µ–π –≤ –±–∞–∑–æ–≤—ã—Ö –º–æ–¥–µ–ª—è—Ö (–ø–∞—Ä–∫–æ–≤–∫–∏, –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è, –ø–ª–∞—Ç–µ–∂–∏ –∏ —Ç.–ø.).
"""
created_at = models.DateTimeField(_("–î–∞—Ç–∞ —Å–æ–∑–¥–∞–Ω–∏—è"), auto_now_add=True)
updated_at = models.DateTimeField(_("–î–∞—Ç–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è"), auto_now=True)
class Meta:
abstract = True
class UUIDModel(models.Model):
"""–ê–±—Å—Ç—Ä–∞–∫—Ç–Ω–∞—è –º–æ–¥–µ–ª—å —Å UUID –≤ –∫–∞—á–µ—Å—Ç–≤–µ –ø–µ—Ä–≤–∏—á–Ω–æ–≥–æ –∫–ª—é—á–∞."""
id = models.UUIDField(primary_key=True, default=uuid.uuid4, editable=False)
class Meta:
abstract = True
class TimeStampedUUIDModel(TimeStampedModel, UUIDModel):
"""–ö–æ–º–±–æ UUID + —Ç–∞–π–º—Å—Ç–µ–º–ø—ã."""
class Meta:
abstract = True

# File 80/160: core\pagination.py
################################################################################

# core/pagination.py
from django.conf import settings
from rest_framework.pagination import PageNumberPagination
class DefaultPageNumberPagination(PageNumberPagination):
"""
–ë–∞–∑–æ–≤—ã–π –ø–∞–≥–∏–Ω–∞—Ç–æ—Ä –¥–ª—è API.
–†–∞–∑–º–µ—Ä —Å—Ç—Ä–∞–Ω–∏—Ü—ã –±–µ—Ä—ë—Ç—Å—è –∏–∑ –Ω–∞—Å—Ç—Ä–æ–µ–∫ DRF (PAGE_SIZE), —Å –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å—é
–ø–µ—Ä–µ–æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è —á–µ—Ä–µ–∑ query-–ø–∞—Ä–∞–º–µ—Ç—Ä ?page_size=.
"""
page_size = settings.REST_FRAMEWORK.get("PAGE_SIZE", 20)
page_size_query_param = "page_size"
max_page_size = 100

# File 81/160: core\permissions.py
################################################################################

# core/permissions.py
from typing import Any
from django.contrib.auth import get_user_model
from rest_framework.permissions import BasePermission, SAFE_METHODS
User = get_user_model()
def _is_admin(user: User) -> bool:
"""
–£—Ç–∏–ª–∏—Ç–∞: –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –∞–¥–º–∏–Ω–∞ –ø–æ —Å—É–ø–µ—Ä–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é –∏–ª–∏ —Ä–æ–ª–∏.
"""
if not user.is_authenticated:
return False
role_cls = getattr(User, "Role", None)
admin_value = None
if role_cls is not None:
admin_value = getattr(role_cls, "ADMIN", None)
if admin_value is not None:
return bool(user.is_superuser or getattr(user, "role", "") == admin_value)
return bool(user.is_superuser or getattr(user, "is_staff", False))
class IsAdminOrReadOnly(BasePermission):
"""
–†–∞–∑—Ä–µ—à–∞–µ—Ç —Ç–æ–ª—å–∫–æ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞–º –∏–∑–º–µ–Ω—è—Ç—å –¥–∞–Ω–Ω—ã–µ, –æ—Å—Ç–∞–ª—å–Ω—ã–º ‚Äî —Ç–æ–ª—å–∫–æ —á—Ç–µ–Ω–∏–µ.
"""
def has_permission(self, request, view) -> bool:
if request.method in SAFE_METHODS:
return True
user: User = request.user
return _is_admin(user)
class IsSelfOrAdmin(BasePermission):
"""
–î–æ—Å—Ç—É–ø –∫ –æ–±—ä–µ–∫—Ç—É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è: –ª–∏–±–æ —Å–∞–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å, –ª–∏–±–æ –∞–¥–º–∏–Ω.
"""
def has_object_permission(self, request, view, obj: Any) -> bool:
user: User = request.user
if not user.is_authenticated:
return False
if _is_admin(user):
return True
return getattr(obj, "pk", None) == getattr(user, "pk", None)
class IsOwnerObject(BasePermission):
"""
–î–æ—Å—Ç—É–ø –∫ –æ–±—ä–µ–∫—Ç–∞–º, —É –∫–æ—Ç–æ—Ä—ã—Ö –µ—Å—Ç—å –∞—Ç—Ä–∏–±—É—Ç owner: —Ç–æ–ª—å–∫–æ –≤–ª–∞–¥–µ–ª–µ—Ü –∏–ª–∏ –∞–¥–º–∏–Ω.
"""
def has_object_permission(self, request, view, obj: Any) -> bool:
user: User = request.user
if not user.is_authenticated:
return False
if _is_admin(user):
return True
owner = getattr(obj, "owner", None)
return owner == user

# File 82/160: core\utils.py
################################################################################

# backend/core/utils.py
import hashlib
import math
from decimal import Decimal, ROUND_HALF_UP
from typing import Optional
from django.conf import settings
def hash_plate_digits(plate: str) -> str:
"""
–•—ç—à–∏—Ä—É–µ—Ç —Ç–æ–ª—å–∫–æ —Ü–∏—Ñ—Ä—ã –≥–æ—Å–Ω–æ–º–µ—Ä–∞ —Å —Å–æ–ª—å—é (SHA‚Äë256).
–ë—É–∫–≤—ã –∏ –ø—Ä–æ–±–µ–ª—ã –∏–≥–Ω–æ—Ä–∏—Ä—É—é—Ç—Å—è.
–í –ë–î –º—ã —Å–æ—Ö—Ä–∞–Ω—è–µ–º —Ç–æ–ª—å–∫–æ —ç—Ç–æ—Ç —Ö—ç—à.
"""
if not plate:
return ""
digits = "".join(ch for ch in plate if ch.isdigit())
salted = f"{settings.VEHICLE_PLATE_SALT}:{digits}"
return hashlib.sha256(salted.encode("utf-8")).hexdigest()
def mask_plate_for_display(plate: str) -> str:
"""
–í–æ–∑–≤—Ä–∞—â–∞–µ—Ç –º–∞—Å–∫—É –Ω–æ–º–µ—Ä–∞ –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è (–µ—Å–ª–∏ –≤–¥—Ä—É–≥ –Ω—É–∂–Ω–æ –≤—ã–≤–æ–¥–∏—Ç—å).
–§–∞–∫—Ç–∏—á–µ—Å–∫–∏–π –Ω–æ–º–µ—Ä –º—ã –Ω–∏–≥–¥–µ –Ω–µ —Ö—Ä–∞–Ω–∏–º, –ø–æ—ç—Ç–æ–º—É —Ñ—É–Ω–∫—Ü–∏—è –º–æ–∂–µ—Ç –ø—Ä–∏–º–µ–Ω—è—Ç—å—Å—è
—Ç–æ–ª—å–∫–æ –∫ –≤–≤–µ–¥—ë–Ω–Ω–æ–º—É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º –∑–Ω–∞—á–µ–Ω–∏—é –¥–æ —Ö—ç—à–∏—Ä–æ–≤–∞–Ω–∏—è.
"""
digits = "".join(ch for ch in plate if ch.isdigit())
if not digits:
return ""
if len(digits) <= 2:
return "*" * len(digits)
return "*" * (len(digits) - 2) + digits[-2:]
def normalize_phone(phone: Optional[str]) -> str:
"""
–ù–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏—è —Ç–µ–ª–µ—Ñ–æ–Ω–∞:
- —É–±–∏—Ä–∞–µ–º –≤—Å–µ —Å–∏–º–≤–æ–ª—ã –∫—Ä–æ–º–µ —Ü–∏—Ñ—Ä –∏ '+';
- –¥–ª—è –†–§ –ø—Ä–∏–≤–æ–¥–∏–º –∫ —Ñ–æ—Ä–º–∞—Ç—É +7XXXXXXXXXX, –µ—Å–ª–∏ –≤–æ–∑–º–æ–∂–Ω–æ;
- –¥–ª—è –æ—Å—Ç–∞–ª—å–Ω—ã—Ö —Å—Ç—Ä–∞–Ω –ø—Ä–æ—Å—Ç–æ –¥–æ–±–∞–≤–ª—è–µ–º '+' –ø–µ—Ä–µ–¥ —Ü–∏—Ñ—Ä–∞–º–∏.
"""
if not phone:
return ""
raw = phone.strip()
# –û—Å—Ç–∞–≤–ª—è–µ–º –ø–ª—é—Å —Ç–æ–ª—å–∫–æ –≤ –Ω–∞—á–∞–ª–µ
plus = "+" if raw.startswith("+") else ""
digits = "".join(ch for ch in raw if ch.isdigit())
if not digits:
return ""
# –†–§: 10 –∏–ª–∏ 11 —Ü–∏—Ñ—Ä, –Ω–∞—á–∏–Ω–∞—é—â–∏—Ö—Å—è —Å 8/7
if len(digits) == 11 and digits.startswith("8"):
digits = "7" + digits[1:]
elif len(digits) == 10:
digits = "7" + digits
if plus or digits.startswith("7"):
return "+" + digits
return "+" + digits
def haversine_distance_km(
lat1: float, lon1: float, lat2: float, lon2: float
) -> float:
"""
–†–∞—Å—Å—Ç–æ—è–Ω–∏–µ –º–µ–∂–¥—É –¥–≤—É–º—è —Ç–æ—á–∫–∞–º–∏ –Ω–∞ —Å—Ñ–µ—Ä–µ –ó–µ–º–ª–∏ (–∫–º).
–ò—Å–ø–æ–ª—å–∑—É–µ–º –¥–ª—è –ø–æ–∏—Å–∫–∞ –ø–∞—Ä–∫–æ–≤–æ–∫ ¬´—Ä—è–¥–æ–º¬ª –±–µ–∑ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ–π –ø—Ä–∏–≤—è–∑–∫–∏
–∫ PostGIS (—Ä–∞–±–æ—Ç–∞–µ—Ç –∏ –Ω–∞ SQLite).
"""
try:
lat1_f = float(lat1)
lon1_f = float(lon1)
lat2_f = float(lat2)
lon2_f = float(lon2)
except (TypeError, ValueError):
return 0.0
radius = 6371.0
d_lat = math.radians(lat2_f - lat1_f)
d_lon = math.radians(lon2_f - lon1_f)
r_lat1 = math.radians(lat1_f)
r_lat2 = math.radians(lat2_f)
a = (
math.sin(d_lat / 2) ** 2
+ math.cos(r_lat1) * math.cos(r_lat2) * math.sin(d_lon / 2) ** 2
)
c = 2 * math.atan2(math.sqrt(a), math.sqrt(1 - a))
return radius * c
def parse_float(value: Optional[str]) -> Optional[float]:
"""
–ê–∫–∫—É—Ä–∞—Ç–Ω–æ –ø–∞—Ä—Å–∏—Ç —Å—Ç—Ä–æ–∫—É –≤ float, –≤–æ–∑–≤—Ä–∞—â–∞—è None –ø—Ä–∏ –æ—à–∏–±–∫–µ.
–£–¥–æ–±–Ω–æ –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å query‚Äë–ø–∞—Ä–∞–º–µ—Ç—Ä–∞–º–∏ API.
"""
if value is None:
return None
try:
return float(value)
except (TypeError, ValueError):
return None
def round_price(value: float | Decimal, step: float = 10.0) -> float:
"""
–û–∫—Ä—É–≥–ª—è–µ—Ç —Ü–µ–Ω—É –∫ –±–ª–∏–∂–∞–π—à–µ–º—É —à–∞–≥—É (step), –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é ‚Äî 10 ‚ÇΩ.
–ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –≤ AI-–º–æ–¥—É–ª–µ —Ü–µ–Ω–æ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏—è.
"""
if step <= 0:
return float(Decimal(str(value)).quantize(Decimal("0.01")))
v = Decimal(str(value))
step_dec = Decimal(str(step))
scaled = (v / step_dec).quantize(Decimal("1"), rounding=ROUND_HALF_UP)
result = scaled * step_dec
return float(result)

# File 83/160: drf_spectacular\__init__.py
################################################################################

"""–õ–æ–∫–∞–ª—å–Ω—ã–π –∑–∞–≥–ª—É—à–µ—á–Ω—ã–π –ø–∞–∫–µ—Ç drf_spectacular –¥–ª—è –æ—Ñ–ª–∞–π–Ω-—Å—Ä–µ–¥—ã."""

# File 84/160: drf_spectacular\openapi.py
################################################################################

from rest_framework.schemas.openapi import AutoSchema
__all__ = ["AutoSchema"]

# File 85/160: drf_spectacular\views.py
################################################################################

from rest_framework.response import Response
from rest_framework.views import APIView
class SpectacularAPIView(APIView):
def get(self, request, *args, **kwargs):
return Response({"schema": "stub"})
class SpectacularSwaggerView(APIView):
url_name = None
def get(self, request, *args, **kwargs):
return Response({"swagger": "stub"})
class SpectacularRedocView(APIView):
url_name = None
def get(self, request, *args, **kwargs):
return Response({"redoc": "stub"})
__all__ = [
"SpectacularAPIView",
"SpectacularSwaggerView",
"SpectacularRedocView",
]

# File 86/160: frontend\parkmate\parkmate.types.ts
################################################################################

export interface ParkMateAI {
voiceCommands: {
booking: string;
navigation: string;
payment: string;
support: string;
};
computerVision: {
licensePlateRecognition: string;
parkingSpotDetection: string;
damageDetection: string;
occupancyAnalytics: string;
};
predictions: {
arrivalTime: string;
priceForecast: string;
availability: string;
};
}
export const defaultParkMateConfig: ParkMateAI = {
voiceCommands: {
booking: "–ó–∞–±—Ä–æ–Ω–∏—Ä—É–π –±–ª–∏–∂–∞–π—à–µ–µ —Å–≤–æ–±–æ–¥–Ω–æ–µ –º–µ—Å—Ç–æ –Ω–∞ 2 —á–∞—Å–∞",
navigation: "–ü–æ—Å—Ç—Ä–æ–π –º–∞—Ä—à—Ä—É—Ç –¥–æ –º–æ–µ–≥–æ –º–µ—Å—Ç–∞ –ø–∞—Ä–∫–æ–≤–∫–∏",
payment: "–û–ø–ª–∞—Ç–∏ –º–æ—é —Ç–µ–∫—É—â—É—é –ø–∞—Ä–∫–æ–≤–∫—É",
support: "–°–æ–µ–¥–∏–Ω–∏ —Å –ø–æ–¥–¥–µ—Ä–∂–∫–æ–π ParkShare",
},
computerVision: {
licensePlateRecognition: "/api/ai/cv/license-plate/",
parkingSpotDetection: "/api/ai/cv/parking-spots/",
damageDetection: "/api/ai/cv/damage/",
occupancyAnalytics: "/api/ai/cv/occupancy/",
},
predictions: {
arrivalTime: "/api/ai/predict/arrival-time/",
priceForecast: "/api/ai/predict/pricing/",
availability: "/api/ai/predict/availability/",
},
};

# File 87/160: nginx\nginx.conf
################################################################################

user  nginx;
worker_processes  auto;

error_log  /var/log/nginx/error.log warn;
pid        /var/run/nginx.pid;

events {
    worker_connections  1024;
}

http {
    include       /etc/nginx/mime.types;
    default_type  application/octet-stream;

    log_format  main  '$remote_addr - $remote_user [$time_local] "$request" '
                      '$status $body_bytes_sent "$http_referer" '
                      '"$http_user_agent" "$http_x_forwarded_for"';

    access_log  /var/log/nginx/access.log  main;

    sendfile        on;
    keepalive_timeout  65;
    gzip on;
    gzip_types text/plain text/css application/json application/javascript application/xml+rss;

    upstream django {
        server web:8000;
    }

    server {
        listen 80;
        server_name _;

        # Uncomment for HTTPS termination + Let's Encrypt
        # listen 443 ssl http2;
        # ssl_certificate /etc/letsencrypt/live/DOMAIN/fullchain.pem;
        # ssl_certificate_key /etc/letsencrypt/live/DOMAIN/privkey.pem;

        add_header X-Content-Type-Options "nosniff" always;
        add_header X-Frame-Options "DENY" always;
        add_header Referrer-Policy "strict-origin-when-cross-origin" always;
        add_header Permissions-Policy "geolocation=(), camera=(), microphone=(), payment=()" always;
        add_header Content-Security-Policy "default-src 'self'; script-src 'self' 'unsafe-inline' https:; style-src 'self' 'unsafe-inline' https:; img-src 'self' data: https:; connect-src 'self' https: wss:;";

        location /static/ {
            alias /static/;
            expires 7d;
        }

        location /media/ {
            alias /media/;
            expires 1d;
        }

        location / {
            proxy_pass http://django;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }

        location = /health/ {
            access_log off;
            return 200 'ok';
        }
    }
}


# File 88/160: parking\__init__.py
################################################################################

# backend/parking/__init__.py
default_app_config = "parking.apps.ParkingConfig"

# File 89/160: parking\admin.py
################################################################################

# backend/parking/admin.py
from django.contrib import admin
from .models import Booking, Complaint, ParkingLot, ParkingSpot, WaitlistEntry
@admin.register(ParkingLot)
class ParkingLotAdmin(admin.ModelAdmin):
list_display = ("name", "city", "owner", "parking_type", "is_active", "is_approved")
list_filter = ("city", "parking_type", "is_active", "is_approved")
search_fields = ("name", "city", "address", "owner__username")
autocomplete_fields = ("owner",)
@admin.register(ParkingSpot)
class ParkingSpotAdmin(admin.ModelAdmin):
list_display = (
"name",
"lot",
"vehicle_type",
"is_covered",
"has_ev_charging",
"status",
"hourly_price",
)
list_filter = (
"vehicle_type",
"is_covered",
"has_ev_charging",
"status",
"lot__city",
)
search_fields = ("name", "lot__name", "lot__city")
autocomplete_fields = ("lot",)
@admin.register(Booking)
class BookingAdmin(admin.ModelAdmin):
list_display = (
"id",
"spot",
"user",
"booking_type",
"status",
"start_at",
"end_at",
"total_price",
"is_paid",
)
list_filter = ("booking_type", "status", "start_at", "spot__lot__city")
search_fields = ("spot__name", "spot__lot__name", "user__username")
autocomplete_fields = ("spot", "user", "vehicle")
@admin.register(WaitlistEntry)
class WaitlistEntryAdmin(admin.ModelAdmin):
list_display = ("id", "user", "spot", "status", "auto_book", "created_at")
list_filter = ("status", "auto_book", "created_at")
search_fields = ("user__username", "spot__name")
autocomplete_fields = ("user", "spot")
@admin.register(Complaint)
class ComplaintAdmin(admin.ModelAdmin):
list_display = ("id", "author", "category", "status", "created_at")
list_filter = ("category", "status", "created_at")
search_fields = ("author__username", "description")
autocomplete_fields = ("author", "booking", "spot")

# File 90/160: parking\apps.py
################################################################################

# backend/parking/apps.py
from django.apps import AppConfig
class ParkingConfig(AppConfig):
default_auto_field = "django.db.models.BigAutoField"
name = "parking"
verbose_name = "–ü–∞—Ä–∫–æ–≤–∫–∏ –∏ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è"

# File 91/160: parking\models.py
################################################################################

# backend/parking/models.py
from __future__ import annotations
from datetime import timedelta
from decimal import Decimal, ROUND_UP
from typing import Optional
from django.conf import settings
from django.db import models
from django.utils import timezone
from django.utils.translation import gettext_lazy as _
from core.models import TimeStampedModel
# PointField —Å fallback –¥–ª—è SQLite: —Ö—Ä–∞–Ω–∏–º JSON {"lat": ..., "lng": ...}
_db_settings = getattr(settings, "DATABASES", {})
_default_db = _db_settings.get("default") or {}
_default_engine = _default_db.get("ENGINE", "")
if _default_engine.endswith("sqlite3"):
class PointField(models.JSONField):
def __init__(self, *args, **kwargs):
kwargs.pop("geography", None)
super().__init__(*args, **kwargs)
else:
from django.contrib.gis.db.models import PointField
class ParkingLot(TimeStampedModel):
"""
–û–±—ä–µ–∫—Ç –ø–∞—Ä–∫–æ–≤–∫–∏ (–¥–≤–æ—Ä, –ø–æ–¥–∑–µ–º–Ω—ã–π –ø–∞—Ä–∫–∏–Ω–≥, –æ—Ñ–∏—Å–Ω—ã–π –ø–∞—Ä–∫–∏–Ω–≥ –∏ —Ç.–¥.).
"""
class ParkingType(models.TextChoices):
YARD = "yard", "–î–≤–æ—Ä–æ–≤–∞—è –ø–∞—Ä–∫–æ–≤–∫–∞"
UNDERGROUND = "underground", "–ü–æ–¥–∑–µ–º–Ω–∞—è –ø–∞—Ä–∫–æ–≤–∫–∞"
MULTILEVEL = "multilevel", "–ú–Ω–æ–≥–æ—É—Ä–æ–≤–Ω–µ–≤–∞—è –ø–∞—Ä–∫–æ–≤–∫–∞"
STREET = "street", "–£–ª–∏—á–Ω–∞—è –ø–∞—Ä–∫–æ–≤–∫–∞"
OFFICE = "office", "–û—Ñ–∏—Å–Ω–∞—è –ø–∞—Ä–∫–æ–≤–∫–∞"
HOME = "home", "–î–æ–º–∞—à–Ω–µ–µ –º–µ—Å—Ç–æ"
owner = models.ForeignKey(
settings.AUTH_USER_MODEL,
on_delete=models.CASCADE,
related_name="parking_lots",
verbose_name="–í–ª–∞–¥–µ–ª–µ—Ü",
)
name = models.CharField("–ù–∞–∑–≤–∞–Ω–∏–µ", max_length=255)
city = models.CharField("–ì–æ—Ä–æ–¥", max_length=100)
address = models.CharField("–ê–¥—Ä–µ—Å", max_length=255)
parking_type = models.CharField(
"–¢–∏–ø –ø–∞—Ä–∫–æ–≤–∫–∏",
max_length=32,
choices=ParkingType.choices,
default=ParkingType.YARD,
)
description = models.TextField("–û–ø–∏—Å–∞–Ω–∏–µ", blank=True)
location = PointField("–¢–æ—á–∫–∞ –Ω–∞ –∫–∞—Ä—Ç–µ", geography=True, null=True, blank=True)
latitude = models.FloatField("–®–∏—Ä–æ—Ç–∞", null=True, blank=True)
longitude = models.FloatField("–î–æ–ª–≥–æ—Ç–∞", null=True, blank=True)
is_active = models.BooleanField("–ê–∫—Ç–∏–≤–µ–Ω", default=True)
is_approved = models.BooleanField(
"–û–¥–æ–±—Ä–µ–Ω –º–æ–¥–µ—Ä–∞—Ü–∏–µ–π",
default=False,
help_text="–û–¥–æ–±—Ä—è–µ—Ç—Å—è –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–º –ø–µ—Ä–µ–¥ –ø—É–±–ª–∏–∫–∞—Ü–∏–µ–π.",
)
is_private = models.BooleanField(
"–ü—Ä–∏–≤–∞—Ç–Ω—ã–π",
default=False,
help_text="–ï—Å–ª–∏ –≤–∫–ª—é—á–µ–Ω–æ, –æ–±—ä–µ–∫—Ç –≤–∏–¥–µ–Ω —Ç–æ–ª—å–∫–æ –ø–æ –ø—Ä—è–º—ã–º —Å—Å—ã–ª–∫–∞–º/–≤–ª–∞–¥–µ–ª—å—Ü—É.",
)
stress_index = models.FloatField(
"–ò–Ω–¥–µ–∫—Å –∑–∞–≥—Ä—É–∂–µ–Ω–Ω–æ—Å—Ç–∏ (0..1)",
default=0.0,
help_text=(
"–°—Ä–µ–¥–Ω—è—è –∑–∞–≥—Ä—É–∂–µ–Ω–Ω–æ—Å—Ç—å –º–µ—Å—Ç –∑–∞ –ø–æ—Å–ª–µ–¥–Ω–∏–µ 7 –¥–Ω–µ–π. "
"–û–±–Ω–æ–≤–ª—è–µ—Ç—Å—è —Ñ–æ–Ω–æ–≤—ã–º–∏ –∑–∞–¥–∞—á–∞–º–∏ AI."
),
)
class Meta:
verbose_name = "–û–±—ä–µ–∫—Ç –ø–∞—Ä–∫–æ–≤–∫–∏"
verbose_name_plural = "–û–±—ä–µ–∫—Ç—ã –ø–∞—Ä–∫–æ–≤–∫–∏"
ordering = ("name",)
def __str__(self) -> str:
return f"{self.name} ({self.city})"
@property
def owner_username(self) -> str:
return getattr(self.owner, "username", "")
def set_coordinates(self, lat: Optional[float], lng: Optional[float]) -> None:
"""
–£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã –∏ PointField (–µ—Å–ª–∏ –¥–æ—Å—Ç—É–ø–µ–Ω GeoDjango).
"""
self.latitude = lat
self.longitude = lng
if lat is None or lng is None:
self.location = None
return
try:
from django.contrib.gis.geos import Point
except Exception:
# SQLite/JSON fallback
self.location = {"lat": lat, "lng": lng}
else:
self.location = Point(lng, lat)
class ParkingSpot(TimeStampedModel):
"""
–ö–æ–Ω–∫—Ä–µ—Ç–Ω–æ–µ –ø–∞—Ä–∫–æ–≤–æ—á–Ω–æ–µ –º–µ—Å—Ç–æ –≤–Ω—É—Ç—Ä–∏ ParkingLot.
"""
class SpotStatus(models.TextChoices):
ACTIVE = "active", "–ê–∫—Ç–∏–≤–Ω–æ"
INACTIVE = "inactive", "–ù–µ–∞–∫—Ç–∏–≤–Ω–æ"
class VehicleType(models.TextChoices):
CAR = "car", "–õ–µ–≥–∫–æ–≤–æ–π –∞–≤—Ç–æ–º–æ–±–∏–ª—å"
MOTO = "moto", "–ú–æ—Ç–æ—Ü–∏–∫–ª"
COMMERCIAL = "commercial", "–ö–æ–º–º–µ—Ä—á–µ—Å–∫–∏–π —Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç"
lot = models.ForeignKey(
ParkingLot,
on_delete=models.CASCADE,
related_name="spots",
verbose_name="–û–±—ä–µ–∫—Ç –ø–∞—Ä–∫–æ–≤–∫–∏",
)
name = models.CharField("–ù–∞–∑–≤–∞–Ω–∏–µ/–Ω–æ–º–µ—Ä –º–µ—Å—Ç–∞", max_length=64)
description = models.TextField("–û–ø–∏—Å–∞–Ω–∏–µ", blank=True)
vehicle_type = models.CharField(
"–¢–∏–ø —Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç–∞",
max_length=16,
choices=VehicleType.choices,
default=VehicleType.CAR,
)
is_covered = models.BooleanField("–ö—Ä—ã—Ç–æ–µ –º–µ—Å—Ç–æ", default=False)
has_ev_charging = models.BooleanField("–ï—Å—Ç—å –∑–∞—Ä—è–¥–∫–∞", default=False)
is_24_7 = models.BooleanField("–ö—Ä—É–≥–ª–æ—Å—É—Ç–æ—á–Ω–æ", default=True)
max_height_m = models.DecimalField(
"–ú–∞–∫—Å–∏–º–∞–ª—å–Ω–∞—è –≤—ã—Å–æ—Ç–∞ (–º)",
max_digits=4,
decimal_places=2,
null=True,
blank=True,
)
hourly_price = models.DecimalField(
"–¶–µ–Ω–∞ –∑–∞ —á–∞—Å, ‚ÇΩ", max_digits=8, decimal_places=2
)
nightly_price = models.DecimalField(
"–¶–µ–Ω–∞ –∑–∞ –Ω–æ—á—å, ‚ÇΩ", max_digits=8, decimal_places=2, null=True, blank=True
)
daily_price = models.DecimalField(
"–¶–µ–Ω–∞ –∑–∞ —Å—É—Ç–∫–∏, ‚ÇΩ", max_digits=8, decimal_places=2, null=True, blank=True
)
monthly_price = models.DecimalField(
"–¶–µ–Ω–∞ –∑–∞ –º–µ—Å—è—Ü, ‚ÇΩ", max_digits=9, decimal_places=2, null=True, blank=True
)
allow_dynamic_pricing = models.BooleanField(
"–î–∏–Ω–∞–º–∏—á–µ—Å–∫–∞—è —Ü–µ–Ω–∞ (AI)",
default=False,
help_text="–ï—Å–ª–∏ –≤–∫–ª—é—á–µ–Ω–æ, —Ç–∞—Ä–∏—Ñ –º–æ–∂–µ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–∏—Ä–æ–≤–∞—Ç—å—Å—è —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è–º–∏ AI.",
)
status = models.CharField(
"–°—Ç–∞—Ç—É—Å",
max_length=16,
choices=SpotStatus.choices,
default=SpotStatus.ACTIVE,
)
occupancy_7d = models.FloatField(
"–ó–∞–≥—Ä—É–∂–µ–Ω–Ω–æ—Å—Ç—å –∑–∞ 7 –¥–Ω–µ–π (0..1)",
default=0.0,
help_text=(
"–î–æ–ª—è –≤—Ä–µ–º–µ–Ω–∏, –∫–æ–≥–¥–∞ –º–µ—Å—Ç–æ –±—ã–ª–æ –∑–∞–Ω—è—Ç–æ –∑–∞ –ø–æ—Å–ª–µ–¥–Ω–∏–µ 7 –¥–Ω–µ–π. "
"–û–±–Ω–æ–≤–ª—è–µ—Ç—Å—è —Ñ–æ–Ω–æ–≤—ã–º–∏ –∑–∞–¥–∞—á–∞–º–∏ AI."
),
)
class Meta:
verbose_name = "–ü–∞—Ä–∫–æ–≤–æ—á–Ω–æ–µ –º–µ—Å—Ç–æ"
verbose_name_plural = "–ü–∞—Ä–∫–æ–≤–æ—á–Ω—ã–µ –º–µ—Å—Ç–∞"
ordering = ("lot__name", "name")
def __str__(self) -> str:
return f"{self.lot.name} ‚Äî {self.name}"
@property
def owner(self):
"""
–î–ª—è IsOwnerObject –∏–∑ core.permissions: –≤–ª–∞–¥–µ–ª–µ—Ü –º–µ—Å—Ç–∞ = –≤–ª–∞–¥–µ–ª–µ—Ü ParkingLot.
"""
return self.lot.owner
@property
def city(self) -> str:
return self.lot.city
@property
def is_active(self) -> bool:
return (
self.status == self.SpotStatus.ACTIVE
and self.lot.is_active
and self.lot.is_approved
)
class Booking(TimeStampedModel):
"""
–ë—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–∞—Ä–∫–æ–≤–æ—á–Ω–æ–≥–æ –º–µ—Å—Ç–∞.
"""
class BookingType(models.TextChoices):
HOURLY = "hourly", "–ü–æ—á–∞—Å–æ–≤–∞—è"
DAILY = "daily", "–°—É—Ç–æ—á–Ω–∞—è"
NIGHT = "night", "–ù–æ—á–Ω–∞—è"
WEEKLY = "weekly", "–ù–µ–¥–µ–ª—å–Ω–∞—è"
MONTHLY = "monthly", "–ú–µ—Å—è—á–Ω–∞—è"
class Status(models.TextChoices):
PENDING = "pending", "–û–∂–∏–¥–∞–µ—Ç –æ–ø–ª–∞—Ç—ã"
CONFIRMED = "confirmed", "–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∞"
ACTIVE = "active", "–ê–∫—Ç–∏–≤–Ω–∞"
COMPLETED = "completed", "–ó–∞–≤–µ—Ä—à–µ–Ω–∞"
CANCELLED = "cancelled", "–û—Ç–º–µ–Ω–µ–Ω–∞"
EXPIRED = "expired", "–ò—Å—Ç–µ–∫–ª–∞"
user = models.ForeignKey(
settings.AUTH_USER_MODEL,
on_delete=models.CASCADE,
related_name="bookings",
verbose_name="–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å",
)
spot = models.ForeignKey(
ParkingSpot,
on_delete=models.PROTECT,
related_name="bookings",
verbose_name="–ü–∞—Ä–∫–æ–≤–æ—á–Ω–æ–µ –º–µ—Å—Ç–æ",
)
vehicle = models.ForeignKey(
"vehicles.Vehicle",
on_delete=models.SET_NULL,
related_name="bookings",
verbose_name="–¢—Ä–∞–Ω—Å–ø–æ—Ä—Ç",
null=True,
blank=True,
)
booking_type = models.CharField(
"–¢–∏–ø –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è",
max_length=16,
choices=BookingType.choices,
default=BookingType.HOURLY,
)
start_at = models.DateTimeField("–ù–∞—á–∞–ª–æ –±—Ä–æ–Ω–∏")
end_at = models.DateTimeField("–û–∫–æ–Ω—á–∞–Ω–∏–µ –±—Ä–æ–Ω–∏")
status = models.CharField(
"–°—Ç–∞—Ç—É—Å",
max_length=16,
choices=Status.choices,
default=Status.PENDING,
)
total_price = models.DecimalField(
"–ò—Ç–æ–≥–æ–≤–∞—è —Å—Ç–æ–∏–º–æ—Å—Ç—å, ‚ÇΩ", max_digits=10, decimal_places=2
)
currency = models.CharField("–í–∞–ª—é—Ç–∞", max_length=8, default="RUB")
is_paid = models.BooleanField("–û–ø–ª–∞—á–µ–Ω–æ", default=False)
dynamic_pricing_applied = models.BooleanField(
"–î–∏–Ω–∞–º–∏—á–µ—Å–∫–æ–µ —Ü–µ–Ω–æ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏–µ", default=False
)
ai_snapshot = models.JSONField(
"AI snapshot",
null=True,
blank=True,
help_text="–î–∞–Ω–Ω—ã–µ —Ä–µ—à–µ–Ω–∏–π AI (—Ü–µ–Ω—ã, –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å, —Ä–∏—Å–∫–∏)",
)
external_payment_id = models.CharField(
"ID –ø–ª–∞—Ç–µ–∂–∞ –ø—Ä–æ–≤–∞–π–¥–µ—Ä–∞",
max_length=64,
blank=True,
help_text="–°–≤—è–∑–∫–∞ —Å –ø–ª–∞—Ç–µ–∂–æ–º —É –ø—Ä–æ–≤–∞–π–¥–µ—Ä–∞ (–Ω–∞–ø—Ä–∏–º–µ—Ä, YooKassa payment_id).",
)
class Meta:
verbose_name = "–ë—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ"
verbose_name_plural = "–ë—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è"
ordering = ("-start_at",)
def __str__(self) -> str:
return f"–ë—Ä–æ–Ω—å
@property
def owner(self):
"""
–î–ª—è —É–¥–æ–±—Å—Ç–≤–∞ ‚Äî –≤–ª–∞–¥–µ–ª–µ—Ü –º–µ—Å—Ç–∞, –ø–æ –∫–æ—Ç–æ—Ä–æ–º—É –∏–¥—ë—Ç –±—Ä–æ–Ω—å.
"""
return self.spot.lot.owner
@staticmethod
def is_spot_available(
spot: ParkingSpot,
start_at,
end_at,
exclude_booking_id: Optional[int] = None,
) -> bool:
"""
–ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–µ—Ä–µ—Å–µ—á–µ–Ω–∏—è –∏–Ω—Ç–µ—Ä–≤–∞–ª–æ–≤ —Å —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–º–∏ –±—Ä–æ–Ω—è–º–∏.
"""
qs = Booking.objects.filter(spot=spot).exclude(
status__in=[Booking.Status.CANCELLED, Booking.Status.EXPIRED]
)
if exclude_booking_id:
qs = qs.exclude(id=exclude_booking_id)
# –ü–µ—Ä–µ—Å–µ—á–µ–Ω–∏–µ –∏–Ω—Ç–µ—Ä–≤–∞–ª–æ–≤: (start1 < end2) –∏ (end1 > start2)
overlap = qs.filter(start_at__lt=end_at, end_at__gt=start_at).exists()
return not overlap
def calculate_price(self) -> Decimal:
"""
–ü—Ä–æ—Å—Ç–∞—è –º–æ–¥–µ–ª—å —Ä–∞—Å—á—ë—Ç–∞ —Ü–µ–Ω—ã –Ω–∞ –æ—Å–Ω–æ–≤–µ —Ç–∞—Ä–∏—Ñ–æ–≤ ParkingSpot –∏ —Ç–∏–ø–∞ –±—Ä–æ–Ω–∏.
"""
if not self.spot:
return Decimal("0.00")
delta = self.end_at - self.start_at
total_hours = Decimal(delta.total_seconds()) / Decimal(3600)
total_days = Decimal(delta.total_seconds()) / Decimal(86400)
base_price = Decimal("0.00")
if self.booking_type == self.BookingType.HOURLY:
hourly = self.spot.hourly_price
units = max(
Decimal("1"),
total_hours.to_integral_value(rounding=ROUND_UP),
)
base_price = hourly * units
elif self.booking_type == self.BookingType.DAILY:
daily = self.spot.daily_price or (self.spot.hourly_price * Decimal("24"))
units = max(
Decimal("1"),
total_days.to_integral_value(rounding=ROUND_UP),
)
base_price = daily * units
elif self.booking_type == self.BookingType.NIGHT:
nightly = self.spot.nightly_price or (
self.spot.hourly_price * Decimal("10")
)
base_price = nightly
elif self.booking_type == self.BookingType.WEEKLY:
daily = self.spot.daily_price or (self.spot.hourly_price * Decimal("24"))
units = max(
Decimal("1"),
(total_days / Decimal("7")).to_integral_value(rounding=ROUND_UP),
)
base_price = daily * Decimal("7") * units
elif self.booking_type == self.BookingType.MONTHLY:
monthly = self.spot.monthly_price or (
(self.spot.daily_price or self.spot.hourly_price * Decimal("24"))
* Decimal("30")
)
units = max(
Decimal("1"),
(total_days / Decimal("30")).to_integral_value(rounding=ROUND_UP),
)
base_price = monthly * units
else:
base_price = self.spot.hourly_price * max(
Decimal("1"),
total_hours.to_integral_value(rounding=ROUND_UP),
)
base_price = base_price.quantize(Decimal("0.01"))
commission_percent = getattr(settings, "SERVICE_COMMISSION_PERCENT", 0)
commission = (
base_price * Decimal(commission_percent) / Decimal("100")
).quantize(Decimal("0.01"))
total = (base_price + commission).quantize(Decimal("0.01"))
self.total_price = total
return total
def mark_paid(self, payment_id: str | None = None) -> None:
"""
–û—Ç–º–µ—Ç–∏—Ç—å –±—Ä–æ–Ω—å –∫–∞–∫ –æ–ø–ª–∞—á–µ–Ω–Ω—É—é (–≤—ã–∑—ã–≤–∞–µ—Ç—Å—è –∏–∑ –º–æ–¥—É–ª—è payments –ø–æ webhook).
"""
self.is_paid = True
self.status = self.Status.CONFIRMED
if payment_id:
self.external_payment_id = payment_id
self.save(update_fields=["is_paid", "status", "external_payment_id"])
@property
def has_started(self) -> bool:
return self.start_at <= timezone.now()
@property
def has_ended(self) -> bool:
return self.end_at <= timezone.now()
@property
def duration(self) -> timedelta:
return self.end_at - self.start_at
class WaitlistEntry(TimeStampedModel):
"""
–ó–∞–ø–∏—Å—å –≤ –ª–∏—Å—Ç–µ –æ–∂–∏–¥–∞–Ω–∏—è –¥–ª—è –∑–∞–Ω—è—Ç–æ–≥–æ –º–µ—Å—Ç–∞.
"""
class Status(models.TextChoices):
WAITING = "waiting", "–û–∂–∏–¥–∞–µ—Ç"
NOTIFIED = "notified", "–£–≤–µ–¥–æ–º–ª—ë–Ω"
BOOKED = "booked", "–ê–≤—Ç–æ‚Äë–±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–æ–∑–¥–∞–Ω–æ"
CANCELLED = "cancelled", "–û—Ç–º–µ–Ω–µ–Ω–æ"
user = models.ForeignKey(
settings.AUTH_USER_MODEL,
on_delete=models.CASCADE,
related_name="waitlist_entries",
verbose_name="–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å",
)
spot = models.ForeignKey(
ParkingSpot,
on_delete=models.CASCADE,
related_name="waitlist_entries",
verbose_name="–ü–∞—Ä–∫–æ–≤–æ—á–Ω–æ–µ –º–µ—Å—Ç–æ",
)
desired_start = models.DateTimeField("–ñ–µ–ª–∞–µ–º–æ–µ –Ω–∞—á–∞–ª–æ")
desired_end = models.DateTimeField("–ñ–µ–ª–∞–µ–º–æ–µ –æ–∫–æ–Ω—á–∞–Ω–∏–µ")
auto_book = models.BooleanField(
"–ê–≤—Ç–æ‚Äë–±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ",
default=False,
help_text="–ï—Å–ª–∏ –≤–∫–ª—é—á–µ–Ω–æ, –ø—Ä–∏ –æ—Å–≤–æ–±–æ–∂–¥–µ–Ω–∏–∏ –º–µ—Å—Ç–∞ –±—É–¥–µ—Ç —Å–æ–∑–¥–∞–Ω–∞ –±—Ä–æ–Ω—å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏.",
)
status = models.CharField(
"–°—Ç–∞—Ç—É—Å",
max_length=16,
choices=Status.choices,
default=Status.WAITING,
)
class Meta:
verbose_name = "–ó–∞–ø–∏—Å—å –≤ –ª–∏—Å—Ç–µ –æ–∂–∏–¥–∞–Ω–∏—è"
verbose_name_plural = "–õ–∏—Å—Ç –æ–∂–∏–¥–∞–Ω–∏—è"
ordering = ("-created_at",)
unique_together = ("user", "spot", "desired_start", "desired_end")
def __str__(self) -> str:
return f"Waitlist
class Complaint(TimeStampedModel):
"""
–ñ–∞–ª–æ–±–∞ –ø–æ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—é/–º–µ—Å—Ç—É:
- —á—É–∂–∞—è –º–∞—à–∏–Ω–∞;
- –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –ø—Ä–∏–µ—Ö–∞–ª;
- —á–∞—Å—Ç—ã–µ –æ—Ç–º–µ–Ω—ã –∏ —Ç.–ø.
"""
class Category(models.TextChoices):
FOREIGN_CAR = "foreign_car", "–ß—É–∂–∞—è –º–∞—à–∏–Ω–∞ –Ω–∞ –º–µ—Å—Ç–µ"
NO_SHOW = "no_show", "–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –ø—Ä–∏–µ—Ö–∞–ª"
NO_FREE_SPOT = "no_free_spot", "–ù–µ –Ω–∞—à—ë–ª —Å–≤–æ–±–æ–¥–Ω–æ–≥–æ –º–µ—Å—Ç–∞"
OTHER = "other", "–î—Ä—É–≥–æ–µ"
class Status(models.TextChoices):
NEW = "new", "–ù–æ–≤–∞—è"
IN_PROGRESS = "in_progress", "–í —Ä–∞–±–æ—Ç–µ"
RESOLVED = "resolved", "–†–µ—à–µ–Ω–∞"
REJECTED = "rejected", "–û—Ç–∫–ª–æ–Ω–µ–Ω–∞"
author = models.ForeignKey(
settings.AUTH_USER_MODEL,
on_delete=models.CASCADE,
related_name="complaints",
verbose_name="–ê–≤—Ç–æ—Ä",
)
booking = models.ForeignKey(
Booking,
on_delete=models.SET_NULL,
related_name="complaints",
null=True,
blank=True,
verbose_name="–ë—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ",
)
spot = models.ForeignKey(
ParkingSpot,
on_delete=models.SET_NULL,
related_name="complaints",
null=True,
blank=True,
verbose_name="–ü–∞—Ä–∫–æ–≤–æ—á–Ω–æ–µ –º–µ—Å—Ç–æ",
)
category = models.CharField(
"–ö–∞—Ç–µ–≥–æ—Ä–∏—è",
max_length=32,
choices=Category.choices,
default=Category.OTHER,
)
description = models.TextField("–û–ø–∏—Å–∞–Ω–∏–µ", blank=True)
status = models.CharField(
"–°—Ç–∞—Ç—É—Å",
max_length=16,
choices=Status.choices,
default=Status.NEW,
)
class Meta:
verbose_name = "–ñ–∞–ª–æ–±–∞"
verbose_name_plural = "–ñ–∞–ª–æ–±—ã"
ordering = ("-created_at",)
def __str__(self) -> str:
return f"–ñ–∞–ª–æ–±–∞
class FavoriteParkingSpot(TimeStampedModel):
"""–ò–∑–±—Ä–∞–Ω–Ω—ã–µ –ø–∞—Ä–∫–æ–≤–æ—á–Ω—ã–µ –º–µ—Å—Ç–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è."""
user = models.ForeignKey(
settings.AUTH_USER_MODEL,
on_delete=models.CASCADE,
related_name="favorite_spots",
)
spot = models.ForeignKey(
ParkingSpot,
on_delete=models.CASCADE,
related_name="favorites",
)
note = models.CharField("–ó–∞–º–µ—Ç–∫–∞", max_length=120, blank=True)
class Meta:
verbose_name = "–ò–∑–±—Ä–∞–Ω–Ω–æ–µ –º–µ—Å—Ç–æ"
verbose_name_plural = "–ò–∑–±—Ä–∞–Ω–Ω—ã–µ –º–µ—Å—Ç–∞"
ordering = ("-created_at",)
unique_together = ("user", "spot")
def __str__(self) -> str:
return f"{self.user} ‚Üí {self.spot}"
class SavedPlace(TimeStampedModel):
"""–°–æ—Ö—Ä–∞–Ω—ë–Ω–Ω—ã–µ —Ç–æ—á–∫–∏ (–¥–æ–º/–æ—Ñ–∏—Å) –¥–ª—è –±—ã—Å—Ç—Ä–æ–≥–æ –ø–æ–∏—Å–∫–∞."""
class PlaceType(models.TextChoices):
HOME = "home", "–î–æ–º"
WORK = "work", "–û—Ñ–∏—Å"
CUSTOM = "custom", "–î—Ä—É–≥–æ–µ"
user = models.ForeignKey(
settings.AUTH_USER_MODEL,
on_delete=models.CASCADE,
related_name="saved_places",
)
title = models.CharField("–ù–∞–∑–≤–∞–Ω–∏–µ", max_length=64)
place_type = models.CharField(
"–¢–∏–ø —Ç–æ—á–∫–∏",
max_length=16,
choices=PlaceType.choices,
default=PlaceType.CUSTOM,
)
latitude = models.FloatField("–®–∏—Ä–æ—Ç–∞")
longitude = models.FloatField("–î–æ–ª–≥–æ—Ç–∞")
class Meta:
verbose_name = "–°–æ—Ö—Ä–∞–Ω—ë–Ω–Ω–∞—è —Ç–æ—á–∫–∞"
verbose_name_plural = "–°–æ—Ö—Ä–∞–Ω—ë–Ω–Ω—ã–µ —Ç–æ—á–∫–∏"
ordering = ("title",)
unique_together = ("user", "title")
def __str__(self) -> str:
return f"{self.title} ({self.user})"

# File 92/160: parking\serializers.py
################################################################################

from __future__ import annotations
from django.utils import timezone
from rest_framework import serializers
from core.utils import haversine_distance_km
from ai.orchestrator import apply_ai_pricing
from .models import (
Booking,
Complaint,
FavoriteParkingSpot,
ParkingLot,
ParkingSpot,
SavedPlace,
WaitlistEntry,
)
class ParkingLotSerializer(serializers.ModelSerializer):
owner = serializers.ReadOnlyField(source="owner.username")
spots_count = serializers.SerializerMethodField()
class Meta:
model = ParkingLot
fields = (
"id",
"name",
"city",
"address",
"parking_type",
"description",
"latitude",
"longitude",
"is_active",
"is_approved",
"is_private",
"owner",
"spots_count",
)
read_only_fields = ("id", "is_approved", "owner", "spots_count")
def get_spots_count(self, obj: ParkingLot) -> int:
return obj.spots.filter(status=ParkingSpot.SpotStatus.ACTIVE).count()
def create(self, validated_data):
"""
–ü—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –ø–∞—Ä–∫–æ–≤–∫–∏ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø–æ–¥—Å—Ç–∞–≤–ª—è–µ–º owner –∏–∑ request
–∏ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä—É–µ–º PointField / lat / lng, –µ—Å–ª–∏ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã –∑–∞–¥–∞–Ω—ã.
"""
request = self.context.get("request")
owner = getattr(request, "user", None)
if owner is not None and owner.is_authenticated:
validated_data["owner"] = owner
lot = super().create(validated_data)
if lot.latitude is not None and lot.longitude is not None:
lot.set_coordinates(lot.latitude, lot.longitude)
lot.save(update_fields=["latitude", "longitude", "location"])
return lot
def update(self, instance: ParkingLot, validated_data):
lat = validated_data.get("latitude", instance.latitude)
lng = validated_data.get("longitude", instance.longitude)
instance = super().update(instance, validated_data)
instance.set_coordinates(lat, lng)
instance.save(update_fields=["latitude", "longitude", "location"])
return instance
class ParkingSpotSerializer(serializers.ModelSerializer):
"""
–°–µ—Ä–∏–ª–∏–∑–∞—Ç–æ—Ä —Å–ø–æ—Ç–∞ –¥–ª—è –ø—É–±–ª–∏—á–Ω–æ–≥–æ API.
–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ read-only –ø–æ–ª—è:
- lot_name, city ‚Äî –¥–ª—è —É–¥–æ–±–Ω–æ–≥–æ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è;
- lot_latitude, lot_longitude, lot_address ‚Äî —á—Ç–æ–±—ã —Ä–∏—Å–æ–≤–∞—Ç—å –º–∞—Ä–∫–µ—Ä—ã –Ω–∞ –∫–∞—Ä—Ç–µ;
- distance_km ‚Äî —Ä–∞—Å—Å—Ç–æ—è–Ω–∏–µ –æ—Ç —Ç–æ—á–∫–∏ –∑–∞–ø—Ä–æ—Å–∞ (lat/lng) –¥–æ –ª–æ—Ç–∞.
"""
lot_name = serializers.ReadOnlyField(source="lot.name")
city = serializers.ReadOnlyField(source="lot.city")
lot_latitude = serializers.ReadOnlyField(source="lot.latitude")
lot_longitude = serializers.ReadOnlyField(source="lot.longitude")
lot_address = serializers.ReadOnlyField(source="lot.address")
distance_km = serializers.SerializerMethodField()
class Meta:
model = ParkingSpot
fields = (
"id",
"lot",
"lot_name",
"city",
"lot_latitude",
"lot_longitude",
"lot_address",
"name",
"description",
"vehicle_type",
"is_covered",
"has_ev_charging",
"is_24_7",
"max_height_m",
"hourly_price",
"nightly_price",
"daily_price",
"monthly_price",
"allow_dynamic_pricing",
"status",
"distance_km",
)
read_only_fields = (
"id",
"lot_name",
"city",
"lot_latitude",
"lot_longitude",
"lot_address",
"distance_km",
)
def get_distance_km(self, obj: ParkingSpot):
"""
–ï—Å–ª–∏ –∞—Ç—Ä–∏–±—É—Ç distance_km —É–∂–µ –ø–æ–≤–µ—à–µ–Ω –≤–æ viewset ‚Äî –∏—Å–ø–æ–ª—å–∑—É–µ–º –µ–≥–æ.
–ò–Ω–∞—á–µ —Å—á–∏—Ç–∞–µ–º –ø–æ lat/lng –∏–∑ query-–ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤ (–µ—Å–ª–∏ –æ–Ω–∏ –∑–∞–¥–∞–Ω—ã).
"""
distance = getattr(obj, "distance_km", None)
if distance is not None:
return round(float(distance), 2)
request = self.context.get("request")
if not request:
return None
lat_param = request.query_params.get("lat")
lng_param = request.query_params.get("lng")
if not lat_param or not lng_param:
return None
if obj.lot.latitude is None or obj.lot.longitude is None:
return None
try:
lat = float(lat_param)
lng = float(lng_param)
except (TypeError, ValueError):
return None
return round(
haversine_distance_km(lat, lng, obj.lot.latitude, obj.lot.longitude), 2
)
class BookingSerializer(serializers.ModelSerializer):
user = serializers.ReadOnlyField(source="user.username")
spot_name = serializers.ReadOnlyField(source="spot.name")
lot_name = serializers.ReadOnlyField(source="spot.lot.name")
class Meta:
model = Booking
fields = (
"id",
"user",
"spot",
"spot_name",
"lot_name",
"vehicle",
"booking_type",
"start_at",
"end_at",
"status",
"total_price",
"currency",
"is_paid",
"created_at",
"updated_at",
"external_payment_id",
)
read_only_fields = (
"id",
"user",
"status",
"total_price",
"currency",
"is_paid",
"created_at",
"updated_at",
"external_payment_id",
"spot_name",
"lot_name",
)
def validate(self, attrs):
"""
–ë–∞–∑–æ–≤–∞—è –≤–∞–ª–∏–¥–∞—Ü–∏—è –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è:
- start < end
- –Ω–µ –≤ –ø—Ä–æ—à–ª–æ–º
- –º–µ—Å—Ç–æ –∞–∫—Ç–∏–≤–Ω–æ
- –Ω–µ—Ç –ø–µ—Ä–µ—Å–µ—á–µ–Ω–∏—è —Å –¥—Ä—É–≥–∏–º–∏ –±—Ä–æ–Ω—è–º–∏.
"""
request = self.context["request"]
spot: ParkingSpot = attrs.get("spot", getattr(self.instance, "spot", None))
start_at = attrs.get("start_at", getattr(self.instance, "start_at", None))
end_at = attrs.get("end_at", getattr(self.instance, "end_at", None))
booking_type = attrs.get(
"booking_type",
getattr(self.instance, "booking_type", Booking.BookingType.HOURLY),
)
if not spot or not start_at or not end_at:
raise serializers.ValidationError(
"–ù–µ–æ–±—Ö–æ–¥–∏–º–æ —É–∫–∞–∑–∞—Ç—å –º–µ—Å—Ç–æ –∏ –∏–Ω—Ç–µ—Ä–≤–∞–ª –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è."
)
if start_at >= end_at:
raise serializers.ValidationError(
"–î–∞—Ç–∞ –Ω–∞—á–∞–ª–∞ –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å –º–µ–Ω—å—à–µ –¥–∞—Ç—ã –æ–∫–æ–Ω—á–∞–Ω–∏—è."
)
if start_at < timezone.now():
raise serializers.ValidationError(
"–ù–µ–ª—å–∑—è —Å–æ–∑–¥–∞–≤–∞—Ç—å –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –≤ –ø—Ä–æ—à–ª–æ–º."
)
if not spot.is_active:
raise serializers.ValidationError(
"–í—ã–±—Ä–∞–Ω–Ω–æ–µ –º–µ—Å—Ç–æ —Å–µ–π—á–∞—Å –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–æ –¥–ª—è –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è."
)
exclude_id = self.instance.id if self.instance else None
if not Booking.is_spot_available(
spot, start_at, end_at, exclude_booking_id=exclude_id
):
raise serializers.ValidationError(
"–ù–∞ –≤—ã–±—Ä–∞–Ω–Ω—ã–π –ø–µ—Ä–∏–æ–¥ —ç—Ç–æ –º–µ—Å—Ç–æ —É–∂–µ –∑–∞–±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–æ."
)
attrs["spot"] = spot
attrs["start_at"] = start_at
attrs["end_at"] = end_at
attrs["booking_type"] = booking_type
return attrs
def create(self, validated_data):
request = self.context["request"]
user = request.user
booking = Booking(
user=user,
**validated_data,
)
booking.total_price = booking.calculate_price()
booking.currency = "RUB"
booking.status = Booking.Status.PENDING
apply_ai_pricing(booking)
booking.save()
return booking
def update(self, instance, validated_data):
for field in ("spot", "start_at", "end_at", "booking_type", "vehicle"):
if field in validated_data:
setattr(instance, field, validated_data[field])
# –î–ª—è –ø—Ä–æ—Å—Ç–æ—Ç—ã —Ä–∞–∑—Ä–µ—à–∞–µ–º —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å —Ç–æ–ª—å–∫–æ PENDING‚Äë–±—Ä–æ–Ω–∏.
if instance.status != Booking.Status.PENDING:
raise serializers.ValidationError(
"–ú–æ–∂–Ω–æ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å —Ç–æ–ª—å–∫–æ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è –≤ —Å—Ç–∞—Ç—É—Å–µ '–û–∂–∏–¥–∞–µ—Ç –æ–ø–ª–∞—Ç—ã'."
)
instance.total_price = instance.calculate_price()
apply_ai_pricing(instance)
instance.save()
return instance
class WaitlistEntrySerializer(serializers.ModelSerializer):
user = serializers.ReadOnlyField(source="user.username")
spot_name = serializers.ReadOnlyField(source="spot.name")
class Meta:
model = WaitlistEntry
fields = (
"id",
"user",
"spot",
"spot_name",
"desired_start",
"desired_end",
"auto_book",
"status",
"created_at",
"updated_at",
)
read_only_fields = (
"id",
"user",
"spot_name",
"status",
"created_at",
"updated_at",
)
def create(self, validated_data):
request = self.context["request"]
user = request.user
entry = WaitlistEntry.objects.create(user=user, **validated_data)
return entry
class ComplaintSerializer(serializers.ModelSerializer):
author = serializers.ReadOnlyField(source="author.username")
spot_name = serializers.ReadOnlyField(source="spot.name")
booking_id = serializers.ReadOnlyField(source="booking.id")
class Meta:
model = Complaint
fields = (
"id",
"author",
"booking",
"booking_id",
"spot",
"spot_name",
"category",
"description",
"status",
"created_at",
"updated_at",
)
read_only_fields = (
"id",
"author",
"status",
"created_at",
"updated_at",
"spot_name",
"booking_id",
)
def create(self, validated_data):
request = self.context["request"]
user = request.user
complaint = Complaint.objects.create(author=user, **validated_data)
return complaint
class FavoriteParkingSpotSerializer(serializers.ModelSerializer):
spot_name = serializers.ReadOnlyField(source="spot.name")
lot_name = serializers.ReadOnlyField(source="spot.lot.name")
city = serializers.ReadOnlyField(source="spot.lot.city")
class Meta:
model = FavoriteParkingSpot
fields = (
"id",
"spot",
"spot_name",
"lot_name",
"city",
"note",
"created_at",
)
read_only_fields = ("id", "spot_name", "lot_name", "city", "created_at")
def create(self, validated_data):
request = self.context.get("request")
if request and request.user.is_authenticated:
validated_data["user"] = request.user
return super().create(validated_data)
class SavedPlaceSerializer(serializers.ModelSerializer):
class Meta:
model = SavedPlace
fields = (
"id",
"title",
"place_type",
"latitude",
"longitude",
"created_at",
)
read_only_fields = ("id", "created_at")
def create(self, validated_data):
request = self.context.get("request")
if request and request.user.is_authenticated:
validated_data["user"] = request.user
return super().create(validated_data)

# File 93/160: parking\tasks.py
################################################################################

# backend/parking/tasks.py
from __future__ import annotations
from datetime import timedelta
from celery import shared_task
from django.utils import timezone
from .models import Booking
@shared_task
def expire_unpaid_bookings() -> str:
"""
–§–æ–Ω–æ–≤–∞—è –∑–∞–¥–∞—á–∞: –ø–æ–º–µ—á–∞–µ—Ç –∫–∞–∫ EXPIRED –Ω–µ–æ–ø–ª–∞—á–µ–Ω–Ω—ã–µ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è,
—É –∫–æ—Ç–æ—Ä—ã—Ö –≤—Ä–µ–º—è –Ω–∞—á–∞–ª–∞ —É–∂–µ –¥–∞–≤–Ω–æ –ø—Ä–æ—à–ª–æ.
–ü–æ–¥–∫–ª—é—á–µ–Ω–∞ –≤ CELERY_BEAT_SCHEDULE –∫–∞–∫ parking.tasks.expire_unpaid_bookings.
"""
now = timezone.now()
grace = timedelta(minutes=15)
qs = Booking.objects.filter(
status=Booking.Status.PENDING,
is_paid=False,
start_at__lt=now - grace,
)
count = qs.count()
for booking in qs:
booking.status = Booking.Status.EXPIRED
booking.save(update_fields=["status"])
return f"Expired {count} unpaid bookings"

# File 94/160: parking\urls.py
################################################################################

# backend/parking/urls.py
from django.urls import path
app_name = "parking"
urlpatterns: list = [
# –ù–∞ –¥–∞–Ω–Ω—ã–π –º–æ–º–µ–Ω—Ç –≤—Å–µ HTML‚Äë—Å—Ç—Ä–∞–Ω–∏—Ü—ã –ø–æ–¥–∫–ª—é—á–∞—é—Ç—Å—è –Ω–∞–ø—Ä—è–º—É—é –∏–∑ config.urls.
]

# File 95/160: parking\views.py
################################################################################

from __future__ import annotations
from typing import Any, Iterable, List
from django.contrib.auth.mixins import LoginRequiredMixin
from django.core.cache import cache
from django.db.models import Q
import requests
from django.shortcuts import redirect
from django.urls import reverse
from django.views.generic import TemplateView
from rest_framework import permissions, status, viewsets
from rest_framework.response import Response
from core.permissions import IsAdminOrReadOnly
from core.utils import haversine_distance_km, parse_float
from vehicles.models import Vehicle
from .models import (
Booking,
Complaint,
FavoriteParkingSpot,
ParkingLot,
ParkingSpot,
SavedPlace,
WaitlistEntry,
)
from .serializers import (
BookingSerializer,
ComplaintSerializer,
FavoriteParkingSpotSerializer,
ParkingLotSerializer,
ParkingSpotSerializer,
SavedPlaceSerializer,
WaitlistEntrySerializer,
)
# =======================
#   DRF ViewSets (API)
# =======================
class ParkingLotViewSet(viewsets.ModelViewSet):
"""
CRUD –ø–æ –æ–±—ä–µ–∫—Ç–∞–º –ø–∞—Ä–∫–æ–≤–∫–∏.
- GET /api/parking/lots/ ‚Äî —Å–ø–∏—Å–æ–∫ (—Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏—è –ø–æ –≥–æ—Ä–æ–¥—É/—Ç–∏–ø—É)
- POST /api/parking/lots/ ‚Äî —Å–æ–∑–¥–∞—Ç—å (—Ç–æ–ª—å–∫–æ –≤–ª–∞–¥–µ–ª—å—Ü—ã/–∞–¥–º–∏–Ω—ã)
"""
serializer_class = ParkingLotSerializer
permission_classes = [permissions.IsAuthenticatedOrReadOnly]
def get_queryset(self):
qs = ParkingLot.objects.select_related("owner")
user = self.request.user
if not user.is_authenticated or (
not user.is_staff and not getattr(user, "is_owner", False)
):
qs = qs.filter(is_active=True, is_approved=True)
city = self.request.query_params.get("city")
if city:
qs = qs.filter(city__iexact=city)
parking_type = self.request.query_params.get("parking_type")
if parking_type:
qs = qs.filter(parking_type=parking_type)
return qs
def perform_create(self, serializer):
user = self.request.user
if not user.is_authenticated or not getattr(user, "is_owner", False):
raise permissions.PermissionDenied(
"–°–æ–∑–¥–∞–≤–∞—Ç—å –æ–±—ä–µ–∫—Ç—ã –ø–∞—Ä–∫–æ–≤–∫–∏ –º–æ–≥—É—Ç —Ç–æ–ª—å–∫–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ —Å —Ä–æ–ª—å—é 'owner' –∏–ª–∏ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—ã."
)
serializer.save(owner=user)
class ParkingSpotViewSet(viewsets.ModelViewSet):
"""
CRUD –ø–æ –ø–∞—Ä–∫–æ–≤–æ—á–Ω—ã–º –º–µ—Å—Ç–∞–º.
- GET /api/parking/spots/?lat=.&lng=.&radius_km=2 ‚Äî –º–µ—Å—Ç–∞ —Ä—è–¥–æ–º
- –§–∏–ª—å—Ç—Ä—ã: ?city=, ?vehicle_type=, ?max_price=, ?has_ev=1, ?covered=1, ?is_24_7=1
"""
serializer_class = ParkingSpotSerializer
permission_classes = [permissions.IsAuthenticatedOrReadOnly]
def get_queryset(self):
qs = ParkingSpot.objects.select_related("lot", "lot__owner").all()
user = self.request.user
if self.request.method in ("GET", "HEAD", "OPTIONS"):
qs = qs.filter(
status=ParkingSpot.SpotStatus.ACTIVE,
lot__is_active=True,
lot__is_approved=True,
)
else:
# –£–ø—Ä–∞–≤–ª—è—Ç—å –º–µ—Å—Ç–∞–º–∏ –º–æ–∂–µ—Ç —Ç–æ–ª—å–∫–æ –≤–ª–∞–¥–µ–ª–µ—Ü/–∞–¥–º–∏–Ω
if not user.is_authenticated or (
not getattr(user, "is_owner", False) and not user.is_superuser
):
return ParkingSpot.objects.none()
qs = qs.filter(lot__owner=user)
# –§–∏–ª—å—Ç—Ä–∞—Ü–∏—è
params = self.request.query_params
city = params.get("city")
if city:
qs = qs.filter(lot__city__iexact=city)
vehicle_type = params.get("vehicle_type")
if vehicle_type:
qs = qs.filter(vehicle_type=vehicle_type)
max_price = parse_float(params.get("max_price"))
if max_price is not None:
qs = qs.filter(hourly_price__lte=max_price)
has_ev = params.get("has_ev")
if has_ev == "1":
qs = qs.filter(has_ev_charging=True)
covered = params.get("covered")
if covered == "1":
qs = qs.filter(is_covered=True)
is_24_7 = params.get("is_24_7")
if is_24_7 == "1":
qs = qs.filter(is_24_7=True)
return qs
def list(self, request, *args, **kwargs):
"""
–°–ø–∏—Å–æ–∫ –º–µ—Å—Ç c –æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ–π —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–µ–π –ø–æ —Ä–∞–¥–∏—É—Å—É –æ—Ç —Ç–æ—á–∫–∏ (lat/lng).
"""
queryset = self.filter_queryset(self.get_queryset())
lat = parse_float(request.query_params.get("lat"))
lng = parse_float(request.query_params.get("lng"))
radius_km = parse_float(request.query_params.get("radius_km"))
if lat is not None and lng is not None and radius_km is not None:
# Python‚Äë—Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏—è –ø–æ —Ä–∞—Å—Å—Ç–æ—è–Ω–∏—é (—Ä–∞–±–æ—Ç–∞–µ—Ç –∏ –±–µ–∑ PostGIS)
filtered: List[ParkingSpot] = []
for spot in queryset:
lot = spot.lot
if lot.latitude is None or lot.longitude is None:
continue
distance = haversine_distance_km(
lat, lng, lot.latitude, lot.longitude
)
if distance <= radius_km:
spot.distance_km = distance
filtered.append(spot)
queryset = filtered
page = self.paginate_queryset(queryset)
if page is not None:
serializer = self.get_serializer(page, many=True)
return self.get_paginated_response(serializer.data)
serializer = self.get_serializer(queryset, many=True)
return Response(serializer.data)
class BookingViewSet(viewsets.ModelViewSet):
"""
–ë—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è.
- –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤–∏–¥–∏—Ç —Å–≤–æ–∏ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è.
- –í–ª–∞–¥–µ–ª–µ—Ü –≤–∏–¥–∏—Ç —Å–≤–æ–∏ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è –∏ –±—Ä–æ–Ω–∏ –ø–æ —Å–≤–æ–∏–º –º–µ—Å—Ç–∞–º.
"""
serializer_class = BookingSerializer
permission_classes = [permissions.IsAuthenticated]
def get_queryset(self):
user = self.request.user
qs = Booking.objects.select_related(
"spot", "spot__lot", "user", "vehicle"
).all()
if not user.is_authenticated:
return Booking.objects.none()
if user.is_superuser:
return qs
if getattr(user, "is_owner", False):
return qs.filter(Q(user=user) | Q(spot__lot__owner=user))
return qs.filter(user=user)
def perform_create(self, serializer):
booking = serializer.save()
return booking
def destroy(self, request, *args, **kwargs):
"""
–û—Ç–º–µ–Ω–∞ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è: –ø–æ–º–µ—á–∞–µ–º –∫–∞–∫ CANCELLED, –µ—Å–ª–∏ –æ–Ω–æ –µ—â—ë –Ω–µ –Ω–∞—á–∞–ª–æ—Å—å.
"""
instance: Booking = self.get_object()
if instance.has_started:
return Response(
{"detail": "–ù–µ–ª—å–∑—è –æ—Ç–º–µ–Ω–∏—Ç—å —É–∂–µ –Ω–∞—á–∞–≤—à–µ–µ—Å—è –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ."},
status=status.HTTP_400_BAD_REQUEST,
)
instance.status = Booking.Status.CANCELLED
instance.save(update_fields=["status"])
return Response(status=status.HTTP_204_NO_CONTENT)
class WaitlistViewSet(viewsets.ModelViewSet):
"""
–õ–∏—Å—Ç –æ–∂–∏–¥–∞–Ω–∏—è. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —É–ø—Ä–∞–≤–ª—è–µ—Ç —Ç–æ–ª—å–∫–æ —Å–≤–æ–∏–º–∏ –∑–∞–ø–∏—Å—è–º–∏.
–ê–¥–º–∏–Ω –º–æ–∂–µ—Ç –≤–∏–¥–µ—Ç—å –≤—Å—ë.
"""
serializer_class = WaitlistEntrySerializer
permission_classes = [permissions.IsAuthenticated]
def get_queryset(self):
user = self.request.user
qs = WaitlistEntry.objects.select_related("spot", "spot__lot", "user")
if user.is_superuser:
return qs
return qs.filter(user=user)
class ComplaintViewSet(viewsets.ModelViewSet):
"""
–ñ–∞–ª–æ–±—ã. –°–æ–∑–¥–∞—Ç–µ–ª—å –≤–∏–¥–∏—Ç —Å–≤–æ–∏, –∞–¥–º–∏–Ω ‚Äî –≤—Å–µ.
"""
serializer_class = ComplaintSerializer
permission_classes = [permissions.IsAuthenticated]
def get_queryset(self):
user = self.request.user
qs = Complaint.objects.select_related("author", "spot", "booking")
if user.is_superuser:
return qs
return qs.filter(author=user)
def perform_create(self, serializer):
serializer.save(author=self.request.user)
class FavoriteParkingSpotViewSet(viewsets.ModelViewSet):
"""API –∏–∑–±—Ä–∞–Ω–Ω—ã—Ö –ø–∞—Ä–∫–æ–≤–æ—á–Ω—ã—Ö –º–µ—Å—Ç."""
serializer_class = FavoriteParkingSpotSerializer
permission_classes = [permissions.IsAuthenticated]
def get_queryset(self):
user = self.request.user
qs = FavoriteParkingSpot.objects.select_related("spot", "spot__lot")
if user.is_superuser:
return qs
return qs.filter(user=user)
def perform_create(self, serializer):
serializer.save(user=self.request.user)
class SavedPlaceViewSet(viewsets.ModelViewSet):
"""–°–æ—Ö—Ä–∞–Ω—ë–Ω–Ω—ã–µ —Ç–æ—á–∫–∏ (–¥–æ–º/–æ—Ñ–∏—Å)."""
serializer_class = SavedPlaceSerializer
permission_classes = [permissions.IsAuthenticated]
def get_queryset(self):
user = self.request.user
qs = SavedPlace.objects.all()
if user.is_superuser:
return qs
return qs.filter(user=user)
def perform_create(self, serializer):
serializer.save(user=self.request.user)
# =======================
#   HTML-–≤—å—é—Ö–∏
# =======================
class LandingPageView(TemplateView):
"""
–õ–µ–Ω–¥–∏–Ω–≥ —Å –∫–∞—Ä—Ç–æ–π –∏ —Å–ø–∏—Å–∫–æ–º –ø–∞—Ä–∫–æ–≤–æ–∫/–º–µ—Å—Ç.
–ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç —Ñ–∏–ª—å—Ç—Ä—ã:
- city
- lat, lng, radius_km (–ø–æ–∏—Å–∫ –ø–æ —Ä–∞–¥–∏—É—Å—É)
"""
template_name = "parking/landing.html"
def get_context_data(self, **kwargs: Any):
ctx = super().get_context_data(**kwargs)
params = self.request.GET
city = (params.get("city") or "").strip()
lat = parse_float(params.get("lat"))
lng = parse_float(params.get("lng"))
radius_km = parse_float(params.get("radius_km"))
lots_qs = ParkingLot.objects.filter(
is_active=True, is_approved=True
).select_related("owner")
if city:
lots_qs = lots_qs.filter(city__iexact=city)
lots = lots_qs.order_by("city", "name")[:50]
spots_qs = ParkingSpot.objects.filter(
status=ParkingSpot.SpotStatus.ACTIVE,
lot__in=lots,
).select_related("lot", "lot__owner")
spots: Iterable[ParkingSpot]
if lat is not None and lng is not None and radius_km is not None:
filtered: list[ParkingSpot] = []
for spot in spots_qs:
lot = spot.lot
if lot.latitude is None or lot.longitude is None:
continue
distance = haversine_distance_km(
lat, lng, lot.latitude, lot.longitude
)
if distance <= radius_km:
spot.distance_km = distance
filtered.append(spot)
spots = sorted(
filtered,
key=lambda s: getattr(s, "distance_km", 0.0),
)[:100]
else:
spots = spots_qs.order_by(
"lot__city", "lot__name", "name"
)[:100]
ctx["lots"] = lots
ctx["spots"] = spots
ctx["has_query"] = bool(
city or (lat is not None and lng is not None and radius_km is not None)
)
return ctx
class MapPageView(LandingPageView):
"""–ü–æ–ª–Ω–æ—ç–∫—Ä–∞–Ω–Ω–∞—è –∫–∞—Ä—Ç–∞ —Å —Ç–µ–º–∏ –∂–µ –¥–∞–Ω–Ω—ã–º–∏, —á—Ç–æ –∏ –ª–µ–Ω–¥–∏–Ω–≥."""
template_name = "parking/map_fullscreen.html"
class PWAInstallGuideView(TemplateView):
"""–ü—Ä–æ—Å—Ç–∞—è —Å—Ç—Ä–∞–Ω–∏—Ü–∞ —Å –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—è–º–∏ –ø–æ —É—Å—Ç–∞–Ω–æ–≤–∫–µ PWA."""
template_name = "parking/pwa_install.html"
class UserDashboardView(LoginRequiredMixin, TemplateView):
"""
–õ–∏—á–Ω—ã–π –∫–∞–±–∏–Ω–µ—Ç –≤–æ–¥–∏—Ç–µ–ª—è: –µ–≥–æ –º–∞—à–∏–Ω—ã –∏ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è.
"""
template_name = "parking/user_dashboard.html"
def get_context_data(self, **kwargs: Any):
ctx = super().get_context_data(**kwargs)
user = self.request.user
vehicles = Vehicle.objects.filter(owner=user).order_by("-created_at")
bookings = (
Booking.objects.filter(user=user)
.select_related("spot", "spot__lot")
.order_by("-start_at")
)
ctx["vehicles"] = vehicles
ctx["bookings"] = bookings
return ctx
class OwnerDashboardView(LoginRequiredMixin, TemplateView):
"""
–ö–∞–±–∏–Ω–µ—Ç –≤–ª–∞–¥–µ–ª—å—Ü–∞: –µ–≥–æ –ø–∞—Ä–∫–∏–Ω–≥–∏, –º–µ—Å—Ç–∞ –∏ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è –ø–æ –Ω–∏–º.
"""
template_name = "parking/owner_dashboard.html"
def dispatch(self, request, *args, **kwargs):
user = request.user
if not (getattr(user, "is_owner", False) or user.is_superuser):
# –ï—Å–ª–∏ –Ω–µ –≤–ª–∞–¥–µ–ª–µ—Ü ‚Äî –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º –≤ –æ–±—ã—á–Ω—ã–π –∫–∞–±–∏–Ω–µ—Ç
return redirect("user_dashboard")
return super().dispatch(request, *args, **kwargs)
def get_context_data(self, **kwargs: Any):
ctx = super().get_context_data(**kwargs)
user = self.request.user
lots = (
ParkingLot.objects.filter(owner=user)
.prefetch_related("spots")
.order_by("city", "name")
)
spots = (
ParkingSpot.objects.filter(lot__owner=user)
.select_related("lot")
.order_by("lot__city", "lot__name", "name")
)
bookings = (
Booking.objects.filter(spot__lot__owner=user)
.select_related("spot", "spot__lot", "user")
.order_by("-start_at")
)
ctx["lots"] = lots
ctx["spots"] = spots
ctx["bookings"] = bookings
return ctx
# parking/views.py (–¥–æ–±–∞–≤–∏—Ç—å –ø–æ—Å–ª–µ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö APIView/ ViewSet)
from rest_framework.views import APIView
from rest_framework.permissions import AllowAny
from rest_framework.response import Response
from ai.orchestrator import AvailabilityDecision
from .models import ParkingSpot
class ParkingMapAPIView(APIView):
"""
–õ—ë–≥–∫–∏–π —ç–Ω–¥–ø–æ–∏–Ω—Ç –¥–ª—è –∫–∞—Ä—Ç—ã:
- —Ñ–∏–ª—å—Ç—Ä—ã –ø–æ —Ü–µ–Ω–µ/—Ñ–∏—á–∞–º;
- –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç GeoJSON‚Äë–ø–æ–¥–æ–±–Ω—É—é —Å—Ç—Ä—É–∫—Ç—É—Ä—É (features).
"""
permission_classes = [AllowAny]
def get(self, request, *args, **kwargs):
params = request.query_params
only_free = params.get("only_free") == "true"
has_ev = params.get("ev") == "true"
covered = params.get("covered") == "true"
is_24_7 = params.get("is_24_7") == "true"
ai_only = params.get("ai_recommended") == "true"
try:
min_price = float(params.get("min_price") or 0)
except ValueError:
min_price = 0.0
try:
max_price = float(params.get("max_price") or 0)
except ValueError:
max_price = 0.0
qs = ParkingSpot.objects.filter(
status=ParkingSpot.SpotStatus.ACTIVE,
lot__is_active=True,
lot__is_approved=True,
).select_related("lot")
if has_ev:
qs = qs.filter(has_ev_charging=True)
if covered:
qs = qs.filter(is_covered=True)
if is_24_7:
qs = qs.filter(is_24_7=True)
if min_price:
qs = qs.filter(hourly_price__gte=min_price)
if max_price:
qs = qs.filter(hourly_price__lte=max_price)
if ai_only:
qs = qs.filter(allow_dynamic_pricing=True)
features = []
for spot in qs[:500]:
lat = getattr(spot.lot, "latitude", None)
lng = getattr(spot.lot, "longitude", None)
if lat is None or lng is None:
continue
availability_score = 1.0 - float(spot.occupancy_7d or 0.0)
is_free_like = availability_score > 0.3
if only_free and not is_free_like:
continue
features.append(
{
"id": str(spot.id),
"type": "Feature",
"geometry": {
"type": "Point",
"coordinates": [lng, lat],
},
"properties": {
"spot_id": str(spot.id),
"lot_id": str(spot.lot_id),
"lot_name": spot.lot.name,
"city": spot.lot.city,
"address": spot.lot.address,
"name": spot.name,
"vehicle_type": spot.vehicle_type,
"has_ev_charging": spot.has_ev_charging,
"is_covered": spot.is_covered,
"is_24_7": spot.is_24_7,
"hourly_price": float(spot.hourly_price),
"allow_dynamic_pricing": spot.allow_dynamic_pricing,
"occupancy_7d": float(spot.occupancy_7d or 0.0),
"stress_index": float(spot.lot.stress_index or 0.0),
},
}
)
return Response(
{
"type": "FeatureCollection",
"features": features,
}
)
class GeocodeAPIView(APIView):
"""–ü—Ä–æ—Å—Ç–æ–π –ø—Ä–æ–∫—Å–∏ –∫ Nominatim —Å –∫–µ—à–∏—Ä–æ–≤–∞–Ω–∏–µ–º."""
permission_classes = [AllowAny]
def get(self, request, *args, **kwargs):
query = (request.query_params.get("q") or "").strip()
if not query:
return Response({"detail": "q is required"}, status=status.HTTP_400_BAD_REQUEST)
cache_key = f"geocode:{query}"
cached = cache.get(cache_key)
if cached:
return Response(cached)
url = "https:
resp = requests.get(
url,
params={"q": query, "format": "json", "limit": 5, "addressdetails": 1},
headers={"User-Agent": "ParkShare-RU/1.0"},
timeout=10,
)
resp.raise_for_status()
data = resp.json()
results = [
{
"title": item.get("display_name"),
"lat": float(item.get("lat")),
"lng": float(item.get("lon")),
}
for item in data
]
payload = {"results": results}
cache.set(cache_key, payload, 60 * 10)
return Response(payload)

# File 96/160: parking\management\commands\seed_demo_parking.py
################################################################################

# parking/management/commands/seed_demo_parking.py
from __future__ import annotations
from decimal import Decimal
from django.contrib.auth import get_user_model
from django.core.management.base import BaseCommand
from django.db import transaction
from parking.models import ParkingLot, ParkingSpot
class Command(BaseCommand):
help = "–°–æ–∑–¥–∞—ë—Ç –¥–µ–º–æ-–æ–±—ä–µ–∫—Ç –ø–∞—Ä–∫–æ–≤–∫–∏ –∏ –Ω–µ—Å–∫–æ–ª—å–∫–æ –º–µ—Å—Ç –¥–ª—è –ª–æ–∫–∞–ª—å–Ω–æ–π —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏."
def handle(self, *args, **options):
User = get_user_model()
# ---------- 1. –í–ª–∞–¥–µ–ª–µ—Ü –ø–∞—Ä–∫–æ–≤–∫–∏ ----------
role_cls = getattr(User, "Role", None)
owner_role_value = getattr(role_cls, "OWNER", None) if role_cls else None
owner_defaults = {
"email": "demo-owner@example.com",
"is_active": True,
}
if owner_role_value is not None:
owner_defaults["role"] = owner_role_value
owner, created_owner = User.objects.get_or_create(
username="demo_owner",
defaults=owner_defaults,
)
if created_owner:
owner.set_password("demo_owner")
owner.save(update_fields=["password"])
self.stdout.write(
self.style.SUCCESS(
"–°–æ–∑–¥–∞–Ω –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å-–≤–ª–∞–¥–µ–ª–µ—Ü demo_owner / –ø–∞—Ä–æ–ª—å: demo_owner"
)
)
else:
self.stdout.write(
self.style.SUCCESS(f"–ù–∞–π–¥–µ–Ω –≤–ª–∞–¥–µ–ª–µ—Ü demo_owner (id={owner.pk})")
)
# ---------- 2. –û–±—ä–µ–∫—Ç –ø–∞—Ä–∫–æ–≤–∫–∏ ----------
with transaction.atomic():
lot, created_lot = ParkingLot.objects.get_or_create(
name="–î–µ–º–æ-–ø–∞—Ä–∫–æ–≤–∫–∞ ParkShare",
city="–ú–æ—Å–∫–≤–∞",
address="—É–ª. –ü—Ä–∏–º–µ—Ä–Ω–∞—è, –¥. 1",
defaults={
"owner": owner,
"parking_type": "yard",
"latitude": 55.751244,
"longitude": 37.618423,
"is_active": True,
"is_approved": True,
"is_private": False,
},
)
if not created_lot:
# –ù–∞ –≤—Å—è–∫–∏–π —Å–ª—É—á–∞–π –ø—Ä–∏–≤—è–∑—ã–≤–∞–µ–º –∫ –Ω–∞—à–µ–º—É –¥–µ–º–æ-–≤–ª–∞–¥–µ–ª—å—Ü—É
if lot.owner_id != owner.id:
lot.owner = owner
lot.save(update_fields=["owner"])
self.stdout.write(
self.style.SUCCESS(
f"–ò—Å–ø–æ–ª—å–∑—É–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â—É—é –ø–∞—Ä–∫–æ–≤–∫—É (id={lot.pk})"
)
)
else:
self.stdout.write(
self.style.SUCCESS(
f"–°–æ–∑–¥–∞–Ω–∞ –¥–µ–º–æ-–ø–∞—Ä–∫–æ–≤–∫–∞ (id={lot.pk}) –≤ –ú–æ—Å–∫–≤–µ"
)
)
# ---------- 3. –ü–∞—Ä–∫–æ–≤–æ—á–Ω—ã–µ –º–µ—Å—Ç–∞ ----------
spots_spec = [
{
"name": "–ú–µ—Å—Ç–æ 1 ‚Äî EV 24/7",
"description": "–†—è–¥–æ–º —Å –≤—ä–µ–∑–¥–æ–º, –µ—Å—Ç—å –∑–∞—Ä—è–¥–∫–∞ –¥–ª—è EV.",
"is_covered": False,
"has_ev_charging": True,
"is_24_7": True,
"hourly_price": Decimal("120.00"),
"allow_dynamic_pricing": True,
"occupancy_7d": 0.65,
},
{
"name": "–ú–µ—Å—Ç–æ 2 ‚Äî –∫—Ä—ã—Ç–æ–µ",
"description": "–ö—Ä—ã—Ç–æ–µ –º–µ—Å—Ç–æ –Ω–∞ -1 —ç—Ç–∞–∂–µ.",
"is_covered": True,
"has_ev_charging": False,
"is_24_7": True,
"hourly_price": Decimal("90.00"),
"allow_dynamic_pricing": False,
"occupancy_7d": 0.40,
},
{
"name": "–ú–µ—Å—Ç–æ 3 ‚Äî –±—é–¥–∂–µ—Ç–Ω–æ–µ",
"description": "–°–∞–º–æ–µ –¥–µ—à—ë–≤–æ–µ, –Ω–æ —á—É—Ç—å –¥–∞–ª—å—à–µ –æ—Ç –≤—ã–µ–∑–¥–∞.",
"is_covered": False,
"has_ev_charging": False,
"is_24_7": True,
"hourly_price": Decimal("70.00"),
"allow_dynamic_pricing": True,
"occupancy_7d": 0.80,
},
{
"name": "–ú–µ—Å—Ç–æ 4 ‚Äî –ø—Ä–µ–º–∏—É–º",
"description": "–®–∏—Ä–æ–∫–æ–µ –º–µ—Å—Ç–æ, —É–¥–æ–±–Ω–æ –¥–ª—è –∫—Ä–æ—Å—Å–æ–≤–µ—Ä–æ–≤.",
"is_covered": True,
"has_ev_charging": True,
"is_24_7": True,
"hourly_price": Decimal("150.00"),
"allow_dynamic_pricing": True,
"occupancy_7d": 0.55,
},
]
created_count = 0
for spec in spots_spec:
spot, created_spot = ParkingSpot.objects.get_or_create(
lot=lot,
name=spec["name"],
defaults=spec,
)
if created_spot:
created_count += 1
total_spots = ParkingSpot.objects.filter(lot=lot).count()
self.stdout.write(
self.style.SUCCESS(
f"–ì–æ—Ç–æ–≤–æ: –º–µ—Å—Ç –≤ –¥–µ–º–æ-–ø–∞—Ä–∫–æ–≤–∫–µ —Å–µ–π—á–∞—Å {total_spots} "
f"(—Å–æ–∑–¥–∞–Ω–æ –∑–∞ —ç—Ç–æ—Ç –∑–∞–ø—É—Å–∫ {created_count})."
)
)
self.stdout.write(self.style.SUCCESS("seed_demo_parking: –¥–µ–º–æ-–¥–∞–Ω–Ω—ã–µ –≥–æ—Ç–æ–≤—ã."))

# File 97/160: parking\migrations\0001_initial.py
################################################################################

# Generated by Django 5.2.8 on 2025-11-21 21:34
import django.db.models.deletion
import parking.models
from django.conf import settings
from django.db import migrations, models
class Migration(migrations.Migration):
initial = True
dependencies = [
('vehicles', '0001_initial'),
migrations.swappable_dependency(settings.AUTH_USER_MODEL),
]
operations = [
migrations.CreateModel(
name='Booking',
fields=[
('id', models.BigAutoField(auto_created=True, primary_key=True, serialize=False, verbose_name='ID')),
('created_at', models.DateTimeField(auto_now_add=True, verbose_name='–î–∞—Ç–∞ —Å–æ–∑–¥–∞–Ω–∏—è')),
('updated_at', models.DateTimeField(auto_now=True, verbose_name='–î–∞—Ç–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è')),
('booking_type', models.CharField(choices=[('hourly', '–ü–æ—á–∞—Å–æ–≤–∞—è'), ('daily', '–°—É—Ç–æ—á–Ω–∞—è'), ('night', '–ù–æ—á–Ω–∞—è'), ('weekly', '–ù–µ–¥–µ–ª—å–Ω–∞—è'), ('monthly', '–ú–µ—Å—è—á–Ω–∞—è')], default='hourly', max_length=16, verbose_name='–¢–∏–ø –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è')),
('start_at', models.DateTimeField(verbose_name='–ù–∞—á–∞–ª–æ –±—Ä–æ–Ω–∏')),
('end_at', models.DateTimeField(verbose_name='–û–∫–æ–Ω—á–∞–Ω–∏–µ –±—Ä–æ–Ω–∏')),
('status', models.CharField(choices=[('pending', '–û–∂–∏–¥–∞–µ—Ç –æ–ø–ª–∞—Ç—ã'), ('confirmed', '–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∞'), ('active', '–ê–∫—Ç–∏–≤–Ω–∞'), ('completed', '–ó–∞–≤–µ—Ä—à–µ–Ω–∞'), ('cancelled', '–û—Ç–º–µ–Ω–µ–Ω–∞'), ('expired', '–ò—Å—Ç–µ–∫–ª–∞')], default='pending', max_length=16, verbose_name='–°—Ç–∞—Ç—É—Å')),
('total_price', models.DecimalField(decimal_places=2, max_digits=10, verbose_name='–ò—Ç–æ–≥–æ–≤–∞—è —Å—Ç–æ–∏–º–æ—Å—Ç—å, ‚ÇΩ')),
('currency', models.CharField(default='RUB', max_length=8, verbose_name='–í–∞–ª—é—Ç–∞')),
('is_paid', models.BooleanField(default=False, verbose_name='–û–ø–ª–∞—á–µ–Ω–æ')),
('external_payment_id', models.CharField(blank=True, help_text='–°–≤—è–∑–∫–∞ —Å –ø–ª–∞—Ç–µ–∂–æ–º —É –ø—Ä–æ–≤–∞–π–¥–µ—Ä–∞ (–Ω–∞–ø—Ä–∏–º–µ—Ä, YooKassa payment_id).', max_length=64, verbose_name='ID –ø–ª–∞—Ç–µ–∂–∞ –ø—Ä–æ–≤–∞–π–¥–µ—Ä–∞')),
('user', models.ForeignKey(on_delete=django.db.models.deletion.CASCADE, related_name='bookings', to=settings.AUTH_USER_MODEL, verbose_name='–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å')),
('vehicle', models.ForeignKey(blank=True, null=True, on_delete=django.db.models.deletion.SET_NULL, related_name='bookings', to='vehicles.vehicle', verbose_name='–¢—Ä–∞–Ω—Å–ø–æ—Ä—Ç')),
],
options={
'verbose_name': '–ë—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ',
'verbose_name_plural': '–ë—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è',
'ordering': ('-start_at',),
},
),
migrations.CreateModel(
name='ParkingLot',
fields=[
('id', models.BigAutoField(auto_created=True, primary_key=True, serialize=False, verbose_name='ID')),
('created_at', models.DateTimeField(auto_now_add=True, verbose_name='–î–∞—Ç–∞ —Å–æ–∑–¥–∞–Ω–∏—è')),
('updated_at', models.DateTimeField(auto_now=True, verbose_name='–î–∞—Ç–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è')),
('name', models.CharField(max_length=255, verbose_name='–ù–∞–∑–≤–∞–Ω–∏–µ')),
('city', models.CharField(max_length=100, verbose_name='–ì–æ—Ä–æ–¥')),
('address', models.CharField(max_length=255, verbose_name='–ê–¥—Ä–µ—Å')),
('parking_type', models.CharField(choices=[('yard', '–î–≤–æ—Ä–æ–≤–∞—è –ø–∞—Ä–∫–æ–≤–∫–∞'), ('underground', '–ü–æ–¥–∑–µ–º–Ω–∞—è –ø–∞—Ä–∫–æ–≤–∫–∞'), ('multilevel', '–ú–Ω–æ–≥–æ—É—Ä–æ–≤–Ω–µ–≤–∞—è –ø–∞—Ä–∫–æ–≤–∫–∞'), ('street', '–£–ª–∏—á–Ω–∞—è –ø–∞—Ä–∫–æ–≤–∫–∞'), ('office', '–û—Ñ–∏—Å–Ω–∞—è –ø–∞—Ä–∫–æ–≤–∫–∞'), ('home', '–î–æ–º–∞—à–Ω–µ–µ –º–µ—Å—Ç–æ')], default='yard', max_length=32, verbose_name='–¢–∏–ø –ø–∞—Ä–∫–æ–≤–∫–∏')),
('description', models.TextField(blank=True, verbose_name='–û–ø–∏—Å–∞–Ω–∏–µ')),
('location', parking.models.PointField(blank=True, null=True, verbose_name='–¢–æ—á–∫–∞ –Ω–∞ –∫–∞—Ä—Ç–µ')),
('latitude', models.FloatField(blank=True, null=True, verbose_name='–®–∏—Ä–æ—Ç–∞')),
('longitude', models.FloatField(blank=True, null=True, verbose_name='–î–æ–ª–≥–æ—Ç–∞')),
('is_active', models.BooleanField(default=True, verbose_name='–ê–∫—Ç–∏–≤–µ–Ω')),
('is_approved', models.BooleanField(default=False, help_text='–û–¥–æ–±—Ä—è–µ—Ç—Å—è –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–º –ø–µ—Ä–µ–¥ –ø—É–±–ª–∏–∫–∞—Ü–∏–µ–π.', verbose_name='–û–¥–æ–±—Ä–µ–Ω –º–æ–¥–µ—Ä–∞—Ü–∏–µ–π')),
('is_private', models.BooleanField(default=False, help_text='–ï—Å–ª–∏ –≤–∫–ª—é—á–µ–Ω–æ, –æ–±—ä–µ–∫—Ç –≤–∏–¥–µ–Ω —Ç–æ–ª—å–∫–æ –ø–æ –ø—Ä—è–º—ã–º —Å—Å—ã–ª–∫–∞–º/–≤–ª–∞–¥–µ–ª—å—Ü—É.', verbose_name='–ü—Ä–∏–≤–∞—Ç–Ω—ã–π')),
('owner', models.ForeignKey(on_delete=django.db.models.deletion.CASCADE, related_name='parking_lots', to=settings.AUTH_USER_MODEL, verbose_name='–í–ª–∞–¥–µ–ª–µ—Ü')),
],
options={
'verbose_name': '–û–±—ä–µ–∫—Ç –ø–∞—Ä–∫–æ–≤–∫–∏',
'verbose_name_plural': '–û–±—ä–µ–∫—Ç—ã –ø–∞—Ä–∫–æ–≤–∫–∏',
'ordering': ('name',),
},
),
migrations.CreateModel(
name='ParkingSpot',
fields=[
('id', models.BigAutoField(auto_created=True, primary_key=True, serialize=False, verbose_name='ID')),
('created_at', models.DateTimeField(auto_now_add=True, verbose_name='–î–∞—Ç–∞ —Å–æ–∑–¥–∞–Ω–∏—è')),
('updated_at', models.DateTimeField(auto_now=True, verbose_name='–î–∞—Ç–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è')),
('name', models.CharField(max_length=64, verbose_name='–ù–∞–∑–≤–∞–Ω–∏–µ/–Ω–æ–º–µ—Ä –º–µ—Å—Ç–∞')),
('description', models.TextField(blank=True, verbose_name='–û–ø–∏—Å–∞–Ω–∏–µ')),
('vehicle_type', models.CharField(choices=[('car', '–õ–µ–≥–∫–æ–≤–æ–π –∞–≤—Ç–æ–º–æ–±–∏–ª—å'), ('moto', '–ú–æ—Ç–æ—Ü–∏–∫–ª'), ('commercial', '–ö–æ–º–º–µ—Ä—á–µ—Å–∫–∏–π —Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç')], default='car', max_length=16, verbose_name='–¢–∏–ø —Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç–∞')),
('is_covered', models.BooleanField(default=False, verbose_name='–ö—Ä—ã—Ç–æ–µ –º–µ—Å—Ç–æ')),
('has_ev_charging', models.BooleanField(default=False, verbose_name='–ï—Å—Ç—å –∑–∞—Ä—è–¥–∫–∞')),
('is_24_7', models.BooleanField(default=True, verbose_name='–ö—Ä—É–≥–ª–æ—Å—É—Ç–æ—á–Ω–æ')),
('max_height_m', models.DecimalField(blank=True, decimal_places=2, max_digits=4, null=True, verbose_name='–ú–∞–∫—Å–∏–º–∞–ª—å–Ω–∞—è –≤—ã—Å–æ—Ç–∞ (–º)')),
('hourly_price', models.DecimalField(decimal_places=2, max_digits=8, verbose_name='–¶–µ–Ω–∞ –∑–∞ —á–∞—Å, ‚ÇΩ')),
('nightly_price', models.DecimalField(blank=True, decimal_places=2, max_digits=8, null=True, verbose_name='–¶–µ–Ω–∞ –∑–∞ –Ω–æ—á—å, ‚ÇΩ')),
('daily_price', models.DecimalField(blank=True, decimal_places=2, max_digits=8, null=True, verbose_name='–¶–µ–Ω–∞ –∑–∞ —Å—É—Ç–∫–∏, ‚ÇΩ')),
('monthly_price', models.DecimalField(blank=True, decimal_places=2, max_digits=9, null=True, verbose_name='–¶–µ–Ω–∞ –∑–∞ –º–µ—Å—è—Ü, ‚ÇΩ')),
('allow_dynamic_pricing', models.BooleanField(default=False, help_text='–ï—Å–ª–∏ –≤–∫–ª—é—á–µ–Ω–æ, —Ç–∞—Ä–∏—Ñ –º–æ–∂–µ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–∏—Ä–æ–≤–∞—Ç—å—Å—è —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è–º–∏ AI.', verbose_name='–î–∏–Ω–∞–º–∏—á–µ—Å–∫–∞—è —Ü–µ–Ω–∞ (AI)')),
('status', models.CharField(choices=[('active', '–ê–∫—Ç–∏–≤–Ω–æ'), ('inactive', '–ù–µ–∞–∫—Ç–∏–≤–Ω–æ')], default='active', max_length=16, verbose_name='–°—Ç–∞—Ç—É—Å')),
('lot', models.ForeignKey(on_delete=django.db.models.deletion.CASCADE, related_name='spots', to='parking.parkinglot', verbose_name='–û–±—ä–µ–∫—Ç –ø–∞—Ä–∫–æ–≤–∫–∏')),
],
options={
'verbose_name': '–ü–∞—Ä–∫–æ–≤–æ—á–Ω–æ–µ –º–µ—Å—Ç–æ',
'verbose_name_plural': '–ü–∞—Ä–∫–æ–≤–æ—á–Ω—ã–µ –º–µ—Å—Ç–∞',
'ordering': ('lot__name', 'name'),
},
),
migrations.CreateModel(
name='Complaint',
fields=[
('id', models.BigAutoField(auto_created=True, primary_key=True, serialize=False, verbose_name='ID')),
('created_at', models.DateTimeField(auto_now_add=True, verbose_name='–î–∞—Ç–∞ —Å–æ–∑–¥–∞–Ω–∏—è')),
('updated_at', models.DateTimeField(auto_now=True, verbose_name='–î–∞—Ç–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è')),
('category', models.CharField(choices=[('foreign_car', '–ß—É–∂–∞—è –º–∞—à–∏–Ω–∞ –Ω–∞ –º–µ—Å—Ç–µ'), ('no_show', '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –ø—Ä–∏–µ—Ö–∞–ª'), ('no_free_spot', '–ù–µ –Ω–∞—à—ë–ª —Å–≤–æ–±–æ–¥–Ω–æ–≥–æ –º–µ—Å—Ç–∞'), ('other', '–î—Ä—É–≥–æ–µ')], default='other', max_length=32, verbose_name='–ö–∞—Ç–µ–≥–æ—Ä–∏—è')),
('description', models.TextField(blank=True, verbose_name='–û–ø–∏—Å–∞–Ω–∏–µ')),
('status', models.CharField(choices=[('new', '–ù–æ–≤–∞—è'), ('in_progress', '–í —Ä–∞–±–æ—Ç–µ'), ('resolved', '–†–µ—à–µ–Ω–∞'), ('rejected', '–û—Ç–∫–ª–æ–Ω–µ–Ω–∞')], default='new', max_length=16, verbose_name='–°—Ç–∞—Ç—É—Å')),
('author', models.ForeignKey(on_delete=django.db.models.deletion.CASCADE, related_name='complaints', to=settings.AUTH_USER_MODEL, verbose_name='–ê–≤—Ç–æ—Ä')),
('booking', models.ForeignKey(blank=True, null=True, on_delete=django.db.models.deletion.SET_NULL, related_name='complaints', to='parking.booking', verbose_name='–ë—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ')),
('spot', models.ForeignKey(blank=True, null=True, on_delete=django.db.models.deletion.SET_NULL, related_name='complaints', to='parking.parkingspot', verbose_name='–ü–∞—Ä–∫–æ–≤–æ—á–Ω–æ–µ –º–µ—Å—Ç–æ')),
],
options={
'verbose_name': '–ñ–∞–ª–æ–±–∞',
'verbose_name_plural': '–ñ–∞–ª–æ–±—ã',
'ordering': ('-created_at',),
},
),
migrations.AddField(
model_name='booking',
name='spot',
field=models.ForeignKey(on_delete=django.db.models.deletion.PROTECT, related_name='bookings', to='parking.parkingspot', verbose_name='–ü–∞—Ä–∫–æ–≤–æ—á–Ω–æ–µ –º–µ—Å—Ç–æ'),
),
migrations.CreateModel(
name='WaitlistEntry',
fields=[
('id', models.BigAutoField(auto_created=True, primary_key=True, serialize=False, verbose_name='ID')),
('created_at', models.DateTimeField(auto_now_add=True, verbose_name='–î–∞—Ç–∞ —Å–æ–∑–¥–∞–Ω–∏—è')),
('updated_at', models.DateTimeField(auto_now=True, verbose_name='–î–∞—Ç–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è')),
('desired_start', models.DateTimeField(verbose_name='–ñ–µ–ª–∞–µ–º–æ–µ –Ω–∞—á–∞–ª–æ')),
('desired_end', models.DateTimeField(verbose_name='–ñ–µ–ª–∞–µ–º–æ–µ –æ–∫–æ–Ω—á–∞–Ω–∏–µ')),
('auto_book', models.BooleanField(default=False, help_text='–ï—Å–ª–∏ –≤–∫–ª—é—á–µ–Ω–æ, –ø—Ä–∏ –æ—Å–≤–æ–±–æ–∂–¥–µ–Ω–∏–∏ –º–µ—Å—Ç–∞ –±—É–¥–µ—Ç —Å–æ–∑–¥–∞–Ω–∞ –±—Ä–æ–Ω—å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏.', verbose_name='–ê–≤—Ç–æ‚Äë–±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ')),
('status', models.CharField(choices=[('waiting', '–û–∂–∏–¥–∞–µ—Ç'), ('notified', '–£–≤–µ–¥–æ–º–ª—ë–Ω'), ('booked', '–ê–≤—Ç–æ‚Äë–±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–æ–∑–¥–∞–Ω–æ'), ('cancelled', '–û—Ç–º–µ–Ω–µ–Ω–æ')], default='waiting', max_length=16, verbose_name='–°—Ç–∞—Ç—É—Å')),
('spot', models.ForeignKey(on_delete=django.db.models.deletion.CASCADE, related_name='waitlist_entries', to='parking.parkingspot', verbose_name='–ü–∞—Ä–∫–æ–≤–æ—á–Ω–æ–µ –º–µ—Å—Ç–æ')),
('user', models.ForeignKey(on_delete=django.db.models.deletion.CASCADE, related_name='waitlist_entries', to=settings.AUTH_USER_MODEL, verbose_name='–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å')),
],
options={
'verbose_name': '–ó–∞–ø–∏—Å—å –≤ –ª–∏—Å—Ç–µ –æ–∂–∏–¥–∞–Ω–∏—è',
'verbose_name_plural': '–õ–∏—Å—Ç –æ–∂–∏–¥–∞–Ω–∏—è',
'ordering': ('-created_at',),
'unique_together': {('user', 'spot', 'desired_start', 'desired_end')},
},
),
]

# File 98/160: parking\migrations\0002_parkinglot_stress_index_parkingspot_occupancy_7d.py
################################################################################

# Generated by Django 5.2.8 on 2025-11-22 11:21
from django.db import migrations, models
class Migration(migrations.Migration):
dependencies = [
('parking', '0001_initial'),
]
operations = [
migrations.AddField(
model_name='parkinglot',
name='stress_index',
field=models.FloatField(default=0.0, help_text='–°—Ä–µ–¥–Ω—è—è –∑–∞–≥—Ä—É–∂–µ–Ω–Ω–æ—Å—Ç—å –º–µ—Å—Ç –∑–∞ –ø–æ—Å–ª–µ–¥–Ω–∏–µ 7 –¥–Ω–µ–π. –û–±–Ω–æ–≤–ª—è–µ—Ç—Å—è —Ñ–æ–Ω–æ–≤—ã–º–∏ –∑–∞–¥–∞—á–∞–º–∏ AI.', verbose_name='–ò–Ω–¥–µ–∫—Å –∑–∞–≥—Ä—É–∂–µ–Ω–Ω–æ—Å—Ç–∏ (0..1)'),
),
migrations.AddField(
model_name='parkingspot',
name='occupancy_7d',
field=models.FloatField(default=0.0, help_text='–î–æ–ª—è –≤—Ä–µ–º–µ–Ω–∏, –∫–æ–≥–¥–∞ –º–µ—Å—Ç–æ –±—ã–ª–æ –∑–∞–Ω—è—Ç–æ –∑–∞ –ø–æ—Å–ª–µ–¥–Ω–∏–µ 7 –¥–Ω–µ–π. –û–±–Ω–æ–≤–ª—è–µ—Ç—Å—è —Ñ–æ–Ω–æ–≤—ã–º–∏ –∑–∞–¥–∞—á–∞–º–∏ AI.', verbose_name='–ó–∞–≥—Ä—É–∂–µ–Ω–Ω–æ—Å—Ç—å –∑–∞ 7 –¥–Ω–µ–π (0..1)'),
),
]

# File 99/160: parking\migrations\0003_booking_ai_fields.py
################################################################################

from django.db import migrations, models
class Migration(migrations.Migration):
dependencies = [
("parking", "0002_parkinglot_stress_index_parkingspot_occupancy_7d"),
]
operations = [
migrations.AddField(
model_name="booking",
name="ai_snapshot",
field=models.JSONField(blank=True, help_text="–î–∞–Ω–Ω—ã–µ —Ä–µ—à–µ–Ω–∏–π AI (—Ü–µ–Ω—ã, –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å, —Ä–∏—Å–∫–∏)", null=True, verbose_name="AI snapshot"),
),
migrations.AddField(
model_name="booking",
name="dynamic_pricing_applied",
field=models.BooleanField(default=False, verbose_name="–î–∏–Ω–∞–º–∏—á–µ—Å–∫–æ–µ —Ü–µ–Ω–æ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏–µ"),
),
]

# File 100/160: parking\migrations\0004_favoriteparkingspot_savedplace.py
################################################################################

from django.conf import settings
from django.db import migrations, models
import django.db.models.deletion
class Migration(migrations.Migration):
dependencies = [
('parking', '0003_booking_ai_fields'),
migrations.swappable_dependency(settings.AUTH_USER_MODEL),
]
operations = [
migrations.CreateModel(
name='FavoriteParkingSpot',
fields=[
('id', models.BigAutoField(auto_created=True, primary_key=True, serialize=False, verbose_name='ID')),
('created_at', models.DateTimeField(auto_now_add=True, verbose_name='–î–∞—Ç–∞ —Å–æ–∑–¥–∞–Ω–∏—è')),
('updated_at', models.DateTimeField(auto_now=True, verbose_name='–î–∞—Ç–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è')),
('note', models.CharField(blank=True, max_length=120, verbose_name='–ó–∞–º–µ—Ç–∫–∞')),
('spot', models.ForeignKey(on_delete=django.db.models.deletion.CASCADE, related_name='favorites', to='parking.parkingspot')),
('user', models.ForeignKey(on_delete=django.db.models.deletion.CASCADE, related_name='favorite_spots', to=settings.AUTH_USER_MODEL)),
],
options={
'verbose_name': '–ò–∑–±—Ä–∞–Ω–Ω–æ–µ –º–µ—Å—Ç–æ',
'verbose_name_plural': '–ò–∑–±—Ä–∞–Ω–Ω—ã–µ –º–µ—Å—Ç–∞',
'ordering': ('-created_at',),
'unique_together': {('user', 'spot')},
},
),
migrations.CreateModel(
name='SavedPlace',
fields=[
('id', models.BigAutoField(auto_created=True, primary_key=True, serialize=False, verbose_name='ID')),
('created_at', models.DateTimeField(auto_now_add=True, verbose_name='–î–∞—Ç–∞ —Å–æ–∑–¥–∞–Ω–∏—è')),
('updated_at', models.DateTimeField(auto_now=True, verbose_name='–î–∞—Ç–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è')),
('title', models.CharField(max_length=64, verbose_name='–ù–∞–∑–≤–∞–Ω–∏–µ')),
('place_type', models.CharField(choices=[('home', '–î–æ–º'), ('work', '–û—Ñ–∏—Å'), ('custom', '–î—Ä—É–≥–æ–µ')], default='custom', max_length=16, verbose_name='–¢–∏–ø —Ç–æ—á–∫–∏')),
('latitude', models.FloatField(verbose_name='–®–∏—Ä–æ—Ç–∞')),
('longitude', models.FloatField(verbose_name='–î–æ–ª–≥–æ—Ç–∞')),
('user', models.ForeignKey(on_delete=django.db.models.deletion.CASCADE, related_name='saved_places', to=settings.AUTH_USER_MODEL)),
],
options={
'verbose_name': '–°–æ—Ö—Ä–∞–Ω—ë–Ω–Ω–∞—è —Ç–æ—á–∫–∞',
'verbose_name_plural': '–°–æ—Ö—Ä–∞–Ω—ë–Ω–Ω—ã–µ —Ç–æ—á–∫–∏',
'ordering': ('title',),
'unique_together': {('user', 'title')},
},
),
]

# File 101/160: parking\migrations\__init__.py
################################################################################



# File 102/160: payments\__init__.py
################################################################################

default_app_config = "payments.apps.PaymentsConfig"

# File 103/160: payments\admin.py
################################################################################

from django.contrib import admin
from .models import Payment
@admin.register(Payment)
class PaymentAdmin(admin.ModelAdmin):
list_display = (
"id",
"booking",
"payer",
"provider",
"provider_payment_id",
"amount",
"currency",
"status",
"success",
"failure",
"created_at",
)
list_filter = (
"provider",
"status",
"success",
"failure",
"created_at",
)
search_fields = ("provider_payment_id", "booking__id", "payer__username")
autocomplete_fields = ("booking", "payer")

# File 104/160: payments\apps.py
################################################################################

from django.apps import AppConfig
class PaymentsConfig(AppConfig):
default_auto_field = "django.db.models.BigAutoField"
name = "payments"
verbose_name = "–ü–ª–∞—Ç–µ–∂–∏"

# File 105/160: payments\models.py
################################################################################

from __future__ import annotations
from decimal import Decimal
from typing import Any, Optional
from django.conf import settings
from django.db import models
from django.utils.translation import gettext_lazy as _
from core.models import TimeStampedModel
class Payment(TimeStampedModel):
"""
–ü–ª–∞—Ç—ë–∂ –∑–∞ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ —á–µ—Ä–µ–∑ –≤–Ω–µ—à–Ω–µ–≥–æ –ø—Ä–æ–≤–∞–π–¥–µ—Ä–∞ (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é ‚Äî YooKassa).
–î–ª—è –ø—Ä–æ—Å—Ç–æ—Ç—ã –≤ —Ç–µ–∫—É—â–µ–π —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏ —É –∫–∞–∂–¥–æ–π –±—Ä–æ–Ω–∏ –º–æ–∂–µ—Ç –±—ã—Ç—å –Ω–µ –±–æ–ª–µ–µ
–æ–¥–Ω–æ–≥–æ —Å–≤—è–∑–∞–Ω–Ω–æ–≥–æ –ø–ª–∞—Ç–µ–∂–∞ (OneToOne), –∫–æ—Ç–æ—Ä—ã–π –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –ø–æ–≤—Ç–æ—Ä–Ω–æ
–ø—Ä–∏ –ø–æ–≤—Ç–æ—Ä–Ω—ã—Ö –ø–æ–ø—ã—Ç–∫–∞—Ö –æ–ø–ª–∞—Ç—ã, –ø–æ–∫–∞ –Ω–µ —Å—Ç–∞–Ω–µ—Ç —É—Å–ø–µ—à–Ω—ã–º –∏–ª–∏ –Ω–µ –±—É–¥–µ—Ç
–æ—Ç–º–µ–Ω—ë–Ω/–∑–∞–≤–µ—Ä—à—ë–Ω —Å –æ—à–∏–±–∫–æ–π.
"""
class Provider(models.TextChoices):
YOOKASSA = "yookassa", "YooKassa"
STRIPE = "stripe", "Stripe"
class Status(models.TextChoices):
CREATED = "created", _("–°–æ–∑–¥–∞–Ω")
PENDING = "pending", _("–û–∂–∏–¥–∞–µ—Ç –æ–ø–ª–∞—Ç—ã")
SUCCEEDED = "succeeded", _("–£—Å–ø–µ—à–µ–Ω")
CANCELLED = "cancelled", _("–û—Ç–º–µ–Ω—ë–Ω")
FAILED = "failed", _("–û—à–∏–±–∫–∞")
booking = models.OneToOneField(
"parking.Booking",
on_delete=models.CASCADE,
related_name="payment",
verbose_name=_("–ë—Ä–æ–Ω—å"),
)
payer = models.ForeignKey(
settings.AUTH_USER_MODEL,
on_delete=models.CASCADE,
related_name="payments",
verbose_name=_("–ü–ª–∞—Ç–µ–ª—å—â–∏–∫"),
)
provider = models.CharField(
_("–ü—Ä–æ–≤–∞–π–¥–µ—Ä"),
max_length=32,
choices=Provider.choices,
default=Provider.YOOKASSA,
)
provider_payment_id = models.CharField(
_("ID –ø–ª–∞—Ç–µ–∂–∞ —É –ø—Ä–æ–≤–∞–π–¥–µ—Ä–∞"),
max_length=128,
blank=True,
db_index=True,
)
amount = models.DecimalField(
_("–°—É–º–º–∞"),
max_digits=10,
decimal_places=2,
)
currency = models.CharField(
_("–í–∞–ª—é—Ç–∞"),
max_length=8,
default="RUB",
)
status = models.CharField(
_("–°—Ç–∞—Ç—É—Å"),
max_length=16,
choices=Status.choices,
default=Status.CREATED,
db_index=True,
)
success = models.BooleanField(_("–£—Å–ø–µ—à–µ–Ω"), default=False)
failure = models.BooleanField(_("–û—à–∏–±–∫–∞"), default=False)
raw_response = models.JSONField(
_("–û—Ç–≤–µ—Ç –ø—Ä–æ–≤–∞–π–¥–µ—Ä–∞"),
null=True,
blank=True,
help_text=_("–°—ã—Ä—ã–µ –¥–∞–Ω–Ω—ã–µ, –≤–µ—Ä–Ω—É–≤—à–∏–µ—Å—è –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –ø–ª–∞—Ç–µ–∂–∞."),
)
raw_webhook = models.JSONField(
_("–ü–æ—Å–ª–µ–¥–Ω–∏–π webhook"),
null=True,
blank=True,
help_text=_("–ü–æ—Å–ª–µ–¥–Ω–µ–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –ø—Ä–æ–≤–∞–π–¥–µ—Ä–∞ –ø–æ —ç—Ç–æ–º—É –ø–ª–∞—Ç–µ–∂—É."),
)
class Meta:
verbose_name = _("–ü–ª–∞—Ç—ë–∂")
verbose_name_plural = _("–ü–ª–∞—Ç–µ–∂–∏")
ordering = ("-created_at",)
def __str__(self) -> str:
return f"Payment
@property
def is_active(self) -> bool:
"""
"–ê–∫—Ç–∏–≤–Ω—ã–π" –ø–ª–∞—Ç—ë–∂ ‚Äî —Ç–æ—Ç, –∫–æ—Ç–æ—Ä—ã–π –µ—â—ë –º–æ–∂–µ—Ç —Å–º–µ–Ω–∏—Ç—å —Å–æ—Å—Ç–æ—è–Ω–∏–µ –Ω–∞ —É—Å–ø–µ—à–Ω–æ–µ.
"""
return self.status in {self.Status.CREATED, self.Status.PENDING}
def _update_status(
self,
status: str,
success: bool,
failure: bool,
webhook_data: Optional[dict[str, Any]] = None,
) -> None:
self.status = status
self.success = success
self.failure = failure
if webhook_data is not None:
self.raw_webhook = webhook_data
self.save(
update_fields=[
"status",
"success",
"failure",
"raw_webhook",
"updated_at",
]
)
def mark_succeeded(self, webhook_data: Optional[dict[str, Any]] = None) -> None:
"""
–ü–æ–º–µ—á–∞–µ—Ç –ø–ª–∞—Ç—ë–∂ –∫–∞–∫ —É—Å–ø–µ—à–Ω—ã–π –∏ –≤—ã–∑—ã–≤–∞–µ—Ç booking.mark_paid(...).
–í—ã–∑—ã–≤–∞–µ—Ç—Å—è –∏–∑ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∞ –≤–µ–±—Ö—É–∫–æ–≤ YooKassa –ø–æ—Å–ª–µ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è
—É—Å–ø–µ—à–Ω–æ–≥–æ –ø–ª–∞—Ç–µ–∂–∞.
"""
self._update_status(
status=self.Status.SUCCEEDED,
success=True,
failure=False,
webhook_data=webhook_data,
)
# –û–±–Ω–æ–≤–ª—è–µ–º —Å–≤—è–∑–∞–Ω–Ω—É—é –±—Ä–æ–Ω—å.
booking = self.booking
if booking:
booking.mark_paid(payment_id=self.provider_payment_id or "")
def mark_failed(self, webhook_data: Optional[dict[str, Any]] = None) -> None:
"""
–ü–æ–º–µ—á–∞–µ—Ç –ø–ª–∞—Ç—ë–∂ –∫–∞–∫ –Ω–µ—É—Å–ø–µ—à–Ω—ã–π (–æ—à–∏–±–∫–∞).
"""
self._update_status(
status=self.Status.FAILED,
success=False,
failure=True,
webhook_data=webhook_data,
)
def mark_cancelled(self, webhook_data: Optional[dict[str, Any]] = None) -> None:
"""
–ü–æ–º–µ—á–∞–µ—Ç –ø–ª–∞—Ç—ë–∂ –∫–∞–∫ –æ—Ç–º–µ–Ω—ë–Ω–Ω—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º –∏–ª–∏ –ø—Ä–æ–≤–∞–π–¥–µ—Ä–æ–º.
"""
self._update_status(
status=self.Status.CANCELLED,
success=False,
failure=True,
webhook_data=webhook_data,
)
class PaymentMethod(TimeStampedModel):
"""
–ü—Ä–∏–≤—è–∑–∞–Ω–Ω—ã–π —Å–ø–æ—Å–æ–± –æ–ø–ª–∞—Ç—ã (–∫–∞—Ä—Ç–∞/–∫–æ—à–µ–ª—ë–∫), –±–µ–∑ —Ö—Ä–∞–Ω–µ–Ω–∏—è PAN.
–î–∞–Ω–Ω—ã–µ –∫–∞—Ä—Ç—ã —Ö—Ä–∞–Ω—è—Ç—Å—è –≤ —Ç–æ–∫–µ–Ω–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω–æ–º –≤–∏–¥–µ —É –ø—Ä–æ–≤–∞–π–¥–µ—Ä–∞ —ç–∫–≤–∞–π—Ä–∏–Ω–≥–∞,
–∑–¥–µ—Å—å –æ—Å—Ç–∞—ë—Ç—Å—è —Ç–æ–ª—å–∫–æ –º–∞—Å–∫–∞ –∏ –º–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ –¥–ª—è UI. –ù–∞—Å—Ç–æ—è—â–∏–π —Ç–æ–∫–µ–Ω
—Ö—Ä–∞–Ω–∏—Ç—Å—è –≤ encrypted –ø–æ–ª–µ token_masked, —á—Ç–æ–±—ã –º–æ–∂–Ω–æ –±—ã–ª–æ –∏–Ω–∏—Ü–∏–∏—Ä–æ–≤–∞—Ç—å
–ø–æ–≤—Ç–æ—Ä–Ω—ã–µ —Å–ø–∏—Å–∞–Ω–∏—è –≤ –±—É–¥—É—â–µ–º.
"""
class Brand(models.TextChoices):
VISA = "visa", "VISA"
MASTERCARD = "mc", "Mastercard"
MIR = "mir", "–ú–∏—Ä"
UNIONPAY = "up", "UnionPay"
OTHER = "other", "–î—Ä—É–≥–∞—è"
user = models.ForeignKey(
settings.AUTH_USER_MODEL,
on_delete=models.CASCADE,
related_name="payment_methods",
verbose_name=_("–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å"),
)
label = models.CharField(
_("–ù–∞–∑–≤–∞–Ω–∏–µ"),
max_length=64,
blank=True,
help_text=_("–ù–∞–ø—Ä–∏–º–µ—Ä: '–õ–∏—á–Ω–∞—è', '–î–ª—è —Ä–∞–±–æ—Ç—ã', '–Æ—Ä–ª–∏—Ü–æ'."),
)
brand = models.CharField(
_("–ë—Ä–µ–Ω–¥"),
max_length=16,
choices=Brand.choices,
default=Brand.OTHER,
)
last4 = models.CharField(_("–ü–æ—Å–ª–µ–¥–Ω–∏–µ 4 —Ü–∏—Ñ—Ä—ã"), max_length=4)
exp_month = models.PositiveSmallIntegerField(_("–ú–µ—Å—è—Ü –æ–∫–æ–Ω—á–∞–Ω–∏—è"))
exp_year = models.PositiveSmallIntegerField(_("–ì–æ–¥ –æ–∫–æ–Ω—á–∞–Ω–∏—è"))
is_default = models.BooleanField(_("–ü–æ —É–º–æ–ª—á–∞–Ω–∏—é"), default=False)
token_masked = models.CharField(
_("–¢–æ–∫–µ–Ω/–º–∞—Å–∫–∞"),
max_length=255,
help_text=_("–°–ª—É–∂–µ–±–Ω—ã–π –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä –ø–ª–∞—Ç—ë–∂–Ω–æ–≥–æ –ø—Ä–æ–≤–∞–π–¥–µ—Ä–∞."),
)
class Meta:
verbose_name = _("–°–ø–æ—Å–æ–± –æ–ø–ª–∞—Ç—ã")
verbose_name_plural = _("–°–ø–æ—Å–æ–±—ã –æ–ø–ª–∞—Ç—ã")
ordering = ("-is_default", "-created_at")
unique_together = ("user", "token_masked")
def __str__(self) -> str:
return f"{self.get_brand_display()} ****{self.last4}"
def save(self, *args, **kwargs):
if self.is_default:
PaymentMethod.objects.filter(user=self.user, is_default=True).exclude(
pk=self.pk
).update(is_default=False)
return super().save(*args, **kwargs)

# File 106/160: payments\providers.py
################################################################################

from __future__ import annotations
import uuid
from decimal import Decimal
from typing import Any, Tuple
from django.conf import settings
from django.core.exceptions import ImproperlyConfigured
try:
# –û—Ñ–∏—Ü–∏–∞–ª—å–Ω—ã–π —Å–∏–Ω—Ö—Ä–æ–Ω–Ω—ã–π SDK YooKassa
from yookassa import Configuration, Payment as YooPayment
except ImportError:
Configuration = None
YooPayment = None
class YooKassaError(Exception):
"""–ë–∞–∑–æ–≤–∞—è –æ—à–∏–±–∫–∞ –ø—Ä–∏ —Ä–∞–±–æ—Ç–µ —Å YooKassa."""
def _configure_yookassa() -> None:
"""
–ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ—Ç SDK YooKassa –∏–∑ Django settings.
–¢—Ä–µ–±—É—é—Ç—Å—è:
- YOOKASSA_SHOP_ID
- YOOKASSA_SECRET_KEY
"""
if Configuration is None or YooPayment is None:
raise ImproperlyConfigured(
"–ü–∞–∫–µ—Ç 'yookassa' –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω. –î–æ–±–∞–≤—å—Ç–µ –µ–≥–æ –≤ requirements.txt."
)
shop_id = getattr(settings, "YOOKASSA_SHOP_ID", "")
secret_key = getattr(settings, "YOOKASSA_SECRET_KEY", "")
if not shop_id or not secret_key:
raise ImproperlyConfigured(
"–ù–µ –∑–∞–¥–∞–Ω—ã YOOKASSA_SHOP_ID –∏/–∏–ª–∏ YOOKASSA_SECRET_KEY –≤ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞—Ö."
)
Configuration.account_id = shop_id
Configuration.secret_key = secret_key
def create_yookassa_payment(booking) -> Tuple[str, str, dict[str, Any]]:
"""
–°–æ–∑–¥–∞—ë—Ç –ø–ª–∞—Ç—ë–∂ –≤ YooKassa –¥–ª—è —É–∫–∞–∑–∞–Ω–Ω–æ–π –±—Ä–æ–Ω–∏.
–í–æ–∑–≤—Ä–∞—â–∞–µ—Ç:
(payment_url, provider_payment_id, raw_response_dict)
–í—Å–µ —Å–µ—Ç–µ–≤—ã–µ –≤—ã–∑–æ–≤—ã –∏–Ω–∫–∞–ø—Å—É–ª–∏—Ä–æ–≤–∞–Ω—ã –∑–¥–µ—Å—å.
"""
_configure_yookassa()
from parking.models import Booking
if not isinstance(booking, Booking):
raise YooKassaError("create_yookassa_payment –æ–∂–∏–¥–∞–µ—Ç —ç–∫–∑–µ–º–ø–ª—è—Ä Booking.")
amount = booking.total_price
if not isinstance(amount, Decimal):
amount = Decimal(str(amount))
amount_str = str(amount.quantize(Decimal("0.01")))
currency = booking.currency or "RUB"
return_url = getattr(settings, "YOOKASSA_RETURN_URL", "")
description = f"–û–ø–ª–∞—Ç–∞ –±—Ä–æ–Ω–∏
payload: dict[str, Any] = {
"amount": {
"value": amount_str,
"currency": currency,
},
"confirmation": {
"type": "redirect",
"return_url": return_url,
},
"capture": True,
"description": description,
"metadata": {
"booking_id": str(booking.id),
"user_id": str(booking.user_id),
},
}
try:
payment = YooPayment.create(payload, uuid.uuid4())
except Exception as exc:
raise YooKassaError(str(exc)) from exc
confirmation = getattr(payment, "confirmation", None)
payment_url = getattr(confirmation, "confirmation_url", None) if confirmation else None
provider_payment_id = getattr(payment, "id", None)
if not payment_url or not provider_payment_id:
raise YooKassaError(
"–ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π –æ—Ç–≤–µ—Ç –æ—Ç YooKassa: –Ω–µ –ø–æ–ª—É—á–µ–Ω—ã id –∏–ª–∏ URL –æ–ø–ª–∞—Ç—ã."
)
raw_response = {
"id": provider_payment_id,
"status": getattr(payment, "status", None),
}
return payment_url, provider_payment_id, raw_response

# File 107/160: payments\serializers.py
################################################################################

# payments/serializers.py
from __future__ import annotations
from typing import Any, Dict
from django.conf import settings
from django.urls import reverse
from rest_framework import serializers
from parking.models import Booking
from .models import Payment, PaymentMethod
from .providers import get_payment_provider
class PaymentSerializer(serializers.ModelSerializer):
"""
–°–æ–∑–¥–∞–Ω–∏–µ –ø–ª–∞—Ç–µ–∂–∞ –¥–ª—è –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è.
–ü–æ—Ç–æ–∫:
- –∫–ª–∏–µ–Ω—Ç –≤—ã–∑—ã–≤–∞–µ—Ç POST /api/payments/ —Å booking_id;
- —Å–µ—Ä–∏–∞–ª–∏–∑–∞—Ç–æ—Ä –ø–æ–¥–Ω–∏–º–∞–µ—Ç Booking, –≤—ã–∑—ã–≤–∞–µ—Ç AI-—Ü–µ–Ω–æ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏–µ (–µ—Å–ª–∏ –Ω—É–∂–Ω–æ ‚Äì —É–∂–µ
—Å–¥–µ–ª–∞–Ω–æ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –±—Ä–æ–Ω–∏), –±–µ—Ä—ë—Ç –∏—Ç–æ–≥–æ–≤—É—é —Å—É–º–º—É;
- –≤—ã–±–∏—Ä–∞–µ—Ç –ø—Ä–æ–≤–∞–π–¥–µ—Ä–∞ –ø–æ REGION/PLATFORM (YooKassa –¥–ª—è RU, Stripe –¥–ª—è GLOBAL);
- —Å–æ–∑–¥–∞—ë—Ç payment –≤ –ë–î –∏ —É –ø—Ä–æ–≤–∞–π–¥–µ—Ä–∞;
- –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –∫–ª–∏–µ–Ω—Ç—É payment_url, –ø–æ –∫–æ—Ç–æ—Ä–æ–º—É –º–æ–∂–Ω–æ —É–π—Ç–∏ –Ω–∞ –æ–ø–ª–∞—Ç—É.
–í–∞–∂–Ω–æ: –±–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫–∞ —Ä–∞—Å—á—ë—Ç–∞ —Ü–µ–Ω—ã (–≤–∫–ª—é—á–∞—è AI) –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –≤ booking/ai,
–∑–¥–µ—Å—å —Ç–æ–ª—å–∫–æ –æ—Ä–∫–µ—Å—Ç—Ä–∞—Ü–∏—è –∏ –∞–¥–∞–ø—Ç–µ—Ä—ã –∫ –ø–ª–∞—Ç—ë–∂–Ω—ã–º –ø—Ä–æ–≤–∞–π–¥–µ—Ä–∞–º.
"""
booking_id = serializers.UUIDField(write_only=True)
payment_url = serializers.SerializerMethodField(read_only=True)
class Meta:
model = Payment
fields = (
"id",
"booking_id",
"amount",
"currency",
"status",
"provider",
"provider_payment_id",
"created_at",
"updated_at",
"payment_url",
)
read_only_fields = (
"id",
"amount",
"currency",
"status",
"provider",
"provider_payment_id",
"created_at",
"updated_at",
"payment_url",
)
def validate_booking_id(self, value):
try:
booking = Booking.objects.select_related("spot", "spot__lot").get(pk=value)
except Booking.DoesNotExist:
raise serializers.ValidationError("–ë—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ.")
if booking.status not in (
Booking.Status.PENDING,
Booking.Status.CONFIRMED,
):
raise serializers.ValidationError(
"–ü–ª–∞—Ç—ë–∂ –º–æ–∂–Ω–æ —Å–æ–∑–¥–∞—Ç—å —Ç–æ–ª—å–∫–æ –¥–ª—è –æ–∂–∏–¥–∞—é—â–µ–≥–æ/–ø–æ–¥—Ç–≤–µ—Ä–∂–¥—ë–Ω–Ω–æ–≥–æ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è."
)
return value
def _get_booking(self, booking_id) -> Booking:
return Booking.objects.select_related("spot", "spot__lot").get(pk=booking_id)
def create(self, validated_data: Dict[str, Any]) -> Payment:
request = self.context.get("request")
booking_id = validated_data["booking_id"]
booking = self._get_booking(booking_id)
# –°—É–º–º–∞ –¥–ª—è –æ–ø–ª–∞—Ç—ã ‚Äì –∏—Ç–æ–≥–æ–≤–∞—è —Ü–µ–Ω–∞ –±—Ä–æ–Ω–∏ (—É–∂–µ —Å AI-—Ü–µ–Ω–æ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏–µ–º, –µ—Å–ª–∏ –ø—Ä–∏–º–µ–Ω–µ–Ω–æ)
amount = booking.total_price
currency = getattr(settings, "DEFAULT_CURRENCY", "RUB")
# –í—ã–±–æ—Ä –ø—Ä–æ–≤–∞–π–¥–µ—Ä–∞:
#   - –¥–ª—è RU –ø—Ä–æ—Ñ–∏–ª—å –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é –±—É–¥–µ—Ç YooKassa (—Å–º. .env/.env.prod);
#   - –¥–ª—è GLOBAL –º–æ–∂–Ω–æ –≤—ã—Å—Ç–∞–≤–∏—Ç—å stripe –≤ PAYMENT_PROVIDER/DEFAULT_PAYMENT_PROVIDER.
provider = get_payment_provider()
payment = Payment.objects.create(
booking=booking,
amount=amount,
currency=currency,
provider=provider.code,
status=Payment.Status.CREATED,
)
# URL –≤–æ–∑–≤—Ä–∞—Ç–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –ø–æ—Å–ª–µ –æ–ø–ª–∞—Ç—ã
if request is not None:
return_url = request.build_absolute_uri(
reverse("payments:return")
)
webhook_url = request.build_absolute_uri(
reverse("payments:webhook", kwargs={"provider": provider.code})
)
else:
# fallback –¥–ª—è –≤–Ω—É—Ç—Ä–µ–Ω–Ω–∏—Ö –≤—ã–∑–æ–≤–æ–≤/—Ç–µ—Å—Ç–æ–≤
return_url = getattr(settings, "YOOKASSA_RETURN_URL", "/")
webhook_url = ""
# –í—ã–∑–æ–≤ –ø—Ä–æ–≤–∞–π–¥–µ—Ä–∞ (–∞–¥–∞–ø—Ç–µ—Ä)
provider_response = provider.create_payment(
payment=payment,
return_url=return_url,
webhook_url=webhook_url,
)
# –û–∂–∏–¥–∞–µ–º, —á—Ç–æ –∞–¥–∞–ø—Ç–µ—Ä –≤–µ—Ä–Ω—ë—Ç —Å—Ç—Ä—É–∫—Ç—É—Ä—É —Å provider_payment_id –∏
# –æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–º –ø–æ–ª–µ–º payment_url/confirmation_url.
payment.provider_payment_id = provider_response.get("id") or provider_response.get(
"provider_payment_id", ""
)
payment.raw_response = provider_response
payment.save(update_fields=["provider_payment_id", "raw_response"])
return payment
def get_payment_url(self, obj: Payment) -> str | None:
"""
–í—ã—Ç–∞—Å–∫–∏–≤–∞–µ–º URL –¥–ª—è —Ä–µ–¥–∏—Ä–µ–∫—Ç–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏–∑ raw_response.
–î–ª—è YooKassa —ç—Ç–æ –æ–±—ã—á–Ω–æ confirmation.redirect_url,
–¥–ª—è Stripe ‚Äì session.url –∏ —Ç.–ø.
"""
data = obj.raw_response or {}
# –û–±—â–∏–π –ø–æ–¥—Ö–æ–¥: –ø—ã—Ç–∞–µ–º—Å—è –Ω–∞–π—Ç–∏ –Ω–∞–∏–±–æ–ª–µ–µ –æ—á–µ–≤–∏–¥–Ω—ã–µ –ø–æ–ª—è
return (
data.get("payment_url")
or data.get("confirmation_url")
or (data.get("confirmation") or {}).get("confirmation_url")
or (data.get("session") or {}).get("url")
)
class PaymentMethodSerializer(serializers.ModelSerializer):
"""–°–µ—Ä–∏–∞–ª–∏–∑–∞—Ç–æ—Ä –¥–ª—è —Å–æ—Ö—Ä–∞–Ω—ë–Ω–Ω—ã—Ö –∫–∞—Ä—Ç/–∫–æ—à–µ–ª—å–∫–æ–≤."""
mask = serializers.SerializerMethodField(read_only=True)
class Meta:
model = PaymentMethod
fields = (
"id",
"label",
"brand",
"last4",
"exp_month",
"exp_year",
"is_default",
"token_masked",
"mask",
"created_at",
)
read_only_fields = ("id", "mask", "created_at")
def get_mask(self, obj: PaymentMethod) -> str:
return f"**** **** **** {obj.last4}"
def create(self, validated_data):
request = self.context.get("request")
if request and request.user.is_authenticated:
validated_data["user"] = request.user
return super().create(validated_data)

# File 108/160: payments\tasks.py
################################################################################

from __future__ import annotations
from celery import shared_task
from .models import Payment
@shared_task
def check_stale_payments() -> str:
"""
–ó–∞–≥–æ—Ç–æ–≤–∫–∞ —Ñ–æ–Ω–æ–≤–æ–π –∑–∞–¥–∞—á–∏ –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ "–∑–∞–≤–∏—Å—à–∏—Ö" –ø–ª–∞—Ç–µ–∂–µ–π.
–í –±—É–¥—É—â–µ–π –≤–µ—Ä—Å–∏–∏ –∑–¥–µ—Å—å –º–æ–∂–Ω–æ —Ä–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å:
- –ø–æ–∏—Å–∫ –ø–ª–∞—Ç–µ–∂–µ–π –≤ —Å—Ç–∞—Ç—É—Å–µ PENDING —Å–ª–∏—à–∫–æ–º –¥–æ–ª–≥–æ;
- –∑–∞–ø—Ä–æ—Å –∏—Ö —Ñ–∞–∫—Ç–∏—á–µ—Å–∫–æ–≥–æ —Å–æ—Å—Ç–æ—è–Ω–∏—è —É YooKassa;
- –ø–µ—Ä–µ–≤–æ–¥ –≤ FAILED/CANCELLED –ø—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏.
"""
pending_count = Payment.objects.filter(status=Payment.Status.PENDING).count()
return f"Pending payments count: {pending_count}"

# File 109/160: payments\views.py
################################################################################

from __future__ import annotations
from django.conf import settings
from rest_framework import mixins, permissions, status, viewsets
from rest_framework.response import Response
from rest_framework.views import APIView
from .models import Payment, PaymentMethod
from .serializers import PaymentMethodSerializer, PaymentSerializer
from .providers.registry import get_payment_provider
class PaymentViewSet(
mixins.CreateModelMixin,
mixins.ListModelMixin,
mixins.RetrieveModelMixin,
viewsets.GenericViewSet,
):
"""
API –ø–ª–∞—Ç–µ–∂–µ–π:
- GET  /api/payments/       ‚Äî —Å–ø–∏—Å–æ–∫ –ø–ª–∞—Ç–µ–∂–µ–π —Ç–µ–∫—É—â–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è;
- POST /api/payments/       ‚Äî –Ω–∞—á–∞—Ç—å –æ–ø–ª–∞—Ç—É –¥–ª—è –±—Ä–æ–Ω–∏;
- GET  /api/payments/{id}/  ‚Äî –¥–µ—Ç–∞–ª–∏ –ø–ª–∞—Ç–µ–∂–∞.
–¢–æ–ª—å–∫–æ –≤–ª–∞–¥–µ–ª–µ—Ü –ø–ª–∞—Ç–µ–∂–∞ –≤–∏–¥–∏—Ç —Å–≤–æ–∏ –ø–ª–∞—Ç–µ–∂–∏; –∞–¥–º–∏–Ω ‚Äî –≤—Å–µ.
"""
serializer_class = PaymentSerializer
permission_classes = [permissions.IsAuthenticated]
def get_queryset(self):
user = self.request.user
qs = Payment.objects.select_related(
"booking",
"booking__spot",
"booking__spot__lot",
"payer",
)
if not user.is_authenticated:
return Payment.objects.none()
if user.is_superuser:
return qs
return qs.filter(payer=user)
def perform_create(self, serializer: PaymentSerializer) -> None:
serializer.save()
class PaymentMethodViewSet(
mixins.CreateModelMixin,
mixins.ListModelMixin,
mixins.UpdateModelMixin,
mixins.DestroyModelMixin,
viewsets.GenericViewSet,
):
"""
–ú–∏–Ω–∏-API –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Å–æ—Ö—Ä–∞–Ω—ë–Ω–Ω—ã–º–∏ –∫–∞—Ä—Ç–∞–º–∏ –≤ –õ–ö.
POST /api/payment-methods/ ‚Äî –¥–æ–±–∞–≤–∏—Ç—å –∫–∞—Ä—Ç—É (–ø–æ–∫–∞ –±–µ–∑ —Ä–µ–∞–ª—å–Ω–æ–≥–æ —Ç–æ–∫–µ–Ω–∏–∑–∞—Ü–∏–∏);
GET  /api/payment-methods/ ‚Äî —Å–ø–∏—Å–æ–∫ –∫–∞—Ä—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è;
DELETE /api/payment-methods/{id}/ ‚Äî —É–¥–∞–ª–∏—Ç—å –∫–∞—Ä—Ç—É.
"""
serializer_class = PaymentMethodSerializer
permission_classes = [permissions.IsAuthenticated]
def get_queryset(self):
user = self.request.user
if not user.is_authenticated:
return PaymentMethod.objects.none()
if user.is_superuser:
return PaymentMethod.objects.select_related("user").order_by("-is_default", "-created_at")
return PaymentMethod.objects.filter(user=user).order_by("-is_default", "-created_at")
def perform_create(self, serializer: PaymentMethodSerializer) -> None:
serializer.save(user=self.request.user)
def perform_update(self, serializer: PaymentMethodSerializer) -> None:
serializer.save(user=self.request.user)
class YooKassaWebhookView(APIView):
"""
–û–±—Ä–∞–±–æ—Ç—á–∏–∫ webhook‚Äë—É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π YooKassa.
URL: /payments/webhook/yookassa/  (—Å–º. backend.config.urls)
–û–∂–∏–¥–∞–µ—Ç—Å—è JSON –≤–∏–¥–∞:
{
"event": "payment.succeeded",
"object": {
"id": "...",
"status": "succeeded",
...
}
}
–ü–æ–¥–ø–∏—Å—å/—Å–µ–∫—Ä–µ—Ç –ø—Ä–æ–≤–µ—Ä—è–µ—Ç—Å—è –ø–æ –∑–∞–≥–æ–ª–æ–≤–∫—É X-Yookassa-Signature
(–∏–ª–∏ X-Yookassa-Webhook-Secret), –∫–æ—Ç–æ—Ä—ã–π —Å–æ–≤–ø–∞–¥–∞–µ—Ç —Å
settings.YOOKASSA_WEBHOOK_SECRET. –ï—Å–ª–∏ —Å–µ–∫—Ä–µ—Ç –Ω–µ –∑–∞–¥–∞–Ω, –ø—Ä–æ–≤–µ—Ä–∫–∞
–ø–æ–¥–ø–∏—Å–∏ –ø—Ä–æ–ø—É—Å–∫–∞–µ—Ç—Å—è.
"""
authentication_classes: list = []
permission_classes = [permissions.AllowAny]
def post(self, request, *args, **kwargs):
secret_expected = getattr(settings, "YOOKASSA_WEBHOOK_SECRET", "")
if secret_expected:
signature = (
request.headers.get("X-Yookassa-Signature")
or request.headers.get("X-Yookassa-Webhook-Secret")
)
if not signature or signature != secret_expected:
return Response(
{"detail": "Invalid webhook signature"},
status=status.HTTP_403_FORBIDDEN,
)
data = request.data or {}
event = data.get("event")
obj = data.get("object") or {}
provider_payment_id = obj.get("id")
if not provider_payment_id:
return Response(
{"detail": "Missing payment id"},
status=status.HTTP_400_BAD_REQUEST,
)
try:
payment = Payment.objects.select_related("booking").get(
provider_payment_id=provider_payment_id
)
except Payment.DoesNotExist:
return Response(
{"detail": "Payment not found"},
status=status.HTTP_404_NOT_FOUND,
)
status_from_provider = obj.get("status")
payment.raw_webhook = data
if status_from_provider == "succeeded" or event == "payment.succeeded":
payment.mark_succeeded(webhook_data=data)
elif status_from_provider in ("canceled", "cancelled") or event == "payment.canceled":
payment.mark_cancelled(webhook_data=data)
else:
# –õ—é–±—ã–µ –ø—Ä–æ–º–µ–∂—É—Ç–æ—á–Ω—ã–µ —Å—Ç–∞—Ç—É—Å—ã —Å—á–∏—Ç–∞–µ–º –æ–∂–∏–¥–∞—é—â–∏–º–∏
payment.status = Payment.Status.PENDING
payment.success = False
payment.failure = False
payment.save(
update_fields=["status", "success", "failure", "raw_webhook", "updated_at"]
)
return Response({"detail": "ok"}, status=status.HTTP_200_OK)
class StripeWebhookView(APIView):
"""–ü—Ä–æ—Å—Ç–æ–π webhook Stripe (stub)."""
authentication_classes: list = []
permission_classes = [permissions.AllowAny]
def post(self, request, *args, **kwargs):
provider = get_payment_provider("stripe")
payment = provider.handle_webhook(request)
if not payment:
return Response({"detail": "Payment not found"}, status=status.HTTP_404_NOT_FOUND)
return Response({"detail": "ok"}, status=status.HTTP_200_OK)

# File 110/160: payments\migrations\0001_initial.py
################################################################################

# Generated by Django 5.2.8 on 2025-11-21 21:34
import django.db.models.deletion
from django.conf import settings
from django.db import migrations, models
class Migration(migrations.Migration):
initial = True
dependencies = [
('parking', '0001_initial'),
migrations.swappable_dependency(settings.AUTH_USER_MODEL),
]
operations = [
migrations.CreateModel(
name='Payment',
fields=[
('id', models.BigAutoField(auto_created=True, primary_key=True, serialize=False, verbose_name='ID')),
('created_at', models.DateTimeField(auto_now_add=True, verbose_name='–î–∞—Ç–∞ —Å–æ–∑–¥–∞–Ω–∏—è')),
('updated_at', models.DateTimeField(auto_now=True, verbose_name='–î–∞—Ç–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è')),
('provider', models.CharField(choices=[('yookassa', 'YooKassa')], default='yookassa', max_length=32, verbose_name='–ü—Ä–æ–≤–∞–π–¥–µ—Ä')),
('provider_payment_id', models.CharField(blank=True, db_index=True, max_length=128, verbose_name='ID –ø–ª–∞—Ç–µ–∂–∞ —É –ø—Ä–æ–≤–∞–π–¥–µ—Ä–∞')),
('amount', models.DecimalField(decimal_places=2, max_digits=10, verbose_name='–°—É–º–º–∞')),
('currency', models.CharField(default='RUB', max_length=8, verbose_name='–í–∞–ª—é—Ç–∞')),
('status', models.CharField(choices=[('created', '–°–æ–∑–¥–∞–Ω'), ('pending', '–û–∂–∏–¥–∞–µ—Ç –æ–ø–ª–∞—Ç—ã'), ('succeeded', '–£—Å–ø–µ—à–µ–Ω'), ('cancelled', '–û—Ç–º–µ–Ω—ë–Ω'), ('failed', '–û—à–∏–±–∫–∞')], db_index=True, default='created', max_length=16, verbose_name='–°—Ç–∞—Ç—É—Å')),
('success', models.BooleanField(default=False, verbose_name='–£—Å–ø–µ—à–µ–Ω')),
('failure', models.BooleanField(default=False, verbose_name='–û—à–∏–±–∫–∞')),
('raw_response', models.JSONField(blank=True, help_text='–°—ã—Ä—ã–µ –¥–∞–Ω–Ω—ã–µ, –≤–µ—Ä–Ω—É–≤—à–∏–µ—Å—è –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –ø–ª–∞—Ç–µ–∂–∞.', null=True, verbose_name='–û—Ç–≤–µ—Ç –ø—Ä–æ–≤–∞–π–¥–µ—Ä–∞')),
('raw_webhook', models.JSONField(blank=True, help_text='–ü–æ—Å–ª–µ–¥–Ω–µ–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –ø—Ä–æ–≤–∞–π–¥–µ—Ä–∞ –ø–æ —ç—Ç–æ–º—É –ø–ª–∞—Ç–µ–∂—É.', null=True, verbose_name='–ü–æ—Å–ª–µ–¥–Ω–∏–π webhook')),
('booking', models.OneToOneField(on_delete=django.db.models.deletion.CASCADE, related_name='payment', to='parking.booking', verbose_name='–ë—Ä–æ–Ω—å')),
('payer', models.ForeignKey(on_delete=django.db.models.deletion.CASCADE, related_name='payments', to=settings.AUTH_USER_MODEL, verbose_name='–ü–ª–∞—Ç–µ–ª—å—â–∏–∫')),
],
options={
'verbose_name': '–ü–ª–∞—Ç—ë–∂',
'verbose_name_plural': '–ü–ª–∞—Ç–µ–∂–∏',
'ordering': ('-created_at',),
},
),
]

# File 111/160: payments\migrations\0002_alter_payment_provider.py
################################################################################

# Generated by Django 5.2.8 on 2025-11-23 12:00
from django.db import migrations, models
class Migration(migrations.Migration):
dependencies = [
('payments', '0001_initial'),
]
operations = [
migrations.AlterField(
model_name='payment',
name='provider',
field=models.CharField(choices=[('yookassa', 'YooKassa'), ('stripe', 'Stripe')], default='yookassa', max_length=32, verbose_name='–ü—Ä–æ–≤–∞–π–¥–µ—Ä'),
),
]

# File 112/160: payments\migrations\0003_paymentmethod.py
################################################################################

from django.conf import settings
from django.db import migrations, models
import django.db.models.deletion
class Migration(migrations.Migration):
dependencies = [
('payments', '0002_alter_payment_provider'),
migrations.swappable_dependency(settings.AUTH_USER_MODEL),
]
operations = [
migrations.CreateModel(
name='PaymentMethod',
fields=[
('id', models.BigAutoField(auto_created=True, primary_key=True, serialize=False, verbose_name='ID')),
('created_at', models.DateTimeField(auto_now_add=True, verbose_name='–î–∞—Ç–∞ —Å–æ–∑–¥–∞–Ω–∏—è')),
('updated_at', models.DateTimeField(auto_now=True, verbose_name='–î–∞—Ç–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è')),
('label', models.CharField(blank=True, help_text="–ù–∞–ø—Ä–∏–º–µ—Ä: '–õ–∏—á–Ω–∞—è', '–î–ª—è —Ä–∞–±–æ—Ç—ã', '–Æ—Ä–ª–∏—Ü–æ'.", max_length=64, verbose_name='–ù–∞–∑–≤–∞–Ω–∏–µ')),
('brand', models.CharField(choices=[('visa', 'VISA'), ('mc', 'Mastercard'), ('mir', '–ú–∏—Ä'), ('up', 'UnionPay'), ('other', '–î—Ä—É–≥–∞—è')], default='other', max_length=16, verbose_name='–ë—Ä–µ–Ω–¥')),
('last4', models.CharField(max_length=4, verbose_name='–ü–æ—Å–ª–µ–¥–Ω–∏–µ 4 —Ü–∏—Ñ—Ä—ã')),
('exp_month', models.PositiveSmallIntegerField(verbose_name='–ú–µ—Å—è—Ü –æ–∫–æ–Ω—á–∞–Ω–∏—è')),
('exp_year', models.PositiveSmallIntegerField(verbose_name='–ì–æ–¥ –æ–∫–æ–Ω—á–∞–Ω–∏—è')),
('is_default', models.BooleanField(default=False, verbose_name='–ü–æ —É–º–æ–ª—á–∞–Ω–∏—é')),
('token_masked', models.CharField(help_text='–°–ª—É–∂–µ–±–Ω—ã–π –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä –ø–ª–∞—Ç—ë–∂–Ω–æ–≥–æ –ø—Ä–æ–≤–∞–π–¥–µ—Ä–∞.', max_length=255, verbose_name='–¢–æ–∫–µ–Ω/–º–∞—Å–∫–∞')),
('user', models.ForeignKey(on_delete=django.db.models.deletion.CASCADE, related_name='payment_methods', to=settings.AUTH_USER_MODEL, verbose_name='–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å')),
],
options={
'verbose_name': '–°–ø–æ—Å–æ–± –æ–ø–ª–∞—Ç—ã',
'verbose_name_plural': '–°–ø–æ—Å–æ–±—ã –æ–ø–ª–∞—Ç—ã',
'ordering': ('-is_default', '-created_at'),
'unique_together': {('user', 'token_masked')},
},
),
]

# File 113/160: payments\migrations\__init__.py
################################################################################



# File 114/160: payments\providers\__init__.py
################################################################################

# payments/providers/__init__.py
from __future__ import annotations
from typing import Dict, Type
from django.conf import settings
from .base import BasePaymentProvider
from .yookassa import YooKassaProvider
from .stripe import StripeProvider
# –†–µ–µ—Å—Ç—Ä –ø—Ä–æ–≤–∞–π–¥–µ—Ä–æ–≤ –ø–æ –∫–æ–¥—É
_PROVIDER_REGISTRY: Dict[str, Type[BasePaymentProvider]] = {
"yookassa": YooKassaProvider,
"yoomoney": YooKassaProvider,
"stripe": StripeProvider,
# —Å—é–¥–∞ –∂–µ –º–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å Sber, Tinkoff, Mir Pay, QIWI –∏ —Ç.–¥.
}
def get_payment_provider(name: str | None = None) -> BasePaymentProvider:
"""
–í–æ–∑–≤—Ä–∞—â–∞–µ—Ç –∏–Ω—Å—Ç–∞–Ω—Å –ø—Ä–æ–≤–∞–π–¥–µ—Ä–∞ –ø–ª–∞—Ç–µ–∂–µ–π –ø–æ –∏–º–µ–Ω–∏.
name:
- None     -> –±–µ—Ä—ë–º DEFAULT_PAYMENT_PROVIDER / PAYMENT_PROVIDER –∏–∑ –Ω–∞—Å—Ç—Ä–æ–µ–∫
- "yookassa", "stripe" –∏ —Ç.–ø.
–î–ª—è RU-–ø—Ä–æ—Ñ–∏–ª—è –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è YooKassa, –¥–ª—è GLOBAL ‚Äì Stripe,
–Ω–æ —ç—Ç–æ –∑–∞–¥–∞—ë—Ç—Å—è –≤ .env / –Ω–∞—Å—Ç—Ä–æ–π–∫–∞—Ö.
"""
# –°–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å —Å —Ä–∞–∑–Ω—ã–º–∏ –∏–º–µ–Ω–∞–º–∏ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö
configured = getattr(settings, "DEFAULT_PAYMENT_PROVIDER", None) or getattr(
settings, "PAYMENT_PROVIDER", "yookassa"
)
provider_name = (name or configured or "yookassa").lower()
provider_cls = _PROVIDER_REGISTRY.get(provider_name)
if provider_cls is None:
raise ValueError(
f"Unknown payment provider '{provider_name}'. "
f"–î–æ—Å—Ç—É–ø–Ω—ã–µ: {', '.join(sorted(_PROVIDER_REGISTRY.keys()))}"
)
return provider_cls()

# File 115/160: payments\providers\base.py
################################################################################

# payments/providers/base.py
from __future__ import annotations
from abc import ABC, abstractmethod
from typing import Any, Dict, Optional
from ..models import Payment
class BasePaymentProvider(ABC):
"""
–ë–∞–∑–æ–≤—ã–π –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å –ø–ª–∞—Ç—ë–∂–Ω–æ–≥–æ –ø—Ä–æ–≤–∞–π–¥–µ—Ä–∞.
–≠—Ç–æ—Ç –∫–ª–∞—Å—Å ‚Äî –µ–¥–∏–Ω–∞—è —Ç–æ—á–∫–∞ —Ä–∞—Å—à–∏—Ä–µ–Ω–∏—è –¥–ª—è YooKassa, Stripe, –°–±–µ—Ä–∞ –∏ —Ç.–¥.
"""
@abstractmethod
def create_payment(
self,
payment: Payment,
return_url: str,
webhook_url: str,
) -> Dict[str, Any]:
"""
–°–æ–∑–¥–∞—Ç—å –ø–ª–∞—Ç—ë–∂ —É –ø—Ä–æ–≤–∞–π–¥–µ—Ä–∞ –∏ –≤–µ—Ä–Ω—É—Ç—å –µ–≥–æ –¥–∞–Ω–Ω—ã–µ (–≤–∫–ª—é—á–∞—è URL –¥–ª—è –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è/–æ–ø–ª–∞—Ç—ã).
–î–æ–ª–∂–µ–Ω –≤–µ—Ä–Ω—É—Ç—å —Å–ª–æ–≤–∞—Ä—å —Å –ø–æ–ª—è–º–∏ –≤—Ä–æ–¥–µ:
{
"payment_url": "...",
"provider_payment_id": "...",
...
}
"""
raise NotImplementedError
@abstractmethod
def handle_webhook(self, request) -> Optional[Payment]:
"""
–û–±—Ä–∞–±–æ—Ç–∞—Ç—å webhook –æ—Ç –ø—Ä–æ–≤–∞–π–¥–µ—Ä–∞ –∏ –æ–±–Ω–æ–≤–∏—Ç—å Payment/Booking.
–î–æ–ª–∂–µ–Ω:
- –Ω–∞–π—Ç–∏ Payment –ø–æ –¥–∞–Ω–Ω—ã–º –∏–∑ webhook;
- –æ–±–Ω–æ–≤–∏—Ç—å —Å—Ç–∞—Ç—É—Å/—Ñ–ª–∞–≥–∏;
- –≤–µ—Ä–Ω—É—Ç—å –æ–±–Ω–æ–≤–ª—ë–Ω–Ω—ã–π Payment (–∏–ª–∏ None, –µ—Å–ª–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω/–∏–≥–Ω–æ—Ä–∏—Ä—É–µ–º).
"""
raise NotImplementedError
@abstractmethod
def refund(self, payment: Payment, amount: Optional[float] = None) -> None:
"""
–ò–Ω–∏—Ü–∏–∏—Ä–æ–≤–∞—Ç—å –≤–æ–∑–≤—Ä–∞—Ç –ø–æ –ø–ª–∞—Ç–µ–∂—É (–ø–æ–ª–Ω—ã–π –∏–ª–∏ —á–∞—Å—Ç–∏—á–Ω—ã–π).
"""
raise NotImplementedError
# ---------------------------------------------------------
# –û–±—Ä–∞—Ç–Ω–∞—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å:
# —Å—Ç–∞—Ä—ã–π –∫–æ–¥ –º–æ–∂–µ—Ç –∏–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å PaymentProvider –∏–ª–∏ BasePaymentProvider.
# ---------------------------------------------------------
PaymentProvider = BasePaymentProvider

# File 116/160: payments\providers\registry.py
################################################################################

from __future__ import annotations
from typing import Dict, Type
from django.core.exceptions import ImproperlyConfigured
from .base import PaymentProvider
from .stripe import StripeProvider
from .yookassa import YooKassaProvider
REGISTRY: Dict[str, Type[PaymentProvider]] = {
"yookassa": YooKassaProvider,
"stripe": StripeProvider,
}
def get_payment_provider(provider_key: str) -> PaymentProvider:
provider_cls = REGISTRY.get(provider_key)
if not provider_cls:
raise ImproperlyConfigured(f"Unknown payment provider: {provider_key}")
return provider_cls()

# File 117/160: payments\providers\stripe.py
################################################################################

from __future__ import annotations
import uuid
from typing import Any, Dict, Optional
from django.conf import settings
from .base import PaymentProvider
class StripeProvider(PaymentProvider):
key = "stripe"
def create_payment(
self, payment, return_url: str, webhook_url: str
) -> Dict[str, Any]:
"""Stub: —ç–º—É–ª—è—Ü–∏—è Stripe Checkout Session.
–í –±–æ—é –Ω–∞–¥–æ –ø–æ–¥–∫–ª—é—á–∏—Ç—å stripe SDK –∏ —Å–æ–∑–¥–∞—Ç—å Checkout Session —Å
success/cancel URL. –ó–¥–µ—Å—å —Ñ–æ—Ä–º–∏—Ä—É–µ—Ç—Å—è –ø—Ä–µ–¥—Å–∫–∞–∑—É–µ–º–∞—è —Å—Å—ã–ª–∫–∞.
"""
session_id = str(uuid.uuid4())
confirmation_url = f"https:
return {
"payment_url": confirmation_url,
"provider_payment_id": session_id,
"raw": {
"mode": "payment",
"return_url": return_url,
"webhook": webhook_url,
},
}
def handle_webhook(self, request) -> Optional["Payment"]:
from payments.models import Payment
payload = request.data or {}
event_type = payload.get("type")
data_object = payload.get("data", {}).get("object", {})
provider_payment_id = data_object.get("id")
if not provider_payment_id:
return None
try:
payment = Payment.objects.select_related("booking").get(
provider_payment_id=provider_payment_id
)
except Payment.DoesNotExist:
return None
if event_type == "checkout.session.completed":
payment.mark_succeeded(webhook_data=payload)
elif event_type == "payment_intent.payment_failed":
payment.mark_failed(webhook_data=payload)
return payment
def refund(self, payment, amount: Optional[float] = None) -> None:
# –ó–∞–≥–ª—É—à–∫–∞ ‚Äî Stripe refund —á–µ—Ä–µ–∑ SDK
return None

# File 118/160: payments\providers\yookassa.py
################################################################################

from __future__ import annotations
from __future__ import annotations
import uuid
from decimal import Decimal
from typing import Any, Dict, Optional
from django.conf import settings
from django.core.exceptions import ImproperlyConfigured
from .base import PaymentProvider
try:
from yookassa import Configuration, Payment as YooPayment
except ImportError:
Configuration = None
YooPayment = None
class YooKassaError(Exception):
"""–ë–∞–∑–æ–≤–∞—è –æ—à–∏–±–∫–∞ –ø—Ä–∏ —Ä–∞–±–æ—Ç–µ —Å YooKassa."""
class YooKassaProvider(PaymentProvider):
key = "yookassa"
def _configure(self) -> None:
if Configuration is None or YooPayment is None:
raise ImproperlyConfigured(
"–ü–∞–∫–µ—Ç 'yookassa' –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω. –î–æ–±–∞–≤—å—Ç–µ –µ–≥–æ –≤ requirements.txt."
)
shop_id = getattr(settings, "YOOKASSA_SHOP_ID", "")
secret_key = getattr(settings, "YOOKASSA_SECRET_KEY", "")
if not shop_id or not secret_key:
raise ImproperlyConfigured(
"–ù–µ –∑–∞–¥–∞–Ω—ã YOOKASSA_SHOP_ID –∏/–∏–ª–∏ YOOKASSA_SECRET_KEY –≤ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞—Ö."
)
Configuration.account_id = shop_id
Configuration.secret_key = secret_key
def create_payment(
self, payment, return_url: str, webhook_url: str
) -> Dict[str, Any]:
self._configure()
from parking.models import Booking
booking: Booking = payment.booking
amount = booking.total_price
if not isinstance(amount, Decimal):
amount = Decimal(str(amount))
amount_str = str(amount.quantize(Decimal("0.01")))
currency = booking.currency or "RUB"
description = f"–û–ø–ª–∞—Ç–∞ –±—Ä–æ–Ω–∏
payload: dict[str, Any] = {
"amount": {
"value": amount_str,
"currency": currency,
},
"confirmation": {
"type": "redirect",
"return_url": return_url,
},
"capture": True,
"description": description,
"metadata": {
"booking_id": str(booking.id),
"user_id": str(booking.user_id),
"webhook": webhook_url,
},
}
try:
provider_payment = YooPayment.create(payload, uuid.uuid4())
except Exception as exc:
raise YooKassaError(str(exc)) from exc
confirmation = getattr(provider_payment, "confirmation", None)
payment_url = (
getattr(confirmation, "confirmation_url", None) if confirmation else None
)
provider_payment_id = getattr(provider_payment, "id", None)
if not payment_url or not provider_payment_id:
raise YooKassaError(
"–ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π –æ—Ç–≤–µ—Ç –æ—Ç YooKassa: –Ω–µ –ø–æ–ª—É—á–µ–Ω—ã id –∏–ª–∏ URL –æ–ø–ª–∞—Ç—ã."
)
raw_response = {
"id": provider_payment_id,
"status": getattr(provider_payment, "status", None),
}
return {
"payment_url": payment_url,
"provider_payment_id": provider_payment_id,
"raw": raw_response,
}
def handle_webhook(self, request) -> Optional[Payment]:
from payments.models import Payment
data = request.data or {}
event = data.get("event")
obj = data.get("object") or {}
provider_payment_id = obj.get("id")
if not provider_payment_id:
return None
try:
payment = Payment.objects.select_related("booking").get(
provider_payment_id=provider_payment_id
)
except Payment.DoesNotExist:
return None
status_from_provider = obj.get("status")
payment.raw_webhook = data
if status_from_provider == "succeeded" or event == "payment.succeeded":
payment.mark_succeeded(webhook_data=data)
elif status_from_provider in ("canceled", "cancelled") or event == "payment.canceled":
payment.mark_cancelled(webhook_data=data)
else:
payment.status = Payment.Status.PENDING
payment.success = False
payment.failure = False
payment.save(
update_fields=["status", "success", "failure", "raw_webhook", "updated_at"]
)
return payment
def refund(self, payment, amount: Optional[float] = None) -> None:
# –ù–µ–ø–æ–ª–Ω–∞—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è –¥–ª—è MVP
raise NotImplementedError("YooKassa refunds are not implemented in this stub.")

# File 119/160: regions\global.yml
################################################################################

# –ë–∞–∑–æ–≤—ã–π –≥–ª–æ–±–∞–ª—å–Ω—ã–π –ø—Ä–æ—Ñ–∏–ª—å ParkShare (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é –¥–ª—è –Ω–µ-RU —Ä–µ–≥–∏–æ–Ω–æ–≤)

id: "global"
name: "ParkShare Global"

locale:
  default_language: "en"
  supported_languages:
    - "en"
    - "ru"

currency:
  default: "EUR"

maps:
  default_provider: "openstreetmap"
  fallback_provider: "none"

payments:
  gateways:
    - "stripe"
    - "paypal"

auth:
  providers:
    - "email-password"


# File 120/160: regions\ru.yml
################################################################################

id: "ru"
name: "ParkShare RU"

locale:
  default_language: "ru"
  supported_languages:
    - "ru"
    - "en"

–∫–∞—Ä—Ç–æ–≥—Ä–∞—Ñ–∏—è:
  –æ—Å–Ω–æ–≤–Ω–æ–π_–ø—Ä–æ–≤–∞–π–¥–µ—Ä: "–Ø–Ω–¥–µ–∫—Å.–ö–∞—Ä—Ç—ã API"
  —Ä–µ–∑–µ—Ä–≤–Ω—ã–π: "2GIS API"

–ø–ª–∞—Ç–µ–∂–Ω—ã–µ_—Å–∏—Å—Ç–µ–º—ã:
  –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ:
    - "–°–±–µ—Ä–±–∞–Ω–∫ –û–Ω–ª–∞–π–Ω"
    - "–¢–∏–Ω—å–∫–æ—Ñ—Ñ"
    - "–ÆMoney"
    - "–ú–∏—Ä Pay"
    - "QIWI"

–∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è:
  - "–ì–æ—Å—É—Å–ª—É–≥–∏ (–ï–°–ò–ê)"
  - "–í–ö ID"
  - "–Ø–Ω–¥–µ–∫—Å ID"
  - "–°–±–µ—Ä ID"
  - "Email/–¢–µ–ª–µ—Ñ–æ–Ω (native)"

pricing:
  currency: "RUB"
  tax_included: true


# File 121/160: services\__init__.py
################################################################################



# File 122/160: services\llm.py
################################################################################

"""Async client helpers for communicating with the LLM microservice."""
from __future__ import annotations
import logging
import os
from typing import Any, Dict, Iterable, List
import httpx
logger = logging.getLogger(__name__)
DEFAULT_TIMEOUT = 8.0
CONNECT_TIMEOUT = 3.0
# –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é –æ–∂–∏–¥–∞–µ–º –ª–æ–∫–∞–ª—å–Ω—ã–π —Å–µ—Ä–≤–∏—Å –Ω–∞ 8002 (—Å–º. README).
# –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é –æ–∂–∏–¥–∞–µ–º –ª–æ–∫–∞–ª—å–Ω—ã–π —Å–µ—Ä–≤–∏—Å –Ω–∞ 8002 (—Å–º. README).
# 1) –≤–Ω—É—Ç—Ä–∏ docker-—Å–µ—Ç–∏: llm_service:8002
# 2) —Å —Ö–æ—Å—Ç–∞: localhost:8002
DEFAULT_LLM_URLS: List[str] = [
"http:
"http:
]
DEFAULT_RETRIES = 2
class LLMClientError(Exception):
"""Raised when the LLM service cannot process the request."""
def _candidate_endpoints() -> Iterable[str]:
"""Return candidate base URLs to try for the LLM service.
Priority: explicit env var, then defaults (llm_service, localhost).
"""
env_url = os.getenv("LLM_SERVICE_URL")
if env_url:
yield env_url.rstrip("/")
for url in DEFAULT_LLM_URLS:
if not env_url or url.rstrip("/") != env_url.rstrip("/"):
yield url.rstrip("/")
async def parse_search_query(query: str) -> Dict[str, Any]:
"""Parse a user parking search query via the LLM microservice.
Args:
query: Raw text query from the user.
Returns:
Structured dict with parking search attributes.
Raises:
LLMClientError: If the request fails or returns non-200 status.
ValueError: If query is empty.
"""
if not query or not query.strip():
raise ValueError("query must be non-empty")
retries = int(os.getenv("LLM_CLIENT_RETRIES", DEFAULT_RETRIES))
timeout_value = float(os.getenv("LLM_CLIENT_TIMEOUT", DEFAULT_TIMEOUT))
timeout = httpx.Timeout(timeout_value, connect=CONNECT_TIMEOUT)
last_error: Exception | None = None
for base_url in _candidate_endpoints():
endpoint = f"{base_url}/api/v1/llm/parse-search-query"
logger.info(
"Calling LLM service",
extra={
"endpoint": endpoint,
"timeout": timeout_value,
"retries": retries,
"query_preview": query[:120],
},
)
try:
async with httpx.AsyncClient(timeout=timeout) as client:
for attempt in range(1, retries + 1):
try:
logger.debug(
"LLM HTTP request",
extra={
"endpoint": endpoint,
"attempt": attempt,
"timeout": timeout_value,
},
)
response = await client.post(endpoint, json={"query": query})
response.raise_for_status()
data = response.json()
logger.debug(
"LLM service response",
extra={"endpoint": endpoint, "attempt": attempt, "response": data},
)
return data
except httpx.TimeoutException as exc:
logger.warning(
"LLM request timeout",
extra={"endpoint": endpoint, "attempt": attempt},
)
last_error = exc
except httpx.HTTPStatusError as exc:
logger.warning(
"LLM service returned HTTP error",
extra={
"status": exc.response.status_code,
"endpoint": endpoint,
"attempt": attempt,
"body": exc.response.text[:500],
},
)
last_error = exc
break
except httpx.RequestError as exc:
logger.warning(
"LLM request error",
extra={"endpoint": endpoint, "attempt": attempt},
exc_info=exc,
)
last_error = exc
# continue retrying this endpoint
except ValueError as exc:
logger.warning(
"LLM service returned invalid JSON",
extra={"endpoint": endpoint, "attempt": attempt},
exc_info=exc,
)
last_error = exc
break
except Exception as exc:
last_error = exc
logger.exception(
"Unexpected LLM client error", extra={"endpoint": endpoint}
)
if last_error:
raise LLMClientError(f"LLM service unreachable: {last_error}") from last_error
raise LLMClientError("LLM service unreachable: no endpoints configured")
async def check_llm_health() -> Dict[str, Any]:
"""Check health endpoints of the LLM service for diagnostics."""
timeout_value = float(os.getenv("LLM_CLIENT_TIMEOUT", DEFAULT_TIMEOUT))
timeout = httpx.Timeout(timeout_value, connect=CONNECT_TIMEOUT)
results: Dict[str, Any] = {"endpoints": []}
for base_url in _candidate_endpoints():
health_url = f"{base_url}/healthz"
try:
async with httpx.AsyncClient(timeout=timeout) as client:
resp = await client.get(health_url)
results["endpoints"].append(
{
"url": health_url,
"status": resp.status_code,
"body": resp.json()
if resp.headers.get("content-type", "").startswith(
"application/json"
)
else resp.text,
}
)
if resp.status_code == 200:
results["ok"] = True
results["active_url"] = health_url
return results
except Exception as exc:
logger.warning(
"LLM health check failed", extra={"url": health_url}, exc_info=exc
)
results["endpoints"].append({"url": health_url, "error": str(exc)})
results["ok"] = False
return results

# File 123/160: services\llm_service\Dockerfile
################################################################################

FROM python:3.11-slim

ENV PYTHONDONTWRITEBYTECODE=1 \
    PYTHONUNBUFFERED=1

WORKDIR /app

# –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –¥–ª—è FastAPI –∏ LLM-–∫–ª–∏–µ–Ω—Ç–∞
RUN pip install --no-cache-dir fastapi uvicorn[standard] httpx pydantic

COPY services/llm_service /app

CMD ["uvicorn", "main:app", "--host", "0.0.0.0", "--port", "8002"]


# File 124/160: services\llm_service\main.py
################################################################################

"""
FastAPI –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –¥–ª—è LLM‚Äë—Ä–∞–∑–±–æ—Ä–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏—Ö –∑–∞–ø—Ä–æ—Å–æ–≤ –Ω–∞ –ø–æ–∏—Å–∫ –ø–∞—Ä–∫–æ–≤–∫–∏.
–í–∫–ª—é—á–∞–µ—Ç –∞–±—Å—Ç—Ä–∞–∫—Ç–Ω—ã–π –∫–ª–∏–µ–Ω—Ç LLMClient –∏ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—é –¥–ª—è OpenAI.
"""
from __future__ import annotations
import json
from datetime import datetime
from functools import lru_cache
from typing import Any, Dict, Protocol, runtime_checkable
import httpx
from fastapi import Depends, FastAPI, HTTPException, status
from pydantic import BaseModel, Field, ValidationError
from pydantic_settings import BaseSettings, SettingsConfigDict
class Settings(BaseSettings):
"""–ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è —Å–µ—Ä–≤–∏—Å–∞, —á–∏—Ç–∞–µ–º–∞—è –∏–∑ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è."""
openai_api_key: str = Field(..., env="OPENAI_API_KEY")
openai_base_url: str = Field(
"https:
env="OPENAI_BASE_URL",
)
openai_model: str = Field("gpt-3.5-turbo", env="OPENAI_MODEL")
request_timeout: float = Field(30.0, env="LLM_REQUEST_TIMEOUT")
model_config = SettingsConfigDict(env_file=".env", env_file_encoding="utf-8")
@runtime_checkable
class LLMClient(Protocol):
"""–ü—Ä–æ—Å—Ç–µ–π—à–∏–π –ø—Ä–æ—Ç–æ–∫–æ–ª –¥–ª—è LLM-–∫–ª–∏–µ–Ω—Ç–æ–≤."""
async def parse_search_query(self, system_prompt: str, user_query: str) -> Dict[str, Any]:
"""–ü–æ–ª—É—á–∏—Ç—å —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –ø–æ —Ç–µ–∫—Å—Ç–æ–≤–æ–º—É –∑–∞–ø—Ä–æ—Å—É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è."""
class OpenAILLMClient:
"""LLM-–∫–ª–∏–µ–Ω—Ç –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å OpenAI Chat Completions API."""
def __init__(self, settings: Settings):
self.base_url = settings.openai_base_url.rstrip("/")
self.api_key = settings.openai_api_key
self.model = settings.openai_model
self.timeout = settings.request_timeout
async def parse_search_query(self, system_prompt: str, user_query: str) -> Dict[str, Any]:
payload = {
"model": self.model,
"messages": [
{"role": "system", "content": system_prompt},
{"role": "user", "content": user_query},
],
"response_format": {"type": "json_object"},
"temperature": 0.2,
}
headers = {
"Authorization": f"Bearer {self.api_key}",
"Content-Type": "application/json",
}
url = f"{self.base_url}/chat/completions"
async with httpx.AsyncClient(timeout=self.timeout) as client:
try:
response = await client.post(url, headers=headers, json=payload)
response.raise_for_status()
except httpx.RequestError as exc:
raise HTTPException(
status_code=status.HTTP_502_BAD_GATEWAY,
detail=f"LLM upstream request error: {exc}",
) from exc
except httpx.HTTPStatusError as exc:
raise HTTPException(
status_code=status.HTTP_502_BAD_GATEWAY,
detail=f"LLM upstream error: {exc.response.text}",
) from exc
data = response.json()
try:
content = data["choices"][0]["message"]["content"]
except (KeyError, IndexError, TypeError) as exc:
raise HTTPException(
status_code=status.HTTP_502_BAD_GATEWAY,
detail="Unexpected response format from LLM",
) from exc
try:
return json.loads(content)
except json.JSONDecodeError as exc:
raise HTTPException(
status_code=status.HTTP_502_BAD_GATEWAY,
detail="LLM response is not valid JSON",
) from exc
PARSER_SYSTEM_PROMPT = """
You are an assistant that extracts structured parking search intent for ParkShare.
Return a strict JSON object with the following fields:
- city: string with the city name in nominative case, or null if unknown.
- start_at: ISO 8601 datetime with timezone (offset or Z) when parking should start, or null.
- end_at: ISO 8601 datetime with timezone (offset or Z) when parking should end, or null.
- max_price_per_hour: number (float) with the hourly price ceiling, or null.
- near_metro: boolean, true if the user wants parking near metro/public transit, else false or null.
- has_ev_charging: boolean, true if the user requires EV charging, else false or null.
- covered: boolean, true if the user prefers indoor/covered parking, else false or null.
Rules:
- If the user did not provide a value, set it to null.
- Never invent unavailable dates or cities; prefer null.
- Output only the JSON object without explanations, markdown, or comments.
- Respect the language of the request, but city names should be in nominative form.
Example output:
{"city": "Moscow", "start_at": "2024-02-10T08:00:00+03:00", "end_at": null, "max_price_per_hour": 250.0, "near_metro": true, "has_ev_charging": false, "covered": true}
"""
class SearchQueryRequest(BaseModel):
query: str = Field(..., min_length=1, description="–¢–µ–∫—Å—Ç–æ–≤—ã–π –∑–∞–ø—Ä–æ—Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è")
class SearchQueryResponse(BaseModel):
city: str | None = Field(None, description="–ì–æ—Ä–æ–¥, —É–∫–∞–∑–∞–Ω–Ω—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º")
start_at: datetime | None = Field(
None, description="ISO 8601 –≤—Ä–µ–º—è –Ω–∞—á–∞–ª–∞ –ø–∞—Ä–∫–æ–≤–∫–∏ (–∏–ª–∏ null)"
)
end_at: datetime | None = Field(
None, description="ISO 8601 –≤—Ä–µ–º—è –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –ø–∞—Ä–∫–æ–≤–∫–∏ (–∏–ª–∏ null)"
)
max_price_per_hour: float | None = Field(
None, description="–ú–∞–∫—Å–∏–º–∞–ª—å–Ω–∞—è —Ü–µ–Ω–∞ –≤ —á–∞—Å, –µ—Å–ª–∏ —É–∫–∞–∑–∞–Ω–∞"
)
near_metro: bool | None = Field(
None, description="True, –µ—Å–ª–∏ –Ω—É–∂–Ω–æ —Ä—è–¥–æ–º —Å –º–µ—Ç—Ä–æ/—Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç–æ–º"
)
has_ev_charging: bool | None = Field(
None, description="True, –µ—Å–ª–∏ —Ç—Ä–µ–±—É–µ—Ç—Å—è –∑–∞—Ä—è–¥–∫–∞ –¥–ª—è —ç–ª–µ–∫—Ç—Ä–æ–º–æ–±–∏–ª—è"
)
covered: bool | None = Field(
None, description="True, –µ—Å–ª–∏ —Ç—Ä–µ–±—É–µ—Ç—Å—è –∫—Ä—ã—Ç–∞—è/–ø–æ–¥–∑–µ–º–Ω–∞—è –ø–∞—Ä–∫–æ–≤–∫–∞"
)
@lru_cache
def get_settings() -> Settings:
return Settings()
def get_llm_client(settings: Settings = Depends(get_settings)) -> LLMClient:
return OpenAILLMClient(settings)
app = FastAPI(title="ParkShare LLM Service", version="0.1.0")
@app.get("/healthz", tags=["health"])
async def healthz() -> dict[str, str]:
return {"status": "ok"}
@app.post(
"/api/v1/llm/parse-search-query",
response_model=SearchQueryResponse,
tags=["llm"],
summary="–†–∞—Å–ø–∞—Ä—Å–∏—Ç—å –ø–æ–∏—Å–∫–æ–≤—ã–π –∑–∞–ø—Ä–æ—Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è —á–µ—Ä–µ–∑ LLM",
)
async def parse_search_query(
payload: SearchQueryRequest, client: LLMClient = Depends(get_llm_client)
) -> SearchQueryResponse:
raw_response = await client.parse_search_query(
system_prompt=PARSER_SYSTEM_PROMPT, user_query=payload.query
)
try:
return SearchQueryResponse(**raw_response)
except ValidationError as exc:
raise HTTPException(
status_code=status.HTTP_502_BAD_GATEWAY,
detail="LLM response failed validation",
) from exc
if __name__ == "__main__":
import uvicorn
uvicorn.run(app, host="0.0.0.0", port=8002)

# File 125/160: services\llm_service\requirements.txt
################################################################################

fastapi==0.115.0
uvicorn[standard]==0.32.1
httpx==0.27.2
pydantic==2.12.4
pydantic-settings==2.8.0
python-dotenv==1.2.1


# File 126/160: static\manifest.webmanifest
################################################################################

{
  "name": "ParkShare ‚Äî —É–º–Ω–∞—è –ø–∞—Ä–∫–æ–≤–∫–∞",
  "short_name": "ParkShare",
  "description": "–ü–æ–∏—Å–∫, –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –∏ –æ–ø–ª–∞—Ç–∞ –ø–∞—Ä–∫–æ–≤–æ–∫ —Ä—è–¥–æ–º —Å –≤–∞–º–∏. –†–∞–±–æ—Ç–∞–µ—Ç –∫–∞–∫ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ, –¥–∞–∂–µ –æ—Ñ–ª–∞–π–Ω.",
  "start_url": "/?pwa=true",
  "scope": "/",
  "display": "standalone",
  "orientation": "portrait-primary",
  "background_color": "#020617",
  "theme_color": "#0f172a",
  "icons": [
    {
      "src": "/static/icons/icon-192.png",
      "sizes": "192x192",
      "type": "image/png",
      "purpose": "any"
    },
    {
      "src": "/static/icons/icon-512.png",
      "sizes": "512x512",
      "type": "image/png",
      "purpose": "any"
    },
    {
      "src": "/static/icons/icon-maskable-192.png",
      "sizes": "192x192",
      "type": "image/png",
      "purpose": "maskable"
    },
    {
      "src": "/static/icons/icon-maskable-512.png",
      "sizes": "512x512",
      "type": "image/png",
      "purpose": "maskable"
    }
  ],
  "shortcuts": [
    {
      "name": "–ù–∞–π—Ç–∏ –ø–∞—Ä–∫–æ–≤–∫—É —Ä—è–¥–æ–º",
      "short_name": "–ù–∞–π—Ç–∏ —Ä—è–¥–æ–º",
      "url": "/#search",
      "icons": [
        {
          "src": "/static/icons/shortcut-search.png",
          "sizes": "96x96",
          "type": "image/png"
        }
      ]
    },
    {
      "name": "–ú–æ–∏ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è",
      "short_name": "–ë—Ä–æ–Ω–∏",
      "url": "/dashboard/#bookings"
    }
  ],
  "categories": ["navigation", "productivity", "travel"],
  "lang": "ru-RU"
}


# File 127/160: static\service-worker.js
################################################################################

const CACHE_VERSION = 'v5';
const STATIC_CACHE = `static-${CACHE_VERSION}`;
const HTML_CACHE = `html-${CACHE_VERSION}`;
const API_CACHE = `api-${CACHE_VERSION}`;
const OFFLINE_URL = '/offline/';
const STATIC_ASSETS = [
'/',
OFFLINE_URL,
'/static/css/app.css',
'/static/js/app.js',
'/static/js/map.js',
'/static/icons/icon-192.png',
'/static/icons/icon-512.png',
'/manifest.webmanifest'
];
self.addEventListener('install', (event) => {
event.waitUntil(
caches.open(STATIC_CACHE).then((cache) => cache.addAll(STATIC_ASSETS)).catch(() => null)
);
self.skipWaiting();
});
self.addEventListener('activate', (event) => {
event.waitUntil(
caches.keys().then((keys) =>
Promise.all(
keys
.filter((key) => ![STATIC_CACHE, HTML_CACHE, API_CACHE].includes(key))
.map((key) => caches.delete(key))
)
)
);
self.clients.claim();
});
const isGet = (req) => req.method === 'GET';
const isApi = (req) => new URL(req.url).pathname.startsWith('/api/');
const isHtml = (req) => req.headers.get('accept')?.includes('text/html');
const sameOrigin = (req) => self.location.origin === new URL(req.url).origin;
self.addEventListener('fetch', (event) => {
const { request } = event;
if (!isGet(request)) return;
if (isApi(request)) {
event.respondWith(staleWhileRevalidate(request, API_CACHE));
return;
}
if (sameOrigin(request) && isHtml(request)) {
event.respondWith(networkFirst(request, HTML_CACHE, OFFLINE_URL));
return;
}
event.respondWith(cacheFirst(request, STATIC_CACHE));
});
async function cacheFirst(request, cacheName) {
const cache = await caches.open(cacheName);
const cached = await cache.match(request);
if (cached) return cached;
try {
const response = await fetch(request);
if (response && response.status === 200) {
cache.put(request, response.clone());
}
return response;
} catch (err) {
if (isHtml(request)) {
const fallback = await caches.match(OFFLINE_URL);
if (fallback) return fallback;
}
throw err;
}
}
async function networkFirst(request, cacheName, fallbackUrl) {
const cache = await caches.open(cacheName);
try {
const response = await fetch(request);
if (response && response.status === 200) {
cache.put(request, response.clone());
}
return response;
} catch (err) {
const cached = await cache.match(request);
if (cached) return cached;
if (fallbackUrl) {
const fallback = await caches.match(fallbackUrl);
if (fallback) return fallback;
}
throw err;
}
}
async function staleWhileRevalidate(request, cacheName) {
const cache = await caches.open(cacheName);
const cached = await cache.match(request);
const network = fetch(request)
.then((response) => {
if (response && response.status === 200) {
cache.put(request, response.clone());
}
return response;
})
.catch(() => cached);
return cached || network;
}

# File 128/160: static\css\app.css
################################################################################

:root {
--ps-color-bg:
--ps-color-bg-elevated:
--ps-color-surface:
--ps-color-border: rgba(255, 255, 255, 0.06);
--ps-color-primary:
--ps-color-primary-soft: rgba(13, 110, 253, 0.16);
--ps-color-primary-strong:
--ps-color-accent:
--ps-color-text:
--ps-color-text-muted:
--ps-color-danger:
--ps-color-warning:
--ps-color-success:
--ps-color-neutral:
--ps-radius-sm: 0.5rem;
--ps-radius-md: 0.75rem;
--ps-radius-lg: 1rem;
--ps-shadow-soft: 0 18px 45px rgba(0, 0, 0, 0.45);
--ps-shadow-card: 0 10px 30px rgba(15, 23, 42, 0.9);
--ps-font-family: system-ui, -apple-system, BlinkMacSystemFont, "SF Pro Text",
"Segoe UI", sans-serif;
--ps-transition-fast: 0.15s ease-out;
--ps-transition-normal: 0.25s ease-out;
--ps-header-height: 60px;
--ps-bottom-nav-height: 70px;
}
@media (min-width: 768px) {
:root {
--ps-header-height: 64px;
}
}
*,
*::before,
*::after {
box-sizing: border-box;
}
html,
body {
margin: 0;
padding: 0;
}
body.ps-body {
min-height: 100vh;
font-family: var(--ps-font-family);
background: radial-gradient(circle at top left,
color: var(--ps-color-text);
-webkit-font-smoothing: antialiased;
}
@media (max-width: 767px) {
body.ps-body {
padding-bottom: calc(var(--ps-bottom-nav-height) + env(safe-area-inset-bottom));
}
.ps-header {
height: var(--ps-header-height);
}
}
img {
max-width: 100%;
display: block;
}
.ps-header {
position: sticky;
top: 0;
z-index: 40;
backdrop-filter: blur(12px);
background: linear-gradient(to bottom, rgba(15, 23, 42, 0.96), rgba(15, 23, 42, 0.7));
border-bottom: 1px solid rgba(148, 163, 184, 0.18);
}
.ps-navbar {
max-width: 1120px;
margin: 0 auto;
display: flex;
align-items: center;
padding: 0.35rem 1rem;
height: var(--ps-header-height);
}
.ps-navbar-left {
flex: 1 1 auto;
display: flex;
align-items: center;
}
.ps-logo {
display: inline-flex;
align-items: baseline;
gap: 0.24rem;
text-decoration: none;
}
.ps-logo-main {
font-weight: 700;
letter-spacing: 0.03em;
text-transform: uppercase;
font-size: 1.05rem;
color:
}
.ps-logo-accent {
font-weight: 700;
font-size: 0.9rem;
color: var(--ps-color-primary);
padding: 0.08rem 0.45rem;
border-radius: 999px;
background: linear-gradient(90deg, rgba(59, 130, 246, 0.16), rgba(59, 130, 246, 0.04));
border: 1px solid rgba(59, 130, 246, 0.4);
}
.ps-navbar-menu {
display: none;
flex-direction: column;
gap: 0.25rem;
position: absolute;
inset-inline: 0.75rem;
top: calc(var(--ps-header-height) + 0.35rem);
padding: 0.5rem;
border-radius: var(--ps-radius-md);
background: rgba(15, 23, 42, 0.97);
box-shadow: var(--ps-shadow-soft);
border: 1px solid rgba(148, 163, 184, 0.35);
}
.ps-navbar-menu.is-open {
display: flex;
}
.ps-nav-link {
display: inline-flex;
align-items: center;
justify-content: flex-start;
padding: 0.5rem 0.75rem;
border-radius: 999px;
font-size: 0.85rem;
text-decoration: none;
color: var(--ps-color-text-muted);
transition: background-color var(--ps-transition-fast), color var(--ps-transition-fast), transform var(--ps-transition-fast);
}
.ps-nav-link:hover {
background: rgba(15, 23, 42, 0.85);
color:
transform: translateY(-1px);
}
.ps-nav-link--primary {
background: linear-gradient(135deg,
color:
}
.ps-nav-link--primary:hover {
filter: brightness(1.08);
}
.ps-nav-link--danger {
color:
}
.ps-nav-link--danger:hover {
background: rgba(248, 113, 113, 0.08);
}
.ps-navbar-toggle {
border: none;
background: transparent;
cursor: pointer;
width: 40px;
height: 40px;
border-radius: 999px;
display: inline-flex;
align-items: center;
justify-content: center;
margin-left: auto;
padding: 0;
position: relative;
}
.ps-navbar-toggle span {
position: absolute;
display: block;
width: 22px;
height: 2px;
border-radius: 999px;
background:
left: 50%;
transition: transform var(--ps-transition-normal), opacity var(--ps-transition-fast);
}
.ps-navbar-toggle span + span {
margin-top: 0;
}
.ps-navbar-toggle span:nth-child(1) {
transform: translate(-50%, -9px);
}
.ps-navbar-toggle span:nth-child(2) {
transform: translate(-50%, -1px);
}
.ps-navbar-toggle span:nth-child(3) {
transform: translate(-50%, 7px);
}
.ps-navbar-toggle.is-open span:nth-child(1) {
transform: translate(-50%, -1px) rotate(45deg);
}
.ps-navbar-toggle.is-open span:nth-child(2) {
opacity: 0;
transform: translate(-50%, -1px);
}
.ps-navbar-toggle.is-open span:nth-child(3) {
transform: translate(-50%, -1px) rotate(-45deg);
}
@media (min-width: 768px) {
.ps-navbar {
padding-inline: 1.25rem;
}
.ps-navbar-menu {
position: static;
display: flex !important;
flex-direction: row;
gap: 0.35rem;
padding: 0;
border-radius: 999px;
background: transparent;
box-shadow: none;
border: none;
}
.ps-navbar-toggle {
display: none;
}
.ps-nav-link {
font-size: 0.85rem;
padding-inline: 0.9rem;
}
}
.ps-main {
max-width: 1120px;
margin: 1.25rem auto 2.5rem;
padding-inline: 1rem;
}
@media (min-width: 768px) {
.ps-main {
margin-top: 1.8rem;
}
}
@media (max-width: 767px) {
.ps-main {
margin-bottom: 5.5rem;
}
}
.ps-footer {
border-top: 1px solid rgba(148, 163, 184, 0.18);
background: rgba(15, 23, 42, 0.96);
}
.ps-footer-inner {
max-width: 1120px;
margin: 0 auto;
padding: 0.75rem 1rem 1rem;
display: flex;
flex-direction: column;
gap: 0.25rem;
font-size: 0.8rem;
color: var(--ps-color-text-muted);
}
@media (min-width: 640px) {
.ps-footer-inner {
flex-direction: row;
justify-content: space-between;
align-items: center;
}
}
.ps-section {
margin-bottom: 2.5rem;
}
.ps-section--flush-top {
margin-top: 0.5rem;
}
.ps-section--center {
text-align: center;
margin-top: 2.5rem;
}
.ps-section--narrow {
max-width: 640px;
margin-inline: auto;
}
.ps-section-header {
margin-bottom: 1.4rem;
}
.ps-section-title {
margin: 0 0 0.35rem;
font-size: 1.4rem;
font-weight: 700;
}
.ps-section-title span {
color: var(--ps-color-primary);
}
.ps-section-title-sm {
margin: 0.75rem 0 0.25rem;
font-size: 1rem;
font-weight: 600;
}
.ps-section-subtitle {
margin: 0;
font-size: 0.9rem;
color: var(--ps-color-text-muted);
}
.ps-section-subheader {
margin-top: 1.4rem;
margin-bottom: 0.5rem;
}
.ps-section-header--stack {
display: flex;
justify-content: space-between;
gap: 12px;
align-items: flex-start;
}
.ps-section-actions {
display: flex;
gap: 8px;
flex-wrap: wrap;
}
@media (max-width: 767px) {
.ps-section-header--stack {
flex-direction: column;
align-items: flex-start;
}
.ps-section-actions {
width: 100%;
}
}
.ps-grid {
display: grid;
gap: 1rem;
}
.ps-grid--gap-md {
gap: 0.75rem;
}
.ps-grid--gap-xl {
gap: 1.5rem;
}
.ps-grid--2col {
grid-template-columns: repeat(2, minmax(0, 1fr));
}
.ps-grid--mobile-stack {
grid-template-columns: 1fr;
}
@media (min-width: 992px) {
.ps-grid--2col@lg {
grid-template-columns: 1.1fr 1.2fr;
align-items: flex-start;
}
}
@media (min-width: 992px) {
.ps-grid--3col@lg {
grid-template-columns: minmax(0, 0.9fr) minmax(0, 1.6fr);
}
}
@media (min-width: 1200px) {
.ps-grid--3col@xl {
grid-template-columns: minmax(0, 1.1fr) minmax(0, 1.9fr);
}
}
@media (max-width: 767px) {
.ps-grid--mobile-stack {
gap: 1.25rem;
}
}
.ps-grid-span-1 {
grid-column: span 1 / span 1;
}
.ps-grid-span-2 {
grid-column: span 1 / span 1;
}
@media (min-width: 992px) {
.ps-grid-span-2 {
grid-column: span 1 / span 1;
}
}
.ps-hero {
margin-bottom: 2rem;
}
.ps-hero-inner {
display: grid;
gap: 1.75rem;
}
@media (min-width: 768px) {
.ps-hero-inner {
grid-template-columns: minmax(0, 1.5fr) minmax(0, 1fr);
align-items: center;
}
}
.ps-hero-title {
margin: 0 0 0.5rem;
font-size: 1.9rem;
line-height: 1.2;
}
.ps-hero-title span {
color: var(--ps-color-primary);
}
@media (min-width: 640px) {
.ps-hero-title {
font-size: 2.15rem;
}
}
.ps-hero-subtitle {
margin: 0 0 1rem;
font-size: 0.95rem;
color: var(--ps-color-text-muted);
}
.ps-hero-actions {
display: flex;
flex-wrap: wrap;
gap: 0.6rem;
margin-bottom: 0.75rem;
}
.ps-hero-meta {
font-size: 0.8rem;
color: var(--ps-color-text-muted);
}
.ps-hero-visual {
display: flex;
justify-content: center;
}
.ps-hero-card {
padding: 0.9rem 1rem;
border-radius: var(--ps-radius-lg);
background: radial-gradient(circle at top left, rgba(37, 99, 235, 0.25), rgba(15, 23, 42, 0.95));
border: 1px solid rgba(148, 163, 184, 0.26);
box-shadow: var(--ps-shadow-card);
min-width: 260px;
}
.ps-hero-card-line {
display: flex;
align-items: center;
gap: 0.4rem;
font-size: 0.85rem;
color:
}
.ps-hero-card-line + .ps-hero-card-line {
margin-top: 0.4rem;
}
.ps-dot {
width: 8px;
height: 8px;
border-radius: 999px;
}
.ps-dot--green {
background: var(--ps-color-success);
}
.ps-dot--blue {
background: var(--ps-color-primary);
}
.ps-dot--yellow {
background: var(--ps-color-warning);
}
.ps-card {
border-radius: var(--ps-radius-md);
background: radial-gradient(circle at top, rgba(15, 23, 42, 0.98),
border: 1px solid rgba(148, 163, 184, 0.22);
padding: 0.9rem 0.95rem;
box-shadow: 0 10px 35px rgba(15, 23, 42, 0.86);
}
.ps-card--elevated {
box-shadow: var(--ps-shadow-card);
}
.ps-card-header {
display: flex;
justify-content: space-between;
align-items: center;
gap: 0.5rem;
margin-bottom: 0.6rem;
}
.ps-card-title {
font-size: 1rem;
font-weight: 600;
}
.ps-card-body {
font-size: 0.88rem;
}
.ps-card-line {
margin-bottom: 0.25rem;
}
.ps-card-line--muted {
color: var(--ps-color-text-muted);
font-size: 0.8rem;
}
.ps-card--spot {
margin-bottom: 0.5rem;
}
.ps-spots-panel {
position: relative;
}
.ps-spots-list {
display: grid;
gap: 0.65rem;
}
@media (max-width: 767px) {
.ps-spots-panel {
background: rgba(15, 23, 42, 0.85);
border: 1px solid rgba(148, 163, 184, 0.25);
border-radius: 18px 18px 0 0;
padding: 12px 14px;
box-shadow: 0 -10px 30px rgba(0, 0, 0, 0.45);
}
.ps-spots-panel.is-sheet-open {
position: fixed;
left: 0;
right: 0;
bottom: 0;
max-height: 70vh;
overflow-y: auto;
z-index: 40;
}
}
.ps-list {
list-style: none;
padding: 0;
margin: 0;
}
.ps-list--compact .ps-list-item {
padding-block: 0.45rem;
}
.ps-list-item {
display: flex;
align-items: center;
justify-content: space-between;
gap: 0.5rem;
padding-block: 0.5rem;
border-bottom: 1px dashed rgba(148, 163, 184, 0.28);
}
.ps-list-item:last-child {
border-bottom: none;
}
.ps-list-main {
min-width: 0;
}
.ps-list-title {
font-size: 0.9rem;
font-weight: 500;
}
.ps-list-subtitle {
font-size: 0.78rem;
color: var(--ps-color-text-muted);
}
.ps-list-empty {
font-size: 0.85rem;
color: var(--ps-color-text-muted);
padding-block: 0.4rem;
}
.ps-form {
display: flex;
flex-direction: column;
gap: 0.6rem;
}
.ps-form-row {
display: flex;
flex-direction: column;
gap: 0.2rem;
}
.ps-form-label {
font-size: 0.82rem;
color: var(--ps-color-text-muted);
}
.ps-input {
border-radius: var(--ps-radius-sm);
border: 1px solid rgba(148, 163, 184, 0.4);
background: rgba(15, 23, 42, 0.95);
color: var(--ps-color-text);
padding: 0.45rem 0.55rem;
font-size: 0.9rem;
outline: none;
transition: border-color var(--ps-transition-fast), box-shadow var(--ps-transition-fast), background-color var(--ps-transition-fast), transform var(--ps-transition-fast);
}
.ps-input:focus {
border-color: var(--ps-color-primary);
box-shadow: 0 0 0 1px rgba(37, 99, 235, 0.35);
transform: translateY(-0.5px);
}
.ps-field-error {
font-size: 0.75rem;
color:
}
.ps-field-help {
font-size: 0.75rem;
color: var(--ps-color-text-muted);
}
.ps-form-actions {
display: flex;
flex-direction: column;
gap: 0.5rem;
margin-top: 0.4rem;
}
@media (min-width: 640px) {
.ps-form-actions {
flex-direction: row;
justify-content: flex-start;
}
}
.ps-btn {
border-radius: 999px;
border: none;
padding: 0.45rem 0.95rem;
font-size: 0.88rem;
font-weight: 500;
cursor: pointer;
display: inline-flex;
align-items: center;
justify-content: center;
gap: 0.35rem;
background: linear-gradient(135deg,
color:
text-decoration: none;
transition: transform var(--ps-transition-fast), box-shadow var(--ps-transition-fast), filter var(--ps-transition-fast), background var(--ps-transition-fast);
}
.ps-btn:hover {
transform: translateY(-1px);
filter: brightness(1.06);
box-shadow: 0 14px 32px rgba(37, 99, 235, 0.6);
}
.ps-btn:active {
transform: translateY(1px);
box-shadow: 0 8px 20px rgba(15, 23, 42, 0.8);
}
.ps-btn-secondary {
background: rgba(15, 23, 42, 0.96);
color:
border: 1px solid rgba(148, 163, 184, 0.5);
box-shadow: none;
}
.ps-btn-secondary:hover {
background: rgba(15, 23, 42, 1);
border-color: rgba(148, 163, 184, 0.8);
}
.ps-btn-ghost {
background: transparent;
color:
border: 1px solid rgba(148, 163, 184, 0.35);
}
.ps-btn-ghost:hover {
background: rgba(15, 23, 42, 0.8);
}
.ps-btn-lg {
padding-block: 0.55rem;
padding-inline: 1.1rem;
}
.ps-btn-full {
width: 100%;
}
.ps-badge {
display: inline-flex;
align-items: center;
justify-content: center;
padding: 0.15rem 0.55rem;
border-radius: 999px;
font-size: 0.72rem;
font-weight: 500;
border: 1px solid transparent;
}
.ps-badge--success {
background: rgba(34, 197, 94, 0.1);
border-color: rgba(34, 197, 94, 0.65);
color:
}
.ps-badge--neutral {
background: rgba(148, 163, 184, 0.12);
border-color: rgba(148, 163, 184, 0.6);
color:
}
.ps-badge--status-pending {
background: rgba(234, 179, 8, 0.1);
border-color: rgba(234, 179, 8, 0.7);
color:
}
.ps-badge--status-confirmed,
.ps-badge--status-active {
background: rgba(34, 197, 94, 0.1);
border-color: rgba(34, 197, 94, 0.7);
color:
}
.ps-badge--status-completed {
background: rgba(59, 130, 246, 0.1);
border-color: rgba(59, 130, 246, 0.7);
color:
}
.ps-badge--status-cancelled,
.ps-badge--status-expired,
.ps-badge--status-inactive {
background: rgba(248, 113, 113, 0.08);
border-color: rgba(248, 113, 113, 0.7);
color:
}
.ps-table-wrapper {
overflow-x: auto;
margin-top: 0.3rem;
}
.ps-table {
width: 100%;
border-collapse: collapse;
font-size: 0.85rem;
}
.ps-table thead {
background: rgba(15, 23, 42, 0.95);
}
.ps-table th,
.ps-table td {
padding: 0.45rem 0.5rem;
border-bottom: 1px solid rgba(30, 64, 175, 0.45);
}
.ps-table th {
text-align: left;
font-weight: 500;
font-size: 0.78rem;
color: var(--ps-color-text-muted);
}
.ps-table tbody tr:nth-child(even) {
background: rgba(15, 23, 42, 0.75);
}
.ps-table tbody tr:hover {
background: rgba(30, 64, 175, 0.45);
}
@media (max-width: 640px) {
.ps-table thead {
display: none;
}
.ps-table tr {
display: grid;
padding-block: 0.4rem;
border-bottom: 1px solid rgba(30, 64, 175, 0.45);
}
.ps-table td {
border: none;
padding: 0.2rem 0.3rem;
}
.ps-table td::before {
content: attr(data-label);
display: inline-block;
width: 46%;
max-width: 120px;
font-size: 0.74rem;
text-transform: uppercase;
letter-spacing: 0.04em;
color: var(--ps-color-text-muted);
}
.ps-table td {
font-size: 0.8rem;
}
}
.ps-map {
border-radius: var(--ps-radius-md);
border: 1px solid rgba(148, 163, 184, 0.25);
overflow: hidden;
height: min(65vh, 560px);
margin-bottom: 0.5rem;
box-shadow: var(--ps-shadow-card);
position: relative;
z-index: 2;
background:
transition: filter 0.2s ease, transform 0.2s ease;
}
@media (max-width: 767px) {
.ps-map {
height: calc(100vh - var(--ps-header-height) - var(--ps-bottom-nav-height) - env(safe-area-inset-bottom) - 16px);
}
}
.ps-map.ps-map--dark {
background:
}
.ps-map-wrapper {
position: relative;
overflow: visible;
}
.ps-map-floating-actions {
position: absolute;
top: 12px;
right: 12px;
display: flex;
flex-direction: column;
gap: 8px;
pointer-events: auto;
z-index: 1300;
transition: opacity var(--ps-transition-normal);
backdrop-filter: blur(8px);
padding: 6px;
border-radius: 16px;
background: rgba(255, 255, 255, 0.75);
}
.ps-map-floating-actions.is-dimmed {
opacity: 0.35;
}
.ps-map-action {
width: 44px;
height: 44px;
border-radius: 12px;
border: 1px solid rgba(15, 23, 42, 0.2);
background: rgba(250, 250, 255, 0.98);
color:
cursor: pointer;
pointer-events: auto;
box-shadow: var(--ps-shadow-card);
transition: transform 0.2s ease, box-shadow 0.2s ease, background-color 0.2s ease, opacity 0.2s ease;
}
.ps-map-action:hover {
transform: translateY(-1px);
background: rgba(255, 255, 255, 0.95);
}
.ps-map-action:active {
transform: scale(0.96);
}
.ps-map-action--toggled {
box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.4);
}
.ps-map-action--spinning { animation: ps-spin-once 0.5s ease-out; }
.ps-map-action--pulse { animation: ps-pulse 1.3s ease-out infinite; }
.ps-map-action.is-animating { animation: ps-rotate-pop 0.45s ease; }
.ps-map-action.is-busy { opacity: 0.7; pointer-events: none; }
@keyframes ps-spin-once {
to { transform: rotate(360deg); }
}
@keyframes ps-pulse {
0% { box-shadow: 0 0 0 0 rgba(34, 197, 94, 0.7); }
70% { box-shadow: 0 0 0 12px rgba(34, 197, 94, 0); }
100% { box-shadow: 0 0 0 0 rgba(34, 197, 94, 0); }
}
@keyframes ps-rotate-pop {
0% { transform: rotate(0deg) scale(0.96); }
60% { transform: rotate(-12deg) scale(1.08); }
100% { transform: rotate(0deg) scale(1); }
}
.ps-map.ps-map--dark ~ .ps-map-floating-actions .ps-map-action,
body.theme-dark .ps-map-floating-actions .ps-map-action,
body:not(.ps-day-mode) .ps-map-floating-actions .ps-map-action {
background: rgba(17, 24, 39, 0.92);
color:
border-color: rgba(255, 255, 255, 0.12);
}
.ps-map-popup,
.ymaps-2-1-79-balloon__layout,
.ymaps-2-1-79-balloon__content {
background-color:
color:
border-radius: 16px;
padding: 0;
box-shadow: 0 20px 40px rgba(15, 23, 42, 0.28);
border: 1px solid rgba(148, 163, 184, 0.35);
}
.ymaps-2-1-79-balloon__layout {
overflow: hidden;
}
.ps-map.ps-map--dark .ps-map-popup,
.ps-map.ps-map--dark .ymaps-2-1-79-balloon__layout,
.ps-map.ps-map--dark .ymaps-2-1-79-balloon__content,
body.theme-dark .ps-map-popup,
body.theme-dark .ymaps-2-1-79-balloon__layout,
body.theme-dark .ymaps-2-1-79-balloon__content,
body:not(.ps-day-mode) .ps-map-popup,
body:not(.ps-day-mode) .ymaps-2-1-79-balloon__layout,
body:not(.ps-day-mode) .ymaps-2-1-79-balloon__content {
background-color:
color:
box-shadow: 0 20px 40px rgba(15, 23, 42, 0.6);
border-color: rgba(148, 163, 184, 0.25);
}
.ps-map-popup {
width: min(380px, 82vw);
padding: 16px 18px 14px;
box-sizing: border-box;
max-height: 55vh;
overflow: hidden;
}
.ps-map-popup-head { margin-bottom: 4px; }
.ps-map-popup-title { font-weight: 700; font-size: 1rem; margin-bottom: 2px; color:
.ps-map-popup-meta { font-size: 0.82rem; color: var(--ps-color-text-muted); margin-bottom: 6px; }
.ps-map-popup-price { font-size: 0.95rem; margin-bottom: 10px; color:
.ps-map-popup-meter {
margin: 10px 0 12px;
height: 10px;
border-radius: 999px;
background: rgba(15, 23, 42, 0.08);
overflow: hidden;
}
.ps-map-popup-meter span {
display: block;
height: 100%;
border-radius: inherit;
background: linear-gradient(90deg,
}
.ps-map-popup-meter-label { font-size: 0.78rem; color: var(--ps-color-text-muted); margin-top: 4px; }
.ps-map.ps-map--dark .ps-map-popup-title,
body.theme-dark .ps-map-popup-title,
body:not(.ps-day-mode) .ps-map-popup-title {
color:
}
.ps-map.ps-map--dark .ps-map-popup-price,
body.theme-dark .ps-map-popup-price,
body:not(.ps-day-mode) .ps-map-popup-price {
color:
}
.ps-map.ps-map--dark .ps-map-popup-meter,
body.theme-dark .ps-map-popup-meter,
body:not(.ps-day-mode) .ps-map-popup-meter {
background: rgba(255, 255, 255, 0.08);
}
.ps-map-popup--list {
max-height: 420px;
overflow-y: auto;
padding: 12px 14px 10px;
}
.ps-map-popup--list .ps-map-popup {
margin-bottom: 10px;
border: 1px solid rgba(148, 163, 184, 0.22);
}
.ps-map-popup--list .ps-map-popup:last-child {
margin-bottom: 0;
}
.ps-map-grid {
display: grid;
grid-template-columns: 1.15fr 0.85fr;
gap: 18px;
}
.ps-map-topbar {
position: absolute;
left: 12px;
right: 12px;
top: 12px;
display: flex;
gap: 10px;
align-items: center;
background: rgba(255, 255, 255, 0.9);
padding: 10px 12px;
border-radius: 14px;
box-shadow: var(--ps-shadow-card);
z-index: 1250;
}
.ps-map.ps-map--dark ~ .ps-map-topbar,
body.theme-dark .ps-map-topbar,
body:not(.ps-day-mode) .ps-map-topbar {
background: rgba(15, 23, 42, 0.9);
}
.ps-map-chips {
position: absolute;
left: 12px;
right: 12px;
top: 72px;
display: flex;
gap: 8px;
overflow-x: auto;
padding: 4px 2px;
z-index: 1200;
}
.ps-bottom-sheet {
background: rgba(255, 255, 255, 0.96);
border-radius: 16px;
border: 1px solid rgba(148, 163, 184, 0.3);
box-shadow: var(--ps-shadow-card);
height: min(70vh, 640px);
display: flex;
flex-direction: column;
position: relative;
overflow: hidden;
}
.ps-bottom-sheet__handle {
width: 54px;
height: 5px;
border-radius: 999px;
background: rgba(148, 163, 184, 0.35);
margin: 8px auto;
}
.ps-bottom-sheet__header {
display: flex;
align-items: center;
justify-content: space-between;
padding: 4px 16px 8px;
}
.ps-bottom-sheet__actions { display: flex; gap: 8px; }
.ps-bottom-sheet__body {
padding: 0 12px 12px;
overflow-y: auto;
}
@media (max-width: 1023px) {
.ps-map-grid { grid-template-columns: 1fr; }
.ps-bottom-sheet { height: auto; min-height: 320px; }
.ps-map-topbar { position: fixed; left: 12px; right: 12px; top: calc(var(--ps-header-height) + 10px); }
.ps-map-chips { top: calc(var(--ps-header-height) + 64px); }
}
@media (max-width: 640px) {
.ps-map { height: calc(100vh - var(--ps-header-height) - var(--ps-bottom-nav-height) - env(safe-area-inset-bottom) - 10px); }
.ps-map-topbar { flex-direction: column; align-items: stretch; gap: 8px; }
.ps-map-grid { gap: 12px; }
}
@media (max-width: 640px) {
.ymaps-2-1-79-balloon__layout,
.ymaps-2-1-79-balloon__content {
max-width: 90vw;
}
.ps-map-popup {
padding: 12px 14px 10px;
max-width: 90vw;
font-size: 13px;
}
.ps-map-popup-title {
font-size: 14px;
}
.ps-map-popup-price {
font-size: 13px;
}
}
.ymaps-2-1-79-balloon__tail::after,
.ymaps-2-1-79-balloon__tail::before {
background: inherit;
}
.ps-map-popup-card .leaflet-popup-content {
margin: 12px 14px;
}
.ps-map-popup-card .ps-map-popup-title {
color: inherit;
}
.ps-map-popup-card .ps-map-popup-price {
color: inherit;
}
.ps-map-popup-actions .ps-btn {
box-shadow: none;
}
.ps-map-popup-actions .ps-btn.ps-btn-ghost {
color: inherit;
border: 1px solid rgba(148, 163, 184, 0.35);
}
.ps-map-marker {
width: 52px;
height: 52px;
border-radius: 50%;
background:
position: relative;
box-shadow: 0 8px 20px rgba(14, 165, 233, 0.35);
transition: transform 0.2s ease, box-shadow 0.2s ease;
}
.ps-map-marker__body {
width: 100%;
height: 100%;
border-radius: inherit;
display: grid;
place-items: center;
color:
font-weight: 700;
font-size: 13px;
letter-spacing: 0.01em;
box-shadow: inset 0 0 0 2px rgba(255, 255, 255, 0.12);
}
.ps-map-marker__halo {
position: absolute;
inset: -6px;
border-radius: inherit;
background: rgba(59, 130, 246, 0.12);
z-index: -1;
transition: opacity 0.2s ease;
}
.ps-map-marker:hover,
.ps-map-marker--active {
transform: translateY(-6px) scale(1.06);
box-shadow: 0 14px 38px rgba(15, 23, 42, 0.35), 0 0 0 3px rgba(59, 130, 246, 0.12);
}
.ps-map-marker:hover .ps-map-marker__halo,
.ps-map-marker--active .ps-map-marker__halo {
opacity: 0.9;
}
.ps-map-marker--hot .ps-map-marker__halo {
background: rgba(34, 197, 94, 0.3);
animation: ps-pulse 1.4s ease-out infinite;
}
.ps-map-marker__value {
text-shadow: 0 2px 6px rgba(0, 0, 0, 0.3);
}
.ps-map-cluster {
width: 56px;
height: 56px;
border-radius: 999px;
background: linear-gradient(135deg,
color:
display: grid;
place-items: center;
font-weight: 700;
font-size: 15px;
box-shadow: 0 12px 26px rgba(59, 130, 246, 0.35);
}
.ps-map-cluster--warn {
background: linear-gradient(135deg,
box-shadow: 0 12px 26px rgba(249, 115, 22, 0.35);
}
.ps-map-cluster--danger {
background: linear-gradient(135deg,
box-shadow: 0 12px 26px rgba(239, 68, 68, 0.35);
}
.ps-map-filters {
margin-top: 0.5rem;
}
.ps-map-filters-card {
background: linear-gradient(120deg, rgba(15, 23, 42, 0.95), rgba(15, 23, 42, 0.7));
border: 1px solid rgba(148, 163, 184, 0.35);
border-radius: var(--ps-radius-lg);
padding: 12px;
display: grid;
gap: 12px;
box-shadow: var(--ps-shadow-card);
}
.ps-map-filters-row {
display: grid;
grid-template-columns: 1fr auto;
gap: 12px;
align-items: center;
}
.ps-map-filters-actions {
display: flex;
justify-content: flex-end;
}
.ps-map-filters-row--chips {
grid-template-columns: 1fr;
gap: 8px;
}
.ps-chip-scroll {
display: flex;
gap: 8px;
overflow-x: auto;
padding-bottom: 4px;
scrollbar-width: thin;
}
.ps-chip-scroll .ps-chip {
white-space: nowrap;
}
.ps-map-filters-row--slider {
grid-template-columns: 1fr;
gap: 6px;
}
.ps-filter-slider {
margin: 2px 0;
}
.ps-filter-price {
font-size: 0.9rem;
color: var(--ps-color-text-muted);
}
.ps-input-icon {
position: relative;
display: flex;
align-items: center;
}
.ps-input-icon .ps-input {
padding-left: 2.25rem;
}
.ps-input-icon-symbol {
position: absolute;
left: 12px;
pointer-events: none;
opacity: 0.8;
}
.ps-geocode-suggestions {
display: grid;
gap: 6px;
}
.ps-geocode-suggestions button {
text-align: left;
background: rgba(30, 41, 59, 0.8);
border: 1px solid rgba(148, 163, 184, 0.3);
color:
padding: 8px 10px;
border-radius: var(--ps-radius-md);
}
.ps-map-popup-badges {
display: flex;
flex-wrap: wrap;
gap: 4px;
}
.ps-map-popup-title {
font-weight: 600;
font-size: 15px;
color:
margin-bottom: 4px;
}
.ps-map-popup-price {
font-size: 14px;
color:
margin-bottom: 8px;
}
.ps-map-popup-meter {
margin-top: 8px;
background: rgba(15, 23, 42, 0.08);
border-radius: 999px;
overflow: hidden;
height: 6px;
}
.ps-map-popup-meter span {
display: block;
height: 100%;
border-radius: 999px;
background: linear-gradient(to right,
}
.ps-map-popup-actions {
display: flex;
gap: 6px;
margin-top: 6px;
}
.ps-meter {
display: inline-block;
width: 90px;
height: 8px;
background: rgba(148, 163, 184, 0.35);
border-radius: 999px;
overflow: hidden;
}
.ps-meter span {
display: block;
height: 100%;
background: linear-gradient(90deg,
}
.ps-map-loading {
position: absolute;
inset: 0;
display: none;
align-items: center;
justify-content: center;
background: rgba(15, 23, 42, 0.5);
color:
font-weight: 600;
}
.ps-route-hint {
margin-top: 8px;
color: var(--ps-color-text-muted);
font-size: 0.9rem;
}
.ps-payment-list {
display: grid;
gap: 10px;
}
.ps-payment-card {
display: grid;
grid-template-columns: 1fr auto;
gap: 8px;
align-items: center;
padding: 10px 12px;
border-radius: var(--ps-radius-md);
background: linear-gradient(120deg, rgba(34, 197, 94, 0.08), rgba(14, 165, 233, 0.06));
border: 1px solid rgba(148, 163, 184, 0.25);
}
.ps-payment-meta {
color: var(--ps-color-text-muted);
font-size: 0.9rem;
}
.ps-payment-actions {
display: flex;
gap: 6px;
}
.ps-payment-brand {
font-weight: 700;
display: inline-flex;
align-items: center;
gap: 6px;
}
.ps-progress-block {
background: rgba(148, 163, 184, 0.08);
border: 1px solid rgba(148, 163, 184, 0.2);
border-radius: var(--ps-radius-md);
padding: 8px 10px;
margin-bottom: 10px;
}
.ps-progress-header {
display: flex;
align-items: center;
justify-content: space-between;
gap: 8px;
flex-wrap: wrap;
margin-bottom: 6px;
}
.ps-progress-label {
color: var(--ps-color-text-muted);
font-size: 0.9rem;
}
.ps-progress {
width: 100%;
height: 8px;
background: rgba(148, 163, 184, 0.2);
border-radius: 999px;
overflow: hidden;
}
.ps-progress-bar {
height: 100%;
background: linear-gradient(90deg,
border-radius: 999px;
}
.ps-chip {
display: inline-flex;
align-items: center;
justify-content: center;
gap: 6px;
background: rgba(148, 163, 184, 0.15);
color:
padding: 8px 12px;
border-radius: 999px;
border: 1px solid rgba(148, 163, 184, 0.25);
cursor: pointer;
transition: all var(--ps-transition-fast);
font-weight: 600;
font-size: 0.9rem;
}
.ps-chip:hover {
border-color: rgba(34, 197, 94, 0.5);
box-shadow: 0 10px 25px rgba(34, 197, 94, 0.14);
}
.ps-chip input {
accent-color:
}
.ps-chip.is-active {
background: rgba(34, 197, 94, 0.12);
border-color: rgba(34, 197, 94, 0.6);
color:
}
@media (min-width: 768px) {
.ps-map {
height: 420px;
}
.ps-map-filters-card {
padding: 14px 16px;
}
}
@media (max-width: 767px) {
.ps-map-filters-row {
grid-template-columns: 1fr;
}
.ps-map {
height: calc(100vh - var(--ps-header-height) - var(--ps-bottom-nav-height) - 150px);
border-radius: var(--ps-radius-lg);
}
.ps-map-filters-actions {
width: 100%;
}
}
.ps-modal {
position: fixed;
inset: 0;
background: rgba(0, 0, 0, 0.7);
display: grid;
place-items: center;
z-index: 50;
}
.ps-modal-dialog {
background:
border: 1px solid rgba(148, 163, 184, 0.4);
border-radius: var(--ps-radius-xl);
padding: 18px;
min-width: 320px;
max-width: 420px;
position: relative;
}
.ps-modal-close {
position: absolute;
top: 8px;
right: 10px;
background: none;
border: none;
color:
font-size: 1.2rem;
cursor: pointer;
}
.ps-tabs {
display: grid;
grid-template-columns: repeat(4, 1fr);
gap: 6px;
margin-bottom: 10px;
}
.ps-tabs button {
background: rgba(148, 163, 184, 0.15);
border: 1px solid rgba(148, 163, 184, 0.2);
color:
padding: 8px 4px;
border-radius: var(--ps-radius-md);
}
.ps-tabs button.is-active {
border-color:
box-shadow: 0 0 0 1px rgba(34, 197, 94, 0.3);
}
.ps-tab-panel {
display: none;
gap: 8px;
}
.ps-tab-panel.is-active {
display: grid;
}
.ps-chat {
position: fixed;
right: 24px;
bottom: 24px;
z-index: 65;
display: grid;
grid-template-columns: auto;
gap: 12px;
align-items: flex-end;
}
.ps-chat-fab {
display: inline-flex;
align-items: center;
gap: 10px;
padding: 12px 16px;
border-radius: 999px;
border: 1px solid rgba(255, 255, 255, 0.12);
background: linear-gradient(145deg, rgba(34, 197, 94, 0.95), rgba(14, 165, 233, 0.95));
color:
font-weight: 700;
box-shadow: 0 18px 35px rgba(0, 0, 0, 0.6);
cursor: pointer;
transition: transform var(--ps-transition-fast), box-shadow var(--ps-transition-fast);
position: relative;
z-index: 3;
}
.ps-chat-fab:hover {
transform: translateY(-1px);
box-shadow: 0 20px 40px rgba(0, 0, 0, 0.55);
}
.ps-chat-fab-text {
display: inline;
}
.ps-chat-panel {
position: fixed;
right: 24px;
bottom: 24px;
width: 400px;
max-width: calc(100vw - 32px);
max-height: 78vh;
background: rgba(10, 14, 26, 0.95);
border-radius: 18px;
border: 1px solid rgba(148, 163, 184, 0.25);
display: grid;
grid-template-rows: auto 1fr auto;
box-shadow: 0 22px 48px rgba(0, 0, 0, 0.7);
overflow: hidden;
transform: translateY(12px) scale(0.99);
opacity: 0;
pointer-events: none;
transition: transform var(--ps-transition-normal), opacity var(--ps-transition-normal);
z-index: 2;
}
.ps-chat.is-sheet .ps-chat-panel {
left: 12px;
right: 12px;
width: auto;
bottom: calc(var(--ps-bottom-nav-height) + 10px);
max-height: calc(100vh - var(--ps-header-height) - var(--ps-bottom-nav-height) - 18px);
border-radius: 20px;
box-shadow: 0 32px 80px rgba(0, 0, 0, 0.65);
}
.ps-chat-overlay {
position: fixed;
inset: 0;
background: rgba(3, 6, 17, 0.3);
backdrop-filter: blur(2px);
opacity: 0;
pointer-events: none;
transition: opacity var(--ps-transition-fast);
z-index: 1;
}
.ps-chat.is-sheet .ps-chat-overlay {
background: linear-gradient(to top, rgba(3, 6, 17, 0.55), rgba(3, 6, 17, 0.1));
}
.ps-chat.is-open .ps-chat-panel {
transform: translateY(0) scale(1);
opacity: 1;
pointer-events: auto;
}
.ps-chat.is-open .ps-chat-overlay {
opacity: 1;
pointer-events: auto;
}
.ps-chat-header {
padding: 14px 16px 12px;
border-bottom: 1px solid rgba(148, 163, 184, 0.2);
display: grid;
grid-template-columns: 1fr auto;
gap: 12px;
align-items: center;
}
.ps-chat-header-text {
display: grid;
gap: 4px;
}
.ps-chat-title {
font-size: 1rem;
font-weight: 700;
}
.ps-chat-hint {
font-size: 0.85rem;
color: var(--ps-color-text-muted);
}
.ps-chat-meta {
display: inline-flex;
gap: 10px;
align-items: center;
}
.ps-chat-close {
border: 1px solid rgba(255, 255, 255, 0.14);
background: rgba(255, 255, 255, 0.06);
color:
border-radius: 10px;
padding: 6px 10px;
cursor: pointer;
}
.ps-chat-status-dot {
font-size: 0.85rem;
color:
padding: 6px 10px;
border-radius: 999px;
background: rgba(52, 211, 153, 0.12);
border: 1px solid rgba(52, 211, 153, 0.4);
}
.ps-chat-body {
overflow-y: auto;
padding: 14px 16px;
display: grid;
gap: 12px;
background: radial-gradient(circle at top right, rgba(34, 197, 94, 0.04), transparent 40%);
}
.ps-chat-bubble {
padding: 12px 13px;
border-radius: 18px;
border: 1px solid rgba(148, 163, 184, 0.22);
background: rgba(148, 163, 184, 0.08);
display: grid;
gap: 6px;
box-shadow: var(--ps-shadow-soft);
}
.ps-chat-bubble--user {
background: rgba(34, 197, 94, 0.14);
border-color: rgba(34, 197, 94, 0.35);
justify-self: end;
}
.ps-chat-text {
line-height: 1.45;
font-size: 0.98rem;
color:
}
.ps-chat-meta {
font-size: 0.82rem;
color: var(--ps-color-text-muted);
}
.ps-chat-spots {
display: grid;
gap: 8px;
}
.ps-chat-spot-card {
padding: 10px 12px;
background: linear-gradient(135deg, rgba(26, 34, 52, 0.94), rgba(16, 24, 40, 0.92));
border: 1px solid rgba(148, 163, 184, 0.25);
border-radius: var(--ps-radius-md);
display: grid;
gap: 6px;
box-shadow: 0 10px 24px rgba(0, 0, 0, 0.25);
}
.ps-chat-spot-title {
font-weight: 700;
}
.ps-chat-spot-meta {
font-size: 0.9rem;
color: var(--ps-color-text-muted);
}
.ps-chat-spot-actions {
display: flex;
justify-content: flex-start;
}
.ps-chat-feedback {
display: flex;
align-items: center;
gap: 8px;
font-size: 0.9rem;
}
.ps-chat-feedback-actions button {
background: rgba(148, 163, 184, 0.1);
border: 1px solid rgba(148, 163, 184, 0.3);
color: var(--ps-color-text);
border-radius: 8px;
padding: 4px 8px;
cursor: pointer;
transition: background var(--ps-transition-fast), transform var(--ps-transition-fast);
}
.ps-chat-feedback-actions button:hover {
background: rgba(255, 255, 255, 0.08);
transform: translateY(-1px);
}
.ps-chat-feedback-actions button.is-active {
border-color: var(--ps-color-primary);
box-shadow: 0 0 0 2px rgba(13, 110, 253, 0.2);
}
.ps-chat-input {
padding: 12px 14px;
display: grid;
grid-template-columns: 1fr auto;
gap: 10px;
border-top: 1px solid rgba(148, 163, 184, 0.2);
background: rgba(15, 23, 42, 0.92);
}
.ps-chat-input .ps-btn {
align-self: end;
}
.ps-chat-input textarea {
min-height: 56px;
resize: none;
}
.ps-chat-status {
padding: 6px 16px;
font-size: 0.85rem;
color: var(--ps-color-text-muted);
}
@media (max-width: 1023px) {
.ps-chat {
right: 16px;
bottom: calc(var(--ps-bottom-nav-height) + 18px);
}
.ps-chat-fab {
padding: 12px;
min-height: 48px;
border-radius: 999px;
box-shadow: 0 14px 32px rgba(0, 0, 0, 0.55);
}
.ps-chat-fab-text {
display: none;
}
.ps-chat-panel {
right: 12px;
left: 12px;
bottom: calc(var(--ps-bottom-nav-height) + 10px);
width: auto;
max-width: 100%;
max-height: calc(100vh - var(--ps-header-height) - var(--ps-bottom-nav-height) - 12px);
border-radius: 18px 18px 0 0;
transform: translateY(120%);
}
.ps-chat.is-open .ps-chat-panel {
transform: translateY(0);
}
.ps-chat-overlay {
display: block;
}
}
.ps-bottom-nav {
position: fixed;
left: 0;
right: 0;
bottom: 0;
height: var(--ps-bottom-nav-height);
background: linear-gradient(180deg, rgba(10, 14, 26, 0.94), rgba(5, 8, 22, 0.98));
border-top: 1px solid rgba(148, 163, 184, 0.15);
display: none;
grid-template-columns: repeat(4, 1fr);
box-shadow: 0 -10px 28px rgba(0, 0, 0, 0.45);
z-index: 1300;
padding-bottom: env(safe-area-inset-bottom);
}
.ps-bottom-nav-item {
display: inline-flex;
flex-direction: column;
align-items: center;
justify-content: center;
gap: 4px;
color: var(--ps-color-text-muted);
background: transparent;
border: none;
font-size: 0.82rem;
cursor: pointer;
text-decoration: none;
position: relative;
transition: color var(--ps-transition-fast), transform var(--ps-transition-fast);
}
.ps-bottom-nav-icon {
font-size: 1.1rem;
}
.ps-bottom-nav-item::before {
content: "";
position: absolute;
top: 0;
left: 18%;
right: 18%;
height: 3px;
border-radius: 999px;
background: transparent;
transition: background var(--ps-transition-fast);
}
.ps-bottom-nav-item.is-active,
.ps-bottom-nav-item:focus-visible,
.ps-bottom-nav-item:hover {
color: var(--ps-color-text);
}
.ps-bottom-nav-item.is-active::before {
background: linear-gradient(90deg,
}
@media (max-width: 1023px) {
.ps-bottom-nav {
display: grid;
}
}
.ps-user-level {
display: inline-flex;
align-items: center;
gap: 4px;
padding: 4px 8px;
border-radius: 999px;
background: rgba(34, 197, 94, 0.12);
color:
margin-left: 8px;
font-size: 0.9rem;
}
.ps-card--skeleton {
position: relative;
overflow: hidden;
}
.ps-skeleton-line {
height: 0.55rem;
border-radius: 999px;
background: linear-gradient(
90deg,
rgba(31, 41, 55, 0.9),
rgba(55, 65, 81, 0.85),
rgba(31, 41, 55, 0.9)
);
background-size: 200% 100%;
animation: ps-shimmer 1.2s linear infinite;
margin-bottom: 0.3rem;
}
.ps-skeleton-line--lg {
width: 75%;
}
.ps-skeleton-line--short {
width: 40%;
}
@keyframes ps-shimmer {
0% {
background-position: 200% 0;
}
100% {
background-position: -200% 0;
}
}
.ps-empty {
font-size: 0.85rem;
color: var(--ps-color-text-muted);
padding: 0.4rem 0;
}
.ps-hint {
font-size: 0.82rem;
color: var(--ps-color-text-muted);
}
.ps-back-to-top {
position: fixed;
right: 1rem;
bottom: 1.1rem;
width: 38px;
height: 38px;
border-radius: 999px;
border: 1px solid rgba(148, 163, 184, 0.6);
background: radial-gradient(circle at top, rgba(30, 64, 175, 0.7), rgba(15, 23, 42, 0.98));
color:
display: flex;
align-items: center;
justify-content: center;
cursor: pointer;
opacity: 0;
pointer-events: none;
transform: translateY(8px);
transition: opacity var(--ps-transition-normal), transform var(--ps-transition-normal), box-shadow var(--ps-transition-fast);
box-shadow: 0 10px 30px rgba(15, 23, 42, 0.9);
z-index: 50;
}
.ps-back-to-top.is-visible {
opacity: 1;
pointer-events: auto;
transform: translateY(0);
}
.ps-back-to-top:hover {
box-shadow: 0 18px 40px rgba(15, 23, 42, 0.95);
}
.ps-toast-container {
position: fixed;
inset-inline: 0;
bottom: 0.85rem;
display: flex;
flex-direction: column;
gap: 0.4rem;
padding-inline: 0.75rem;
z-index: 60;
}
@media (min-width: 640px) {
.ps-toast-container {
align-items: center;
}
}
.ps-toast {
max-width: 360px;
width: 100%;
border-radius: var(--ps-radius-md);
padding: 0.6rem 0.75rem;
display: flex;
align-items: center;
justify-content: space-between;
gap: 0.5rem;
font-size: 0.82rem;
border: 1px solid rgba(148, 163, 184, 0.56);
background: rgba(15, 23, 42, 0.98);
box-shadow: var(--ps-shadow-card);
transform: translateY(8px);
opacity: 0;
animation: ps-toast-in 0.22s ease-out forwards;
}
.ps-toast-message {
flex: 1;
}
.ps-toast-close {
border: none;
background: transparent;
color: var(--ps-color-text-muted);
cursor: pointer;
padding: 0.1rem;
font-size: 1rem;
}
.ps-toast--success {
border-color: rgba(34, 197, 94, 0.7);
}
.ps-toast--error {
border-color: rgba(248, 113, 113, 0.8);
}
@keyframes ps-toast-in {
from {
opacity: 0;
transform: translateY(8px);
}
to {
opacity: 1;
transform: translateY(0);
}
}
.ps-install-banner {
position: fixed;
inset-inline: 0.5rem;
bottom: 4rem;
z-index: 55;
display: flex;
justify-content: center;
opacity: 0;
transform: translateY(12px);
transition: opacity var(--ps-transition-normal), transform var(--ps-transition-normal);
}
.ps-install-banner-inner {
max-width: 420px;
width: 100%;
border-radius: var(--ps-radius-lg);
padding: 0.6rem 0.75rem;
background: radial-gradient(circle at top left, rgba(37, 99, 235, 0.3), rgba(15, 23, 42, 0.98));
border: 1px solid rgba(148, 163, 184, 0.65);
box-shadow: var(--ps-shadow-card);
display: flex;
flex-direction: column;
gap: 0.5rem;
font-size: 0.82rem;
}
.ps-install-banner.is-visible {
opacity: 1;
transform: translateY(0);
}
.ps-install-banner-actions {
display: flex;
flex-wrap: wrap;
gap: 0.4rem;
}
.ps-auth {
min-height: calc(100vh - var(--ps-header-height) - 80px);
display: flex;
align-items: center;
justify-content: center;
padding: 1.5rem;
}
.ps-auth-card {
max-width: 420px;
width: 100%;
background: rgba(12, 16, 28, 0.92);
border: 1px solid rgba(148, 163, 184, 0.25);
border-radius: 16px;
padding: 1.25rem;
box-shadow: var(--ps-shadow-card);
}
.ps-auth-title {
margin: 0 0 0.4rem;
font-size: 1.4rem;
}
.ps-auth-subtitle {
margin: 0 0 1rem;
font-size: 0.9rem;
color: var(--ps-color-text-muted);
}
.ps-auth-tabs {
display: grid;
grid-template-columns: repeat(4, 1fr);
gap: 6px;
margin-bottom: 12px;
}
.ps-auth-tabs button {
padding: 0.45rem 0.35rem;
border-radius: 10px;
border: 1px solid rgba(148, 163, 184, 0.2);
background: rgba(255, 255, 255, 0.02);
color: var(--ps-color-text);
cursor: pointer;
font-weight: 600;
}
.ps-auth-tabs button.is-active {
border-color: var(--ps-color-primary);
background: rgba(13, 110, 253, 0.12);
box-shadow: 0 4px 16px rgba(13, 110, 253, 0.25);
}
.ps-auth-panels {
position: relative;
}
.ps-auth-panel {
display: none;
}
.ps-auth-panel.is-active {
display: block;
}
.ps-auth-placeholder {
padding: 1rem;
border: 1px dashed rgba(148, 163, 184, 0.4);
border-radius: 12px;
color: var(--ps-color-text-muted);
display: grid;
gap: 0.6rem;
text-align: center;
}
.ps-auth-footer {
margin-top: 0.75rem;
font-size: 0.8rem;
color: var(--ps-color-text-muted);
}
.ps-auth-footer a {
color: var(--ps-color-primary);
text-decoration: none;
}
.ps-auth-footer a:hover {
text-decoration: underline;
}
.ps-auth-alt {
display: grid;
gap: 8px;
margin-top: 12px;
}
.ps-alert {
border-radius: var(--ps-radius-sm);
padding: 0.4rem 0.55rem;
font-size: 0.8rem;
margin-bottom: 0.45rem;
}
.ps-alert--danger {
background: rgba(248, 113, 113, 0.12);
border: 1px solid rgba(248, 113, 113, 0.7);
color:
}
.ps-offline-icon {
font-size: 2.5rem;
margin-bottom: 0.75rem;
}
.ps-offline-actions {
margin-top: 1rem;
display: flex;
justify-content: center;
gap: 0.5rem;
flex-wrap: wrap;
}
.ps-animate-fade-up {
opacity: 0;
transform: translateY(8px);
animation: ps-fade-up 0.45s ease-out forwards;
}
.ps-animate-delay-1 {
animation-delay: 0.12s;
}
.ps-animate-stagger {
animation-delay: 0.04s;
}
.ps-animate-float {
animation: ps-float 6s ease-in-out infinite;
}
@keyframes ps-fade-up {
from {
opacity: 0;
transform: translateY(8px);
}
to {
opacity: 1;
transform: translateY(0);
}
}
@keyframes ps-float {
0% {
transform: translateY(0);
}
50% {
transform: translateY(-6px);
}
100% {
transform: translateY(0);
}
}
.ps-form-row input,
.ps-form-row select,
.ps-form-row textarea {
border-radius: 8px;
padding: 0.75rem 1rem;
}

# File 129/160: static\css\cinematic-ui.css
################################################################################

:root {
--cinematic-glow: radial-gradient(circle at center,
rgba(100, 200, 255, 0.4) 0%,
transparent 70%);
--hologram-effect: linear-gradient(45deg,
transparent 30%,
rgba(255, 255, 255, 0.1) 50%,
transparent 70%);
--quantum-shadow: 0 0 40px rgba(100, 200, 255, 0.3),
0 0 80px rgba(100, 200, 255, 0.2),
0 0 120px rgba(100, 200, 255, 0.1);
--hologram-glow: rgba(0, 255, 255, 0.8);
}
@property --hologram-glow {
syntax: '<color>';
inherits: false;
initial-value: rgba(0, 255, 255, 0.8);
}
.cinematic-surface {
position: relative;
overflow: hidden;
background: linear-gradient(135deg, rgba(12, 19, 39, 0.9), rgba(6, 11, 25, 0.9));
border: 1px solid rgba(255, 255, 255, 0.04);
box-shadow: 0 18px 60px rgba(0, 0, 0, 0.55), var(--quantum-shadow);
}
.cinematic-surface::before {
content: "";
position: absolute;
inset: -1px;
background: var(--cinematic-glow);
filter: blur(38px);
opacity: 0.55;
pointer-events: none;
}
.cinematic-surface::after {
content: "";
position: absolute;
inset: 0;
background: var(--hologram-effect);
opacity: 0.35;
mix-blend-mode: screen;
pointer-events: none;
}
.cinematic-button,
.quantum-toggle {
background: radial-gradient(circle at 20% 20%, rgba(59, 130, 246, 0.35), rgba(14, 165, 233, 0.12));
box-shadow: 0 10px 30px rgba(14, 165, 233, 0.35), 0 20px 60px rgba(6, 182, 212, 0.25);
border: 1px solid rgba(255, 255, 255, 0.08);
color:
padding: 0.5rem 0.9rem;
border-radius: 999px;
display: inline-flex;
align-items: center;
gap: 0.4rem;
cursor: pointer;
position: relative;
overflow: hidden;
}
.cinematic-button::after,
.quantum-toggle::after {
content: "";
position: absolute;
inset: 0;
background: linear-gradient(120deg, rgba(255, 255, 255, 0.12), rgba(255, 255, 255, 0));
opacity: 0;
transition: opacity 0.35s ease;
}
.cinematic-button:hover::after,
.quantum-toggle:hover::after {
opacity: 1;
}
.cinematic-marker {
animation: hologram-float 3s ease-in-out infinite;
filter: drop-shadow(0 0 20px var(--hologram-glow));
}
.quantum-pulse {
position: absolute;
inset: 0;
pointer-events: none;
border-radius: inherit;
background: radial-gradient(circle at 50% 45%, rgba(56, 189, 248, 0.15), transparent 60%);
animation: quantum-breathe 6s ease-in-out infinite;
}
.ai-forecast {
display: grid;
grid-template-columns: repeat(2, minmax(0, 1fr));
gap: 0.5rem;
margin-top: 0.35rem;
}
.ai-forecast-metric {
padding: 0.55rem 0.65rem;
border-radius: 0.75rem;
border: 1px solid rgba(59, 130, 246, 0.2);
background: rgba(15, 23, 42, 0.8);
box-shadow: inset 0 1px 0 rgba(255, 255, 255, 0.05);
}
.ai-forecast-label {
font-size: 0.7rem;
color:
display: block;
margin-bottom: 0.15rem;
}
.ai-forecast-value {
font-weight: 700;
font-size: 0.95rem;
letter-spacing: 0.01em;
}
.ai-reasoning {
margin-top: 0.5rem;
padding: 0.55rem 0.6rem;
border-radius: 0.75rem;
border: 1px dashed rgba(255, 255, 255, 0.16);
color:
background: rgba(79, 70, 229, 0.08);
}
@keyframes hologram-float {
0% { transform: translateY(0); }
50% { transform: translateY(-4px); }
100% { transform: translateY(0); }
}
@keyframes quantum-breathe {
0% { opacity: 0.2; }
50% { opacity: 0.55; }
100% { opacity: 0.2; }
}
[data-quantum-theme="dark"] body,
body[data-quantum-theme="dark"] {
background: radial-gradient(circle at top left,
}
[data-quantum-theme="light"] body,
body[data-quantum-theme="light"] {
background: radial-gradient(circle at top left,
color:
}
.ai-crest {
display: inline-flex;
align-items: center;
gap: 0.35rem;
padding: 0.35rem 0.8rem;
border-radius: 999px;
border: 1px solid rgba(255, 255, 255, 0.14);
background: linear-gradient(135deg, rgba(59, 130, 246, 0.18), rgba(16, 185, 129, 0.16));
box-shadow: 0 18px 45px rgba(15, 23, 42, 0.5);
}

# File 130/160: static\js\app.js
################################################################################

(function () {
"use strict";
window.ParkShare = window.ParkShare || {};
function qs(selector, scope) {
return (scope || document).querySelector(selector);
}
function qsa(selector, scope) {
return Array.prototype.slice.call((scope || document).querySelectorAll(selector));
}
function isMobileWidth() {
return window.matchMedia("(max-width: 767px)").matches;
}
if ("serviceWorker" in navigator) {
window.addEventListener("load", function () {
navigator.serviceWorker
.register("/service-worker.js")
.then(function (reg) {
console.log("[SW] registered", reg.scope);
})
.catch(function (err) {
console.warn("[SW] registration failed", err);
});
});
}
function initMenu() {
const toggle = qs("[data-menu-toggle]");
const menu = qs("[data-menu]");
if (!toggle || !menu) return;
function syncAria(isOpen) {
toggle.setAttribute("aria-expanded", String(isOpen));
toggle.setAttribute("aria-label", isOpen ? "–ó–∞–∫—Ä—ã—Ç—å –º–µ–Ω—é" : "–û—Ç–∫—Ä—ã—Ç—å –º–µ–Ω—é");
}
toggle.addEventListener("click", function () {
const isOpen = toggle.classList.toggle("is-open");
menu.classList.toggle("is-open", isOpen);
document.body.classList.toggle("ps-menu-open", isOpen);
syncAria(isOpen);
});
syncAria(toggle.classList.contains("is-open"));
qsa(".ps-nav-link", menu).forEach(function (link) {
link.addEventListener("click", function () {
toggle.classList.remove("is-open");
menu.classList.remove("is-open");
document.body.classList.remove("ps-menu-open");
syncAria(false);
});
});
}
function initSmoothScroll() {
qsa("[data-scroll-to]").forEach(function (el) {
el.addEventListener("click", function (e) {
const href = el.getAttribute("href");
if (!href || !href.startsWith("
const target = qs(href);
if (!target) return;
e.preventDefault();
window.scrollTo({
top: target.getBoundingClientRect().top + window.scrollY - 72,
behavior: "smooth"
});
});
});
}
function initBackToTop() {
const btn = qs("[data-back-to-top]");
if (!btn) return;
function onScroll() {
if (window.scrollY > 300) {
btn.classList.add("is-visible");
} else {
btn.classList.remove("is-visible");
}
}
window.addEventListener("scroll", onScroll, {passive: true});
onScroll();
btn.addEventListener("click", function () {
window.scrollTo({top: 0, behavior: "smooth"});
});
}
function showToast(message, type) {
type = type || "info";
const container = qs(".ps-toast-container");
if (!container) return;
const toast = document.createElement("div");
toast.className = "ps-toast ps-toast--" + type;
const msg = document.createElement("div");
msg.className = "ps-toast-message";
msg.textContent = message;
const close = document.createElement("button");
close.className = "ps-toast-close";
close.type = "button";
close.innerHTML = "√ó";
close.addEventListener("click", function () {
toast.remove();
});
toast.appendChild(msg);
toast.appendChild(close);
container.appendChild(toast);
setTimeout(function () {
toast.remove();
}, 4000);
}
let deferredPrompt = null;
const INSTALL_DISMISS_KEY = "pwaPromptDismissedUntil";
const INSTALL_DISMISS_DAYS = 30;
function isStandalone() {
return window.matchMedia("(display-mode: standalone)").matches || window.navigator.standalone;
}
function isMobileDevice() {
const ua = navigator.userAgent || "";
const isIOS = /iPhone|iPad|iPod/i.test(ua);
const isAndroid = /Android/i.test(ua);
const isCoarse = window.matchMedia && window.matchMedia("(pointer:coarse)").matches;
return isIOS || isAndroid || isCoarse;
}
function dismissedUntil() {
try {
const value = localStorage.getItem(INSTALL_DISMISS_KEY);
return value ? parseInt(value, 10) : 0;
} catch (_) {
return 0;
}
}
function markDismiss(days) {
try {
const until = Date.now() + days * 24 * 60 * 60 * 1000;
localStorage.setItem(INSTALL_DISMISS_KEY, String(until));
} catch (_) {}
}
function canShowBanner() {
if (!isMobileDevice() || isStandalone()) return false;
const until = dismissedUntil();
if (until && until > Date.now()) return false;
return true;
}
function initInstallBanner() {
const banner = qs("[data-install-banner]");
const btnAccept = qs("[data-install-accept]", banner);
const btnDismiss = qs("[data-install-dismiss]", banner);
const menuButton = qs("[data-nav-install-app]");
const fallbackUrl = (menuButton && menuButton.getAttribute("data-install-href")) || "/pwa-install/";
if (!banner || !btnAccept || !btnDismiss) return;
function hideBanner() {
banner.classList.remove("is-visible");
setTimeout(function () { banner.hidden = true; }, 200);
}
function showBanner() {
if (!canShowBanner()) return;
banner.hidden = false;
requestAnimationFrame(function () { banner.classList.add("is-visible"); });
}
function triggerInstall(source) {
if (deferredPrompt) {
deferredPrompt.prompt();
deferredPrompt.userChoice
.then(function (choiceResult) {
if (choiceResult.outcome === "accepted") {
showToast("–£—Å—Ç–∞–Ω–æ–≤–∫–∞ ParkShare RU –∑–∞–ø—É—â–µ–Ω–∞", "success");
markDismiss(365);
}
})
.finally(function () {
deferredPrompt = null;
hideBanner();
});
} else {
if (fallbackUrl) {
window.location.href = fallbackUrl;
} else {
showToast("–û—Ç–∫—Ä–æ–π—Ç–µ –º–µ–Ω—é –±—Ä–∞—É–∑–µ—Ä–∞ –∏ –≤—ã–±–µ—Ä–∏—Ç–µ ¬´–î–æ–±–∞–≤–∏—Ç—å –Ω–∞ —ç–∫—Ä–∞–Ω¬ª", "info");
}
hideBanner();
}
}
if (menuButton) {
if (!isMobileDevice() || isStandalone()) {
menuButton.style.display = "none";
}
menuButton.addEventListener("click", function () { triggerInstall("menu"); });
}
window.addEventListener("beforeinstallprompt", function (e) {
e.preventDefault();
deferredPrompt = e;
if (canShowBanner()) {
showBanner();
}
});
btnDismiss.addEventListener("click", function () {
markDismiss(INSTALL_DISMISS_DAYS);
hideBanner();
deferredPrompt = null;
});
btnAccept.addEventListener("click", function () { triggerInstall("banner"); });
window.addEventListener("appinstalled", function () {
markDismiss(365);
hideBanner();
});
if (canShowBanner()) {
showBanner();
}
}
function initSkeletons() {
const cards = qsa(".ps-card--skeleton");
if (!cards.length) return;
window.setTimeout(function () {
cards.forEach(function (card) {
card.parentNode && card.parentNode.removeChild(card);
});
}, 350);
}
function initSpotsSheet() {
const panel = qs("[data-spots-panel]");
if (!panel) return;
const triggers = qsa("[data-open-spots]");
function setState(open) {
panel.classList.toggle("is-sheet-open", open);
if (open) {
panel.scrollIntoView({ behavior: "smooth" });
}
}
triggers.forEach(function (btn) {
btn.addEventListener("click", function () {
const next = !panel.classList.contains("is-sheet-open");
setState(next);
});
});
window.addEventListener("resize", function () {
if (!isMobileWidth()) {
panel.classList.remove("is-sheet-open");
}
});
}
function initAdaptiveProbe() {
const payload = {
width: window.innerWidth,
height: window.innerHeight,
pixelRatio: window.devicePixelRatio || 1,
platform: document.documentElement.getAttribute("data-platform") || "RU",
};
fetch("/api/ai/parkmate/config/", {
method: "POST",
credentials: "include",
headers: {
"Content-Type": "application/json",
},
body: JSON.stringify({
client: payload,
action: "adaptive-profile",
}),
keepalive: true,
}).catch(function () {
});
}
function initGeolocation() {
const buttons = qsa("[data-fill-location]");
if (!buttons.length) return;
function fill(lat, lng) {
const latInput = qs("
const lngInput = qs("
if (!latInput || !lngInput) return;
latInput.value = lat.toFixed(5);
lngInput.value = lng.toFixed(5);
showToast("–ö–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã –æ–ø—Ä–µ–¥–µ–ª–µ–Ω—ã, –Ω–∞–∂–º–∏—Ç–µ ¬´–ù–∞–π—Ç–∏ –º–µ—Å—Ç–∞¬ª", "success");
}
buttons.forEach(function (btn) {
btn.addEventListener("click", function () {
if (!("geolocation" in navigator)) {
showToast("–ì–µ–æ–ª–æ–∫–∞—Ü–∏—è –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞ –≤ —ç—Ç–æ–º –±—Ä–∞—É–∑–µ—Ä–µ", "error");
return;
}
navigator.geolocation.getCurrentPosition(
function (pos) {
fill(pos.coords.latitude, pos.coords.longitude);
},
function () {
showToast("–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ", "error");
},
{
enableHighAccuracy: false,
timeout: 8000,
maximumAge: 60000
}
);
});
});
}
const PAYMENT_METHODS_ENDPOINT = "/api/payments/methods/";
function getCSRFToken() {
const match = document.cookie.match(/csrftoken=([^;]+)/);
return match ? match[1] : "";
}
function detectBrand(num) {
if (!num) return "other";
if (/^4/.test(num)) return "visa";
if (/^5[1-5]/.test(num)) return "mc";
if (/^220[0-4]/.test(num)) return "mir";
if (/^62/.test(num)) return "up";
return "other";
}
function renderPaymentMethods(methods, container) {
if (!container) return;
if (!methods || !methods.length) {
container.innerHTML = "<div class='ps-empty'>–ö–∞—Ä—Ç—ã –ø–æ–∫–∞ –Ω–µ –¥–æ–±–∞–≤–ª–µ–Ω—ã.</div>";
return;
}
container.innerHTML = methods
.map(function (method) {
const brand = method.brand ? method.brand.toUpperCase() : "CARD";
const defaultBadge = method.is_default ? "<span class='ps-badge ps-badge--success'>–ü–æ —É–º–æ–ª—á–∞–Ω–∏—é</span>" : "";
return (
"<div class='ps-payment-card'>" +
"<div>" +
"<div class='ps-payment-brand'>" + brand + " ¬∑ " + (method.mask || ("**** " + method.last4)) + " " + defaultBadge + "</div>" +
"<div class='ps-payment-meta'>–°—Ä–æ–∫: " + method.exp_month + "/" + method.exp_year + (method.label ? " ¬∑ " + method.label : "") + "</div>" +
"</div>" +
"<div class='ps-payment-actions'>" +
"<button class='ps-btn ps-btn-ghost ps-btn-sm' data-payment-default='" + method.id + "'>–°–¥–µ–ª–∞—Ç—å –æ—Å–Ω.</button>" +
"<button class='ps-btn ps-btn-ghost ps-btn-sm' data-payment-delete='" + method.id + "'>–£–¥–∞–ª–∏—Ç—å</button>" +
"</div>" +
"</div>"
);
})
.join("");
}
function initPaymentMethods() {
const container = qs("[data-payment-methods]");
const form = qs("[data-payment-method-form]");
if (!container && !form) return;
function loadMethods() {
fetch(PAYMENT_METHODS_ENDPOINT, { credentials: "include" })
.then(function (resp) { return resp.json(); })
.then(function (data) { renderPaymentMethods(data.results || data, container); })
.catch(function () { showToast("–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å —Å–ø–æ—Å–æ–±—ã –æ–ø–ª–∞—Ç—ã", "error"); });
}
if (form) {
form.addEventListener("submit", function (evt) {
evt.preventDefault();
const fd = new FormData(form);
const cardNumber = (fd.get("card_number") || "").replace(/\D/g, "");
const exp = (fd.get("exp") || "").split("/");
const expMonth = parseInt(exp[0], 10) || 1;
const expYear = parseInt((exp[1] || "").replace(/[^0-9]/g, ""), 10) || 30;
const payload = {
label: fd.get("label") || fd.get("provider") || "–ú–æ—è –∫–∞—Ä—Ç–∞",
brand: detectBrand(cardNumber),
last4: cardNumber.slice(-4) || "0000",
exp_month: expMonth,
exp_year: expYear,
is_default: fd.get("is_default") === "on",
token_masked: "tok_" + (cardNumber.slice(-6) || "card") + Date.now(),
};
fetch(PAYMENT_METHODS_ENDPOINT, {
method: "POST",
credentials: "include",
headers: {
"Content-Type": "application/json",
"X-CSRFToken": getCSRFToken(),
},
body: JSON.stringify(payload),
})
.then(function (resp) { return resp.json(); })
.then(function () {
showToast("–ö–∞—Ä—Ç–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞", "success");
form.reset();
loadMethods();
})
.catch(function () { showToast("–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å –∫–∞—Ä—Ç—É", "error"); });
});
}
if (container) {
container.addEventListener("click", function (evt) {
const defBtn = evt.target.closest("[data-payment-default]");
const delBtn = evt.target.closest("[data-payment-delete]");
if (defBtn) {
const id = defBtn.getAttribute("data-payment-default");
fetch(PAYMENT_METHODS_ENDPOINT + id + "/", {
method: "PATCH",
credentials: "include",
headers: {
"Content-Type": "application/json",
"X-CSRFToken": getCSRFToken(),
},
body: JSON.stringify({ is_default: true }),
})
.then(function (resp) { return resp.json(); })
.then(function () { showToast("–ö–∞—Ä—Ç–∞ –≤—ã–±—Ä–∞–Ω–∞ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é", "success"); loadMethods(); })
.catch(function () { showToast("–ù–µ —É–¥–∞–ª–æ—Å—å –æ–±–Ω–æ–≤–∏—Ç—å –∫–∞—Ä—Ç—É", "error"); });
}
if (delBtn) {
const id = delBtn.getAttribute("data-payment-delete");
fetch(PAYMENT_METHODS_ENDPOINT + id + "/", {
method: "DELETE",
credentials: "include",
headers: { "X-CSRFToken": getCSRFToken() },
})
.then(function (resp) { if (!resp.ok) throw new Error(); })
.then(function () { showToast("–ö–∞—Ä—Ç–∞ —É–¥–∞–ª–µ–Ω–∞", "info"); loadMethods(); })
.catch(function () { showToast("–ù–µ —É–¥–∞–ª–æ—Å—å —É–¥–∞–ª–∏—Ç—å –∫–∞—Ä—Ç—É", "error"); });
}
});
}
loadMethods();
}
var ChatWidget = (function () {
let root, toggle, panel, overlay, input, sendBtn, body, statusEl, closeBtn;
let isOpen = false;
let isLoading = false;
let messages = [];
function setStatus(text, visible) {
if (!statusEl) return;
statusEl.textContent = text || "";
statusEl.hidden = !visible;
}
function isSheetMode() {
return isMobileWidth();
}
function applyLayout() {
if (!root) return;
root.classList.toggle("is-sheet", isSheetMode());
}
function persistState(openState) {
try {
localStorage.setItem("psChatState", openState ? "open" : "closed");
} catch (e) {}
}
function syncState(nextOpen) {
isOpen = !!nextOpen;
if (!root) return;
root.classList.toggle("is-open", isOpen);
root.classList.toggle("is-sheet-open", isOpen && isSheetMode());
if (panel) {
panel.setAttribute("aria-hidden", String(!isOpen));
}
if (toggle) {
toggle.setAttribute("aria-expanded", String(isOpen));
}
document.body.classList.toggle("ps-chat-open", isOpen && !isSheetMode());
if (window.ParkShare && typeof window.ParkShare.setBottomNavActive === "function") {
window.ParkShare.setBottomNavActive(isOpen ? "chat" : null);
}
}
function openPanel() {
syncState(true);
applyLayout();
if (input) {
input.focus({ preventScroll: isSheetMode() });
}
persistState(true);
}
function closePanel() {
syncState(false);
persistState(false);
}
function togglePanel() {
if (isOpen) {
closePanel();
} else {
openPanel();
}
}
function sendFeedback(messageId, rating, container) {
fetch("/api/ai/chat/feedback/", {
method: "POST",
credentials: "include",
headers: {"Content-Type": "application/json"},
body: JSON.stringify({message_id: messageId, rating: rating}),
}).catch(function () {
console.debug("Feedback failed");
});
if (!container) return;
qsa("button", container).forEach(function (btn) {
btn.classList.toggle("is-active", btn.getAttribute("data-rating") == String(rating));
});
}
function renderSuggestions(suggestions, messageId) {
if (!suggestions || !suggestions.length) return null;
const list = document.createElement("div");
list.className = "ps-chat-spots";
suggestions.forEach(function (spot) {
const card = document.createElement("div");
card.className = "ps-chat-spot-card";
const badges = [];
if (spot.tags && spot.tags.length) {
badges.push(spot.tags.join(" ¬∑ "));
}
if (spot.allow_dynamic_pricing) badges.push("AI-—Ç–∞—Ä–∏—Ñ");
if (spot.ev || spot.has_ev_charging) badges.push("EV");
if (spot.is_covered) badges.push("–ö—Ä—ã—Ç–∞—è");
if (spot.is_24_7) badges.push("24/7");
const metaParts = [
spot.price ? spot.price + " ‚ÇΩ/—á–∞—Å" : null,
spot.distance_m ? "~" + Math.round(spot.distance_m) + " –º" : null,
spot.occupancy_now != null ? "–°–≤–æ–±–æ–¥–Ω–æ: " + Math.round((1 - spot.occupancy_now) * 100) + "%" : null,
].filter(Boolean);
const title = spot.title || spot.name || "–ü–∞—Ä–∫–æ–≤–∫–∞";
card.innerHTML =
"<div class='ps-chat-spot-title'>" + title + "</div>" +
"<div class='ps-chat-spot-meta'>" + metaParts.join(" ¬∑ ") + (badges.length ? " ¬∑ " + badges.join(" ¬∑ ") : "") + "</div>" +
"<div class='ps-chat-spot-actions'>" +
"<button type='button' class='ps-btn ps-btn-ghost ps-btn-sm' data-spot-map>–ü–æ–∫–∞–∑–∞—Ç—å –Ω–∞ –∫–∞—Ä—Ç–µ</button>" +
"</div>";
const mapBtn = card.querySelector("[data-spot-map]");
mapBtn.addEventListener("click", function () {
const event = new CustomEvent("ps:focus-spot", {detail: {spotId: spot.spot_id || spot.id}});
window.dispatchEvent(event);
if (isSheetMode()) closePanel();
});
list.appendChild(card);
});
if (messageId) {
const feedback = document.createElement("div");
feedback.className = "ps-chat-feedback";
feedback.innerHTML =
"<span>–ü–æ–¥—Å–∫–∞–∑–∫–∞ –ø–æ–º–æ–≥–ª–∞?</span>" +
"<div class='ps-chat-feedback-actions'>" +
"<button type='button' data-rating='1' aria-label='–ü–æ–ª–µ–∑–Ω–æ'>üëç</button>" +
"<button type='button' data-rating='-1' aria-label='–ù–µ –ø–æ–ª–µ–∑–Ω–æ'>üëé</button>" +
"</div>";
feedback.querySelectorAll("button").forEach(function (btn) {
btn.addEventListener("click", function () {
sendFeedback(messageId, parseInt(btn.getAttribute("data-rating"), 10), feedback);
});
});
list.appendChild(feedback);
}
return list;
}
function appendBubble(message) {
if (!body) return;
const item = document.createElement("div");
item.className = "ps-chat-bubble ps-chat-bubble--" + (message.role === "assistant" ? "bot" : "user");
const text = document.createElement("div");
text.className = "ps-chat-text";
text.textContent = message.text;
item.appendChild(text);
if (message.reason) {
const meta = document.createElement("div");
meta.className = "ps-chat-meta";
meta.textContent = "–ü–æ—á–µ–º—É —Ç–∞–∫: " + message.reason;
item.appendChild(meta);
}
const suggestions = renderSuggestions(message.suggestions, message.id);
if (suggestions) item.appendChild(suggestions);
body.appendChild(item);
body.scrollTop = body.scrollHeight;
}
function sendMessage() {
const text = (input.value || "").trim();
if (!text || isLoading) return;
const userMsg = {role: "user", text: text};
messages.push(userMsg);
appendBubble(userMsg);
input.value = "";
isLoading = true;
setStatus("–ê—Å—Å–∏—Å—Ç–µ–Ω—Ç –ø–µ—á–∞—Ç–∞–µ—Ç‚Ä¶", true);
sendBtn.disabled = true;
const history = messages.slice(-6).map(function (msg) {
return {role: msg.role === "assistant" ? "assistant" : "user", text: msg.text};
});
fetch("/api/ai/chat/parking/", {
method: "POST",
credentials: "include",
headers: {"Content-Type": "application/json"},
body: JSON.stringify({message: text, history: history}),
})
.then(function (resp) { return resp.json(); })
.then(function (data) {
const botMsg = {
role: "assistant",
text: data.reply || data.answer || "–ì–æ—Ç–æ–≤ –ø–æ–º–æ—á—å —Å –ø–æ–∏—Å–∫–æ–º –ø–∞—Ä–∫–æ–≤–∫–∏.",
suggestions: data.suggestions || data.spots || [],
reason: data.reason,
id: data.message_id,
};
messages.push(botMsg);
appendBubble(botMsg);
})
.catch(function () {
const fallback = {role: "assistant", text: "–ù–µ —É–¥–∞–ª–æ—Å—å –æ–±—Ä–∞—Ç–∏—Ç—å—Å—è –∫ –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç—É."};
messages.push(fallback);
appendBubble(fallback);
})
.finally(function () {
isLoading = false;
sendBtn.disabled = false;
setStatus("", false);
});
}
function init() {
root = qs("[data-chat]");
if (!root) return;
toggle = qs("[data-chat-toggle]", root);
panel = qs("[data-chat-panel]", root);
overlay = qs("[data-chat-overlay]", root);
input = qs("[data-chat-input]", root);
sendBtn = qs("[data-chat-send]", root);
body = qs("[data-chat-body]", root);
statusEl = qs("[data-chat-status]", root);
closeBtn = qs("[data-chat-close]", root);
const openLinks = qsa("[data-chat-open-link]");
applyLayout();
const savedState = (function () {
try { return localStorage.getItem("psChatState"); } catch (e) { return null; }
})();
syncState(savedState === "open");
const welcome = {
role: "assistant",
text: "–ü—Ä–∏–≤–µ—Ç! –ù–∞–ø–∏—à–∏—Ç–µ –∞–¥—Ä–µ—Å, –º–µ—Ç—Ä–æ –∏–ª–∏ –≤—Ä–µ–º—è ‚Äî –ø–æ–¥—Å–∫–∞–∂—É —Å–≤–æ–±–æ–¥–Ω—ã–µ –º–µ—Å—Ç–∞ –∏ —Ç–∞—Ä–∏—Ñ—ã.",
};
messages.push(welcome);
appendBubble(welcome);
if (toggle) toggle.addEventListener("click", togglePanel);
if (closeBtn) closeBtn.addEventListener("click", closePanel);
if (overlay) overlay.addEventListener("click", closePanel);
openLinks.forEach(function (link) {
link.addEventListener("click", function (e) {
e.preventDefault();
openPanel();
if (isSheetMode() && panel) {
panel.scrollTo({ top: panel.scrollHeight });
}
});
});
if (sendBtn) sendBtn.addEventListener("click", sendMessage);
if (input) {
input.addEventListener("keydown", function (e) {
if (e.key === "Enter" && !e.shiftKey) {
e.preventDefault();
sendMessage();
}
});
}
document.addEventListener("keydown", function (e) {
if (e.key === "Escape" && !isSheetMode() && isOpen) {
closePanel();
}
});
window.addEventListener("resize", function () {
applyLayout();
if (!isSheetMode() && isOpen) {
document.body.classList.add("ps-chat-open");
}
});
}
return {
init: init,
open: openPanel,
close: closePanel,
toggle: togglePanel,
};
})();
window.ParkShare = window.ParkShare || {};
window.ParkShare.ChatWidget = ChatWidget;
function initBottomNav() {
const nav = qs("[data-bottom-nav]");
if (!nav) return;
const items = qsa("[data-nav]", nav);
const defaultKey = (function () {
const path = window.location.pathname;
if (path.indexOf("/accounts") === 0) return "profile";
if (path.indexOf("/parking/user") === 0) return "bookings";
return "map";
})();
function setActive(key) {
const target = key || defaultKey;
items.forEach(function (item) {
const current = item.getAttribute("data-nav");
item.classList.toggle("is-active", current === target);
});
}
items.forEach(function (item) {
item.addEventListener("click", function () {
const key = item.getAttribute("data-nav");
if (key === "chat") {
setActive("chat");
if (window.ParkShare && window.ParkShare.ChatWidget) {
window.ParkShare.ChatWidget.open();
}
return;
}
if (key) setActive(key);
});
});
setActive(defaultKey);
window.ParkShare = window.ParkShare || {};
window.ParkShare.setBottomNavActive = setActive;
}
document.addEventListener("DOMContentLoaded", function () {
initMenu();
initSmoothScroll();
initBackToTop();
initInstallBanner();
initSkeletons();
initSpotsSheet();
initAdaptiveProbe();
initGeolocation();
initPaymentMethods();
ChatWidget.init();
initBottomNav();
});
window.ParkShare = window.ParkShare || {};
window.ParkShare.showToast = showToast;
})();

# File 131/160: static\js\map.js
################################################################################

(function () {
"use strict";
function qs(sel, ctx) { return (ctx || document).querySelector(sel); }
function qsa(sel, ctx) { return Array.prototype.slice.call((ctx || document).querySelectorAll(sel)); }
var MAP_CONFIG = window.PARKSHARE_MAP_PROVIDER || {};
var priceRange = [0, 1500];
var MAP_THEME_KEY = "ps-map-theme";
var storedTheme = null;
try { storedTheme = localStorage.getItem(MAP_THEME_KEY); } catch (_) {}
var prefersDark = window.matchMedia && window.matchMedia("(prefers-color-scheme: dark)").matches;
var isNight = (storedTheme || (prefersDark ? "dark" : "light")) === "dark";
var lastFeatures = [];
var userLocation = null;
function distanceKm(a, b) {
if (!a || !b) return 0;
var rad = Math.PI / 180;
var lat1 = a[0] * rad, lat2 = b[0] * rad, lon1 = a[1] * rad, lon2 = b[1] * rad;
var dlat = lat2 - lat1, dlon = lon2 - lon1;
var h = Math.sin(dlat / 2) ** 2 + Math.cos(lat1) * Math.cos(lat2) * Math.sin(dlon / 2) ** 2;
return 6371 * 2 * Math.atan2(Math.sqrt(h), Math.sqrt(1 - h));
}
function applyMapTheme(theme, provider, container) {
var mode = theme === "dark" ? "dark" : "light";
var mapEl = container || qs("
if (mapEl) {
mapEl.classList.toggle("ps-map--dark", mode === "dark");
mapEl.classList.toggle("ps-map--light", mode === "light");
}
document.body.classList.toggle("theme-dark", mode === "dark");
document.body.classList.toggle("ps-day-mode", mode === "light");
var btn = qs("[data-map-theme]");
if (btn) {
var isDark = mode === "dark";
btn.textContent = isDark ? "‚òÄÔ∏è" : "üåô";
btn.setAttribute("aria-pressed", String(isDark));
btn.classList.toggle("is-active", isDark);
btn.classList.add("is-animating");
btn.addEventListener("animationend", function handler() {
btn.classList.remove("is-animating");
btn.removeEventListener("animationend", handler);
});
}
try { localStorage.setItem(MAP_THEME_KEY, mode); } catch (_) {}
isNight = mode === "dark";
if (provider && provider.toggleTheme) provider.toggleTheme(isNight ? "night" : "day");
}
function BaseMapProvider(options) { this.options = options || {}; }
BaseMapProvider.prototype.init = function () {};
BaseMapProvider.prototype.setFeatures = function () {};
BaseMapProvider.prototype.setLoading = function () {};
BaseMapProvider.prototype.drawRouteTo = function () {};
BaseMapProvider.prototype.focusOn = function () {};
BaseMapProvider.prototype.onInteraction = function () {};
BaseMapProvider.prototype.toggleTheme = function () {};
BaseMapProvider.prototype.showUserLocation = function () {};
BaseMapProvider.prototype.setView = function () {};
function LeafletMapProvider(options) {
BaseMapProvider.call(this, options);
this._map = null;
this._markersLayer = null;
this._tileLayers = {};
this._currentTile = "day";
this._activeRoute = null;
this._highlight = null;
}
LeafletMapProvider.prototype = Object.create(BaseMapProvider.prototype);
LeafletMapProvider.prototype.init = function (container, center, zoom) {
if (typeof L === "undefined") return;
this._map = L.map(container, { center: center, zoom: zoom, scrollWheelZoom: false });
this._tileLayers.day = this._createBaseLayer("light");
this._tileLayers.night = this._createBaseLayer("dark");
this._tileLayers.day.addTo(this._map);
this._markersLayer = L.markerClusterGroup({ chunkedLoading: true, spiderfyOnMaxZoom: true }).addTo(this._map);
};
LeafletMapProvider.prototype._createBaseLayer = function (mode) {
var url = mode === "dark"
? "https:
: "https:
return L.tileLayer(url, { maxZoom: 20 });
};
LeafletMapProvider.prototype.setFeatures = function (fc) {
if (!this._map || !this._markersLayer) return;
var layer = this._markersLayer;
layer.clearLayers();
var bounds = [];
(fc.features || []).forEach(function (feature) {
var coords = feature.geometry && feature.geometry.coordinates;
if (!coords) return;
var lng = coords[0], lat = coords[1];
var p = feature.properties || {};
var stress = p.stress_index || 0;
var color = stress >= 0.8 ? "
var marker = L.circleMarker([lat, lng], { radius: 12, weight: 2, color: color, fillColor: color, fillOpacity: 0.92 });
marker.bindPopup(buildPopupHtml(p, color), { className: "ps-map-popup-card" });
marker.addTo(layer);
bounds.push([lat, lng]);
});
lastFeatures = fc.features || [];
if (bounds.length) this._map.fitBounds(bounds, { padding: [72, 72] });
};
LeafletMapProvider.prototype.toggleTheme = function (mode) {
if (!this._map) return;
var next = mode === "night" ? "night" : mode === "day" ? "day" : (this._currentTile === "day" ? "night" : "day");
this._map.removeLayer(this._tileLayers[this._currentTile]);
this._tileLayers[next].addTo(this._map);
this._currentTile = next;
};
LeafletMapProvider.prototype.setLoading = function (isLoading) {
var el = qs("[data-map-loading]");
if (el) el.style.display = isLoading ? "flex" : "none";
};
LeafletMapProvider.prototype.drawRouteTo = function (target, fromCoords, onHint) {
if (!this._map || !target) return;
if (this._activeRoute) this._activeRoute.remove();
var origin = fromCoords ? L.latLng(fromCoords.lat, fromCoords.lng) : this._map.getCenter();
var dest = target.lat != null ? L.latLng(target.lat, target.lng) : L.latLng(target[0], target[1]);
this._activeRoute = L.polyline([origin, dest], { color: "
var km = distanceKm([origin.lat, origin.lng], [dest.lat, dest.lng]);
if (onHint) onHint(km);
this._map.fitBounds(this._activeRoute.getBounds(), { padding: [56, 56] });
};
LeafletMapProvider.prototype.focusOn = function (lat, lng) {
if (!this._map) return;
if (this._highlight) this._highlight.remove();
this._highlight = L.circleMarker([lat, lng], { color: "
this._map.setView([lat, lng], 15);
};
LeafletMapProvider.prototype.onInteraction = function (start, end) {
if (!this._map) return;
if (start) this._map.on("movestart zoomstart dragstart", start);
if (end) this._map.on("moveend zoomend dragend", end);
};
LeafletMapProvider.prototype.showUserLocation = function (lat, lng) {
if (!this._map) return;
var radius = L.circle([lat, lng], { radius: 450, color: "
radius.bringToBack();
};
LeafletMapProvider.prototype.setView = function (lat, lng, zoom) {
if (!this._map) return;
this._map.setView([lat, lng], zoom || this._map.getZoom());
};
function YandexMapProvider(options) {
BaseMapProvider.call(this, options);
this._map = null;
this._clusterer = null;
this._activeRoute = null;
this._highlight = null;
this._ready = false;
this._theme = options.theme || "day";
this._mapTypesReady = false;
this._heatLayer = null;
}
YandexMapProvider.prototype = Object.create(BaseMapProvider.prototype);
YandexMapProvider.prototype._ensureMapTypes = function () {
if (this._mapTypesReady || typeof ymaps === "undefined") return;
var lightLayer = function () {
return new ymaps.Layer("https:
};
var darkLayer = function () {
return new ymaps.Layer("https:
};
ymaps.mapType.storage.add("ps
ymaps.mapType.storage.add("ps
this._mapTypesReady = true;
};
YandexMapProvider.prototype._ensureLayouts = function () {
if (this._markerLayout && this._clusterIconLayout && this._clusterBalloonLayout) return;
var markerTpl = [
"<div class='ps-map-marker {{properties.markerActive}} {{properties.markerHot ? \"ps-map-marker--hot\" : ''}}'>",
"  <div class='ps-map-marker__halo'></div>",
"  <div class='ps-map-marker__body' style='background: {{properties.markerColor}}'>",
"    <span class='ps-map-marker__value'>{{properties.markerLabel}}</span>",
"  </div>",
"</div>"
].join("");
this._markerLayout = ymaps.templateLayoutFactory.createClass(markerTpl, {
getShape: function () { return new ymaps.shape.Circle(new ymaps.geometry.pixel.Point([28, 28]), 26); },
});
var clusterTpl = "<div class='ps-map-cluster'><div class='ps-map-cluster__count'>{{properties.geoObjects.length}}</div></div>";
this._clusterIconLayout = ymaps.templateLayoutFactory.createClass(clusterTpl, {
build: function () {
this.constructor.superclass.build.call(this);
var node = this.getParentElement() && this.getParentElement().firstChild;
if (!node) return;
var geoObjects = (this.getData().properties.get("geoObjects") || []).map(function (g) { return g.properties.getAll(); });
var avg = geoObjects.reduce(function (acc, p) { return acc + (p.stress_index || 0); }, 0) / (geoObjects.length || 1);
node.classList.add(avg >= 0.75 ? "ps-map-cluster--danger" : avg >= 0.45 ? "ps-map-cluster--warn" : "ps-map-cluster--ok");
}
});
this._clusterBalloonLayout = ymaps.templateLayoutFactory.createClass("<div class='ps-map-popup ps-map-popup--list'></div>", {
build: function () {
this.constructor.superclass.build.call(this);
var container = this.getParentElement() && this.getParentElement().querySelector(".ps-map-popup--list");
if (!container) return;
var items = this.getData().properties.get("geoObjects") || [];
container.innerHTML = items.map(function (g) { return g.properties.get("balloonContent") || ""; }).join("");
}
});
};
YandexMapProvider.prototype.init = function (container, center, zoom) {
var self = this;
if (typeof ymaps === "undefined") return;
this._container = container;
ymaps.ready(function () {
self._ensureMapTypes();
self._map = new ymaps.Map(container, { center: center, zoom: zoom, type: isNight ? "ps
self._map.behaviors.disable("scrollZoom");
self._ensureLayouts();
self._clusterer = new ymaps.Clusterer({
clusterIconLayout: self._clusterIconLayout,
clusterIconOffset: [-28, -28],
clusterIconShape: { type: "Circle", coordinates: [28, 28], radius: 28 },
clusterNumbers: [50],
groupByCoordinates: false,
clusterDisableClickZoom: true,
clusterBalloonContentLayout: self._clusterBalloonLayout,
clusterBalloonPanelMaxMapArea: 0,
});
self._map.geoObjects.add(self._clusterer);
self._ready = true;
if (self._pending) { self.setFeatures(self._pending); self._pending = null; }
});
};
YandexMapProvider.prototype._renderHeat = function (features) {
if (!this._map) return;
if (this._heatLayer) { this._map.geoObjects.remove(this._heatLayer); }
var collection = new ymaps.GeoObjectCollection({}, { opacity: 0.35, fillOpacity: 0.18, strokeWidth: 0 });
features.slice(0, 40).forEach(function (f) {
var coords = f.geometry && f.geometry.coordinates; if (!coords) return;
var stress = f.properties && (f.properties.stress_index || 0);
if (!stress) return;
var radius = 250 + stress * 1200;
var color = stress > 0.75 ? "rgba(239,68,68,0.4)" : stress > 0.5 ? "rgba(245,158,11,0.4)" : "rgba(14,165,233,0.35)";
collection.add(new ymaps.Circle([[coords[1], coords[0]], radius], {}, { fillColor: color }));
});
this._heatLayer = collection;
this._map.geoObjects.add(collection);
};
YandexMapProvider.prototype.setFeatures = function (fc) {
if (typeof ymaps === "undefined") return;
if (!this._map || !this._ready) { this._pending = fc; return; }
this._ensureLayouts();
this._clusterer.removeAll();
var bounds = [];
var features = fc.features || [];
var prices = features.map(function (f) { return f.properties && f.properties.hourly_price; }).filter(function (v) { return typeof v === "number"; });
var avgPrice = prices.length ? prices.reduce(function (a, b) { return a + b; }, 0) / prices.length : null;
var self = this;
features.forEach(function (feature) {
var coords = feature.geometry && feature.geometry.coordinates; if (!coords) return;
var lng = coords[0], lat = coords[1];
var p = feature.properties || {};
var stress = p.stress_index || 0;
var allowAi = !!p.allow_dynamic_pricing;
var color = allowAi ? "
if (stress > 0.7) color = "
var isHot = avgPrice && p.hourly_price && p.hourly_price < avgPrice * 0.75;
var label = p.free_places != null ? p.free_places + " —Å–≤." : (p.hourly_price ? p.hourly_price + " ‚ÇΩ" : "?" );
var popupHtml = buildPopupHtml(p, color);
var placemark = new ymaps.Placemark([lat, lng], {
hintContent: (p.lot_name || "") + (p.name ? " ‚Äî " + p.name : ""),
balloonContent: popupHtml,
markerColor: color,
markerLabel: label,
markerHot: isHot,
stress_index: stress,
}, {
iconLayout: self._markerLayout,
iconOffset: [-26, -26],
hideIconOnBalloonOpen: false,
balloonPanelMaxMapArea: 0,
});
placemark.events.add("balloonopen", function () { self._setActive(placemark); self._map.panTo([lat, lng], { flying: true, duration: 400 }); });
placemark.events.add("balloonclose", function () { self._setActive(null); });
self._clusterer.add(placemark);
bounds.push([lat, lng]);
});
if (bounds.length) this._map.setBounds(bounds, { checkZoomRange: true, zoomMargin: 48 });
this._renderHeat(features);
};
YandexMapProvider.prototype._setActive = function (placemark) {
if (this._activePlacemark && this._activePlacemark !== placemark) {
this._activePlacemark.properties.set("markerActive", "");
this._activePlacemark.options.unset("zIndex");
}
this._activePlacemark = placemark;
if (placemark) { placemark.properties.set("markerActive", "ps-map-marker--active"); placemark.options.set("zIndex", 2200); }
};
YandexMapProvider.prototype.toggleTheme = function (mode) {
this._theme = mode || this._theme;
if (!this._map || !this._ready) return;
this._ensureMapTypes();
this._map.setType(this._theme === "night" ? "ps
};
YandexMapProvider.prototype.setLoading = LeafletMapProvider.prototype.setLoading;
YandexMapProvider.prototype.drawRouteTo = function (target, fromCoords, onHint) {
if (!this._map || !target) return;
if (this._activeRoute) this._map.geoObjects.remove(this._activeRoute);
var origin = fromCoords ? [fromCoords.lat, fromCoords.lng] : this._map.getCenter();
var dest = target.lat != null ? [target.lat, target.lng] : target;
this._activeRoute = new ymaps.Polyline([origin, dest], {}, { strokeColor: "
this._map.geoObjects.add(this._activeRoute);
var km = distanceKm(origin, dest);
if (onHint) onHint(km);
this._map.setBounds(this._activeRoute.geometry.getBounds(), { checkZoomRange: true, zoomMargin: 48 });
};
YandexMapProvider.prototype.focusOn = function (lat, lng) {
if (!this._map || !this._ready) return;
if (this._highlight) this._map.geoObjects.remove(this._highlight);
this._highlight = new ymaps.Circle([[lat, lng], 120], {}, { strokeColor: "
this._map.geoObjects.add(this._highlight);
this._map.setCenter([lat, lng], 15, { duration: 300 });
};
YandexMapProvider.prototype.onInteraction = function (start, end) {
var self = this;
if (!this._map || !this._ready) {
if (typeof ymaps !== "undefined") ymaps.ready(function () { self.onInteraction(start, end); });
return;
}
["actionbegin", "wheel", "mousedown", "touchstart"].forEach(function (ev) { if (start) self._map.events.add(ev, start); });
if (end) self._map.events.add("actionend", end);
};
YandexMapProvider.prototype.showUserLocation = function (lat, lng) {
if (!this._map || !this._ready) return;
if (this._userMarker) this._map.geoObjects.remove(this._userMarker);
if (this._userRadius) this._map.geoObjects.remove(this._userRadius);
this._userRadius = new ymaps.Circle([[lat, lng], 500], {}, { fillColor: "rgba(34,197,94,0.15)", strokeColor: "
this._userMarker = new ymaps.Placemark([lat, lng], {}, { preset: "islands
this._map.geoObjects.add(this._userRadius); this._map.geoObjects.add(this._userMarker);
};
YandexMapProvider.prototype.setView = function (lat, lng, zoom) {
if (!this._map || !this._ready) return;
this._map.setCenter([lat, lng], zoom || this._map.getZoom(), { duration: 300 });
};
function buildPopupHtml(props, color) {
var badges = [];
if (props.allow_dynamic_pricing) badges.push("<span class='ps-badge ps-badge--success'>AI‚Äë—Ç–∞—Ä–∏—Ñ</span>");
if (props.has_ev_charging) badges.push("<span class='ps-badge'>EV</span>");
if (props.is_covered) badges.push("<span class='ps-badge'>–ö—Ä—ã—Ç–∞—è</span>");
if (props.is_24_7) badges.push("<span class='ps-badge'>24/7</span>");
var occupancy = Math.min(100, Math.round((props.occupancy_7d || 0) * 100));
var stressTone = occupancy > 80 ? "danger" : occupancy > 60 ? "warn" : "ok";
return [
"<div class='ps-map-popup ps-map-popup--" + stressTone + "'>",
"  <header class='ps-map-popup-head'>",
"    <div class='ps-map-popup-title'>" + (props.city || "") + (props.lot_name ? ", " + props.lot_name : "") + (props.name ? " ‚Äî " + props.name : "") + "</div>",
"    <div class='ps-map-popup-meta'>" + (props.address || "–ê–¥—Ä–µ—Å —É—Ç–æ—á–Ω—è–µ—Ç—Å—è") + "</div>",
"  </header>",
"  <div class='ps-map-popup-price'>–æ—Ç <strong>" + (props.hourly_price || "?") + " ‚ÇΩ/—á–∞—Å</strong></div>",
"  <div class='ps-map-popup-badges'>" + badges.join(" ") + "</div>",
"  <div class='ps-map-popup-meter'><span style='width:" + occupancy + "%; background:" + color + "'></span><div class='ps-map-popup-meter-label'>–∑–∞–≥—Ä—É–∂–µ–Ω–Ω–æ—Å—Ç—å " + occupancy + "%</div></div>",
"  <div class='ps-map-popup-actions'>",
"    <button class='ps-btn ps-btn-primary ps-btn-sm' data-spot-id='" + (props.spot_id || props.id || "") + "'>–ó–∞–±—Ä–æ–Ω–∏—Ä–æ–≤–∞—Ç—å</button>",
"    <button class='ps-btn ps-btn-ghost ps-btn-sm' data-focus-spot='" + (props.spot_id || props.id || "") + "'>–ú–∞—Ä—à—Ä—É—Ç</button>",
"  </div>",
"</div>"
].join("");
}
function createProvider() {
var id = (MAP_CONFIG.key || MAP_CONFIG.id || "yandex").toLowerCase();
var fallback = (MAP_CONFIG.fallback || "leaflet").toLowerCase();
var center = MAP_CONFIG.default_center || [55.75, 37.61];
var zoom = MAP_CONFIG.default_zoom || 12;
var container = qs("
if (!container) return { provider: null, center: center, zoom: zoom };
var hasYandex = typeof ymaps !== "undefined";
var hasLeaflet = typeof L !== "undefined";
var provider = null;
var opts = Object.assign({}, MAP_CONFIG, { theme: isNight ? "night" : "day" });
if (id === "yandex" && hasYandex) provider = new YandexMapProvider(opts);
else if (id === "leaflet" && hasLeaflet) provider = new LeafletMapProvider(opts);
else if (fallback === "yandex" && hasYandex) provider = new YandexMapProvider(opts);
else if (hasLeaflet) provider = new LeafletMapProvider(opts);
if (!provider) return { provider: null, center: center, zoom: zoom };
provider.init(container, center, zoom);
return { provider: provider, center: center, zoom: zoom };
}
function readFilters() {
var form = qs("[data-map-filters]");
if (!form) return {};
var fd = new FormData(form);
return {
only_free: fd.get("only_free") === "on",
ev: fd.get("ev") === "on",
covered: fd.get("covered") === "on",
is_24_7: fd.get("is_24_7") === "on",
ai_recommended: fd.get("ai_recommended") === "on",
min_price: priceRange[0],
max_price: priceRange[1]
};
}
function buildQuery(params) {
var q = [];
Object.keys(params).forEach(function (k) {
var v = params[k];
if (v === "" || v === null || typeof v === "undefined") return;
if (typeof v === "boolean") v = v ? "true" : "false";
q.push(encodeURIComponent(k) + "=" + encodeURIComponent(v));
});
return q.length ? "?" + q.join("&") : "";
}
function fetchFeatures(provider) {
if (!provider) return;
provider.setLoading(true);
var url = "/api/parking/map/" + buildQuery(readFilters());
return fetch(url, { headers: { "Accept": "application/json" } })
.then(function (resp) { if (!resp.ok) throw new Error("Map API error"); return resp.json(); })
.then(function (data) {
provider.setFeatures(data);
lastFeatures = data.features || [];
updateSpotsList(data); updateStats(data);
})
.catch(function () {})
.finally(function () { provider.setLoading(false); });
}
function updateStats(fc) {
var features = fc.features || [];
var prices = features.map(function (f) { return f.properties && f.properties.hourly_price; }).filter(function (p) { return typeof p === "number"; });
var avgEl = qs("[data-avg-price]"); var countEl = qs("[data-spots-count]");
if (countEl) countEl.textContent = String(features.length);
if (!avgEl) return; if (!prices.length) { avgEl.textContent = "‚Äî"; return; }
var sum = prices.reduce(function (acc, p) { return acc + p; }, 0);
avgEl.textContent = (Math.round((sum / prices.length) / 10) * 10) + " ‚ÇΩ/—á–∞—Å";
}
function updateSpotsList(fc) {
var container = qs("[data-spots-list]"); if (!container) return;
var features = fc.features || [];
if (!features.length) { container.innerHTML = "<div class='ps-empty'><p>–ü–æ–¥—Ö–æ–¥—è—â–∏—Ö –º–µ—Å—Ç –ø–æ–∫–∞ –Ω–µ—Ç. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –∏–∑–º–µ–Ω–∏—Ç—å —Ñ–∏–ª—å—Ç—Ä—ã.</p></div>"; return; }
container.innerHTML = features.map(function (f) {
var p = f.properties || {}, tags = [];
if (p.has_ev_charging) tags.push("‚ö° EV"); if (p.is_covered) tags.push("üõ° –∫—Ä—ã—Ç–∞—è"); if (p.is_24_7) tags.push("‚è∞ 24/7");
var badge = p.allow_dynamic_pricing ? "<span class='ps-badge ps-badge--success'>AI‚Äë—Ç–∞—Ä–∏—Ñ</span>" : "";
return [
"<article class='ps-card ps-card--spot ps-animate-fade-up ps-animate-stagger' data-spot-card='" + (p.spot_id || f.id || "") + "'>",
"  <div class='ps-card-header'><div class='ps-card-title'>" + (p.city || "") + (p.lot_name ? ", " + p.lot_name : "") + (p.name ? " ‚Äî " + p.name : "") + "</div>" + badge + "</div>",
"  <div class='ps-card-body'>",
"    <div class='ps-card-line'>–æ—Ç " + (p.hourly_price || "?") + " ‚ÇΩ/—á–∞—Å" + (tags.length ? " ¬∑ " + tags.join(" ¬∑ ") : "") + "</div>",
"    <div class='ps-card-line ps-card-line--muted'>" + (p.address || "–ê–¥—Ä–µ—Å –±—É–¥–µ—Ç —É—Ç–æ—á–Ω—ë–Ω") + "</div>",
"  </div>",
"</article>"
].join("");
}).join("");
}
function initPriceSlider(onChange) {
var slider = qs("[data-price-slider]"); var priceLabel = qs("[data-price-display]");
if (!slider || typeof noUiSlider === "undefined") return;
function render(values) { if (priceLabel) priceLabel.textContent = "–¶–µ–Ω–∞: –æ—Ç " + values[0] + " ‚ÇΩ –¥–æ " + values[1] + " ‚ÇΩ"; }
noUiSlider.create(slider, { start: priceRange, connect: true, step: 50, range: { min: 0, max: 2000 } });
slider.noUiSlider.on("update", function (values) { priceRange = values.map(function (v) { return Math.round(parseFloat(v)); }); render(priceRange); if (onChange) onChange(); });
render(priceRange);
}
function updateRouteHint(km) {
var hint = qs("[data-route-hint]"); if (!hint) return;
if (!km) { hint.textContent = "–ü–æ—Å—Ç—Ä–æ–π—Ç–µ –º–∏–Ω–∏-–º–∞—Ä—à—Ä—É—Ç –¥–æ –≤—ã–±—Ä–∞–Ω–Ω–æ–π —Ç–æ—á–∫–∏."; return; }
var timeMin = Math.max(2, Math.round(km / 0.4));
hint.textContent = "~" + km.toFixed(1) + " –∫–º, " + timeMin + " –º–∏–Ω –ø–µ—à–∫–æ–º/–∞–≤—Ç–æ.";
}
function drawRoute(provider, targetLatLng) {
if (!provider || !targetLatLng || !provider.drawRouteTo) return;
var from = userLocation ? { lat: userLocation.lat, lng: userLocation.lng } : null;
provider.drawRouteTo({ lat: targetLatLng.lat || targetLatLng[0], lng: targetLatLng.lng || targetLatLng[1] }, from, function (km) { updateRouteHint(km); });
}
function initFloatingActions(provider) {
var actions = qs(".ps-map-floating-actions"); if (!actions) return;
var timer = null;
function dim() { actions.classList.add("is-dimmed"); }
function undim() { actions.classList.remove("is-dimmed"); startTimer(); }
function startTimer() { clearTimeout(timer); timer = setTimeout(dim, 3000); }
startTimer();
qsa(".ps-map-action", actions).forEach(function (btn) {
["mouseenter", "touchstart", "click"].forEach(function (evt) { btn.addEventListener(evt, undim, { passive: true }); });
});
if (provider && provider.onInteraction) provider.onInteraction(undim, startTimer);
}
function initGeocode(provider) {
var input = qs("[data-geocode-input]"); var submit = qs("[data-geocode-submit]"); var suggestions = qs("[data-geocode-suggestions]"); var timer = null;
function search(query) {
if (!query) return;
fetch("/api/geocode/?q=" + encodeURIComponent(query))
.then(function (resp) { return resp.json(); })
.then(function (data) {
var list = data.results || [];
suggestions.innerHTML = list.map(function (item) { return "<button type='button' data-geocode-choice data-lat='" + item.lat + "' data-lng='" + item.lng + "'>" + item.title + "</button>"; }).join("");
})
.catch(function () {});
}
if (input) {
input.addEventListener("input", function () { clearTimeout(timer); var value = input.value.trim(); timer = setTimeout(function () { search(value); }, 350); });
input.addEventListener("keydown", function (evt) { if (evt.key === "Enter") { evt.preventDefault(); search(input.value.trim()); } });
}
if (submit) submit.addEventListener("click", function () { search(input.value); });
if (suggestions) {
suggestions.addEventListener("click", function (e) {
var btn = e.target.closest("[data-geocode-choice]"); if (!btn) return;
var lat = parseFloat(btn.getAttribute("data-lat")); var lng = parseFloat(btn.getAttribute("data-lng"));
suggestions.innerHTML = "";
if (provider && provider.setView) { provider.setView(lat, lng, 15); drawRoute(provider, { lat: lat, lng: lng }); }
});
}
}
document.addEventListener("DOMContentLoaded", function () {
var mapContainer = qs("
var result = createProvider(); var provider = result.provider; if (!provider) return;
initPriceSlider(function () { fetchFeatures(provider); });
initGeocode(provider);
fetchFeatures(provider);
initFloatingActions(provider);
applyMapTheme(isNight ? "dark" : "light", provider, mapContainer);
var themeBtn = qs("[data-map-theme]");
if (themeBtn) themeBtn.addEventListener("click", function () { var next = isNight ? "light" : "dark"; themeBtn.classList.add("is-animating"); applyMapTheme(next, provider, mapContainer); });
var filtersForm = qs("[data-map-filters]");
if (filtersForm) filtersForm.addEventListener("change", function () { fetchFeatures(provider); });
qsa("[data-chip-toggle]").forEach(function (chip) {
var input = qs("input", chip); if (!input) return; chip.classList.toggle("is-active", input.checked);
chip.addEventListener("click", function (e) { if (e.target.tagName === "INPUT") return; input.checked = !input.checked; chip.classList.toggle("is-active", input.checked); input.dispatchEvent(new Event("change", { bubbles: true })); fetchFeatures(provider); });
});
var resetBtn = qs("[data-reset-filters]");
if (resetBtn) {
resetBtn.addEventListener("click", function () {
resetBtn.classList.remove("ps-map-action--spinning"); void resetBtn.offsetWidth; resetBtn.classList.add("ps-map-action--spinning");
if (filtersForm) filtersForm.reset(); priceRange = [0, 1500];
var slider = qs("[data-price-slider]"); if (slider && slider.noUiSlider) slider.noUiSlider.set(priceRange);
qsa("[data-chip-toggle]").forEach(function (chip) { chip.classList.remove("is-active"); });
fetchFeatures(provider);
});
}
qsa("[data-fill-location]").forEach(function (btn) {
btn.addEventListener("click", function () {
if (!navigator.geolocation) return; btn.classList.add("ps-map-action--pulse");
navigator.geolocation.getCurrentPosition(function (pos) {
userLocation = { lat: pos.coords.latitude, lng: pos.coords.longitude };
if (provider.showUserLocation) provider.showUserLocation(userLocation.lat, userLocation.lng);
if (provider.setView) provider.setView(userLocation.lat, userLocation.lng, 14);
btn.classList.remove("ps-map-action--pulse");
}, function () { btn.classList.remove("ps-map-action--pulse"); }, { timeout: 8000 });
});
});
var mapPanel = qs("[data-map-panel]");
if (mapPanel) {
mapPanel.addEventListener("click", function (e) {
var focusBtn = e.target.closest("[data-focus-spot]");
var bookBtn = e.target.closest("[data-spot-id]");
if (focusBtn) {
var id = focusBtn.getAttribute("data-focus-spot");
var match = (lastFeatures || []).find(function (f) { var fid = String(f.id); var pid = f.properties && f.properties.spot_id ? String(f.properties.spot_id) : null; return id && (fid === id || pid === id); });
if (match && match.geometry) { var coords = match.geometry.coordinates; var latlng = { lat: coords[1], lng: coords[0] }; if (provider.focusOn) provider.focusOn(latlng.lat, latlng.lng); drawRoute(provider, latlng); }
}
if (bookBtn) {
var targetId = bookBtn.getAttribute("data-spot-id");
var card = qs("[data-spot-card='" + targetId + "']");
if (card) card.scrollIntoView({ behavior: "smooth", block: "start" });
}
});
}
qsa("[data-spots-list]").forEach(function (list) {
list.addEventListener("click", function (e) {
var card = e.target.closest("[data-spot-card]"); if (!card) return;
var id = card.getAttribute("data-spot-card");
var match = (lastFeatures || []).find(function (f) { var fid = String(f.id); var pid = f.properties && f.properties.spot_id ? String(f.properties.spot_id) : null; return id && (fid === id || pid === id); });
if (match && match.geometry) { var coords = match.geometry.coordinates; var latlng = { lat: coords[1], lng: coords[0] }; if (provider.focusOn) provider.focusOn(latlng.lat, latlng.lng); drawRoute(provider, latlng); }
});
});
});
})();

# File 132/160: static\js\parkmate-ai.ts
################################################################################

export interface ParkMateVoiceCommands {
booking: string;
navigation: string;
payment: string;
support: string;
}
export interface ParkMateComputerVision {
licensePlateRecognition: string;
parkingSpotDetection: string;
damageDetection: string;
occupancyAnalytics: string;
}
export interface ParkMatePredictions {
arrivalTime: string;
priceForecast: string;
availability: string;
}
export interface ParkMateAI {
voiceCommands: ParkMateVoiceCommands;
computerVision: ParkMateComputerVision;
predictions: ParkMatePredictions;
}
export const parkMateConfig: ParkMateAI = {
voiceCommands: {
booking: "–ó–∞–±—Ä–æ–Ω–∏—Ä–æ–≤–∞—Ç—å –ø–∞—Ä–∫–æ–≤–∫—É —Ä—è–¥–æ–º",
navigation: "–ü–æ—Å—Ç—Ä–æ–∏—Ç—å –º–∞—Ä—à—Ä—É—Ç –¥–æ –ø–∞—Ä–∫–æ–≤–∫–∏",
payment: "–û–ø–ª–∞—Ç–∏—Ç—å —Ç–µ–∫—É—â—É—é –ø–∞—Ä–∫–æ–≤–∫—É",
support: "–°–≤—è–∑–∞—Ç—å—Å—è —Å –ø–æ–¥–¥–µ—Ä–∂–∫–æ–π ParkShare",
},
computerVision: {
licensePlateRecognition: "/api/ai/cv/license-plate/",
parkingSpotDetection: "/api/ai/cv/parking-occupancy/",
damageDetection: "/api/ai/cv/vehicle-damage/",
occupancyAnalytics: "/api/ai/stress-index/",
},
predictions: {
arrivalTime: "/api/ai/departure-assistant/",
priceForecast: "/api/ai/parkmate/price-forecast/",
availability: "/api/ai/parkmate/availability/",
},
};
export interface PriceForecastRequestPayload {
spotId: string;
}
export interface PriceForecastResponse {
spot_id: string;
lot_id: string;
currency: string;
base_price: number;
recommended_price: number;
min_price: number;
max_price: number;
discount_percent: number;
is_discount: boolean;
reason: string;
}
export interface AvailabilityForecastRequestPayload {
spotId?: string;
occupancy_7d?: number;
stress_index?: number;
}
export interface AvailabilityForecastResponse {
spot_id: string | null;
occupancy_7d: number;
stress_index: number;
as_of: string;
availability: {
next_1h: number;
next_3h: number;
next_24h: number;
};
}
async function jsonFetch<T>(
url: string,
options: RequestInit = {}
): Promise<T> {
const resp = await fetch(url, {
credentials: "include",
...options,
headers: {
"Content-Type": "application/json",
...(options.headers || {}),
},
});
if (!resp.ok) {
const text = await resp.text();
throw new Error(`Request failed ${resp.status}: ${text}`);
}
return (await resp.json()) as T;
}
export async function getPriceForecast(
payload: PriceForecastRequestPayload
): Promise<PriceForecastResponse> {
return jsonFetch<PriceForecastResponse>(
parkMateConfig.predictions.priceForecast,
{
method: "POST",
body: JSON.stringify({ spot_id: payload.spotId }),
}
);
}
export async function getAvailabilityForecast(
payload: AvailabilityForecastRequestPayload
): Promise<AvailabilityForecastResponse> {
return jsonFetch<AvailabilityForecastResponse>(
parkMateConfig.predictions.availability,
{
method: "POST",
body: JSON.stringify({
spot_id: payload.spotId,
occupancy_7d: payload.occupancy_7d,
stress_index: payload.stress_index,
}),
}
);
}
export async function fetchPriceForecast(
payload: PriceForecastRequestPayload
): Promise<PriceForecastResponse> {
return jsonFetch<PriceForecastResponse>(
parkMateConfig.predictions.priceForecast,
{
method: "POST",
body: JSON.stringify({ spot_id: payload.spotId }),
}
);
}
export async function fetchAvailabilityForecast(
payload: AvailabilityForecastRequestPayload
): Promise<AvailabilityForecastResponse> {
return jsonFetch<AvailabilityForecastResponse>(
parkMateConfig.predictions.availability,
{
method: "POST",
body: JSON.stringify({
spot_id: payload.spotId,
occupancy_7d: payload.occupancy_7d,
stress_index: payload.stress_index,
}),
}
);
}

# File 133/160: static\js\quantum-theme-manager.js
################################################################################

class QuantumThemeManager {
constructor(options = {}) {
this.themes = options.themes || {
dark: {
map: "dark",
css: "dark",
effects: "hologram-dark",
emotion: "calm",
},
light: {
map: "standard",
css: "light",
effects: "hologram-light",
emotion: "energetic",
},
};
this.currentTheme = "dark";
this.root = options.root || document.documentElement;
}
async switchTheme(theme) {
const config = this.themes[theme];
if (!config) return;
this.currentTheme = theme;
const tasks = [
this.switchCSSTheme(config.css),
this.switchEmotionalMode(config.emotion),
this.switchCinematicEffects(config.effects),
];
await Promise.all(tasks);
this.triggerThemeTransitionAnimation();
}
switchCSSTheme(css) {
this.root.dataset.quantumTheme = css;
document.body.dataset.quantumTheme = css;
return Promise.resolve();
}
switchEmotionalMode(emotion) {
document.body.dataset.emotion = emotion;
return Promise.resolve();
}
switchCinematicEffects(effects) {
document.body.dataset.cinematic = effects;
return Promise.resolve();
}
triggerThemeTransitionAnimation() {
const flash = document.createElement("div");
flash.className = "quantum-pulse";
document.body.appendChild(flash);
setTimeout(() => flash.remove(), 800);
}
bindToggle(buttonId) {
const btn = document.getElementById(buttonId);
if (!btn) return;
btn.addEventListener("click", () => {
const next = this.currentTheme === "dark" ? "light" : "dark";
btn.dataset.theme = next;
const label = btn.querySelector(".quantum-toggle__label");
if (label) {
label.textContent = next === "dark" ? "Dark Matter" : "Photon";
}
this.switchTheme(next);
});
}
}
window.initQuantumThemeManager = function initQuantumThemeManager() {
const manager = new QuantumThemeManager();
manager.bindToggle("themeToggle");
manager.switchTheme("dark");
return manager;
};

# File 134/160: templates\base.html
################################################################################

{% load static %}
<!doctype html>
<html lang="ru" data-platform="{{ PLATFORM_MODE|default:'RU' }}">
<head>
<meta charset="utf-8">
<title>{% block title %}ParkShare ‚Äî smart parking{% endblock %}</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<!-- PWA -->
<meta name="theme-color" content="
<link rel="manifest" href="{% url 'manifest' %}">
<link rel="apple-touch-icon" sizes="192x192" href="{% static 'icons/icon-192.png' %}">
<link rel="apple-touch-icon" sizes="512x512" href="{% static 'icons/icon-512.png' %}">
<!-- Favicon (–º–∏–Ω–∏–º–∞–ª—å–Ω—ã–π –Ω–∞–±–æ—Ä) -->
<link rel="icon" type="image/png" sizes="32x32" href="{% static 'icons/icon-72.png' %}">
<!-- –û—Å–Ω–æ–≤–Ω—ã–µ —Å—Ç–∏–ª–∏ PWA -->
<link rel="stylesheet" href="{% static 'css/app.css' %}">
{% block extra_head %}{% endblock %}
</head>
<body class="ps-body">
<header class="ps-header">
<nav class="ps-navbar">
<div class="ps-navbar-left">
<a href="{% url 'landing' %}" class="ps-logo">
<span class="ps-logo-main">ParkShare</span>
<span class="ps-logo-accent">{{ REGION_PROFILE }}</span>
</a>
{% if user.is_authenticated %}
<span class="ps-user-level" title="–í–∞—à —É—Ä–æ–≤–µ–Ω—å –ø–æ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è–º">
üéñÔ∏è {{ user.username }}
</span>
{% endif %}
</div>
<button class="ps-navbar-toggle" type="button" data-menu-toggle aria-label="–û—Ç–∫—Ä—ã—Ç—å –º–µ–Ω—é">
<span></span>
<span></span>
<span></span>
</button>
<div class="ps-navbar-menu" data-menu>
<a href="{% url 'landing' %}" class="ps-nav-link">–ì–ª–∞–≤–Ω–∞—è</a>
<a href="{% url 'user_dashboard' %}" class="ps-nav-link">–õ–∏—á–Ω—ã–π –∫–∞–±–∏–Ω–µ—Ç</a>
{% if user.is_authenticated and user.is_owner %}
<a href="{% url 'owner_dashboard' %}" class="ps-nav-link">–ö–∞–±–∏–Ω–µ—Ç –≤–ª–∞–¥–µ–ª—å—Ü–∞</a>
{% endif %}
<a href="{% url 'map_page' %}" class="ps-nav-link">–ö–∞—Ä—Ç–∞</a>
<button type="button" class="ps-nav-link ps-nav-link--ghost" data-chat-open-link>AI-–ø–æ–º–æ—â–Ω–∏–∫</button>
<button type="button" class="ps-nav-link" data-nav-install-app data-install-href="{% url 'pwa_install' %}">–£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ</button>
{% if user.is_authenticated %}
<a href="{% url 'accounts:profile' %}" class="ps-nav-link">–ü—Ä–æ—Ñ–∏–ª—å</a>
<a href="{% url 'accounts:logout' %}" class="ps-nav-link ps-nav-link--danger">–í—ã–π—Ç–∏</a>
{% else %}
<a href="{% url 'accounts:login' %}" class="ps-nav-link">–í–æ–π—Ç–∏</a>
<a href="{% url 'accounts:register' %}" class="ps-nav-link ps-nav-link--primary">–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</a>
{% endif %}
</div>
</nav>
</header>
<main class="ps-main">
{% block content %}{% endblock %}
</main>
<footer class="ps-footer">
<div class="ps-footer-inner">
<span>¬© {% now "Y" %} ParkShare RU</span>
<span class="ps-footer-meta">PWA ¬∑ Offline-first ¬∑ AI pricing</span>
</div>
</footer>
<!-- Back to top -->
<button class="ps-back-to-top" type="button" data-back-to-top aria-label="–ù–∞–≤–µ—Ä—Ö">
‚Üë
</button>
<!-- Toasts -->
<div class="ps-toast-container" aria-live="polite" aria-atomic="true"></div>
<!-- Chat assistant -->
<div class="ps-chat" data-chat>
<button class="ps-chat-fab" type="button" data-chat-toggle aria-expanded="false">
<span class="ps-chat-fab-icon">ü§ñ</span>
<span class="ps-chat-fab-text">AI-–ø–æ–º–æ—â–Ω–∏–∫</span>
</button>
<div class="ps-chat-overlay" data-chat-overlay></div>
<div class="ps-chat-panel" data-chat-panel aria-hidden="true" role="dialog" aria-label="AI-–ø–æ–º–æ—â–Ω–∏–∫ –ø–æ –ø–∞—Ä–∫–æ–≤–∫–µ">
<div class="ps-chat-header">
<div class="ps-chat-header-text">
<div class="ps-chat-title">AI-–ø–æ–º–æ—â–Ω–∏–∫ –ø–æ –ø–∞—Ä–∫–æ–≤–∫–µ</div>
<div class="ps-chat-hint">–ü–æ–¥—Å–∫–∞–∂–µ—Ç —Å–≤–æ–±–æ–¥–Ω—ã–µ –º–µ—Å—Ç–∞, —Ç–∞—Ä–∏—Ñ—ã –∏ –ø–æ—Å—Ç—Ä–æ–∏—Ç –º–∞—Ä—à—Ä—É—Ç.</div>
</div>
<div class="ps-chat-meta">
<span class="ps-chat-status-dot">–æ–Ω–ª–∞–π–Ω</span>
<button class="ps-chat-close" type="button" data-chat-close aria-label="–°–≤–µ—Ä–Ω—É—Ç—å —á–∞—Ç">√ó</button>
</div>
</div>
<div class="ps-chat-body" data-chat-body></div>
<div class="ps-chat-status" data-chat-status hidden>–ê—Å—Å–∏—Å—Ç–µ–Ω—Ç –ø–µ—á–∞—Ç–∞–µ—Ç‚Ä¶</div>
<div class="ps-chat-input">
<textarea class="ps-input" rows="2" placeholder="–ù–∞–ø–∏—à–∏—Ç–µ: ¬´–ù—É–∂–Ω–∞ –ø–∞—Ä–∫–æ–≤–∫–∞ –∑–∞–≤—Ç—Ä–∞ —Å 9 –¥–æ 11 —É –º–µ—Ç—Ä–æ –ö—É—Ä—Å–∫–∞—è, –Ω–µ–¥–æ—Ä–æ–≥–æ¬ª" data-chat-input></textarea>
<button class="ps-btn ps-btn-primary" type="button" data-chat-send>–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
</div>
</div>
</div>
<!-- Bottom navigation for mobile -->
<nav class="ps-bottom-nav" data-bottom-nav>
<a href="{% url 'map_page' %}" class="ps-bottom-nav-item" data-nav="map">
<span class="ps-bottom-nav-icon" aria-hidden="true">üó∫Ô∏è</span>
<span class="ps-bottom-nav-label">–ö–∞—Ä—Ç–∞</span>
</a>
<a href="{% url 'user_dashboard' %}" class="ps-bottom-nav-item" data-nav="bookings">
<span class="ps-bottom-nav-icon" aria-hidden="true">üßæ</span>
<span class="ps-bottom-nav-label">–ú–æ–∏ –±—Ä–æ–Ω–∏</span>
</a>
<a href="{% url 'accounts:profile' %}" class="ps-bottom-nav-item" data-nav="profile">
<span class="ps-bottom-nav-icon" aria-hidden="true">üë§</span>
<span class="ps-bottom-nav-label">–ü—Ä–æ—Ñ–∏–ª—å</span>
</a>
<button type="button" class="ps-bottom-nav-item" data-nav="chat" data-chat-open-link>
<span class="ps-bottom-nav-icon" aria-hidden="true">ü§ñ</span>
<span class="ps-bottom-nav-label">AI-—á–∞—Ç</span>
</button>
</nav>
<!-- PWA install banner -->
<div class="ps-install-banner" data-install-banner hidden>
<div class="ps-install-banner-inner">
<div class="ps-install-banner-text">
–£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ <strong>ParkShare RU</strong> –∫–∞–∫ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ
</div>
<div class="ps-install-banner-actions">
<button type="button" class="ps-btn ps-btn-secondary" data-install-dismiss>–ü–æ–∑–∂–µ</button>
<button type="button" class="ps-btn" data-install-accept>–£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å</button>
</div>
</div>
</div>
<script src="{% static 'js/app.js' %}"></script>
{% block extra_scripts %}{% endblock %}
</body>
</html>

# File 135/160: templates\offline.html
################################################################################

{% extends "base.html" %}
{% block title %}–û—Ñ—Ñ–ª–∞–π–Ω ‚Äî ParkShare RU{% endblock %}
{% block content %}
<section class="ps-section ps-section--center">
<div class="ps-offline-icon">‚òÅÔ∏è</div>
<h1 class="ps-section-title">–ù–µ—Ç –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ —Å–µ—Ç–∏</h1>
<p class="ps-section-subtitle">
–í—ã –æ—Ñ—Ñ–ª–∞–π–Ω. –ù–µ–∫–æ—Ç–æ—Ä—ã–µ –¥–∞–Ω–Ω—ã–µ –º–æ–≥—É—Ç –±—ã—Ç—å —É—Å—Ç–∞—Ä–µ–≤—à–∏–º–∏ –∏–ª–∏ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω—ã–º–∏,
–Ω–æ –±–∞–∑–æ–≤—ã–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã –∏ —Ä–∞–Ω–µ–µ –æ—Ç–∫—Ä—ã—Ç—ã–µ —Ä–µ—Å—É—Ä—Å—ã –≤—Å—ë –µ—â—ë —Ä–∞–±–æ—Ç–∞—é—Ç.
</p>
<div class="ps-offline-actions">
<button type="button" class="ps-btn" onclick="location.reload()">
–ü–æ–≤—Ç–æ—Ä–∏—Ç—å –ø–æ–ø—ã—Ç–∫—É
</button>
<a href="{% url 'landing' %}" class="ps-btn ps-btn-secondary">
–ù–∞ –≥–ª–∞–≤–Ω—É—é
</a>
</div>
</section>
{% endblock %}

# File 136/160: templates\accounts\login.html
################################################################################

{% extends "base.html" %}
{% load static %}
{% block title %}–í—Ö–æ–¥ ‚Äî ParkShare RU{% endblock %}
{% block content %}
<section class="ps-auth">
<div class="ps-auth-card ps-card ps-card--elevated ps-animate-fade-up">
<h1 class="ps-auth-title">–í—Ö–æ–¥</h1>
<p class="ps-auth-subtitle">
–í–æ–π–¥–∏—Ç–µ, —á—Ç–æ–±—ã —É–ø—Ä–∞–≤–ª—è—Ç—å —Å–≤–æ–∏–º–∏ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è–º–∏ –∏ –º–∞—à–∏–Ω–∞–º–∏.
</p>
<div class="ps-auth-tabs" data-auth-switcher>
<button type="button" class="is-active" data-auth-target="password">Email/–ü–∞—Ä–æ–ª—å</button>
<button type="button" data-auth-target="google">Google</button>
<button type="button" data-auth-target="sms">SMS</button>
<button type="button" data-auth-target="esia">–ì–æ—Å—É—Å–ª—É–≥–∏</button>
</div>
<div class="ps-auth-panels">
<div class="ps-auth-panel is-active" data-auth-panel="password">
<form method="post" class="ps-form">
{% csrf_token %}
{% if form.non_field_errors %}
<div class="ps-alert ps-alert--danger">
{{ form.non_field_errors }}
</div>
{% endif %}
{% for field in form.visible_fields %}
<div class="ps-form-row">
<label class="ps-form-label" for="{{ field.id_for_label }}">
{{ field.label }}
</label>
{{ field }}
{% if field.help_text %}
<div class="ps-field-help">{{ field.help_text }}</div>
{% endif %}
{% for error in field.errors %}
<div class="ps-field-error">{{ error }}</div>
{% endfor %}
</div>
{% endfor %}
<div class="ps-form-actions">
<button type="submit" class="ps-btn ps-btn-full">
–í–æ–π—Ç–∏
</button>
</div>
</form>
</div>
<div class="ps-auth-panel" data-auth-panel="google">
<div class="ps-auth-placeholder">
<p>–í—Ö–æ–¥ —á–µ—Ä–µ–∑ Google —Å–∫–æ—Ä–æ –ø–æ—è–≤–∏—Ç—Å—è.</p>
<button type="button" class="ps-btn ps-btn-secondary" disabled>Google</button>
</div>
</div>
<div class="ps-auth-panel" data-auth-panel="sms">
<div class="ps-auth-placeholder">
<p>–í—Ö–æ–¥ –ø–æ SMS-–∫–æ–¥—É –≤ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ.</p>
<button type="button" class="ps-btn ps-btn-secondary" disabled>–ü–æ–ª—É—á–∏—Ç—å –∫–æ–¥</button>
</div>
</div>
<div class="ps-auth-panel" data-auth-panel="esia">
<div class="ps-auth-placeholder">
<p>–ü–æ–¥–¥–µ—Ä–∂–∫–∞ –ì–æ—Å—É—Å–ª—É–≥ —Å–∫–æ—Ä–æ –±—É–¥–µ—Ç –¥–æ—Å—Ç—É–ø–Ω–∞.</p>
<button type="button" class="ps-btn ps-btn-secondary" disabled>–ü–µ—Ä–µ–π—Ç–∏ –≤ –ì–æ—Å—É—Å–ª—É–≥–∏</button>
</div>
</div>
</div>
<div class="ps-auth-footer">
–ù–µ—Ç –∞–∫–∫–∞—É–Ω—Ç–∞?
<a href="{% url 'accounts:register' %}">–ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è</a>
<br>
<a href="{% url 'accounts:password_reset' %}">–ó–∞–±—ã–ª–∏ –ø–∞—Ä–æ–ª—å?</a>
</div>
</div>
</section>
{% endblock %}
{% block extra_scripts %}
<script>
(function () {
const root = document.querySelector('[data-auth-switcher]');
if (!root) return;
const buttons = Array.from(root.querySelectorAll('[data-auth-target]'));
const panels = Array.from(document.querySelectorAll('[data-auth-panel]'));
buttons.forEach(function (btn) {
btn.addEventListener('click', function () {
const target = btn.getAttribute('data-auth-target');
buttons.forEach(function (b) { b.classList.toggle('is-active', b === btn); });
panels.forEach(function (panel) {
panel.classList.toggle('is-active', panel.getAttribute('data-auth-panel') === target);
});
});
});
})();
</script>
{% endblock %}

# File 137/160: templates\accounts\password_change.html
################################################################################

{% extends "base.html" %}
{% block title %}–°–º–µ–Ω–∞ –ø–∞—Ä–æ–ª—è ‚Äî ParkShare RU{% endblock %}
{% block content %}
<section class="ps-auth">
<div class="ps-auth-card ps-card ps-card--elevated ps-animate-fade-up">
<h1 class="ps-auth-title">–°–º–µ–Ω–∞ –ø–∞—Ä–æ–ª—è</h1>
<p class="ps-auth-subtitle">
–£–∫–∞–∂–∏—Ç–µ —Ç–µ–∫—É—â–∏–π –ø–∞—Ä–æ–ª—å –∏ –Ω–æ–≤—ã–π ‚Äî –º—ã –ø—Ä–æ–≤–µ—Ä–∏–º –µ–≥–æ –Ω–∞–¥—ë–∂–Ω–æ—Å—Ç—å.
</p>
<form method="post" class="ps-form">
{% csrf_token %}
{% if form.non_field_errors %}
<div class="ps-alert ps-alert--danger">
{{ form.non_field_errors }}
</div>
{% endif %}
{% for field in form.visible_fields %}
<div class="ps-form-row">
<label class="ps-form-label" for="{{ field.id_for_label }}">
{{ field.label }}
</label>
{{ field }}
{% if field.help_text %}
<div class="ps-field-help">{{ field.help_text }}</div>
{% endif %}
{% for error in field.errors %}
<div class="ps-field-error">{{ error }}</div>
{% endfor %}
</div>
{% endfor %}
<div class="ps-form-actions">
<button type="submit" class="ps-btn ps-btn-full">
–û–±–Ω–æ–≤–∏—Ç—å –ø–∞—Ä–æ–ª—å
</button>
</div>
</form>
</div>
</section>
{% endblock %}

# File 138/160: templates\accounts\password_change_done.html
################################################################################

{% extends "base.html" %}
{% block title %}–ü–∞—Ä–æ–ª—å –æ–±–Ω–æ–≤–ª—ë–Ω ‚Äî ParkShare RU{% endblock %}
{% block content %}
<section class="ps-section ps-section--center ps-section--narrow ps-animate-fade-up">
<h1 class="ps-section-title">–ü–∞—Ä–æ–ª—å —É—Å–ø–µ—à–Ω–æ –æ–±–Ω–æ–≤–ª—ë–Ω</h1>
<p class="ps-section-subtitle">
–í–∞—à –Ω–æ–≤—ã–π –ø–∞—Ä–æ–ª—å —Å–æ—Ö—Ä–∞–Ω—ë–Ω. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –µ–≥–æ –¥–ª—è —Å–ª–µ–¥—É—é—â–µ–≥–æ –≤—Ö–æ–¥–∞.
</p>
<div class="ps-offline-actions">
<a href="{% url 'user_dashboard' %}" class="ps-btn">
–í –ª–∏—á–Ω—ã–π –∫–∞–±–∏–Ω–µ—Ç
</a>
</div>
</section>
{% endblock %}

# File 139/160: templates\accounts\password_reset.html
################################################################################

{% extends "base.html" %}
{% block title %}–°–±—Ä–æ—Å –ø–∞—Ä–æ–ª—è ‚Äî ParkShare RU{% endblock %}
{% block content %}
<section class="ps-auth">
<div class="ps-auth-card ps-card ps-card--elevated ps-animate-fade-up">
<h1 class="ps-auth-title">–°–±—Ä–æ—Å –ø–∞—Ä–æ–ª—è</h1>
<p class="ps-auth-subtitle">
–£–∫–∞–∂–∏—Ç–µ email, –Ω–∞ –∫–æ—Ç–æ—Ä—ã–π –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω –∞–∫–∫–∞—É–Ω—Ç. –ú—ã –æ—Ç–ø—Ä–∞–≤–∏–º —Å—Å—ã–ª–∫—É
–¥–ª—è –∑–∞–¥–∞–Ω–∏—è –Ω–æ–≤–æ–≥–æ –ø–∞—Ä–æ–ª—è.
</p>
<form method="post" class="ps-form">
{% csrf_token %}
{% if form.non_field_errors %}
<div class="ps-alert ps-alert--danger">
{{ form.non_field_errors }}
</div>
{% endif %}
{% for field in form.visible_fields %}
<div class="ps-form-row">
<label class="ps-form-label" for="{{ field.id_for_label }}">
{{ field.label }}
</label>
{{ field }}
{% for error in field.errors %}
<div class="ps-field-error">{{ error }}</div>
{% endfor %}
</div>
{% endfor %}
<div class="ps-form-actions">
<button type="submit" class="ps-btn ps-btn-full">
–û—Ç–ø—Ä–∞–≤–∏—Ç—å —Å—Å—ã–ª–∫—É
</button>
</div>
</form>
<div class="ps-auth-footer">
–í—Å–ø–æ–º–Ω–∏–ª–∏ –ø–∞—Ä–æ–ª—å?
<a href="{% url 'accounts:login' %}">–í–µ—Ä–Ω—É—Ç—å—Å—è –∫–æ –≤—Ö–æ–¥—É</a>
</div>
</div>
</section>
{% endblock %}

# File 140/160: templates\accounts\password_reset_complete.html
################################################################################

{% extends "base.html" %}
{% block title %}–ü–∞—Ä–æ–ª—å –∏–∑–º–µ–Ω—ë–Ω ‚Äî ParkShare RU{% endblock %}
{% block content %}
<section class="ps-section ps-section--center ps-section--narrow ps-animate-fade-up">
<h1 class="ps-section-title">–ü–∞—Ä–æ–ª—å —É—Å–ø–µ—à–Ω–æ –∏–∑–º–µ–Ω—ë–Ω</h1>
<p class="ps-section-subtitle">
–¢–µ–ø–µ—Ä—å –≤—ã –º–æ–∂–µ—Ç–µ –≤–æ–π—Ç–∏ –≤ —Å–≤–æ–π –∞–∫–∫–∞—É–Ω—Ç, –∏—Å–ø–æ–ª—å–∑—É—è –Ω–æ–≤—ã–π –ø–∞—Ä–æ–ª—å.
</p>
<div class="ps-offline-actions">
<a href="{% url 'accounts:login' %}" class="ps-btn">
–ü–µ—Ä–µ–π—Ç–∏ –∫–æ –≤—Ö–æ–¥—É
</a>
</div>
</section>
{% endblock %}

# File 141/160: templates\accounts\password_reset_confirm.html
################################################################################

{% extends "base.html" %}
{% block title %}–ù–æ–≤—ã–π –ø–∞—Ä–æ–ª—å ‚Äî ParkShare RU{% endblock %}
{% block content %}
<section class="ps-auth">
<div class="ps-auth-card ps-card ps-card--elevated ps-animate-fade-up">
{% if validlink %}
<h1 class="ps-auth-title">–ó–∞–¥–∞–π—Ç–µ –Ω–æ–≤—ã–π –ø–∞—Ä–æ–ª—å</h1>
<p class="ps-auth-subtitle">
–í–≤–µ–¥–∏—Ç–µ –Ω–æ–≤—ã–π –ø–∞—Ä–æ–ª—å –¥–≤–∞–∂–¥—ã, —á—Ç–æ–±—ã –∏—Å–∫–ª—é—á–∏—Ç—å –æ–ø–µ—á–∞—Ç–∫–∏.
</p>
<form method="post" class="ps-form">
{% csrf_token %}
{% if form.non_field_errors %}
<div class="ps-alert ps-alert--danger">
{{ form.non_field_errors }}
</div>
{% endif %}
{% for field in form.visible_fields %}
<div class="ps-form-row">
<label class="ps-form-label" for="{{ field.id_for_label }}">
{{ field.label }}
</label>
{{ field }}
{% if field.help_text %}
<div class="ps-field-help">{{ field.help_text }}</div>
{% endif %}
{% for error in field.errors %}
<div class="ps-field-error">{{ error }}</div>
{% endfor %}
</div>
{% endfor %}
<div class="ps-form-actions">
<button type="submit" class="ps-btn ps-btn-full">
–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –Ω–æ–≤—ã–π –ø–∞—Ä–æ–ª—å
</button>
</div>
</form>
{% else %}
<h1 class="ps-auth-title">–°—Å—ã–ª–∫–∞ –Ω–µ–¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–∞</h1>
<p class="ps-auth-subtitle">
–°—Å—ã–ª–∫–∞ –¥–ª—è —Å–±—Ä–æ—Å–∞ –ø–∞—Ä–æ–ª—è —É—Å—Ç–∞—Ä–µ–ª–∞ –∏–ª–∏ —É–∂–µ –±—ã–ª–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∞.
–ü–æ–ø—Ä–æ–±—É–π—Ç–µ –∑–∞–ø—Ä–æ—Å–∏—Ç—å —Å–±—Ä–æ—Å –µ—â—ë —Ä–∞–∑.
</p>
<div class="ps-offline-actions">
<a href="{% url 'accounts:password_reset' %}" class="ps-btn">
–ó–∞–ø—Ä–æ—Å–∏—Ç—å –Ω–æ–≤—É—é —Å—Å—ã–ª–∫—É
</a>
</div>
{% endif %}
</div>
</section>
{% endblock %}

# File 142/160: templates\accounts\password_reset_done.html
################################################################################

{% extends "base.html" %}
{% block title %}–ü–∏—Å—å–º–æ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ ‚Äî ParkShare RU{% endblock %}
{% block content %}
<section class="ps-section ps-section--center ps-section--narrow ps-animate-fade-up">
<h1 class="ps-section-title">–ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø–æ—á—Ç—É</h1>
<p class="ps-section-subtitle">
–ï—Å–ª–∏ –∞–∫–∫–∞—É–Ω—Ç —Å —Ç–∞–∫–∏–º email —Å—É—â–µ—Å—Ç–≤—É–µ—Ç, –º—ã –æ—Ç–ø—Ä–∞–≤–∏–ª–∏ –Ω–∞ –Ω–µ–≥–æ –ø–∏—Å—å–º–æ
—Å –¥–∞–ª—å–Ω–µ–π—à–∏–º–∏ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—è–º–∏.
</p>
<div class="ps-offline-actions">
<a href="{% url 'accounts:login' %}" class="ps-btn ps-btn-secondary">
–í–µ—Ä–Ω—É—Ç—å—Å—è –∫–æ –≤—Ö–æ–¥—É
</a>
</div>
</section>
{% endblock %}

# File 143/160: templates\accounts\password_reset_email.txt
################################################################################

–í—ã –ø–æ–ª—É—á–∏–ª–∏ —ç—Ç–æ –ø–∏—Å—å–º–æ, –ø–æ—Ç–æ–º—É —á—Ç–æ –Ω–∞ —Å–∞–π—Ç–µ {{ site_name }} –±—ã–ª –∑–∞–ø—Ä–æ—à–µ–Ω —Å–±—Ä–æ—Å –ø–∞—Ä–æ–ª—è
–¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è, –∏—Å–ø–æ–ª—å–∑—É—é—â–µ–≥–æ —ç—Ç–æ—Ç email.

–ß—Ç–æ–±—ã –∑–∞–¥–∞—Ç—å –Ω–æ–≤—ã–π –ø–∞—Ä–æ–ª—å, –ø–µ—Ä–µ–π–¥–∏—Ç–µ –ø–æ —Å—Å—ã–ª–∫–µ:

{{ protocol }}://{{ domain }}{% url 'accounts:password_reset_confirm' uidb64=uid token=token %}

–ï—Å–ª–∏ –≤—ã –Ω–µ –∑–∞–ø—Ä–∞—à–∏–≤–∞–ª–∏ —Å–±—Ä–æ—Å –ø–∞—Ä–æ–ª—è, –ø—Ä–æ—Å—Ç–æ –ø—Ä–æ–∏–≥–Ω–æ—Ä–∏—Ä—É–π—Ç–µ —ç—Ç–æ –ø–∏—Å—å–º–æ.


# File 144/160: templates\accounts\password_reset_subject.txt
################################################################################

–°–±—Ä–æ—Å –ø–∞—Ä–æ–ª—è –Ω–∞ ParkShare RU


# File 145/160: templates\accounts\profile.html
################################################################################

{% extends "base.html" %}
{% load static %}
{% block title %}–ü—Ä–æ—Ñ–∏–ª—å ‚Äî ParkShare RU{% endblock %}
{% block content %}
<section class="ps-section ps-section--narrow">
<div class="ps-section-header">
<h1 class="ps-section-title">–ü—Ä–æ—Ñ–∏–ª—å</h1>
<p class="ps-section-subtitle">
–û–±–Ω–æ–≤–∏—Ç–µ –∫–æ–Ω—Ç–∞–∫—Ç–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ, —á—Ç–æ–±—ã –ø–æ–ª—É—á–∞—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –ø–æ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è–º.
</p>
</div>
<div class="ps-card ps-card--elevated ps-animate-fade-up">
<form method="post" class="ps-form">
{% csrf_token %}
{% if form.non_field_errors %}
<div class="ps-alert ps-alert--danger">
{{ form.non_field_errors }}
</div>
{% endif %}
{% for field in form.visible_fields %}
<div class="ps-form-row">
<label class="ps-form-label" for="{{ field.id_for_label }}">
{{ field.label }}
</label>
{{ field }}
{% if field.help_text %}
<div class="ps-field-help">{{ field.help_text }}</div>
{% endif %}
{% for error in field.errors %}
<div class="ps-field-error">{{ error }}</div>
{% endfor %}
</div>
{% endfor %}
<div class="ps-form-actions">
<button type="submit" class="ps-btn ps-btn-full">
–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è
</button>
<a href="{% url 'user_dashboard' %}" class="ps-btn ps-btn-secondary ps-btn-full">
–í–µ—Ä–Ω—É—Ç—å—Å—è –≤ –∫–∞–±–∏–Ω–µ—Ç
</a>
</div>
</form>
</div>
</section>
{% endblock %}

# File 146/160: templates\accounts\register.html
################################################################################

{% extends "base.html" %}
{% load static %}
{% block title %}–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è ‚Äî ParkShare RU{% endblock %}
{% block content %}
<section class="ps-auth">
<div class="ps-auth-card ps-card ps-card--elevated ps-animate-fade-up">
<h1 class="ps-auth-title">–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</h1>
<p class="ps-auth-subtitle">
–°–æ–∑–¥–∞–π—Ç–µ –∞–∫–∫–∞—É–Ω—Ç, —á—Ç–æ–±—ã –±—Ä–æ–Ω–∏—Ä–æ–≤–∞—Ç—å –ø–∞—Ä–∫–æ–≤–∫–∏ –∏ —É–ø—Ä–∞–≤–ª—è—Ç—å –º–µ—Å—Ç–∞–º–∏.
</p>
<form method="post" class="ps-form">
{% csrf_token %}
{% if form.non_field_errors %}
<div class="ps-alert ps-alert--danger">
{{ form.non_field_errors }}
</div>
{% endif %}
{% for field in form.visible_fields %}
<div class="ps-form-row">
<label class="ps-form-label" for="{{ field.id_for_label }}">
{{ field.label }}
</label>
{{ field }}
{% if field.help_text %}
<div class="ps-field-help">{{ field.help_text }}</div>
{% endif %}
{% for error in field.errors %}
<div class="ps-field-error">{{ error }}</div>
{% endfor %}
</div>
{% endfor %}
<div class="ps-form-actions">
<button type="submit" class="ps-btn ps-btn-full">
–ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è
</button>
</div>
<div class="ps-auth-alt">
<button type="button" class="ps-btn ps-btn-ghost" title="–°–∫–æ—Ä–æ">–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –ø–æ –∫–æ–¥—É</button>
<button type="button" class="ps-btn ps-btn-ghost" title="–°–∫–æ—Ä–æ">–ì–æ—Å—É—Å–ª—É–≥–∏</button>
<button type="button" class="ps-btn ps-btn-ghost" title="–°–∫–æ—Ä–æ">Google</button>
<!-- TODO: –ø–æ–¥–∫–ª—é—á–∏—Ç—å –±—ã—Å—Ç—Ä—É—é —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—é —á–µ—Ä–µ–∑ code/ESIA/OAuth -->
</div>
</form>
<div class="ps-auth-footer">
–£–∂–µ –µ—Å—Ç—å –∞–∫–∫–∞—É–Ω—Ç?
<a href="{% url 'accounts:login' %}">–í–æ–π—Ç–∏</a>
</div>
</div>
</section>
{% endblock %}

# File 147/160: templates\parking\landing.html
################################################################################

{% extends "base.html" %}
{% load static %}
{% block title %}ParkShare RU ‚Äî –Ω–∞–π—Ç–∏ –ø–∞—Ä–∫–æ–≤–∫—É —Ä—è–¥–æ–º{% endblock %}
{% block extra_head %}
<!-- –ö–∞—Ä—Ç–∞: Yandex API –∫–∞–∫ –æ—Å–Ω–æ–≤–Ω–æ–π –ø—Ä–æ–≤–∞–π–¥–µ—Ä, Leaflet ‚Äî fallback -->
<link rel="stylesheet"
href="https:
integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
crossorigin=""/>
<link rel="stylesheet" href="https:
<link rel="stylesheet" href="https:
<script src="https:
defer></script>
{% endblock %}
{% block content %}
<section class="ps-hero ps-animate-fade-up">
<div class="ps-hero-inner">
<div class="ps-hero-text">
<h1 class="ps-hero-title">
–ü–∞—Ä–∫–æ–≤–∫–∞ <span>–≤ –æ–¥–∏–Ω —Ç–∞–ø</span>
</h1>
<p class="ps-hero-subtitle">
–ù–∞–π–¥–∏—Ç–µ —Å–≤–æ–±–æ–¥–Ω–æ–µ –º–µ—Å—Ç–æ –≤–æ –¥–≤–æ—Ä–µ, —É –æ—Ñ–∏—Å–∞ –∏–ª–∏ —Ä—è–¥–æ–º —Å –¥–æ–º–æ–º.
–ë—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ, –æ–ø–ª–∞—Ç–∞ –∏ –Ω–∞–≤–∏–≥–∞—Ü–∏—è ‚Äî –ø—Ä—è–º–æ –≤ –≤–∞—à–µ–º –±—Ä–∞—É–∑–µ—Ä–µ.
</p>
<div class="ps-hero-actions">
<a href="
–ù–∞–π—Ç–∏ –ø–∞—Ä–∫–æ–≤–∫—É —Ä—è–¥–æ–º
</a>
<button type="button" class="ps-btn ps-btn-ghost ps-btn-lg" data-fill-location>
–û–ø—Ä–µ–¥–µ–ª–∏—Ç—å –º–æ—ë –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ
</button>
</div>
<div class="ps-hero-meta">
–†–∞–±–æ—Ç–∞–µ—Ç –∫–∞–∫ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ ¬∑ –û—Ñ—Ñ–ª–∞–π–Ω-—Ä–µ–∂–∏–º ¬∑ –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –æ –±—Ä–æ–Ω—è—Ö
</div>
</div>
<div class="ps-hero-visual">
<div class="ps-hero-card ps-animate-float">
<div class="ps-hero-card-line">
<span class="ps-dot ps-dot--green"></span>
–ú–µ—Å—Ç–∞ —Ä—è–¥–æ–º —Å –≤–∞–º–∏ –Ω–∞–π–¥–µ–Ω—ã
</div>
<div class="ps-hero-card-line">
<span class="ps-dot ps-dot--blue"></span>
–°—Ä–µ–¥–Ω—è—è —Ü–µ–Ω–∞: <strong data-avg-price>180 ‚ÇΩ/—á–∞—Å</strong>
</div>
<div class="ps-hero-card-line">
<span class="ps-dot ps-dot--yellow"></span>
–°–≤–æ–±–æ–¥–Ω—ã—Ö –º–µ—Å—Ç:
<strong data-spots-count>{{ spots|length }}</strong>
</div>
</div>
</div>
</div>
</section>
<section id="search" class="ps-section ps-section--flush-top">
<div class="ps-section-header ps-section-header--stack">
<div>
<h2 class="ps-section-title">–ù–∞–π—Ç–∏ –ø–∞—Ä–∫–æ–≤–∫—É —Ä—è–¥–æ–º</h2>
<p class="ps-section-subtitle">
–ö–∞—Ä—Ç–∞ —Å –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏–º–∏ —Ü–µ–Ω–∞–º–∏, —Ñ–∏–ª—å—Ç—Ä–∞–º–∏ –∏ AI‚Äë—Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è–º–∏.
</p>
</div>
<div class="ps-section-actions" data-mobile-toolbar>
<button type="button" class="ps-btn ps-btn-secondary ps-btn-sm" data-fill-location>–†—è–¥–æ–º —Å–æ –º–Ω–æ–π</button>
<button type="button" class="ps-btn ps-btn-ghost ps-btn-sm" data-open-spots>–°–ø–∏—Å–æ–∫ –º–µ—Å—Ç</button>
</div>
</div>
<div class="ps-grid ps-grid--2col@lg ps-grid--gap-xl ps-grid--mobile-stack">
<div class="ps-map-panel" data-map-panel>
<div class="ps-map-wrapper">
<div id="map" class="ps-map ps-map--light"></div>
<div class="ps-map-loading" data-map-loading>–û–±–Ω–æ–≤–ª—è–µ–º –∫–∞—Ä—Ç—É‚Ä¶</div>
<div class="ps-map-floating-actions" aria-label="–î–µ–π—Å—Ç–≤–∏—è –∫–∞—Ä—Ç—ã">
<button class="ps-map-action" type="button" data-fill-location title="–ú–æ—ë –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ">üéØ</button>
<button class="ps-map-action" type="button" data-reset-filters title="–°–±—Ä–æ—Å–∏—Ç—å —Ñ–∏–ª—å—Ç—Ä—ã">‚Ü∫</button>
<button class="ps-map-action" type="button" data-map-theme title="–°–≤–µ—Ç–ª–∞—è / —Ç—ë–º–Ω–∞—è –∫–∞—Ä—Ç–∞" aria-pressed="false">üåô</button>
</div>
</div>
<div class="ps-map-filters" data-map-filters-container>
<form class="ps-map-filters-card" data-map-filters>
<div class="ps-map-filters-row">
<div class="ps-input-icon">
<span class="ps-input-icon-symbol">üîç</span>
<input type="text" class="ps-input" placeholder="–ê–¥—Ä–µ—Å, –º–µ—Ç—Ä–æ –∏–ª–∏ –º–µ—Å—Ç–æ" data-geocode-input>
</div>
<div class="ps-map-filters-actions">
<button class="ps-btn ps-btn-primary" type="button" data-geocode-submit>–ù–∞–π—Ç–∏</button>
</div>
</div>
<div class="ps-geocode-suggestions" data-geocode-suggestions></div>
<div class="ps-map-filters-row ps-map-filters-row--chips" data-filter-chips>
<div class="ps-chip-scroll">
<label class="ps-chip" data-chip-toggle>
<input type="checkbox" name="only_free" hidden>
<span>–¢–æ–ª—å–∫–æ —Å–≤–æ–±–æ–¥–Ω—ã–µ</span>
</label>
<label class="ps-chip" data-chip-toggle>
<input type="checkbox" name="ai_recommended" hidden>
<span>AI-—Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏</span>
</label>
<label class="ps-chip" data-chip-toggle>
<input type="checkbox" name="ev" hidden>
<span>–° –∑–∞—Ä—è–¥–∫–æ–π EV</span>
</label>
<label class="ps-chip" data-chip-toggle>
<input type="checkbox" name="covered" hidden>
<span>–ö—Ä—ã—Ç–∞—è</span>
</label>
<label class="ps-chip" data-chip-toggle>
<input type="checkbox" name="is_24_7" hidden>
<span>24/7</span>
</label>
</div>
</div>
<div class="ps-map-filters-row ps-map-filters-row--slider">
<div class="ps-filter-slider" data-price-slider></div>
<div class="ps-filter-price" data-price-display>–¶–µ–Ω–∞: –æ—Ç 0 ‚ÇΩ –¥–æ 1500 ‚ÇΩ</div>
</div>
</form>
</div>
<div class="ps-route-hint" data-route-hint>–ü–æ—Å—Ç—Ä–æ–π—Ç–µ –º–∏–Ω–∏-–º–∞—Ä—à—Ä—É—Ç –¥–æ –≤—ã–±—Ä–∞–Ω–Ω–æ–π —Ç–æ—á–∫–∏.</div>
</div>
<div class="ps-spots-panel" data-spots-panel>
<div class="ps-section-subheader">
<h3 class="ps-section-title-sm">–î–æ—Å—Ç—É–ø–Ω—ã–µ –º–µ—Å—Ç–∞</h3>
</div>
<div class="ps-spots-list" data-spots-list>
<div class="ps-card ps-card--spot ps-card--skeleton">
<div class="ps-skeleton-line ps-skeleton-line--lg"></div>
<div class="ps-skeleton-line"></div>
<div class="ps-skeleton-line ps-skeleton-line--short"></div>
</div>
<div class="ps-card ps-card--spot ps-card--skeleton">
<div class="ps-skeleton-line ps-skeleton-line--lg"></div>
<div class="ps-skeleton-line"></div>
<div class="ps-skeleton-line ps-skeleton-line--short"></div>
</div>
</div>
<div class="ps-favorites-hint">
–°–æ—Ö—Ä–∞–Ω—è–π—Ç–µ –ø–∞—Ä–∫–æ–≤–∫–∏ –≤ –∏–∑–±—Ä–∞–Ω–Ω–æ–µ –∏ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä—É–π—Ç–µ —Å ¬´–¥–æ–º–æ–º¬ª/¬´–æ—Ñ–∏—Å–æ–º¬ª.
</div>
</div>
</div>
</section>
<section class="ps-section">
<div class="ps-section-header ps-section--center">
<h2 class="ps-section-title">
–ü–æ—á–µ–º—É <span>ParkShare RU</span>
</h2>
<p class="ps-section-subtitle">
–ù–µ –ø—Ä–æ—Å—Ç–æ –∫–∞—Ä—Ç–∞ –ø–∞—Ä–∫–æ–≤–æ–∫, –∞ —É–º–Ω—ã–π –ø–æ–º–æ—â–Ω–∏–∫, –∫–æ—Ç–æ—Ä—ã–π —ç–∫–æ–Ω–æ–º–∏—Ç –≤—Ä–µ–º—è –∏ –¥–µ–Ω—å–≥–∏.
</p>
</div>
<div class="ps-grid ps-grid--2col ps-grid--gap-xl">
<article class="ps-card ps-card--elevated ps-animate-fade-up">
<div class="ps-card-header">
<h3 class="ps-card-title">–î–µ—à–µ–≤–ª–µ, —á–µ–º —à—Ç—Ä–∞—Ñ –∑–∞ —ç–≤–∞–∫—É–∞—Ç–æ—Ä</h3>
</div>
<div class="ps-card-body">
<p class="ps-card-line">
–ë—Ä–æ–Ω–∏—Ä—É–π—Ç–µ –º–µ—Å—Ç–æ –∑–∞—Ä–∞–Ω–µ–µ –∏ –Ω–µ —Ä–∏—Å–∫—É–π—Ç–µ —Å—Ç–∞–≤–∏—Ç—å –º–∞—à–∏–Ω—É ‚Äú–∫–∞–∫-–Ω–∏–±—É–¥—å‚Äù.
</p>
<p class="ps-card-line ps-card-line--muted">
–ê–ª–≥–æ—Ä–∏—Ç–º—ã –ø–æ–¥—Å–∫–∞–∑—ã–≤–∞—é—Ç –≤–∞—Ä–∏–∞–Ω—Ç—ã —Å –ª—É—á—à–∏–º —Å–æ–æ—Ç–Ω–æ—à–µ–Ω–∏–µ–º —Ü–µ–Ω–∞/—Ä–∞—Å—Å—Ç–æ—è–Ω–∏–µ.
</p>
</div>
</article>
<article class="ps-card ps-card--elevated ps-animate-fade-up ps-animate-delay-1">
<div class="ps-card-header">
<h3 class="ps-card-title">–ë–µ–∑ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–π –∏ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ –Ω–∞ —Å—Ç–∞—Ä—Ç–µ</h3>
</div>
<div class="ps-card-body">
<p class="ps-card-line">
–í—Å—ë —Ä–∞–±–æ—Ç–∞–µ—Ç –ø—Ä—è–º–æ –≤ –±—Ä–∞—É–∑–µ—Ä–µ ‚Äî –∫–∞–∫ PWA-–ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ.
</p>
<p class="ps-card-line ps-card-line--muted">
–î–æ–±–∞–≤—å—Ç–µ –Ω–∞ –≥–ª–∞–≤–Ω—ã–π —ç–∫—Ä–∞–Ω –∏ –æ—Ç–∫—Ä—ã–≤–∞–π—Ç–µ –≤ –æ–¥–∏–Ω —Ç–∞–ø, –¥–∞–∂–µ –æ—Ñ—Ñ–ª–∞–π–Ω.
</p>
</div>
</article>
</div>
</section>
<section class="ps-section">
<div class="ps-section-header">
<h2 class="ps-section-title">–ö–∞–∫ —ç—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç</h2>
<p class="ps-section-subtitle">
–¢—Ä–∏ —à–∞–≥–∞ –æ—Ç –ø–æ–∏—Å–∫–∞ –¥–æ –æ–ø–ª–∞—á–µ–Ω–Ω–æ–≥–æ –º–µ—Å—Ç–∞.
</p>
</div>
<div class="ps-grid ps-grid--2col ps-grid--gap-xl">
<div>
<article class="ps-card ps-card--elevated ps-animate-fade-up">
<div class="ps-card-body">
<div class="ps-card-line"><strong>1. –ù–∞–π–¥–∏—Ç–µ —Ç–æ—á–∫—É –Ω–∞ –∫–∞—Ä—Ç–µ</strong></div>
<div class="ps-card-line ps-card-line--muted">
–£–∫–∞–∂–∏—Ç–µ —Ä–∞–π–æ–Ω –∏–ª–∏ –≤–æ—Å–ø–æ–ª—å–∑—É–π—Ç–µ—Å—å –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ–º –≥–µ–æ–ø–æ–∑–∏—Ü–∏–∏ ‚Äî –º—ã –ø–æ–∫–∞–∂–µ–º —Å–≤–æ–±–æ–¥–Ω—ã–µ –º–µ—Å—Ç–∞ –ø–æ–±–ª–∏–∑–æ—Å—Ç–∏.
</div>
<div class="ps-card-line"><strong>2. –ó–∞–±—Ä–æ–Ω–∏—Ä—É–π—Ç–µ –æ–Ω–ª–∞–π–Ω</strong></div>
<div class="ps-card-line ps-card-line--muted">
–í—ã–±–µ—Ä–∏—Ç–µ —Ç–∞—Ä–∏—Ñ, –≤—Ä–µ–º—è –∏ —Å–ø–æ—Å–æ–± –æ–ø–ª–∞—Ç—ã. –ú–µ—Å—Ç–æ —Ä–µ–∑–µ—Ä–≤–∏—Ä—É–µ—Ç—Å—è –ø–æ–¥ –≤–∞—Å, —Å–æ—Å–µ–¥ –µ–≥–æ —É–∂–µ –Ω–µ –∑–∞–±–µ—Ä—ë—Ç.
</div>
<div class="ps-card-line"><strong>3. –ü–æ—Å—Ç—Ä–æ–π—Ç–µ –º–∞—Ä—à—Ä—É—Ç</strong></div>
<div class="ps-card-line ps-card-line--muted">
–û—Ç–∫—Ä–æ–π—Ç–µ –Ω–∞–≤–∏–≥–∞—Ç–æ—Ä –≤ –æ–¥–∏–Ω –∫–ª–∏–∫ –∏ –¥–æ–µ–∑–∂–∞–π—Ç–µ –±–µ–∑ –∫—Ä—É–≥–æ–≤ –≤–æ–∫—Ä—É–≥ –¥–æ–º–∞.
</div>
</div>
</article>
</div>
<div>
<article class="ps-card ps-card--elevated ps-animate-fade-up ps-animate-delay-1">
<div class="ps-card-header">
<h3 class="ps-card-title">–ï—Å—Ç—å —Å–≤–æ—ë –º–µ—Å—Ç–æ –∏–ª–∏ –ø–∞—Ä–∫–æ–≤–∫–∞?</h3>
</div>
<div class="ps-card-body">
<p class="ps-card-line">
–ü—Ä–µ–≤—Ä–∞—Ç–∏—Ç–µ –ø—É—Å—Ç—É—é—â–∏–µ –º–µ—Å—Ç–∞ –≤–æ –¥–≤–æ—Äe –∏–ª–∏ —É –æ—Ñ–∏—Å–∞ –≤ –ø–∞—Å—Å–∏–≤–Ω—ã–π –¥–æ—Ö–æ–¥.
</p>
<p class="ps-card-line ps-card-line--muted">
–î–æ–±–∞–≤—å—Ç–µ –æ–±—ä–µ–∫—Ç, –Ω–∞—Å—Ç—Ä–æ–π—Ç–µ —Ü–µ–Ω—ã –∏ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è ‚Äî –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è –∏ –≤—ã–ø–ª–∞—Ç—ã –º—ã –≤–æ–∑—å–º—ë–º –Ω–∞ —Å–µ–±—è.
</p>
<div class="ps-form-actions" style="margin-top:0.75rem;">
<a href="{% url 'owner_dashboard' %}" class="ps-btn ps-btn-lg">
–°—Ç–∞—Ç—å –≤–ª–∞–¥–µ–ª—å—Ü–µ–º –ø–∞—Ä–∫–æ–≤–∫–∏
</a>
</div>
</div>
</article>
</div>
</div>
</section>
{% endblock %}
{% block extra_scripts %}
<script src="https:
integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
crossorigin=""></script>
<script src="https:
<script src="https:
<script>
window.PARKSHARE_MAP_PROVIDER = {
id: "{{ MAP_PROVIDER|default:'yandex' }}",
fallback: "{{ MAP_PROVIDER_FALLBACK|default:'leaflet' }}",
default_center: {{ MAP_DEFAULT_CENTER|safe }},
default_zoom: {{ MAP_DEFAULT_ZOOM|default:11 }},
};
</script>
{% load static %}
{% static 'js/map.js' as map_static %}
<script src="{{ map_static }}?v=43"></script>
{% endblock %}

# File 148/160: templates\parking\map_fullscreen.html
################################################################################

{% extends "base.html" %}
{% load static %}
{% block title %}–ñ–∏–≤–∞—è –∫–∞—Ä—Ç–∞ ‚Äî ParkShare{% endblock %}
{% block extra_head %}
<link rel="stylesheet"
href="https:
integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
crossorigin=""/>
<link rel="stylesheet" href="https:
<link rel="stylesheet" href="https:
<script src="https:
defer></script>
{% endblock %}
{% block content %}
<section class="ps-section ps-section--flush-top ps-map-hero">
<div class="ps-section-header ps-section-header--stack">
<div>
<h1 class="ps-section-title">–ö–∞—Ä—Ç–∞ –ø–∞—Ä–∫–æ–≤–æ–∫</h1>
<p class="ps-section-subtitle">–ü–æ–ª–Ω–æ—ç–∫—Ä–∞–Ω–Ω—ã–π —Ä–µ–∂–∏–º —Å –ø–æ–∏—Å–∫–æ–º, —Ñ–∏–ª—å—Ç—Ä–∞–º–∏ –∏ –º–∞—Ä—à—Ä—É—Ç–∞–º–∏.</p>
</div>
<div class="ps-section-actions">
<a href="{% url 'landing' %}" class="ps-btn ps-btn-ghost ps-btn-sm">–ù–∞ –≥–ª–∞–≤–Ω—É—é</a>
<button type="button" class="ps-btn ps-btn-primary ps-btn-sm" data-fill-location>–†—è–¥–æ–º —Å–æ –º–Ω–æ–π</button>
</div>
</div>
<div class="ps-map-grid">
<div class="ps-map-panel" data-map-panel>
<div class="ps-map-wrapper">
<div id="map" class="ps-map ps-map--light"></div>
<div class="ps-map-loading" data-map-loading>–û–±–Ω–æ–≤–ª—è–µ–º –∫–∞—Ä—Ç—É‚Ä¶</div>
<div class="ps-map-floating-actions" aria-label="–î–µ–π—Å—Ç–≤–∏—è –∫–∞—Ä—Ç—ã">
<button class="ps-map-action" type="button" data-fill-location title="–ú–æ—ë –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ">üéØ</button>
<button class="ps-map-action" type="button" data-reset-filters title="–°–±—Ä–æ—Å–∏—Ç—å —Ñ–∏–ª—å—Ç—Ä—ã">‚Ü∫</button>
<button class="ps-map-action" type="button" data-map-theme title="–°–≤–µ—Ç–ª–∞—è / —Ç—ë–º–Ω–∞—è –∫–∞—Ä—Ç–∞" aria-pressed="false">üåô</button>
</div>
<div class="ps-map-topbar">
<div class="ps-input-icon">
<span class="ps-input-icon-symbol">üîç</span>
<input type="text" class="ps-input" placeholder="–ê–¥—Ä–µ—Å, –º–µ—Ç—Ä–æ –∏–ª–∏ –º–µ—Å—Ç–æ" data-geocode-input>
</div>
<button class="ps-btn ps-btn-primary" type="button" data-geocode-submit>–ù–∞–π—Ç–∏</button>
</div>
<div class="ps-map-chips" data-filter-chips>
<label class="ps-chip" data-chip-toggle>
<input type="checkbox" name="only_free" hidden>
<span>–¢–æ–ª—å–∫–æ —Å–≤–æ–±–æ–¥–Ω—ã–µ</span>
</label>
<label class="ps-chip" data-chip-toggle>
<input type="checkbox" name="ai_recommended" hidden>
<span>AI-—Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏</span>
</label>
<label class="ps-chip" data-chip-toggle>
<input type="checkbox" name="ev" hidden>
<span>EV-–∑–∞—Ä—è–¥–∫–∞</span>
</label>
<label class="ps-chip" data-chip-toggle>
<input type="checkbox" name="covered" hidden>
<span>–ö—Ä—ã—Ç–∞—è</span>
</label>
<label class="ps-chip" data-chip-toggle>
<input type="checkbox" name="is_24_7" hidden>
<span>24/7</span>
</label>
</div>
<div class="ps-geocode-suggestions" data-geocode-suggestions></div>
</div>
<div class="ps-map-filters" data-map-filters-container>
<form class="ps-map-filters-card" data-map-filters>
<div class="ps-map-filters-row ps-map-filters-row--slider">
<div class="ps-filter-slider" data-price-slider></div>
<div class="ps-filter-price" data-price-display>–¶–µ–Ω–∞: –æ—Ç 0 ‚ÇΩ –¥–æ 1500 ‚ÇΩ</div>
</div>
</form>
</div>
<div class="ps-route-hint" data-route-hint>–ü–æ—Å—Ç—Ä–æ–π—Ç–µ –º–∏–Ω–∏-–º–∞—Ä—à—Ä—É—Ç –¥–æ –≤—ã–±—Ä–∞–Ω–Ω–æ–π —Ç–æ—á–∫–∏.</div>
</div>
<div class="ps-bottom-sheet" data-spots-panel>
<div class="ps-bottom-sheet__handle"></div>
<div class="ps-bottom-sheet__header">
<div>
<div class="ps-section-title-sm">–î–æ—Å—Ç—É–ø–Ω—ã–µ –º–µ—Å—Ç–∞</div>
<div class="ps-text-muted">–°–≤–æ–±–æ–¥–Ω—ã—Ö: <span data-spots-count>{{ spots|length }}</span>, —Å—Ä. —Ü–µ–Ω–∞ <span data-avg-price>‚Äî</span></div>
</div>
<div class="ps-bottom-sheet__actions">
<button type="button" class="ps-btn ps-btn-ghost ps-btn-sm" data-reset-filters>–°–±—Ä–æ—Å–∏—Ç—å</button>
</div>
</div>
<div class="ps-bottom-sheet__body">
<div class="ps-spots-list" data-spots-list>
{% for spot in spots %}
<article class="ps-card ps-card--spot" data-spot-card="{{ spot.id }}">
<div class="ps-card-header">
<div class="ps-card-title">{{ spot.lot.city }}, {{ spot.lot.name }} ‚Äî {{ spot.name }}</div>
</div>
<div class="ps-card-body">
<div class="ps-card-line">–æ—Ç {{ spot.hourly_price }} ‚ÇΩ/—á–∞—Å</div>
<div class="ps-card-line ps-card-line--muted">{{ spot.lot.address|default:"–ê–¥—Ä–µ—Å —É—Ç–æ—á–Ω—è–µ—Ç—Å—è" }}</div>
</div>
</article>
{% empty %}
<div class="ps-empty">–ú–µ—Å—Ç–∞ –±—É–¥—É—Ç –ø–æ–∫–∞–∑–∞–Ω—ã –ø–æ—Å–ª–µ –∑–∞–≥—Ä—É–∑–∫–∏ –∫–∞—Ä—Ç—ã.</div>
{% endfor %}
</div>
</div>
</div>
</div>
</section>
{% endblock %}
{% block extra_scripts %}
<script src="https:
integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
crossorigin=""></script>
<script src="https:
<script src="https:
<script>
window.PARKSHARE_MAP_PROVIDER = {
id: "{{ MAP_PROVIDER|default:'yandex' }}",
fallback: "{{ MAP_PROVIDER_FALLBACK|default:'leaflet' }}",
default_center: {{ MAP_DEFAULT_CENTER|safe }},
default_zoom: {{ MAP_DEFAULT_ZOOM|default:11 }},
};
</script>
{% static 'js/map.js' as map_static %}
<script src="{{ map_static }}?v=50"></script>
{% endblock %}

# File 149/160: templates\parking\owner_dashboard.html
################################################################################

{% extends "base.html" %}
{% load static %}
{% block title %}ParkShare RU ‚Äî –∫–∞–±–∏–Ω–µ—Ç –≤–ª–∞–¥–µ–ª—å—Ü–∞{% endblock %}
{% block content %}
<section class="ps-section">
<div class="ps-section-header">
<h1 class="ps-section-title">–ö–∞–±–∏–Ω–µ—Ç –≤–ª–∞–¥–µ–ª—å—Ü–∞ –ø–∞—Ä–∫–æ–≤–æ–∫</h1>
<p class="ps-section-subtitle">
–£–ø—Ä–∞–≤–ª—è–π—Ç–µ —Å–≤–æ–∏–º–∏ –æ–±—ä–µ–∫—Ç–∞–º–∏, –º–µ—Å—Ç–∞–º–∏ –∏ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è–º–∏ –≤ –æ–¥–Ω–æ–º –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–µ.
</p>
</div>
<div class="ps-grid ps-grid--3col@xl ps-grid--gap-xl">
<div class="ps-grid-span-1">
<article class="ps-card ps-card--elevated ps-animate-fade-up">
<div class="ps-card-header">
<h2 class="ps-card-title">–ú–æ–∏ –æ–±—ä–µ–∫—Ç—ã –ø–∞—Ä–∫–æ–≤–∫–∏</h2>
</div>
<ul class="ps-list">
{% for lot in lots %}
<li class="ps-list-item">
<div class="ps-list-main">
<div class="ps-list-title">
{{ lot.city }}, {{ lot.name }}
</div>
<div class="ps-list-subtitle">
{{ lot.get_parking_type_display }} ¬∑ –º–µ—Å—Ç: {{ lot.spots.count }}
</div>
</div>
<span class="ps-badge ps-badge--neutral">
{{ lot.created_at|date:"d.m.Y" }}
</span>
</li>
{% empty %}
<li class="ps-list-empty">
–ü–æ–∫–∞ –Ω–µ—Ç –Ω–∏ –æ–¥–Ω–æ–≥–æ –æ–±—ä–µ–∫—Ç–∞. –î–æ–±–∞–≤—å—Ç–µ –ø–∞—Ä–∫–æ–≤–∫—É —á–µ—Ä–µ–∑ web-–∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å –≤–ª–∞–¥–µ–ª—å—Ü–∞.
</li>
{% endfor %}
</ul>
</article>
<article class="ps-card ps-animate-fade-up ps-animate-delay-1">
<div class="ps-card-header">
<h2 class="ps-card-title">–ú–µ—Å—Ç–∞</h2>
</div>
<ul class="ps-list ps-list--compact">
{% for spot in spots %}
<li class="ps-list-item">
<div class="ps-list-main">
<div class="ps-list-title">
{{ spot.lot.city }}, {{ spot.lot.name }} ‚Äî {{ spot.name }}
</div>
<div class="ps-list-subtitle">
–¢–∏–ø: {{ spot.get_vehicle_type_display }} ¬∑ {{ spot.hourly_price }} ‚ÇΩ/—á
</div>
</div>
<span class="ps-badge ps-badge--status-{{ spot.status }}">
{{ spot.get_status_display }}
</span>
</li>
{% empty %}
<li class="ps-list-empty">
–ú–µ—Å—Ç –ø–æ–∫–∞ –Ω–µ—Ç.
</li>
{% endfor %}
</ul>
</article>
</div>
<div class="ps-grid-span-2">
<article class="ps-card ps-card--elevated ps-animate-fade-up">
<div class="ps-card-header">
<h2 class="ps-card-title">–ë—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è –ø–æ –º–æ–∏–º –º–µ—Å—Ç–∞–º</h2>
</div>
<div class="ps-table-wrapper">
<table class="ps-table">
<thead>
<tr>
<th>–ú–µ—Å—Ç–æ</th>
<th>–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å</th>
<th>–ü–µ—Ä–∏–æ–¥</th>
<th>–°—Ç–∞—Ç—É—Å</th>
<th>–°—É–º–º–∞</th>
</tr>
</thead>
<tbody>
{% for booking in bookings %}
<tr class="ps-animate-fade-up ps-animate-stagger">
<td data-label="–ú–µ—Å—Ç–æ">
{{ booking.spot.lot.city }},
{{ booking.spot.lot.name }} ‚Äî {{ booking.spot.name }}
</td>
<td data-label="–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å">
{{ booking.user.username }}
</td>
<td data-label="–ü–µ—Ä–∏–æ–¥">
{{ booking.start_at|date:"d.m H:i" }} ‚Üí {{ booking.end_at|date:"d.m H:i" }}
</td>
<td data-label="–°—Ç–∞—Ç—É—Å">
<span class="ps-badge ps-badge--status-{{ booking.status }}">
{{ booking.get_status_display }}
</span>
</td>
<td data-label="–°—É–º–º–∞">
{{ booking.total_price }} ‚ÇΩ
</td>
</tr>
{% empty %}
<tr>
<td colspan="5" class="ps-empty">
–ü–æ –≤–∞—à–∏–º –º–µ—Å—Ç–∞–º –µ—â—ë –Ω–µ –±—ã–ª–æ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–π.
</td>
</tr>
{% endfor %}
</tbody>
</table>
</div>
</article>
</div>
</div>
</section>
{% endblock %}

# File 150/160: templates\parking\pwa_install.html
################################################################################

{% extends "base.html" %}
{% load static %}
{% block title %}–£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å ParkShare –∫–∞–∫ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ{% endblock %}
{% block content %}
<section class="ps-section ps-section--flush-top">
<div class="ps-section-header ps-section-header--stack">
<div>
<h1 class="ps-section-title">–£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ ParkShare RU –Ω–∞ –≥–ª–∞–≤–Ω—ã–π —ç–∫—Ä–∞–Ω</h1>
<p class="ps-section-subtitle">PWA —Ä–∞–±–æ—Ç–∞–µ—Ç –æ—Ñ—Ñ–ª–∞–π–Ω, –¥–∞—ë—Ç –±—ã—Å—Ç—Ä—ã–π –¥–æ—Å—Ç—É–ø –∫ –±—Ä–æ–Ω–∏ –∏ —á–∞—Ç—É.</p>
</div>
</div>
<div class="ps-grid ps-grid--2col@lg ps-grid--gap-lg ps-grid--mobile-stack">
<article class="ps-card ps-card--elevated">
<div class="ps-card-header">
<h3 class="ps-card-title">Android / Chrome</h3>
</div>
<div class="ps-card-body">
<ol class="ps-list-ordered">
<li>–ù–∞–∂–º–∏—Ç–µ <strong>‚ãÆ</strong> –≤ –ø—Ä–∞–≤–æ–º –≤–µ—Ä—Ö–Ω–µ–º —É–≥–ª—É –±—Ä–∞—É–∑–µ—Ä–∞.</li>
<li>–í—ã–±–µ—Ä–∏—Ç–µ –ø—É–Ω–∫—Ç <strong>¬´–£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ¬ª</strong> –∏–ª–∏ <strong>¬´–î–æ–±–∞–≤–∏—Ç—å –Ω–∞ –≥–ª–∞–≤–Ω—ã–π —ç–∫—Ä–∞–Ω¬ª</strong>.</li>
<li>–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç–µ —É—Å—Ç–∞–Ω–æ–≤–∫—É ‚Äî —è—Ä–ª—ã–∫ –ø–æ—è–≤–∏—Ç—Å—è —Ä—è–¥–æ–º —Å –¥—Ä—É–≥–∏–º–∏ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è–º–∏.</li>
</ol>
<p class="ps-card-line ps-card-line--muted">–ï—Å–ª–∏ –≤–∏–¥–∏—Ç–µ –±–∞–Ω–Ω–µ—Ä —É—Å—Ç–∞–Ω–æ–≤–∫–∏ ‚Äî –Ω–∞–∂–º–∏—Ç–µ ¬´–£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å¬ª –ø—Ä—è–º–æ –≤ –Ω—ë–º.</p>
</div>
</article>
<article class="ps-card ps-card--elevated">
<div class="ps-card-header">
<h3 class="ps-card-title">iOS / Safari</h3>
</div>
<div class="ps-card-body">
<ol class="ps-list-ordered">
<li>–ù–∞–∂–º–∏—Ç–µ –∫–Ω–æ–ø–∫—É ¬´–ü–æ–¥–µ–ª–∏—Ç—å—Å—è¬ª (–∫–≤–∞–¥—Ä–∞—Ç —Å–æ —Å—Ç—Ä–µ–ª–∫–æ–π –≤–≤–µ—Ä—Ö).</li>
<li>–ü—Ä–æ–∫—Ä—É—Ç–∏—Ç–µ —Å–ø–∏—Å–æ–∫ –∏ –≤—ã–±–µ—Ä–∏—Ç–µ <strong>¬´–ù–∞ —ç–∫—Ä–∞–Ω ‚Äú–î–æ–º–æ–π‚Äù¬ª</strong>.</li>
<li>–ù–∞–∂–º–∏—Ç–µ ¬´–î–æ–±–∞–≤–∏—Ç—å¬ª ‚Äî –ø–æ—è–≤–∏—Ç—Å—è –∑–Ω–∞—á–æ–∫ ParkShare.</li>
</ol>
<p class="ps-card-line ps-card-line--muted">–ü–æ—Å–ª–µ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ —Ä–∞–±–æ—Ç–∞–µ—Ç –±–µ–∑ –∞–¥—Ä–µ—Å–Ω–æ–π —Å—Ç—Ä–æ–∫–∏ –∏ –∑–∞–Ω–∏–º–∞–µ—Ç –≤–µ—Å—å —ç–∫—Ä–∞–Ω.</p>
</div>
</article>
</div>
</section>
{% endblock %}

# File 151/160: templates\parking\user_dashboard.html
################################################################################

{% extends "base.html" %}
{% load static %}
{% block title %}ParkShare RU ‚Äî –ª–∏—á–Ω—ã–π –∫–∞–±–∏–Ω–µ—Ç{% endblock %}
{% block content %}
<section class="ps-section">
<div class="ps-section-header">
<h1 class="ps-section-title">–õ–∏—á–Ω—ã–π –∫–∞–±–∏–Ω–µ—Ç –≤–æ–¥–∏—Ç–µ–ª—è</h1>
<p class="ps-section-subtitle">
–ó–¥–µ—Å—å —Å–æ–±—Ä–∞–Ω—ã –≤–∞—à–∏ –º–∞—à–∏–Ω—ã –∏ –≤—Å–µ –∞–∫—Ç–∏–≤–Ω—ã–µ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è.
</p>
</div>
<div class="ps-grid ps-grid--3col@lg ps-grid--gap-xl">
<div class="ps-grid-span-1">
<article class="ps-card ps-card--elevated ps-animate-fade-up">
<div class="ps-card-header">
<h2 class="ps-card-title">–ü—Ä–æ—Ñ–∏–ª—å</h2>
</div>
<div class="ps-card-body">
<p class="ps-card-line">
<span class="ps-label">–õ–æ–≥–∏–Ω:</span> {{ user.username }}
</p>
<p class="ps-card-line">
<span class="ps-label">–†–æ–ª—å:</span> {{ user.get_role_display }}
</p>
<div class="ps-progress-block">
<div class="ps-progress-header">
<span class="ps-badge">–£—Ä–æ–≤–µ–Ω—å 1 ¬∑ –ù–æ–≤–∏—á–æ–∫</span>
<span class="ps-progress-label">–î–æ —Å–ª–µ–¥—É—é—â–µ–≥–æ —É—Ä–æ–≤–Ω—è: 3 –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è</span>
</div>
<div class="ps-progress">
<div class="ps-progress-bar" style="width: 45%"></div>
</div>
</div>
<a href="{% url 'accounts:profile' %}" class="ps-btn ps-btn-full">
–ù–∞—Å—Ç—Ä–æ–π–∫–∏ –ø—Ä–æ—Ñ–∏–ª—è
</a>
</div>
</article>
<article class="ps-card ps-animate-fade-up">
<div class="ps-card-header">
<h2 class="ps-card-title">–°–ø–æ—Å–æ–±—ã –æ–ø–ª–∞—Ç—ã</h2>
</div>
<div class="ps-card-body ps-card-body--spacing-lg">
<div class="ps-payment-list" data-payment-methods>
<div class="ps-empty">–ö–∞—Ä—Ç—ã –µ—â—ë –Ω–µ –¥–æ–±–∞–≤–ª–µ–Ω—ã. –ü–æ–¥–∫–ª—é—á–∏—Ç–µ –∫–∞—Ä—Ç—É, —á—Ç–æ–±—ã –±—Ä–æ–Ω–∏—Ä–æ–≤–∞—Ç—å –±–µ–∑ –≤–≤–æ–¥–∞ –¥–∞–Ω–Ω—ã—Ö.</div>
</div>
<div class="ps-divider"></div>
<form class="ps-form ps-form-compact" method="post" action="
<div class="ps-form-row">
<label class="ps-form-label">–ù–æ–º–µ—Ä –∫–∞—Ä—Ç—ã / —Ç–æ–∫–µ–Ω</label>
<input class="ps-input" type="text" name="card_number" placeholder="**** **** **** 1234" autocomplete="off">
<div class="ps-field-help">–î–∞–Ω–Ω—ã–µ —Ç–æ–∫–µ–Ω–∏–∑–∏—Ä—É—é—Ç—Å—è —É –ø—Ä–æ–≤–∞–π–¥–µ—Ä–∞, –º—ã —Ö—Ä–∞–Ω–∏–º —Ç–æ–ª—å–∫–æ –º–∞—Å–∫—É.</div>
</div>
<div class="ps-form-row ps-form-row--inline">
<input class="ps-input" type="text" name="exp" placeholder="MM/YY">
<input class="ps-input" type="text" name="label" placeholder="–õ–∏—á–Ω–∞—è / –†–∞–±–æ—Ç–∞">
</div>
<div class="ps-form-row ps-form-row--inline">
<select class="ps-input" name="provider">
<option value="sber">–°–±–µ—Ä–±–∞–Ω–∫</option>
<option value="tinkoff">–¢–∏–Ω—å–∫–æ—Ñ—Ñ</option>
<option value="other">YooKassa / –¥—Ä—É–≥–æ–µ</option>
</select>
<label class="ps-checkbox ps-checkbox--inline">
<input type="checkbox" name="is_default">
<span>–°–¥–µ–ª–∞—Ç—å –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é</span>
</label>
</div>
<div class="ps-form-actions">
<button class="ps-btn ps-btn-primary ps-btn-full" type="submit">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∫–∞—Ä—Ç—É</button>
</div>
</form>
</div>
</article>
<article class="ps-card ps-animate-fade-up ps-animate-delay-1">
<div class="ps-card-header">
<h2 class="ps-card-title">–ú–æ–∏ –º–∞—à–∏–Ω—ã</h2>
</div>
<ul class="ps-list">
{% for vehicle in vehicles %}
<li class="ps-list-item">
<div class="ps-list-main">
<div class="ps-list-title">
{{ vehicle.label|default:"–ë–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è" }}
</div>
<div class="ps-list-subtitle">
{{ vehicle.get_vehicle_type_display }}
</div>
</div>
<span class="ps-badge ps-badge--neutral">
{{ vehicle.created_at|date:"d.m.Y" }}
</span>
</li>
{% empty %}
<li class="ps-list-empty">
–ü–æ–∫–∞ –Ω–∏ –æ–¥–Ω–æ–π –º–∞—à–∏–Ω—ã. –î–æ–±–∞–≤—å—Ç–µ –º–∞—à–∏–Ω—É —á–µ—Ä–µ–∑ –º–æ–±–∏–ª—å–Ω—ã–π –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å ParkShare RU.
</li>
{% endfor %}
</ul>
</article>
</div>
<div class="ps-grid-span-2">
<article class="ps-card ps-card--elevated ps-animate-fade-up">
<div class="ps-card-header">
<h2 class="ps-card-title">–ú–æ–∏ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è</h2>
</div>
<div class="ps-table-wrapper">
<table class="ps-table">
<thead>
<tr>
<th>–ú–µ—Å—Ç–æ</th>
<th>–¢–∏–ø</th>
<th>–ü–µ—Ä–∏–æ–¥</th>
<th>–°—Ç–∞—Ç—É—Å</th>
<th>–°—É–º–º–∞</th>
</tr>
</thead>
<tbody>
{% for booking in bookings %}
<tr class="ps-animate-fade-up ps-animate-stagger">
<td data-label="–ú–µ—Å—Ç–æ">
{{ booking.spot.lot.city }},
{{ booking.spot.lot.name }} ‚Äî {{ booking.spot.name }}
</td>
<td data-label="–¢–∏–ø">
{{ booking.get_booking_type_display }}
</td>
<td data-label="–ü–µ—Ä–∏–æ–¥">
{{ booking.start_at|date:"d.m H:i" }} ‚Üí {{ booking.end_at|date:"d.m H:i" }}
</td>
<td data-label="–°—Ç–∞—Ç—É—Å">
<span class="ps-badge ps-badge--status-{{ booking.status }}">
{{ booking.get_status_display }}
</span>
</td>
<td data-label="–°—É–º–º–∞">
{{ booking.total_price }} ‚ÇΩ
{% if booking.status == 'confirmed' or booking.status == 'active' or booking.status == 'completed' %}
<span class="ps-badge ps-badge--success">+10 –æ–ø—ã—Ç–∞</span>
{% endif %}
</td>
</tr>
{% empty %}
<tr>
<td colspan="5" class="ps-empty">
–£ –≤–∞—Å –ø–æ–∫–∞ –Ω–µ—Ç –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–π.
</td>
</tr>
{% endfor %}
</tbody>
</table>
</div>
</article>
</div>
</div>
</section>
{% endblock %}

# File 152/160: vehicles\__init__.py
################################################################################



# File 153/160: vehicles\admin.py
################################################################################

# vehicles/admin.py
from django.contrib import admin
from .models import Vehicle
@admin.register(Vehicle)
class VehicleAdmin(admin.ModelAdmin):
list_display = ("label", "owner", "vehicle_type", "created_at")
list_filter = ("vehicle_type", "created_at")
search_fields = ("label", "owner__username")
readonly_fields = ("plate_hash", "created_at")
def has_view_or_change_permission(self, request, obj=None):
"""
–í –∞–¥–º–∏–Ω–∫—É –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é –∏–º–µ–µ—Ç –¥–æ—Å—Ç—É–ø —Ç–æ–ª—å–∫–æ –ø–µ—Ä—Å–æ–Ω–∞–ª,
—Ç–∞–∫ —á—Ç–æ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã—Ö –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–π –Ω–µ –≤–≤–æ–¥–∏–º.
"""
return super().has_view_or_change_permission(request, obj)

# File 154/160: vehicles\apps.py
################################################################################

# vehicles/apps.py
from django.apps import AppConfig
class VehiclesConfig(AppConfig):
default_auto_field = "django.db.models.BigAutoField"
name = "vehicles"
verbose_name = "–ú–∞—à–∏–Ω—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π"

# File 155/160: vehicles\models.py
################################################################################

import uuid
from django.conf import settings
from django.db import models
from django.utils.translation import gettext_lazy as _
from core.models import TimeStampedModel
class Vehicle(TimeStampedModel):
"""
–ú–∞—à–∏–Ω–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.
–í–∞–∂–Ω–æ:
- —Ä–µ–∞–ª—å–Ω—ã–π –≥–æ—Å–Ω–æ–º–µ—Ä –Ω–∏–≥–¥–µ –Ω–µ —Ö—Ä–∞–Ω–∏—Ç—Å—è;
- –≤ –ë–î –µ—Å—Ç—å —Ç–æ–ª—å–∫–æ —Ö—ç—à —Ü–∏—Ñ—Ä –Ω–æ–º–µ—Ä–∞ –∏ –ø—Ä–æ–∏–∑–≤–æ–ª—å–Ω–∞—è –º–µ—Ç–∫–∞ (label).
"""
class VehicleType(models.TextChoices):
CAR = "car", _("–õ–µ–≥–∫–æ–≤–æ–π –∞–≤—Ç–æ–º–æ–±–∏–ª—å")
MOTO = "moto", _("–ú–æ—Ç–æ—Ü–∏–∫–ª")
COMMERCIAL = "commercial", _("–ö–æ–º–º–µ—Ä—á–µ—Å–∫–∏–π —Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç")
id = models.UUIDField(primary_key=True, default=uuid.uuid4, editable=False)
owner = models.ForeignKey(
settings.AUTH_USER_MODEL,
on_delete=models.CASCADE,
related_name="vehicles",
verbose_name=_("–í–ª–∞–¥–µ–ª–µ—Ü"),
)
label = models.CharField(
_("–ù–∞–∑–≤–∞–Ω–∏–µ/–æ–ø–∏—Å–∞–Ω–∏–µ"),
max_length=64,
blank=True,
help_text=_("–ù–∞–ø—Ä–∏–º–µ—Ä: ¬´–°–µ—Ä–∞—è Toyota —É –¥–æ–º–∞¬ª."),
)
vehicle_type = models.CharField(
_("–¢–∏–ø —Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç–∞"),
max_length=16,
choices=VehicleType.choices,
default=VehicleType.CAR,
)
plate_hash = models.CharField(
_("–•—ç—à –Ω–æ–º–µ—Ä–∞"),
max_length=64,
db_index=True,
help_text=_("SHA‚Äë256‚Äë—Ö—ç—à —Ü–∏—Ñ—Ä –≥–æ—Å–Ω–æ–º–µ—Ä–∞ —Å —Å–æ–ª—å—é."),
)
class Meta:
verbose_name = _("–ú–∞—à–∏–Ω–∞")
verbose_name_plural = _("–ú–∞—à–∏–Ω—ã")
unique_together = (("owner", "plate_hash"),)
ordering = ("-created_at",)
def __str__(self) -> str:
if self.label:
return f"{self.label} ({self.owner.username})"
return f"–ú–∞—à–∏–Ω–∞ {self.pk}"

# File 156/160: vehicles\serializers.py
################################################################################

# vehicles/serializers.py
from django.utils.translation import gettext_lazy as _
from rest_framework import serializers
from core.utils import hash_plate_digits
from .models import Vehicle
class VehicleSerializer(serializers.ModelSerializer):
"""
–°–µ—Ä–∏–∞–ª–∏–∑–∞—Ç–æ—Ä –¥–ª—è –º–∞—à–∏–Ω.
–í—Ö–æ–¥:
- plate_number (write_only) ‚Äî —Å—Ç—Ä–æ–∫–∞ –Ω–æ–º–µ—Ä–∞, —Ö—ç—à–∏—Ä—É–µ—Ç—Å—è –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ;
- label, vehicle_type.
–í—ã—Ö–æ–¥:
- id, label, vehicle_type, created_at.
"""
plate_number = serializers.CharField(
write_only=True,
label=_("–ì–æ—Å–Ω–æ–º–µ—Ä"),
help_text=_(
"–§–∞–∫—Ç–∏—á–µ—Å–∫–∏–π –Ω–æ–º–µ—Ä –±—É–¥–µ—Ç –ø—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞–Ω –≤ —Ö—ç—à –∏ –Ω–µ –±—É–¥–µ—Ç —Ö—Ä–∞–Ω–∏—Ç—å—Å—è –≤ –æ—Ç–∫—Ä—ã—Ç–æ–º –≤–∏–¥–µ."
),
)
class Meta:
model = Vehicle
fields = ("id", "label", "vehicle_type", "plate_number", "created_at")
read_only_fields = ("id", "created_at")
def validate_plate_number(self, value: str) -> str:
digits = "".join(ch for ch in value if ch.isdigit())
if not digits:
raise serializers.ValidationError(
_("–ù—É–∂–Ω–æ —É–∫–∞–∑–∞—Ç—å —Ö–æ—Ç—è –±—ã –æ–¥–Ω—É —Ü–∏—Ñ—Ä—É –Ω–æ–º–µ—Ä–∞.")
)
return value
def create(self, validated_data: dict) -> Vehicle:
request = self.context["request"]
user = request.user
plate_number = validated_data.pop("plate_number")
plate_hash = hash_plate_digits(plate_number)
if Vehicle.objects.filter(owner=user, plate_hash=plate_hash).exists():
raise serializers.ValidationError(
{
"plate_number": _(
"–ú–∞—à–∏–Ω–∞ —Å —Ç–∞–∫–∏–º –Ω–æ–º–µ—Ä–æ–º —É–∂–µ –¥–æ–±–∞–≤–ª–µ–Ω–∞ –≤ –≤–∞—à —Å–ø–∏—Å–æ–∫."
)
}
)
vehicle = Vehicle.objects.create(
owner=user,
plate_hash=plate_hash,
**validated_data,
)
return vehicle
def update(self, instance: Vehicle, validated_data: dict) -> Vehicle:
# –ù–æ–º–µ—Ä –º–µ–Ω—è—Ç—å –Ω–µ–ª—å–∑—è (–ø–æ—Ç—Ä–µ–±—É–µ—Ç —Å–æ–∑–¥–∞–Ω–∏—è –Ω–æ–≤–æ–≥–æ –æ–±—ä–µ–∫—Ç–∞),
# –ø–æ—ç—Ç–æ–º—É –∏–≥–Ω–æ—Ä–∏—Ä—É–µ–º plate_number –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏.
validated_data.pop("plate_number", None)
return super().update(instance, validated_data)

# File 157/160: vehicles\urls.py
################################################################################

# vehicles/urls.py
from django.contrib.auth.decorators import login_required
from django.urls import path
from django.views.generic import TemplateView
app_name = "vehicles"
urlpatterns = [
# –ü—Ä–æ—Å—Ç–∞—è HTML-—Å—Ç—Ä–∞–Ω–∏—Ü–∞ ¬´–ú–æ–∏ –º–∞—à–∏–Ω—ã¬ª (–º–æ–∂–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –≤ –±—É–¥—É—â–µ–º).
path(
"my/",
login_required(
TemplateView.as_view(template_name="vehicles/my_vehicles.html")
),
name="my_vehicles",
),
]

# File 158/160: vehicles\views.py
################################################################################

# vehicles/views.py
from rest_framework import permissions, viewsets
from core.permissions import IsOwnerObject
from .models import Vehicle
from .serializers import VehicleSerializer
class VehicleViewSet(viewsets.ModelViewSet):
"""
API –¥–ª—è –º–∞—à–∏–Ω –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.
- /api/vehicles/              (GET)   ‚Äî —Å–ø–∏—Å–æ–∫ –º–∞—à–∏–Ω —Ç–µ–∫—É—â–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
- /api/vehicles/              (POST)  ‚Äî —Å–æ–∑–¥–∞—Ç—å –º–∞—à–∏–Ω—É (–Ω–æ–º–µ—Ä —Ö—ç—à–∏—Ä—É–µ—Ç—Å—è)
- /api/vehicles/{id}/         (GET)   ‚Äî –¥–µ—Ç–∞–ª–∏ (—Ç–æ–ª—å–∫–æ –≤–ª–∞–¥–µ–ª–µ—Ü)
- /api/vehicles/{id}/         (PATCH/PUT/DELETE) ‚Äî —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –º–∞—à–∏–Ω–æ–π (—Ç–æ–ª—å–∫–æ –≤–ª–∞–¥–µ–ª–µ—Ü)
"""
serializer_class = VehicleSerializer
permission_classes = [permissions.IsAuthenticated, IsOwnerObject]
def get_queryset(self):
user = self.request.user
if not user.is_authenticated:
return Vehicle.objects.none()
return Vehicle.objects.filter(owner=user).order_by("-created_at")
def perform_create(self, serializer: VehicleSerializer) -> None:
# owner —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç—Å—è –≤ serializer.create()
serializer.save()

# File 159/160: vehicles\migrations\0001_initial.py
################################################################################

# Generated by Django 5.2.8 on 2025-11-21 21:34
import django.db.models.deletion
import uuid
from django.conf import settings
from django.db import migrations, models
class Migration(migrations.Migration):
initial = True
dependencies = [
migrations.swappable_dependency(settings.AUTH_USER_MODEL),
]
operations = [
migrations.CreateModel(
name='Vehicle',
fields=[
('created_at', models.DateTimeField(auto_now_add=True, verbose_name='–î–∞—Ç–∞ —Å–æ–∑–¥–∞–Ω–∏—è')),
('updated_at', models.DateTimeField(auto_now=True, verbose_name='–î–∞—Ç–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è')),
('id', models.UUIDField(default=uuid.uuid4, editable=False, primary_key=True, serialize=False)),
('label', models.CharField(blank=True, help_text='–ù–∞–ø—Ä–∏–º–µ—Ä: ¬´–°–µ—Ä–∞—è Toyota —É –¥–æ–º–∞¬ª.', max_length=64, verbose_name='–ù–∞–∑–≤–∞–Ω–∏–µ/–æ–ø–∏—Å–∞–Ω–∏–µ')),
('vehicle_type', models.CharField(choices=[('car', '–õ–µ–≥–∫–æ–≤–æ–π –∞–≤—Ç–æ–º–æ–±–∏–ª—å'), ('moto', '–ú–æ—Ç–æ—Ü–∏–∫–ª'), ('commercial', '–ö–æ–º–º–µ—Ä—á–µ—Å–∫–∏–π —Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç')], default='car', max_length=16, verbose_name='–¢–∏–ø —Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç–∞')),
('plate_hash', models.CharField(db_index=True, help_text='SHA‚Äë256‚Äë—Ö—ç—à —Ü–∏—Ñ—Ä –≥–æ—Å–Ω–æ–º–µ—Ä–∞ —Å —Å–æ–ª—å—é.', max_length=64, verbose_name='–•—ç—à –Ω–æ–º–µ—Ä–∞')),
('owner', models.ForeignKey(on_delete=django.db.models.deletion.CASCADE, related_name='vehicles', to=settings.AUTH_USER_MODEL, verbose_name='–í–ª–∞–¥–µ–ª–µ—Ü')),
],
options={
'verbose_name': '–ú–∞—à–∏–Ω–∞',
'verbose_name_plural': '–ú–∞—à–∏–Ω—ã',
'ordering': ('-created_at',),
'unique_together': {('owner', 'plate_hash')},
},
),
]

# File 160/160: vehicles\migrations\__init__.py
################################################################################



